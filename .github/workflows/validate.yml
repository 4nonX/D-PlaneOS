name: D-PlaneOS CI

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

# What this CI does and does NOT do:
#
# DOES:
#   - Confirms the daemon compiles without errors
#   - Spins up the daemon against a real ZFS pool (loopback-backed)
#   - Seeds a known user and logs in — confirms auth works end to end
#   - Hits every API endpoint and asserts valid responses
#   - Verifies ZFS operations (create/snapshot/rollback/destroy) at the OS level
#   - Checks security boundaries (401 on unauth, bad session, injection blocked)
#
# DOES NOT:
#   - Test the frontend (requires a browser on real hardware)
#   - Test frontend-backend integration (use integration-test.sh on real hardware)
#   - Verify UI displays correct data (same — real hardware only)
#   - Run install.sh (requires actual root environment, not a CI VM)
#
# For full system validation including UI, install, and onboarding:
#   sudo ./scripts/integration-test.sh

jobs:
  ci:
    name: Build + API integration
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: daemon/go.mod
          cache-dependency-path: daemon/go.sum

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y gcc libc6-dev zfsutils-linux sqlite3 python3-bcrypt curl
          sudo modprobe zfs

      - name: Build daemon
        working-directory: daemon
        run: |
          CGO_ENABLED=1 go build \
            -tags sqlite_fts5 \
            -ldflags="-s -w" \
            -o ../dplaned-ci \
            ./cmd/dplaned/

      - name: Create loopback ZFS pool
        run: |
          sudo truncate -s 512M /tmp/vdisk0.img
          sudo truncate -s 512M /tmp/vdisk1.img
          sudo truncate -s 512M /tmp/vdisk2.img
          LOOP0=$(sudo losetup --find --show /tmp/vdisk0.img)
          LOOP1=$(sudo losetup --find --show /tmp/vdisk1.img)
          LOOP2=$(sudo losetup --find --show /tmp/vdisk2.img)
          echo "LOOP0=$LOOP0" >> $GITHUB_ENV
          echo "LOOP1=$LOOP1" >> $GITHUB_ENV
          echo "LOOP2=$LOOP2" >> $GITHUB_ENV
          sudo zpool create -f testpool raidz1 "$LOOP0" "$LOOP1" "$LOOP2"
          sudo zpool status testpool

      - name: Initialise database
        run: |
          sudo mkdir -p /var/lib/dplaneos

      - name: Start daemon
        run: |
          chmod +x dplaned-ci
          sudo mkdir -p /opt/dplaneos /var/log/dplaneos /etc/dplaneos
          sudo cp -r app /opt/dplaneos/app
          sudo ./dplaned-ci \
            -db /var/lib/dplaneos/dplaneos.db \
            -listen 127.0.0.1:9000 \
            -smb-conf /var/lib/dplaneos/smb-shares.conf \
            &>/tmp/dplaned.log &
          echo $! > /tmp/dplaned.pid
          for i in $(seq 1 20); do
            curl -sf http://127.0.0.1:9000/health | grep -q '"ok"' && break
            sleep 1
          done
          curl -sf http://127.0.0.1:9000/health | grep -q '"ok"'

      - name: Set CI admin password
        run: |
          CI_PASS="CiAdmin1!Test"
          CI_HASH=$(python3 -c "import bcrypt; print(bcrypt.hashpw(b'$CI_PASS', bcrypt.gensalt(rounds=10)).decode())")
          sudo sqlite3 /var/lib/dplaneos/dplaneos.db \
            "UPDATE users SET password_hash = '$CI_HASH' WHERE username = 'admin';"
          echo "CI_PASS=$CI_PASS" >> $GITHUB_ENV

      - name: API integration tests
        run: |
          BASE="http://127.0.0.1:9000"
          PASS=0; FAIL=0; FAILURES=""

          ok()   { echo "  ✓ $1"; PASS=$((PASS+1)); }
          fail() { echo "  ✗ $1"; FAIL=$((FAIL+1)); FAILURES="${FAILURES}\n  ✗ $1"; }

          assert_json() {
            local label="$1" resp="$2" key="$3" expected="${4:-}"
            if echo "$resp" | python3 -c "
          import sys,json
          try: d=json.load(sys.stdin)
          except: sys.exit(1)
          val=d
          for k in '$key'.split('.'): val=val.get(k) if isinstance(val,dict) else None
          sys.exit(0 if (str(val).lower()=='$expected'.lower() if '$expected' else bool(val)) else 1)
          " 2>/dev/null; then ok "$label"; else fail "$label  (got: $(echo "$resp" | head -c 120))"; fi
          }

          valid_json() {
            echo "$1" | python3 -c "import sys,json; json.load(sys.stdin)" 2>/dev/null
          }

          # ── Auth ─────────────────────────────────────────────────────────────

          assert_json "/health ok"             "$(curl -sf $BASE/health)"  "status" "ok"
          assert_json "/api/csrf returns token" "$(curl -sf $BASE/api/csrf)" "csrf_token"

          # Capture login response and HTTP code (avoid curl -f so we can show body on failure)
          LOGIN_RESP=$(curl -s -w "\n%{http_code}" -X POST $BASE/api/auth/login \
            -H "Content-Type: application/json" \
            -d "{\"username\":\"admin\",\"password\":\"$CI_PASS\"}")
          HTTP_CODE=$(echo "$LOGIN_RESP" | tail -n1)
          LOGIN=$(echo "$LOGIN_RESP" | sed '$d')
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Login failed (HTTP $HTTP_CODE): $LOGIN"
            exit 1
          fi
          assert_json "Login succeeds"        "$LOGIN" "success" "true"
          assert_json "Login returns session" "$LOGIN" "session_id"

          SESSION=$(echo "$LOGIN" | python3 -c \
            "import sys,json; print(json.load(sys.stdin).get('session_id',''))" 2>/dev/null)

          # Use curl -s (no -f): we expect 4xx here, and -f would make curl exit 22 before we check CODE
          CODE=$(curl -s -o /dev/null -w "%{http_code}" $BASE/api/zfs/pools)
          [ "$CODE" = "401" ] && ok "Unauth request → 401" || fail "Unauth request → $CODE (want 401)"

          CODE=$(curl -s -o /dev/null -w "%{http_code}" $BASE/api/zfs/pools -H "X-Session-ID: garbage")
          [ "$CODE" = "401" ] && ok "Bad session → 401" || fail "Bad session → $CODE (want 401)"

          CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST $BASE/api/auth/login \
            -H "Content-Type: application/json" -d '{"username":"admin","password":"wrong"}')
          [ "$CODE" = "401" ] && ok "Wrong password → 401" || fail "Wrong password → $CODE (want 401)"

          CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST $BASE/api/auth/login \
            -H "Content-Type: application/json" -d '{"username":"bad user<>","password":"x"}')
          [ "$CODE" = "400" ] && ok "Malformed username → 400" || fail "Malformed username → $CODE (want 400)"

          WEAK=$(curl -sf -X POST $BASE/api/auth/change-password \
            -H "X-Session-ID: $SESSION" -H "X-User: admin" -H "Content-Type: application/json" \
            -d "{\"current_password\":\"$CI_PASS\",\"new_password\":\"weak\"}")
          assert_json "Weak password rejected" "$WEAK" "success" "false"

          api() {
            local method="$1" path="$2" body="${3:-}"
            local args=(-sf --max-time 15 -X "$method" "$BASE$path"
                        -H "X-Session-ID: $SESSION" -H "X-User: admin"
                        -H "Content-Type: application/json")
            [ -n "$body" ] && args+=(-d "$body")
            curl "${args[@]}" 2>/dev/null || echo '{"_err":true}'
          }

          # ── Session ──────────────────────────────────────────────────────────

          assert_json "Auth check → authenticated" "$(api GET /api/auth/check)"   "authenticated" "true"
          assert_json "Session → role=admin"        "$(api GET /api/auth/session)" "user.role"     "admin"

          # ── System info ───────────────────────────────────────────────────────

          assert_json "System status"    "$(api GET /api/system/status)"    "success" "true"
          assert_json "System profile"   "$(api GET /api/system/profile)"   "success" "true"
          assert_json "System preflight" "$(api GET /api/system/preflight)" "success" "true"
          assert_json "System settings"  "$(api GET /api/system/settings)"  "success" "true"
          assert_json "Metrics current"  "$(api GET /api/metrics/current)"  "success" "true"
          valid_json "$(api GET /api/system/network)"         && ok "System network"  || fail "System network → invalid JSON"
          valid_json "$(api GET '/api/system/logs?lines=20')" && ok "System logs"     || fail "System logs → invalid JSON"
          valid_json "$(api GET /api/system/disks)"           && ok "Disk discovery"  || fail "Disk discovery → invalid JSON"
          valid_json "$(api GET /api/system/ntp)"             && ok "NTP status"      || fail "NTP status → invalid JSON"
          valid_json "$(api GET /api/system/ups)"             && ok "UPS status"      || fail "UPS status → invalid JSON"
          valid_json "$(api GET /api/monitoring/inotify)"     && ok "Inotify stats"   || fail "Inotify stats → invalid JSON"

          # ── ZFS ───────────────────────────────────────────────────────────────

          POOLS=$(api GET /api/zfs/pools)
          assert_json "ZFS pools" "$POOLS" "success" "true"
          COUNT=$(echo "$POOLS" | python3 -c \
            "import sys,json; print(len(json.load(sys.stdin).get('data',[])))" 2>/dev/null || echo 0)
          [ "$COUNT" -ge 1 ] && ok "ZFS pool list → $COUNT pool(s)" || fail "ZFS pool list → empty"

          assert_json "ZFS datasets" "$(api GET /api/zfs/datasets)" "success" "true"

          assert_json "Create dataset" \
            "$(api POST /api/zfs/datasets '{"name":"testpool/ci-test","compression":"lz4"}')" \
            "success" "true"
          sudo zfs list testpool/ci-test &>/dev/null \
            && ok "Dataset exists on system after create" \
            || fail "Dataset missing on system after create"

          assert_json "Create snapshot" \
            "$(api POST /api/zfs/snapshots '{"dataset":"testpool/ci-test","name":"ci-snap-1"}')" \
            "success" "true"
          sudo zfs list -t snapshot testpool/ci-test@ci-snap-1 &>/dev/null \
            && ok "Snapshot exists on system after create" \
            || fail "Snapshot missing on system after create"

          SNAPS=$(api GET '/api/zfs/snapshots?dataset=testpool/ci-test')
          assert_json "List snapshots" "$SNAPS" "success" "true"
          SC=$(echo "$SNAPS" | python3 -c \
            "import sys,json; print(json.load(sys.stdin).get('count',0))" 2>/dev/null || echo 0)
          [ "$SC" -ge 1 ] && ok "Snapshot list → $SC snapshot(s)" || fail "Snapshot list → empty"

          assert_json "Rollback snapshot" \
            "$(api POST /api/zfs/snapshots/rollback '{"snapshot":"testpool/ci-test@ci-snap-1"}')" \
            "success" "true"

          assert_json "Destroy snapshot" \
            "$(api DELETE /api/zfs/snapshots '{"snapshot":"testpool/ci-test@ci-snap-1"}')" \
            "success" "true"
          sudo zfs list -t snapshot testpool/ci-test@ci-snap-1 &>/dev/null \
            && fail "Snapshot still exists after destroy" \
            || ok "Snapshot gone from system after destroy"

          valid_json "$(api GET /api/zfs/health)"          && ok "ZFS health"          || fail "ZFS health → invalid JSON"
          valid_json "$(api GET /api/zfs/iostat)"          && ok "ZFS iostat"          || fail "ZFS iostat → invalid JSON"
          valid_json "$(api GET /api/zfs/capacity)"        && ok "ZFS capacity"        || fail "ZFS capacity → invalid JSON"
          valid_json "$(api GET /api/zfs/smart)"           && ok "ZFS SMART"           || fail "ZFS SMART → invalid JSON"
          valid_json "$(api GET /api/snapshots/schedules)" && ok "Snapshot schedules"  || fail "Snapshot schedules → invalid JSON"

          # ── Users ─────────────────────────────────────────────────────────────

          USERS=$(api GET /api/rbac/users)
          assert_json "User list" "$USERS" "success" "true"
          ADMIN_IN=$(echo "$USERS" | python3 -c \
            "import sys,json; print('yes' if any(u['username']=='admin' for u in json.load(sys.stdin).get('users',[])) else 'no')" 2>/dev/null)
          [ "$ADMIN_IN" = "yes" ] && ok "Admin visible in user list" || fail "Admin not in user list"

          assert_json "Create user" \
            "$(api POST /api/users/create \
              '{"action":"create","username":"ci-testuser","password":"CiTest1!Pass","email":"ci@test.local","role":"user"}')" \
            "success" "true"
          NEW_IN=$(api GET /api/rbac/users | python3 -c \
            "import sys,json; print('yes' if any(u['username']=='ci-testuser' for u in json.load(sys.stdin).get('users',[])) else 'no')" 2>/dev/null)
          [ "$NEW_IN" = "yes" ] && ok "New user visible in list after create" || fail "New user missing after create"

          # ── Remaining subsystems ──────────────────────────────────────────────

          valid_json "$(api GET /api/shares)"              && ok "Shares"            || fail "Shares → invalid JSON"
          valid_json "$(api GET /api/shares/nfs/list)"     && ok "NFS exports"       || fail "NFS exports → invalid JSON"
          valid_json "$(api GET /api/docker/preflight)"    && ok "Docker preflight"  || fail "Docker preflight → invalid JSON"
          valid_json "$(api GET /api/docker/containers)"   && ok "Docker containers" || fail "Docker containers → invalid JSON"
          valid_json "$(api GET /api/git-sync/config)"     && ok "Git sync config"   || fail "Git sync config → invalid JSON"
          valid_json "$(api GET /api/git-sync/repos)"      && ok "Git sync repos"    || fail "Git sync repos → invalid JSON"
          valid_json "$(api GET /api/alerts/webhooks)"     && ok "Webhooks"          || fail "Webhooks → invalid JSON"
          valid_json "$(api GET /api/alerts/smtp)"         && ok "SMTP config"       || fail "SMTP config → invalid JSON"
          valid_json "$(api GET /api/ldap/config)"         && ok "LDAP config"       || fail "LDAP config → invalid JSON"
          valid_json "$(api GET /api/ldap/status)"         && ok "LDAP status"       || fail "LDAP status → invalid JSON"
          valid_json "$(api GET /api/firewall/status)"     && ok "Firewall status"   || fail "Firewall status → invalid JSON"
          valid_json "$(api GET /api/ha/status)"           && ok "HA status"         || fail "HA status → invalid JSON"
          valid_json "$(api GET /api/iscsi/status)"        && ok "iSCSI status"      || fail "iSCSI status → invalid JSON"
          valid_json "$(api GET /api/sandbox/list)"        && ok "Sandbox list"      || fail "Sandbox list → invalid JSON"
          valid_json "$(api GET /api/trash/list)"          && ok "Trash list"        || fail "Trash list → invalid JSON"
          valid_json "$(api GET /api/removable/list)"      && ok "Removable media"   || fail "Removable media → invalid JSON"
          valid_json "$(api GET /api/power/disks)"         && ok "Power/spindown"    || fail "Power/spindown → invalid JSON"
          valid_json "$(api GET /api/certs/list)"          && ok "Certs"             || fail "Certs → invalid JSON"
          valid_json "$(api GET /api/rbac/me/permissions)" && ok "My permissions"    || fail "My permissions → invalid JSON"
          valid_json "$(api GET /api/auth/tokens)"         && ok "API tokens"        || fail "API tokens → invalid JSON"

          INJECT=$(api POST /api/zfs/command \
            "{\"command\":\"ls\",\"args\":[\"/etc/passwd\"],\"session_id\":\"$SESSION\",\"user\":\"admin\"}")
          echo "$INJECT" | grep -q '"success":false\|Forbidden\|not allowed' \
            && ok "Command injection blocked" || fail "Command injection NOT blocked"

          PROM=$(curl -sf --max-time 5 $BASE/metrics \
            -H "X-Session-ID: $SESSION" -H "X-User: admin" 2>/dev/null || echo "")
          [ -n "$PROM" ] && ok "Prometheus /metrics responds" || fail "Prometheus /metrics no response"

          # ── Logout ────────────────────────────────────────────────────────────

          assert_json "Logout" "$(api POST /api/auth/logout)" "success" "true"
          AUTHED=$(curl -sf $BASE/api/auth/check -H "X-Session-ID: $SESSION" | \
            python3 -c "import sys,json; print(json.load(sys.stdin).get('authenticated'))" 2>/dev/null)
          [ "$AUTHED" = "False" ] || [ "$AUTHED" = "false" ] \
            && ok "Session dead after logout" \
            || fail "Session still valid after logout"

          # ── Summary ───────────────────────────────────────────────────────────

          echo ""
          echo "══════════════════════════════════════════"
          printf "  Results: ✓ %d passed   ✗ %d failed\n" "$PASS" "$FAIL"
          echo "══════════════════════════════════════════"
          if [ "$FAIL" -gt 0 ]; then
            printf "Failures:$FAILURES\n"
            exit 1
          fi

      - name: Dump daemon log on failure
        if: failure()
        run: cat /tmp/dplaned.log || true

      - name: Cleanup
        if: always()
        run: |
          [ -f /tmp/dplaned.pid ] && sudo kill $(cat /tmp/dplaned.pid) 2>/dev/null || true
          sudo zpool destroy testpool 2>/dev/null || true
          sudo losetup -d "$LOOP0" "$LOOP1" "$LOOP2" 2>/dev/null || true
