[Unit]
Description=D-PlaneOS System Daemon
# Hard gate: dplaned MUST NOT start before ZFS pools are fully mounted.
# dplaneos-zfs-mount-wait.service polls until all pools are ONLINE + writable,
# preventing the Docker-before-ZFS silent data loss race condition.
After=network.target zfs.target dplaneos-zfs-mount-wait.service
Requires=dplaneos-zfs-mount-wait.service
Wants=zfs.target
Documentation=https://github.com/4nonX/homelab

[Service]
Type=simple
ExecStartPre=/bin/mkdir -p /var/run/dplaneos /var/lib/dplaneos /var/log/dplaneos /etc/dplaneos
ExecStartPre=/bin/chmod 755 /var/run/dplaneos
ExecStart=/opt/dplaneos/daemon/dplaned -db /var/lib/dplaneos/dplaneos.db -listen 127.0.0.1:9000
WorkingDirectory=/opt/dplaneos
Restart=always
RestartSec=5

# Daemon runs as root — required for:
# - ZFS pool/dataset operations (zpool, zfs commands)
# - Disk power management (hdparm, smartctl)
# - Network configuration (ip, iptables)
# - Service management (systemctl reload smbd/nfsd)
# - udev socket communication (/var/run/dplaneos/)
User=root
Group=root

# RuntimeDirectory creates /run/dplaneos with correct ownership on boot
# and cleans it up on service stop — solves the udev socket permission issue
RuntimeDirectory=dplaneos
RuntimeDirectoryMode=0755
StateDirectory=dplaneos
LogsDirectory=dplaneos

# Hardening — restrict despite running as root
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/var/log/dplaneos /var/lib/dplaneos /opt/dplaneos /etc/dplaneos /run/dplaneos /etc/crontab /etc/exports /etc/samba

# Capabilities (ZFS requires SYS_ADMIN, network config requires NET_ADMIN)
AmbientCapabilities=CAP_SYS_ADMIN CAP_NET_ADMIN CAP_DAC_READ_SEARCH CAP_CHOWN CAP_FOWNER
CapabilityBoundingSet=CAP_SYS_ADMIN CAP_NET_ADMIN CAP_DAC_READ_SEARCH CAP_CHOWN CAP_FOWNER

# Limits
LimitNOFILE=65536
TasksMax=4096

# OOM Protection — prevent daemon from destabilizing the NAS
# 1GB is generous for a Go daemon that shells out to zfs/docker CLI tools.
# MemoryHigh triggers cgroup throttling before the hard kill.
# OOMScoreAdjust=-900 makes dplaned one of the last to be killed system-wide.
# Restart=always ensures recovery within 5 seconds if killed.
MemoryMax=1G
MemoryHigh=768M
OOMScoreAdjust=-900

# Logging
StandardOutput=journal
StandardError=journal
SyslogIdentifier=dplaned

[Install]
WantedBy=multi-user.target
