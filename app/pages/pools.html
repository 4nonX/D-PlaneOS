<!DOCTYPE html>
<!-- saved from url=(0139)pools.html -->
<html lang="en"><head><style>html{background:#0a0a0a}</style><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Storage - D-PlaneOS</title>
  <link rel="stylesheet" href="/assets/css/design-tokens.css">
<link rel="stylesheet" href="/assets/css/m3-tokens.css">
<link rel="stylesheet" href="/assets/css/m3-components.css">
<link rel="stylesheet" href="/assets/css/m3-icons.css">
  <link rel="stylesheet" href="/assets/css/enhanced-ui.css">
<link rel="stylesheet" href="/assets/css/m3-animations.css">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif; background: #0a0a0a; color: #fff; overflow-x: hidden; }


.logo { font-size: 20px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; cursor: pointer; }


.nav-link:hover, 
.main { max-width: 1600px; margin: 140px auto 60px; padding: 0 40px; }
.page-header { margin-bottom: 48px; }
.page-title { font-size: 32px; font-weight: 700; letter-spacing: -1.5px; margin-bottom: 12px; }
.page-subtitle { font-size: 18px; color: rgba(255,255,255,0.6); }
.pool-card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: var(--radius-xl); padding: 32px; margin-bottom: 24px; border-left: 4px solid var(--primary); }
.pool-header { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
.pool-icon { font-size: 32px; color: var(--primary); }
.pool-info { flex: 1; }
.pool-name { font-size: 28px; font-weight: 700; margin-bottom: 6px; }
.pool-details { font-size: 15px; color: rgba(255,255,255,0.6); }
.capacity-bar { height: 12px; background: rgba(255,255,255,0.05); border-radius: 24px; overflow: hidden; margin: 20px 0; }
.capacity-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--primary)); border-radius: 24px; transition: width 0.5s; }
/* Badge styles are in m3-components.css */
.icon-btn { width: 40px; height: 40px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,0.8); cursor: pointer; transition: all 0.3s; border: none; }
.icon-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
.btn { background: rgba(255,255,255,0.1); color: #fff; padding: 12px 24px; border-radius: 10px; font-weight: 500; font-size: 14px; border: none; cursor: pointer; transition: all 0.3s; }
.btn:hover { background: rgba(255,255,255,0.15); }
.btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--primary) 100%); }
.btn-primary:hover { box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4); }
.fab { position: fixed; bottom: 32px; right: 32px; width: 64px; height: 64px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary) 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4); cursor: pointer; transition: all 0.3s; border: none; color: #fff; }
.fab:hover { transform: translateY(-4px); box-shadow: 0 12px 48px rgba(102, 126, 234, 0.6); }
</style>
<style type="text/css" id="operaUserStyle"></style><link rel="stylesheet" href="/assets/css/ui-components.css">
<script src="/assets/js/core.js"></script>
<script src="/assets/js/nav-flyout.js"></script>
<script src="/assets/js/hybrid-router.js"></script>
  <script src="/assets/js/enhanced-ui.js"></script>
  <script src="/assets/js/connection-monitor.js"></script>
  <script src="/assets/js/keyboard-shortcuts.js"></script>
  <script src="/assets/js/form-validator.js"></script>
  <link rel="stylesheet" href="/assets/css/material-symbols-local.css">
  <link rel="stylesheet" href="/assets/css/ui-consistency.css">
  <link rel="stylesheet" href="/assets/css/ui-polish.css">
  <script src="/assets/js/daemon-api.js"></script>
</head>
<body>
<!-- D-PlaneOS v2.1.0 - Hierarchical Navigation -->
<!-- This navigation maintains all security (CSRF, Auth) and real system state -->

<nav class="nav-container">
  <div class="nav-main">
    <div style="display: flex; align-items: center; gap: 16px;">
      <div class="logo">
        D-PlaneOS
        <span class="version-badge">v2.1.0</span>
      </div>
    </div>
    
    <div class="nav-links">
      <button class="nav-link" onclick="navigateToSection('dashboard')" data-section="dashboard">
        Dashboard
      </button>
      <button class="nav-link" onclick="toggleSubNav('storage', this)" data-section="storage">
        Storage
      </button>
      <button class="nav-link" onclick="toggleSubNav('compute', this)" data-section="compute">
        Compute
      </button>
      <button class="nav-link" onclick="toggleSubNav('network', this)" data-section="network">
        Network
      </button>
      <button class="nav-link" onclick="toggleSubNav('identity', this)" data-section="identity">
        Identity
      </button>
      <button class="nav-link" onclick="toggleSubNav('security', this)" data-section="security">
        Security
      </button>
      <button class="nav-link" onclick="toggleSubNav('system', this)" data-section="system">
        System
      </button>
    </div>
    
    <div class="nav-actions">
      <button class="nav-action-btn" onclick="showKeyboardHelp()" title="Keyboard Shortcuts (?)">
        <span class="material-symbols-rounded">keyboard</span>
      </button>
      <div class="connection-status online" id="navConnectionStatus">
        <span class="status-dot"></span>
        <span>Connected</span>
      </div>
    </div>
  </div>

  <!-- Storage Sub-Navigation -->
  <div id="sub-storage" class="nav-sub">
    <div class="nav-sub-inner">
      <a href="pools.html" class="sub-link" data-page="pools">
        <span class="material-symbols-rounded">database</span>
        ZFS Pools
      </a>
      <a href="pools-advanced.html" class="sub-link" data-page="pools-advanced">
        <span class="material-symbols-rounded">photo_camera</span>
        Snapshots
      </a>
      <a href="shares.html" class="sub-link" data-page="shares">
        <span class="material-symbols-rounded">folder_shared</span>
        Shares
      </a>
      <a href="replication.html" class="sub-link" data-page="replication">
        <span class="material-symbols-rounded">sync</span>
        Replication
      </a>
      <a href="files.html" class="sub-link" data-page="files">
        <span class="material-symbols-rounded">folder_open</span>
        File Explorer
      </a>
      <a href="quotas.html" class="sub-link" data-page="quotas">
        <span class="material-symbols-rounded">pie_chart</span>
        Quotas
      </a>
      <a href="snapshot-scheduler.html" class="sub-link" data-page="snapshot-scheduler">
        <span class="material-symbols-rounded">schedule</span>
        Snapshot Scheduler
      </a>
      <a href="acl-manager.html" class="sub-link" data-page="acl-manager">
        <span class="material-symbols-rounded">admin_panel_settings</span>
        ACL Manager
      </a>
      <a href="zfs-encryption.html" class="sub-link" data-page="zfs-encryption">
        <span class="material-symbols-rounded">enhanced_encryption</span>
        Encryption
      </a>
      <a href="files-enhanced.html" class="sub-link" data-page="files-enhanced">
        <span class="material-symbols-rounded">upload_file</span>
        File Upload
      </a>
      <a href="cloud-sync.html" class="sub-link" data-page="cloud-sync">
        <span class="material-symbols-rounded">cloud_sync</span>
        Cloud Sync
      </a>
    </div>
  </div>

  <!-- Compute Sub-Navigation -->
  <div id="sub-compute" class="nav-sub">
    <div class="nav-sub-inner">
      <a href="docker.html" class="sub-link" data-page="docker">
        <span class="material-symbols-rounded">dns</span>
        Docker Containers
      </a>
      <a href="git-sync.html" class="sub-link" data-page="git-sync">
        <span class="material-symbols-rounded">sync</span>
        Git Sync
      </a>
      <a href="modules.html" class="sub-link" data-page="modules">
        <span class="material-symbols-rounded">extension</span>
        App Modules
      </a>
    </div>
  </div>

  <!-- Network Sub-Navigation -->
  <div id="sub-network" class="nav-sub">
    <div class="nav-sub-inner">
      <a href="network.html" class="sub-link" data-page="network">
        <span class="material-symbols-rounded">lan</span>
        Network Settings
      </a>
      <a href="network-interfaces.html" class="sub-link" data-page="network-interfaces">
        <span class="material-symbols-rounded">settings_ethernet</span>
        Interfaces
      </a>
      <a href="network-dns.html" class="sub-link" data-page="network-dns">
        <span class="material-symbols-rounded">dns</span>
        DNS
      </a>
      <a href="network-routing.html" class="sub-link" data-page="network-routing">
        <span class="material-symbols-rounded">route</span>
        Routing
      </a>
    </div>
  </div>

  <!-- Identity Sub-Navigation -->
  <div id="sub-identity" class="nav-sub">
    <div class="nav-sub-inner">
      <a href="users.html" class="sub-link" data-page="users">
        <span class="material-symbols-rounded">person</span>
        Users
      </a>
      <a href="groups.html" class="sub-link" data-page="groups">
        <span class="material-symbols-rounded">group</span>
        Groups
      </a>
      <a href="directory-service.html" class="sub-link" data-page="directory-service">
        <span class="material-symbols-rounded">domain</span>
        Directory Service
      </a>
      <a href="rbac-management.html" class="sub-link" data-page="rbac-management">
        <span class="material-symbols-rounded">admin_panel_settings</span>
        Roles & Permissions
      </a>
    </div>
  </div>

  <!-- Security Sub-Navigation -->
  <div id="sub-security" class="nav-sub">
    <div class="nav-sub-inner">
      <a href="security.html" class="sub-link" data-page="security">
        <span class="material-symbols-rounded">shield</span>
        Security Settings
      </a>
      <a href="audit.html" class="sub-link" data-page="audit">
        <span class="material-symbols-rounded">fact_check</span>
        Audit Logs
      </a>
      <a href="firewall.html" class="sub-link" data-page="firewall">
        <span class="material-symbols-rounded">local_fire_department</span>
        Firewall
      </a>
      <a href="certificates.html" class="sub-link" data-page="certificates">
        <span class="material-symbols-rounded">verified_user</span>
        Certificates
      </a>
    </div>
  </div>

  <!-- System Sub-Navigation -->
  <div id="sub-system" class="nav-sub">
    <div class="nav-sub-inner">
      <a href="settings.html" class="sub-link" data-page="settings">
        <span class="material-symbols-rounded">tune</span>
        General Settings
      </a>
      <a href="logs.html" class="sub-link" data-page="logs">
        <span class="material-symbols-rounded">description</span>
        System Logs
      </a>
      <a href="ups.html" class="sub-link" data-page="ups">
        <span class="material-symbols-rounded">battery_charging_full</span>
        UPS Management
      </a>
      <a href="reporting.html" class="sub-link" data-page="reporting">
        <span class="material-symbols-rounded">monitoring</span>
        Reporting
      </a>
      <a href="power-management.html" class="sub-link" data-page="power-management">
        <span class="material-symbols-rounded">power_settings_new</span>
        Power Management
      </a>
      <a href="system-settings.html" class="sub-link" data-page="system-settings">
        <span class="material-symbols-rounded">settings_suggest</span>
        System Settings
      </a>
      <a href="system-monitoring.html" class="sub-link" data-page="system-monitoring">
        <span class="material-symbols-rounded">monitor_heart</span>
        Monitoring
      </a>
      <a href="hardware.html" class="sub-link" data-page="hardware">
        <span class="material-symbols-rounded">developer_board</span>
        Hardware
      </a>
      <a href="ipmi.html" class="sub-link" data-page="ipmi">
        <span class="material-symbols-rounded">memory</span>
        IPMI
      </a>
      <a href="removable-media-ui.html" class="sub-link" data-page="removable-media-ui">
        <span class="material-symbols-rounded">usb</span>
        Removable Media
      </a>
    </div>
  </div>
</nav>

<script src="/assets/js/nav-shared.js"></script>

<main class="main">
<div class="page-header">
<h1 class="page-title">ZFS Storage</h1>
<p class="page-subtitle">Pools ‚Ä¢ Advanced ‚Ä¢ Quotas ‚Ä¢ Encryption</p>
</div>
<div class="consolidation-tabs">
  <button class="consolidation-tab active" data-tab="pools" onclick="switchConsolidatedTab('pools')">Pools</button>
  <button class="consolidation-tab" data-tab="advanced" onclick="switchConsolidatedTab('advanced')">Advanced</button>
  <button class="consolidation-tab" data-tab="quotas" onclick="switchConsolidatedTab('quotas')">Quotas</button>
  <button class="consolidation-tab" data-tab="encryption" onclick="switchConsolidatedTab('encryption')">Encryption</button>
</div>

<div id="tab-pools" class="consolidation-content active">


<div class="page-header">
<h1 class="page-title">ZFS Storage</h1>
<p class="page-subtitle">Enterprise redundancy ‚Ä¢ Snapshots ‚Ä¢ Compression ‚Ä¢ Data integrity</p>
</div>
<div id="poolList" style="padding:40px;text-align:center;color:rgba(255,255,255,0.5);">
  Loading ZFS pools...
</div>
<button class="fab" onclick="showPoolMenu()"><span class="material-symbols-rounded" style="font-size:28px;">add</span></button>

<!-- Quick Menu for Pool Actions -->
<div id="poolQuickMenu" class="context-menu" style="display:none;">
  <div class="context-menu-item" onclick="createPool(); document.getElementById('poolQuickMenu').style.display='none';">
    <span class="material-symbols-rounded">add_circle</span>
    <span>Create New Pool</span>
  </div>
  <div class="context-menu-item" onclick="importPool(); document.getElementById('poolQuickMenu').style.display='none';">
    <span class="material-symbols-rounded">drive_folder_upload</span>
    <span>Import Existing Pool</span>
  </div>
</div>

<script>
function showPoolMenu() {
  const menu = document.getElementById('poolQuickMenu');
  const fab = document.querySelector('.fab');
  const rect = fab.getBoundingClientRect();
  menu.style.display = 'block';
  menu.style.bottom = '100px';
  menu.style.right = '32px';
  menu.style.left = 'auto';
  menu.style.top = 'auto';
}

// Close menu when clicking outside
document.addEventListener('click', (e) => {
  const menu = document.getElementById('poolQuickMenu');
  const fab = document.querySelector('.fab');
  if (!menu.contains(e.target) && e.target !== fab && !fab.contains(e.target)) {
    menu.style.display = 'none';
  }
});
</script>

<script src="/assets/js/m3-ripple.js"></script>
<script src="/assets/js/ui-components.js"></script>
</div>
<div id="tab-advanced" class="consolidation-content">


	<div id="network-interfaces-container">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Advanced ZFS Management</h1>
                    <p class="page-subtitle">Encryption ‚Ä¢ Caching ‚Ä¢ Dedup ‚Ä¢ Automation</p>
                </div>
                <a href="pools.html" class="btn">‚Üê Back to Pools</a>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('encryption')">Encryption</button>
                <button class="tab" onclick="switchTab('cache')">Cache & Log</button>
                <button class="tab" onclick="switchTab('compression')">Compression</button>
                <button class="tab" onclick="switchTab('snapshots')">Snapshots</button>
            </div>

            <!-- Encryption Tab -->
            <div id="encryption-tab" class="tab-content active">
                <div class="card">
                    <h2>Create Encrypted Dataset</h2>
                    <div class="form-group">
                        <label>Dataset Name</label>
                        <input type="text" id="enc-dataset" placeholder="pool/encrypted-data" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Encryption Algorithm</label>
                        <select id="enc-algorithm" class="form-input">
                            <option value="aes-256-gcm">AES-256-GCM (Recommended)</option>
                            <option value="aes-128-gcm">AES-128-GCM</option>
                            <option value="aes-256-ccm">AES-256-CCM</option>
                            <option value="aes-128-ccm">AES-128-CCM</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Passphrase (16+ characters)</label>
                        <input type="password" id="enc-passphrase" class="form-input">
                    </div>
                    <div class="warning-box">
                        ‚ö†Ô∏è <strong>WARNING:</strong> Store your passphrase securely! Lost passphrase = permanent data loss.
                    </div>
                    <button class="btn btn-primary" onclick="createEncryptedDataset()">Create Encrypted Dataset</button>
                </div>
            </div>

            <!-- Cache & Log Tab -->
            <div id="cache-tab" class="tab-content">
                <div class="card">
                    <h2>L2ARC (Read Cache)</h2>
                    <p>Add SSD/NVMe as read cache to accelerate frequently accessed data</p>
                    <div class="form-group">
                        <label>Pool</label>
                        <select id="l2arc-pool" class="form-input"></select>
                    </div>
                    <div class="form-group">
                        <label>Cache Device</label>
                        <select id="l2arc-device" class="form-input"></select>
                    </div>
                    <button class="btn btn-primary" onclick="addL2ARC()">Add L2ARC</button>
                </div>

                <div class="card">
                    <h2>ZIL (Write Log)</h2>
                    <p>Separate log device for synchronous writes</p>
                    <div class="form-group">
                        <label>Pool</label>
                        <select id="zil-pool" class="form-input"></select>
                    </div>
                    <div class="form-group">
                        <label>Log Device</label>
                        <select id="zil-device" class="form-input"></select>
                    </div>
                    <div class="form-group">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;"><input type="checkbox" id="zil-mirror" style="accent-color:var(--md-sys-color-primary);width:18px;height:18px;"> Mirror ZIL (recommended)</label>
                    </div>
                    <button class="btn btn-primary" onclick="addZIL()">Add ZIL</button>
                </div>
            </div>

            <!-- Compression Tab -->
            <div id="compression-tab" class="tab-content">
                <div class="card">
                    <h2>Compression Settings</h2>
                    <div class="form-group">
                        <label>Dataset</label>
                        <select id="comp-dataset" class="form-input"></select>
                    </div>
                    <div class="form-group">
                        <label>Compression Algorithm</label>
                        <select id="comp-algorithm" class="form-input">
                            <option value="lz4">LZ4 (Fast, Recommended)</option>
                            <option value="gzip">GZIP (Balanced)</option>
                            <option value="gzip-9">GZIP-9 (Max Compression)</option>
                            <option value="zstd">ZSTD (Modern)</option>
                            <option value="off">Off</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="setCompression()">Apply Compression</button>
                </div>

                <div class="card">
                    <h2>Deduplication</h2>
                    <div class="warning-box">
                        ‚ö†Ô∏è <strong>WARNING:</strong> Dedup requires ~5GB RAM per 1TB of data!
                    </div>
                    <div class="form-group">
                        <label>Dataset</label>
                        <select id="dedup-dataset" class="form-input"></select>
                    </div>
                    <div class="form-group">
                        <label>Deduplication</label>
                        <select id="dedup-setting" class="form-input">
                            <option value="off">Off (Recommended)</option>
                            <option value="on">On</option>
                            <option value="verify">On with Verification</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="setDedup()">Apply Deduplication</button>
                </div>
            </div>

            <!-- Snapshots Tab -->
            <div id="snapshots-tab" class="tab-content">
                <div class="card">
                    <h2>Automated Snapshot Schedules</h2>
                    <button class="btn btn-primary" onclick="createSnapshotSchedule()">+ Create Schedule</button>
                    <div id="snapshot-schedules" style="margin-top: 16px;"></div>
                </div>
            </div>
    </div>

    	    <script src="/assets/js/core.js"></script>
    <script>
    function switchTab(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector(`button[onclick="switchTab('"+JSON.stringify(tab)+"')"]`).classList.add('active');
        document.getElementById(`${tab}-tab`).classList.add('active');
    }

    async function createEncryptedDataset() {
        const dataset = document.getElementById('enc-dataset').value;
        const algorithm = document.getElementById('enc-algorithm').value;
        const passphrase = document.getElementById('enc-passphrase').value;

        if (!dataset || !passphrase) {
            showToast('Please fill all fields', 'error');
            return;
        }

        if (passphrase.length < 16) {
            showToast('Passphrase must be at least 16 characters', 'error');
            return;
        }

        try {
            showLoading('Creating encrypted dataset...');
            const response = await csrfFetch('/api/snapshots/schedules', {
                method: 'POST',
                body: JSON.stringify({
                    action: 'create_encrypted_dataset',
                    dataset,
                    encryption: algorithm,
                    key_format: 'passphrase',
                    passphrase
                })
            });

            const data = await response.json();
            if (data.success) {
                showToast('Encrypted dataset created successfully!', 'success');
                document.getElementById('enc-dataset').value = '';
                document.getElementById('enc-passphrase').value = '';
            } else {
                showToast(data.error || 'Failed to create dataset', 'error');
            }
        } catch (error) {
            showToast('Error creating dataset', 'error');
        } finally {
            hideLoading();
        }
    }

    async function addL2ARC() {
        const pool = document.getElementById('l2arc-pool').value;
        const device = document.getElementById('l2arc-device').value;

        if (!pool || !device) {
            showToast('Please select pool and device', 'error');
            return;
        }

        try {
            showLoading('Adding L2ARC...');
            const response = await csrfFetch('/api/snapshots/schedules', {
                method: 'POST',
                body: JSON.stringify({ action: 'add_l2arc', pool, device })
            });

            const data = await response.json();
            if (data.success) {
                showToast('L2ARC added successfully!', 'success');
            } else {
                showToast(data.error, 'error');
            }
        } catch (error) {
            showToast('Error adding L2ARC', 'error');
        } finally {
            hideLoading();
        }
    }

    async function addZIL() {
        const pool = document.getElementById('zil-pool').value;
        const device = document.getElementById('zil-device').value;
        const mirror = document.getElementById('zil-mirror').checked;

        if (!pool || !device) {
            showToast('Please select pool and device', 'error');
            return;
        }

        try {
            showLoading('Adding ZIL...');
            const response = await csrfFetch('/api/snapshots/schedules', {
                method: 'POST',
                body: JSON.stringify({ action: 'add_zil', pool, device, mirror })
            });

            const data = await response.json();
            if (data.success) {
                showToast('ZIL added successfully!', 'success');
            } else {
                showToast(data.error, 'error');
            }
        } catch (error) {
            showToast('Error adding ZIL', 'error');
        } finally {
            hideLoading();
        }
    }

    async function setCompression() {
        const dataset = document.getElementById('comp-dataset').value;
        const compression = document.getElementById('comp-algorithm').value;

        try {
            showLoading('Setting compression...');
            const response = await csrfFetch('/api/snapshots/schedules', {
                method: 'POST',
                body: JSON.stringify({ action: 'set_compression', dataset, compression })
            });

            const data = await response.json();
            if (data.success) {
                showToast('Compression updated!', 'success');
            } else {
                showToast(data.error, 'error');
            }
        } catch (error) {
            showToast('Error setting compression', 'error');
        } finally {
            hideLoading();
        }
    }

    async function setDedup() {
        const dataset = document.getElementById('dedup-dataset').value;
        const dedup = document.getElementById('dedup-setting').value;

        if (dedup !== 'off') {
            if (!await ui.confirmWithCheckbox(
                'Enable Deduplication', 
                'Deduplication requires significant RAM (~5GB per 1TB of data). This can impact system performance if insufficient RAM is available.',
                'I understand the RAM requirements and want to proceed'
            )) {
                return;
            }
        }

        try {
            showLoading('Setting deduplication...');
            const response = await csrfFetch('/api/snapshots/schedules', {
                method: 'POST',
                body: JSON.stringify({ action: 'set_dedup', dataset, dedup })
            });

            const data = await response.json();
            if (data.success) {
                showToast('Deduplication updated!', 'success');
            } else {
                showToast(data.error, 'error');
            }
        } catch (error) {
            showToast('Error setting dedup', 'error');
        } finally {
            hideLoading();
        }
    }

    async function createSnapshotSchedule() {
        const dataset = await ui.prompt('Create Snapshot Schedule', 'Enter dataset name:', '', 'pool/dataset');
        if (!dataset) return;

        const schedule = await ui.prompt('Snapshot Schedule', 'Enter schedule (hourly/daily/weekly/monthly):', '', 'daily');
        if (!schedule) return;

        try {
            showLoading('Creating schedule...');
            const response = await csrfFetch('/api/snapshots/schedules', {
                method: 'POST',
                body: JSON.stringify({
                    action: 'create_snapshot_schedule',
                    dataset,
                    schedule,
                    retention_count: 7,
                    retention_days: 30
                })
            });

            const data = await response.json();
            if (data.success) {
                showToast('Schedule created!', 'success');
                loadSnapshotSchedules();
            } else {
                showToast(data.error, 'error');
            }
        } catch (error) {
            showToast('Error creating schedule', 'error');
        } finally {
            hideLoading();
        }
    }

    async function loadSnapshotSchedules() {
        try {
            const response = await csrfFetch('/api/snapshots/schedules');
            const data = await response.json();
            
            if (data.success) {
                const container = document.getElementById('snapshot-schedules');
                container.innerHTML = data.schedules.map(s => `
                    <div class="schedule-item">
                        <strong>${s.dataset}</strong> - ${s.schedule}
                        <button onclick="deleteSchedule(${s.id})" class="btn btn-sm">Delete</button>
                    </div>
                `).join('');
            }
        } catch (error) {
            console.error('Failed to load schedules', error);
        }
    }

    async function deleteSchedule(id) {
        if (!await ui.confirm('Delete Schedule', 'Delete this snapshot schedule? Existing snapshots will be kept.')) return;
        
        try {
            const response = await csrfFetch('/api/snapshots/schedules', {
                method: 'POST',
                body: JSON.stringify({ action: 'delete_snapshot_schedule', schedule_id: id })
            });

            const data = await response.json();
            if (data.success) {
                showToast('Schedule deleted', 'success');
                loadSnapshotSchedules();
            }
        } catch (error) {
            showToast('Error deleting schedule', 'error');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadSnapshotSchedules();
    });
    </script>

    <style>
    .tabs { display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 1px solid #e0e0e0; }
    .tab { padding: 12px 24px; background: none; border: none; cursor: pointer; border-bottom: 2px solid transparent; }
    .tab.active { border-bottom-color: var(--primary); color: var(--primary); font-weight: 600; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .warning-box { background: #fff3cd; border: 1px solid #ffc107; padding: 12px; border-radius: 4px; margin: 16px 0; }
    .schedule-item { padding: 12px; background: #f5f5f5; margin-top: 8px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
    </style>
  <script src="/assets/js/realtime-client.js"></script>

<!-- v2.1.0: Scrub, VDEV, Disk Replace, Capacity Guardian -->
</div>
<div id="tab-quotas" class="consolidation-content">



<div class="nav-glass"><div class="nav-inner"><div class="logo" onclick="window.location.href='index.html'">D-PlaneOS</div><div class="nav-links"><a href="index.html" class="nav-link">Dashboard</a><a href="files.html" class="nav-link">Files</a><a href="pools.html" class="nav-link">Storage</a><a href="quotas.html" class="nav-link active">Quotas</a><a href="users.html" class="nav-link">Users</a><a href="settings.html" class="nav-link">Settings</a></div><div class="nav-user"><span class="nav-username" id="currentUser">Loading...</span><button class="btn btn-sm btn-logout" onclick="handleLogout()"><span class="material-symbols-rounded" style="font-size:18px;">logout</span>Logout</button></div></div></div>
<div class="main"><div class="page-header"><div><h1 class="page-title">Quota Management</h1><p class="page-meta">Manage dataset quotas and usage limits</p></div><button class="btn btn-primary" onclick="showSetQuotaModal()"><span class="material-symbols-rounded">data_usage</span>Set Quota</button></div><div id="quotaList"></div></div>
</div>
<div id="tab-encryption" class="consolidation-content">
<h1>ZFS Encryption Management</h1>

<div class="toolbar">
  <button class="btn" onclick="loadDatasets()">üîÑ Refresh</button>
  <button class="btn" onclick="createEncryptedDataset()">‚ûï Create Encrypted Dataset</button>
</div>

<div id="status" class="loading">Loading...</div>
<div id="datasets" class="dataset-list"></div>


</div>

</main>
<button class="fab" onclick="showPoolMenu()"><span class="material-symbols-rounded" style="font-size:28px;">add</span></button>

<!-- Quick Menu for Pool Actions -->
<div id="poolQuickMenu" class="context-menu" style="display:none;">
  <div class="context-menu-item" onclick="createPool(); document.getElementById('poolQuickMenu').style.display='none';">
    <span class="material-symbols-rounded">add_circle</span>
    <span>Create New Pool</span>
  </div>
  <div class="context-menu-item" onclick="importPool(); document.getElementById('poolQuickMenu').style.display='none';">
    <span class="material-symbols-rounded">drive_folder_upload</span>
    <span>Import Existing Pool</span>
  </div>
</div>

<script>
function showPoolMenu() {
  const menu = document.getElementById('poolQuickMenu');
  const fab = document.querySelector('.fab');
  const rect = fab.getBoundingClientRect();
  menu.style.display = 'block';
  menu.style.bottom = '100px';
  menu.style.right = '32px';
  menu.style.left = 'auto';
  menu.style.top = 'auto';
}

// Close menu when clicking outside
document.addEventListener('click', (e) => {
  const menu = document.getElementById('poolQuickMenu');
  const fab = document.querySelector('.fab');
  if (!menu.contains(e.target) && e.target !== fab && !fab.contains(e.target)) {
    menu.style.display = 'none';
  }
});
</script>

<script src="/assets/js/m3-ripple.js"></script>
<script src="/assets/js/ui-components.js"></script>
<script>
function switchConsolidatedTab(t){document.querySelectorAll('.consolidation-content').forEach(function(c){c.classList.remove('active')});document.querySelectorAll('.consolidation-tab').forEach(function(b){b.classList.remove('active')});var el=document.getElementById('tab-'+t);var btn=document.querySelector('[data-tab="'+t+'"]');if(el)el.classList.add('active');if(btn)btn.classList.add('active');if(typeof window['init_'+t]==='function')window['init_'+t]();}window.addEventListener('load',function(){var h=window.location.hash.replace('#','');if(h&&document.getElementById('tab-'+h))switchConsolidatedTab(h);});
// Initialize UI components
const ui = new DPlaneUI();

async function createPool() {
  const result = await ui.form('Create ZFS Pool', [
    { name: 'name', label: 'Pool Name', type: 'text', required: true },
    { name: 'type', label: 'Pool Type', type: 'select', options: [
      { value: 'stripe', label: 'Stripe (No redundancy)' },
      { value: 'mirror', label: 'Mirror (2-way redundancy)' },
      { value: 'raidz1', label: 'RAID-Z1 (Single parity)' },
      { value: 'raidz2', label: 'RAID-Z2 (Double parity)' }
    ], required: true },
    { name: 'disks', label: 'Disks (comma-separated)', type: 'text', required: true }
  ], 'Create Pool');
  
  if (result) {
    ui.showLoading('Creating pool...');
    
    try {
      const response = await csrfFetch('/api/zfs/command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'create', ...result })
      });
      
      const data = await response.json();
      ui.hideLoading();
      
      if (data.success) {
        ui.toast('Pool created successfully', 'success');
        setTimeout(() => location.reload(), 1000);
      } else {
        ui.toast(data.error || 'Failed to create pool', 'error');
      }
    } catch (error) {
      ui.hideLoading();
      ui.toast('Network error: ' + error.message, 'error');
    }
  }
}

async function managePool(name) {
  const action = await ui.modal(`Manage: ${name}`, `
    <div style="display:flex;flex-direction:column;gap:12px;">
      <button class="btn btn-primary" onclick="createDataset('"+JSON.stringify(name)+"')">+ Create Dataset</button>
      <button class="btn" onclick="listDatasets('"+JSON.stringify(name)+"')">View Datasets</button>
      <button class="btn" onclick="exportPool('"+JSON.stringify(name)+"')">Export Pool</button>
      <button class="btn" onclick="viewProperties('"+JSON.stringify(name)+"')">View Properties</button>
      <button class="btn" style="background:rgba(239,68,68,0.2);color:#ef4444;" onclick="destroyPool('"+JSON.stringify(name)+"')">Destroy Pool</button>
    </div>
  `, [{ text: 'Close', primary: true }]);
}

async function createDataset(poolName) {
  const result = await ui.form(`Create Dataset in ${poolName}`, [
    { name: 'name', label: 'Dataset Name', type: 'text', required: true, placeholder: 'e.g., photos' },
    { name: 'mountpoint', label: 'Mount Point', type: 'text', placeholder: `/${poolName}/dataset-name` },
    { name: 'quota', label: 'Quota (optional)', type: 'text', placeholder: '100G, 1T, etc.' },
    { name: 'compression', label: 'Compression', type: 'select', options: [
      { value: 'lz4', label: 'LZ4 (recommended)' },
      { value: 'zstd', label: 'ZSTD (better compression)' },
      { value: 'gzip', label: 'GZIP' },
      { value: 'off', label: 'Off' }
    ], value: 'lz4' },
    { name: 'encryption', label: 'Enable Encryption', type: 'checkbox' }
  ], 'Create');
  
  if (result) {
    try {
      ui.showLoading('Creating dataset...');
      
      const response = await csrfFetch('/api/zfs/datasets', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          pool: poolName,
          name: result.name,
          mountpoint: result.mountpoint || `/${poolName}/${result.name}`,
          quota: result.quota || '',
          compression: result.compression,
          encryption: result.encryption ? 1 : 0
        })
      });
      
      const data = await response.json();
      ui.hideLoading();
      
      if (data.success) {
        ui.toast('Dataset created successfully!', 'success');
        setTimeout(() => location.reload(), 1000);
      } else {
        ui.toast(data.error || 'Failed to create dataset', 'error');
      }
    } catch (error) {
      ui.hideLoading();
      ui.toast('Error creating dataset: ' + error.message, 'error');
    }
  }
}

async function listDatasets(poolName) {
  try {
    ui.showLoading('Loading datasets...');
    
    const response = await csrfFetch(`/api/zfs/datasets?pool=${poolName}`);
    const data = await response.json();
    ui.hideLoading();
    
    if (data.success) {
      const datasets = data.datasets || [];
      if (datasets.length === 0) {
        ui.modal(`Datasets in ${poolName}`, '<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.5);">No datasets yet. Create one above!</div>', [{ text: 'OK', primary: true }]);
      } else {
        const html = datasets.map(d => `
          <div style="padding:16px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:12px;">
            <div style="font-weight:600;margin-bottom:4px;">${d.pool}/${d.name}</div>
            <div style="font-size:14px;color:rgba(255,255,255,0.5);">
              Mountpoint: ${d.mountpoint || 'default'} ‚Ä¢ 
              Compression: ${d.compression || 'lz4'} ‚Ä¢
              ${d.quota ? `Quota: ${d.quota}` : 'No quota'}
            </div>
          </div>
        `).join('');
        ui.modal(`Datasets in ${poolName}`, html, [{ text: 'Close', primary: true }]);
      }
    } else {
      ui.toast(data.error || 'Failed to load datasets', 'error');
    }
  } catch (error) {
    ui.hideLoading();
    ui.toast('Error loading datasets: ' + error.message, 'error');
  }
}

async function exportPool(name) {
  if (await ui.confirm('Export Pool?', `Export ${name}? The pool will be unmounted and can be imported later.`)) {
    ui.showLoading(`Exporting ${name}...`);
    
    try {
      const response = await csrfFetch('/api/zfs/command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'export', pool: name })
      });
      
      const result = await response.json();
      ui.hideLoading();
      
      if (result.success) {
        ui.toast(`${name} exported`, 'success');
        setTimeout(() => location.reload(), 1000);
      } else {
        ui.toast(result.error || 'Export failed', 'error');
      }
    } catch (error) {
      ui.hideLoading();
      ui.toast('Network error: ' + error.message, 'error');
    }
  }
}

async function viewProperties(name) {
  ui.showLoading(`Loading ${name} properties...`);
  
  try {
    const response = await csrfFetch(`/api/zfs/pools?pool=${name}`);
    const result = await response.json();
    ui.hideLoading();
    
    if (result.success) {
      const pools = result.pools || result.data || [];
      const pool = pools.find(p => (p.name || p.Name) === name) || {};
      await ui.modal(`Properties: ${name}`, `<pre style="font-family:monospace;font-size:13px;line-height:1.6;">${JSON.stringify(pool, null, 2)}</pre>`, [
        { text: 'Close', primary: true }
      ]);
    } else {
      ui.toast(result.error || 'Failed to load properties', 'error');
    }
  } catch (error) {
    ui.hideLoading();
    ui.toast('Network error: ' + error.message, 'error');
  }
}

async function destroyPool(name) {
  if (await ui.confirm('Destroy Pool?', `WARNING: This will permanently destroy ${name} and ALL data in it. This cannot be undone!`, 'Destroy', 'Cancel')) {
    ui.showLoading(`Destroying ${name}...`);
    
    try {
      const response = await csrfFetch('/api/zfs/command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'destroy', pool: name })
      });
      
      const result = await response.json();
      ui.hideLoading();
      
      if (result.success) {
        ui.toast(`${name} destroyed`, 'success');
        setTimeout(() => location.reload(), 1000);
      } else {
        ui.toast(result.error || 'Destroy failed', 'error');
      }
    } catch (error) {
      ui.hideLoading();
      ui.toast('Network error: ' + error.message, 'error');
    }
  }
}

async function importPool() {
  ui.showLoading('Scanning for importable pools...');
  
  try {
    // Step 1: Scan for importable pools
    const scanRes = await csrfFetch('/api/zfs/pools');
    const scan = await scanRes.json();
    ui.hideLoading();
    
    if (!scan.success || !scan.pools || scan.pools.length === 0) {
      ui.toast('No importable pools found', 'info');
      return;
    }
    
    // Step 2: Show list of pools
    const poolNames = scan.pools.map(p => p.name);
    const selectedPool = await ui.form('Import Existing Pool', [
      {
        name: 'pool',
        label: 'Select Pool to Import',
        type: 'select',
        required: true,
        options: poolNames.map(name => {
          const pool = scan.pools.find(p => p.name === name);
          return {
            value: name,
            label: `${name} (${pool.state})`
          };
        })
      },
      {
        name: 'force',
        label: 'Force import (if pool was not cleanly exported)',
        type: 'checkbox'
      }
    ], 'Import');
    
    if (!selectedPool) return;
    
    // Step 3: Import selected pool
    ui.showLoading(`Importing pool ${selectedPool.pool}...`);
    
    const importRes = await csrfFetch('/api/zfs/command', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'import',
        name: selectedPool.pool,
        force: selectedPool.force || false
      })
    });
    
    const result = await importRes.json();
    ui.hideLoading();
    
    if (result.success) {
      ui.toast(`‚úì Pool ${selectedPool.pool} imported successfully`, 'success', 5000);
      setTimeout(() => location.reload(), 2000);
    } else {
      ui.toast(result.error || 'Import failed', 'error');
    }
    
  } catch (error) {
    ui.hideLoading();
    ui.toast('Failed to import pool: ' + error.message, 'error');
  }
}


async function scrubPool(name) {
  if (await ui.confirm('Scrub Pool?', `Scrub ${name}? This will verify data integrity across all disks.`)) {
    ui.showLoading('Starting scrub...');
    
    try {
      const response = await csrfFetch('/api/zfs/command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'scrub', pool: name })
      });
      
      const result = await response.json();
      ui.hideLoading();
      
      if (result.success) {
        ui.toast('Scrub started', 'success');
      } else {
        ui.toast(result.error || 'Scrub failed to start', 'error');
      }
    } catch (error) {
      ui.hideLoading();
      ui.toast('Network error: ' + error.message, 'error');
    }
  }
}

// ===== DYNAMIC POOL LOADING =====
async function loadPools() {
  const poolList = document.getElementById('poolList');
  
  // Show skeleton
  poolList.innerHTML = '';
  for (let i = 0; i < 2; i++) {
    const skeleton = document.createElement('div');
    skeleton.className = 'skeleton skeleton-card';
    skeleton.style.marginBottom = '16px';
    skeleton.style.height = '120px';
    poolList.appendChild(skeleton);
  }
  
  try {
    const response = await csrfFetch('/api/zfs/pools', { showLoading: false });
    const data = await response.json();
    
    if (data.success && data.pools) {
      updatePoolList(data.pools);
    } else {
      poolList.innerHTML = '';
      const emptyState = EnhancedUI.emptyState({
        icon: '<svg width="80" height="80" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12z"/></svg>',
        title: 'No ZFS pools found',
        message: 'Create a pool to start storing data',
        action: { label: 'Create Pool', onclick: 'createPool()' }
      });
      poolList.appendChild(emptyState);
    }
  } catch (error) {
    EnhancedUI.toast('Failed to load pools', 'error');
  }
}

function updatePoolList(pools) {
  const poolList = document.getElementById('poolList');
  
  if (!pools || pools.length === 0) {
    poolList.innerHTML = '';
    const emptyState = EnhancedUI.emptyState({
      icon: '<svg width="80" height="80" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12z"/></svg>',
      title: 'No pools',
      message: 'Create your first ZFS pool',
      action: { label: 'Create Pool', onclick: 'createPool()' }
    });
    poolList.appendChild(emptyState);
    return;
  }
  
  poolList.innerHTML = '';
  
	  pools.forEach(pool => {
	    const badgeClass = pool.health === 'ONLINE' ? 'badge-success' : 'badge-error';
	    const healthIcon = pool.health === 'ONLINE' ? 'check_circle' : 'error';
	    const usedPercent = pool.capacity ? parseInt(pool.capacity.replace('%', '')) : 0;

	    const card = document.createElement('div');
	    card.className = 'pool-card';
	    card.dataset.contextMenu = 'pool';
	    card.dataset.contextData = JSON.stringify({name: pool.name || '', type: pool.type || '', health: pool.health || ''});

	    const header = document.createElement('div');
	    header.className = 'pool-header';

	    const icon = document.createElement('span');
	    icon.className = 'material-symbols-rounded pool-icon';
	    icon.textContent = 'storage';

	    const info = document.createElement('div');
	    info.className = 'pool-info';
	    const name = document.createElement('div');
	    name.className = 'pool-name';
	    name.textContent = pool.name || 'Unknown';
	    const details = document.createElement('div');
	    details.className = 'pool-details';
	    details.textContent = `${pool.type || 'Unknown'} ‚Ä¢ ${pool.used || 'N/A'} / ${pool.size || 'N/A'} used (${pool.capacity || '0%'})`;
	    info.appendChild(name);
	    info.appendChild(details);

	    const badge = document.createElement('div');
	    badge.className = `badge ${badgeClass}`;
	    const badgeIcon = document.createElement('span');
	    badgeIcon.className = 'material-symbols-rounded';
	    badgeIcon.style.fontSize = '16px';
	    badgeIcon.textContent = healthIcon;
	    badge.appendChild(badgeIcon);
	    badge.appendChild(document.createTextNode(` ${pool.health || 'Unknown'}`));

	    const manageBtn = document.createElement('button');
	    manageBtn.className = 'icon-btn';
	    manageBtn.addEventListener('click', () => managePool(pool.name));
	    manageBtn.innerHTML = '<span class="material-symbols-rounded">settings</span>';

	    const scrubBtn = document.createElement('button');
	    scrubBtn.className = 'icon-btn';
	    scrubBtn.addEventListener('click', () => scrubPool(pool.name));
	    scrubBtn.innerHTML = '<span class="material-symbols-rounded">cleaning_services</span>';

	    header.append(icon, info, badge, manageBtn, scrubBtn);

	    const capacityBar = document.createElement('div');
	    capacityBar.className = 'capacity-bar';
	    const capacityFill = document.createElement('div');
	    capacityFill.className = 'capacity-fill';
	    capacityFill.style.width = `${Math.max(0, Math.min(100, usedPercent || 0))}%`;
	    capacityBar.appendChild(capacityFill);

	    const meta = document.createElement('div');
	    meta.style.display = 'flex';
	    meta.style.gap = '12px';
	    const compression = document.createElement('span');
	    compression.style.cssText = 'padding:6px 12px;background:rgba(255,255,255,0.05);border-radius:8px;font-size:13px;';
	    compression.textContent = `Compression: ${pool.compression || 'Unknown'}`;
	    const dedup = document.createElement('span');
	    dedup.style.cssText = 'padding:6px 12px;background:rgba(255,255,255,0.05);border-radius:8px;font-size:13px;';
	    dedup.textContent = `Dedup: ${pool.dedup || 'Off'}`;
	    meta.append(compression, dedup);

	    card.append(header, capacityBar, meta);
	    poolList.appendChild(card);
	  });
}

// Load pools on page load
window.addEventListener('DOMContentLoaded', loadPools);

// Auto-refresh pools every 10 seconds
setInterval(loadPools, 10000);
var __advanced_init=false;function init_advanced(){if(__advanced_init)return;__advanced_init=true;document.addEventListener('DOMContentLoaded', () => {
  const main = document.querySelector('.main');
  if (!main) return;

  // Inject new sections after existing content
  const newSections = document.createElement('div');
  newSections.innerHTML = `
    <div style="margin-top:48px;">
      <h2 class="page-title" style="font-size:28px;">Pool Operations</h2>
      <p class="page-subtitle" style="margin-bottom:32px;">Scrub ‚Ä¢ Expand ‚Ä¢ Replace ‚Ä¢ Capacity</p>

      <!-- Scrub Section -->
      <div class="card" style="padding:32px;margin-bottom:24px;border-left:4px solid var(--md-sys-color-success);">
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;">
          <span class="material-symbols-rounded" style="font-size:32px;color:var(--md-sys-color-success);">verified_user</span>
          <div style="flex:1;">
            <div style="font-size:20px;font-weight:800;">ZFS Scrub</div>
            <div style="font-size:14px;color:rgba(255,255,255,0.5);">Data integrity verification</div>
          </div>
          <div style="display:flex;gap:8px;">
            <select id="scrub-pool" class="btn" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:var(--md-sys-shape-corner-medium);padding:10px 16px;color:#fff;appearance:none;">
              <option value="">Select pool...</option>
            </select>
            <button class="btn btn-primary" onclick="startScrub()">
              <span class="material-symbols-rounded" style="font-size:18px;">play_arrow</span> Start
            </button>
            <button class="btn" onclick="stopScrub()" style="background:rgba(255,255,255,0.05);">
              <span class="material-symbols-rounded" style="font-size:18px;">stop</span> Stop
            </button>
          </div>
        </div>
        <div id="scrub-status" style="font-family:monospace;font-size:13px;color:rgba(255,255,255,0.6);padding:12px;background:rgba(0,0,0,0.3);border-radius:var(--md-sys-shape-corner-small);">No scrub running</div>
      </div>

      <!-- VDEV Add Section -->
      <div class="card" style="padding:32px;margin-bottom:24px;border-left:4px solid #f59e0b;">
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;">
          <span class="material-symbols-rounded" style="font-size:32px;color:#f59e0b;">add_circle</span>
          <div>
            <div style="font-size:20px;font-weight:800;">Expand Pool</div>
            <div style="font-size:14px;color:rgba(255,255,255,0.5);">Add VDEV, L2ARC cache, or SLOG device</div>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:12px;align-items:end;">
          <div>
            <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px;">Pool</label>
            <select id="vdev-pool" class="btn" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:var(--md-sys-shape-corner-medium);padding:10px 16px;color:#fff;appearance:none;">
              <option value="">Select...</option>
            </select>
          </div>
          <div>
            <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px;">VDEV Type</label>
            <select id="vdev-type" class="btn" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:var(--md-sys-shape-corner-medium);padding:10px 16px;color:#fff;appearance:none;">
              <option value="mirror">Mirror</option>
              <option value="raidz">RAIDZ</option>
              <option value="raidz2">RAIDZ2</option>
              <option value="cache">L2ARC (Cache)</option>
              <option value="log">SLOG (Log)</option>
              <option value="special">Special</option>
              <option value="">Stripe (no redundancy)</option>
            </select>
          </div>
          <div>
            <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px;">Disks (comma-separated)</label>
            <input id="vdev-disks" type="text" placeholder="sdc,sdd" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:var(--md-sys-shape-corner-medium);padding:10px 16px;color:#fff;font-family:monospace;">
          </div>
          <button class="btn btn-primary" onclick="addVdev()" style="white-space:nowrap;">
            <span class="material-symbols-rounded" style="font-size:18px;">add</span> Add VDEV
          </button>
        </div>
      </div>

      <!-- Disk Replace Section -->
      <div class="card" style="padding:32px;margin-bottom:24px;border-left:4px solid #ef4444;">
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;">
          <span class="material-symbols-rounded" style="font-size:32px;color:#ef4444;">swap_horiz</span>
          <div>
            <div style="font-size:20px;font-weight:800;">Replace Failed Disk</div>
            <div style="font-size:14px;color:rgba(255,255,255,0.5);">Swap and resilver</div>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:12px;align-items:end;">
          <div>
            <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px;">Pool</label>
            <select id="replace-pool" class="btn" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:var(--md-sys-shape-corner-medium);padding:10px 16px;color:#fff;appearance:none;">
              <option value="">Select...</option>
            </select>
          </div>
          <div>
            <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px;">Failed Disk</label>
            <input id="replace-old" type="text" placeholder="sda" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:var(--md-sys-shape-corner-medium);padding:10px 16px;color:#fff;font-family:monospace;">
          </div>
          <div>
            <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px;">New Disk</label>
            <input id="replace-new" type="text" placeholder="sde" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:var(--md-sys-shape-corner-medium);padding:10px 16px;color:#fff;font-family:monospace;">
          </div>
          <button class="btn" onclick="replaceDisk()" style="white-space:nowrap;background:rgba(239,68,68,0.2);border:1px solid rgba(239,68,68,0.3);color:#ef4444;">
            <span class="material-symbols-rounded" style="font-size:18px;">swap_horiz</span> Replace
          </button>
        </div>
      </div>

      <!-- Capacity Guardian -->
      <div class="card" style="padding:32px;margin-bottom:24px;border-left:4px solid var(--md-sys-color-primary);">
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;">
          <span class="material-symbols-rounded" style="font-size:32px;color:var(--md-sys-color-primary);">shield</span>
          <div style="flex:1;">
            <div style="font-size:20px;font-weight:800;">Capacity Guardian</div>
            <div style="font-size:14px;color:rgba(255,255,255,0.5);">Emergency reserve protects against ZFS full freeze</div>
          </div>
          <button class="btn btn-primary" onclick="setupReserve()" style="white-space:nowrap;">Setup 2% Reserve</button>
          <button class="btn" onclick="releaseReserve()" style="white-space:nowrap;background:rgba(255,255,255,0.05);">Release</button>
        </div>
        <div id="capacity-status" style="font-family:monospace;font-size:13px;color:rgba(255,255,255,0.6);"></div>
      </div>

      <!-- Extra Actions Row -->
      <div style="display:flex;flex-wrap:wrap;gap:12px;margin-top:24px;">
        <button class="btn" onclick="runSMART('short')" style="background:rgba(255,255,255,0.05);">
          <span class="material-symbols-rounded" style="font-size:18px;">health_and_safety</span> SMART Short</button>
        <button class="btn" onclick="runSMART('long')" style="background:rgba(255,255,255,0.05);">
          <span class="material-symbols-rounded" style="font-size:18px;">health_and_safety</span> SMART Long</button>
        <button class="btn" onclick="showSMARTResults()" style="background:rgba(255,255,255,0.05);">
          <span class="material-symbols-rounded" style="font-size:18px;">assignment</span> SMART Results</button>
        <button class="btn" onclick="rollbackSnapshot()" style="background:rgba(239,68,68,0.15);color:#ef4444;">
          <span class="material-symbols-rounded" style="font-size:18px;">undo</span> Rollback Snapshot</button>
        <button class="btn" onclick="removePoolDevice()" style="background:rgba(255,255,255,0.05);">
          <span class="material-symbols-rounded" style="font-size:18px;">eject</span> Remove Device</button>
        <button class="btn" onclick="openScrubScheduler()" style="background:rgba(255,255,255,0.05);">
          <span class="material-symbols-rounded" style="font-size:18px;">calendar_month</span> Schedule Scrub</button>
        <button class="btn" onclick="revokeDeleg()" style="background:rgba(255,255,255,0.05);">
          <span class="material-symbols-rounded" style="font-size:18px;">person_remove</span> Revoke Delegation</button>
      </div>
    </div>
  `;
  main.appendChild(newSections);

  // Load pools for dropdowns
  loadPoolSelectors();
  loadCapacityStatus();
  refreshScrubStatus();
});

async function loadPoolSelectors() {
  try {
    const r = await csrfFetch('/api/zfs/pools');
    const d = await r.json();
    if (!d.success || !d.pools) return;
    ['scrub-pool','vdev-pool','replace-pool'].forEach(id => {
      const sel = document.getElementById(id);
      if (!sel) return;
      d.pools.forEach(p => {
        const o = document.createElement('option');
        o.value = p.name || p;
        o.textContent = p.name || p;
        sel.appendChild(o);
      });
    });
  } catch(e) {}
}

async function startScrub() {
  const pool = document.getElementById('scrub-pool').value;
  if (!pool) { ui.toast('Select a pool', 'warning'); return; }
  try {
    const r = await csrfFetch('/api/zfs/scrub/start', { method:'POST', body:JSON.stringify({pool}) });
    const d = await r.json();
    d.success ? ui.toast('Scrub started', 'success') : ui.toast(d.error, 'error');
    refreshScrubStatus();
  } catch(e) { ui.toast('Failed', 'error'); }
}

async function stopScrub() {
  const pool = document.getElementById('scrub-pool').value;
  if (!pool) return;
  try {
    const r = await csrfFetch('/api/zfs/scrub/stop', { method:'POST', body:JSON.stringify({pool}) });
    const d = await r.json();
    d.success ? ui.toast('Scrub stopped', 'success') : ui.toast(d.error, 'error');
    refreshScrubStatus();
  } catch(e) { ui.toast('Failed', 'error'); }
}

async function refreshScrubStatus() {
  const pool = document.getElementById('scrub-pool').value;
  if (!pool) return;
  try {
    const r = await csrfFetch('/api/zfs/scrub/status?pool=' + pool);
    const d = await r.json();
    document.getElementById('scrub-status').textContent = d.scrub || 'No scrub running';
  } catch(e) {}
}

async function addVdev() {
  const pool = document.getElementById('vdev-pool').value;
  const type = document.getElementById('vdev-type').value;
  const disks = document.getElementById('vdev-disks').value.split(',').map(s=>s.trim()).filter(Boolean);
  if (!pool || !disks.length) { ui.toast('Pool and disks required', 'warning'); return; }
  if (!await ui.confirm('Add VDEV', `Add ${type||'stripe'} (${disks.join(', ')}) to ${pool}? This cannot be undone.`)) return;
  try {
    const r = await csrfFetch('/api/zfs/pool/add-vdev', { method:'POST', body:JSON.stringify({pool, vdev_type:type, disks}) });
    const d = await r.json();
    d.success ? ui.toast('VDEV added', 'success') : ui.toast(d.error, 'error');
  } catch(e) { ui.toast('Failed', 'error'); }
}

async function replaceDisk() {
  const pool = document.getElementById('replace-pool').value;
  const old_disk = document.getElementById('replace-old').value.trim();
  const new_disk = document.getElementById('replace-new').value.trim();
  if (!pool || !old_disk || !new_disk) { ui.toast('All fields required', 'warning'); return; }
  if (!await ui.confirm('Replace Disk', `Replace ${old_disk} with ${new_disk} in ${pool}? Resilver will start.`)) return;
  try {
    const r = await csrfFetch('/api/zfs/pool/replace', { method:'POST', body:JSON.stringify({pool, old_disk, new_disk}) });
    const d = await r.json();
    d.success ? ui.toast('Resilver started', 'success') : ui.toast(d.error, 'error');
  } catch(e) { ui.toast('Failed', 'error'); }
}

async function loadCapacityStatus() {
  try {
    const r = await csrfFetch('/api/zfs/capacity');
    const d = await r.json();
    if (!d.success) return;
    const el = document.getElementById('capacity-status');
    if (!d.pools || !d.pools.length) { el.textContent = 'No pools found'; return; }
    el.innerHTML = d.pools.map(p => {
      const color = p.state==='emergency'?'#ef4444':p.state==='critical'?'#f59e0b':p.state==='warning'?'#eab308':'var(--md-sys-color-success)';
      return `<div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
        <span style="width:8px;height:8px;border-radius:50%;background:${color};"></span>
        <strong>${p.pool}</strong>
        <span>${p.used_percent}% used</span>
        <span class="badge badge-${p.state==='ok'?'success':p.state==='warning'?'warning':'error'}">${p.state}</span>
        ${p.has_reserve?'<span class="badge badge-info">Reserve active</span>':''}
      </div>`;
    }).join('');
  } catch(e) {}
}

async function setupReserve() {
  const pool = document.getElementById('vdev-pool').value || document.getElementById('scrub-pool').value;
  if (!pool) { ui.toast('Select a pool first', 'warning'); return; }
  try {
    const r = await csrfFetch('/api/zfs/capacity/reserve?pool='+pool, { method:'POST' });
    const d = await r.json();
    d.success ? ui.toast(`Reserve set: ${d.reserve_human}`, 'success') : ui.toast(d.error, 'error');
    loadCapacityStatus();
  } catch(e) { ui.toast('Failed', 'error'); }
}

// SMART Tests
async function runSMART(type) {
  const disk = await ui.prompt('SMART Test', 'Disk device:', '', 'sda');
  if (!disk) return;
  try { const r = await csrfFetch('/api/zfs/smart/test',{method:'POST',body:JSON.stringify({disk,test_type:type||'short'})}); const d = await r.json();
    d.success ? ui.toast('SMART '+type+' test started on '+disk,'success') : ui.toast(d.error,'error');
  } catch(e) { ui.toast('Failed','error'); }
}
async function showSMARTResults() {
  const disk = await ui.prompt('SMART Results', 'Disk device:', '', 'sda');
  if (!disk) return;
  try { const r = await csrfFetch('/api/zfs/smart/results?disk='+encodeURIComponent(disk)); const d = await r.json();
    await ui.modal('SMART Results: '+disk, '<pre style="max-height:400px;overflow:auto;font-family:monospace;font-size:12px;">'+(d.output||d.error||JSON.stringify(d,null,2))+'</pre>');
  } catch(e) { ui.toast('Failed','error'); }
}

// Snapshot Rollback
async function rollbackSnapshot() {
  const snap = await ui.prompt('Rollback Snapshot', 'Full snapshot name:', '', 'tank/data@daily-2025-01-01');
  if (!snap) return;
  if (!await ui.confirm('DANGEROUS: Rollback', 'Rollback to '+snap+'? ALL data written after this snapshot will be LOST.')) return;
  try { const r = await csrfFetch('/api/zfs/snapshots/rollback',{method:'POST',body:JSON.stringify({snapshot:snap})}); const d = await r.json();
    d.success ? ui.toast('Rolled back to '+snap,'success') : ui.toast(d.error,'error');
  } catch(e) { ui.toast('Failed','error'); }
}

// Remove cache/log device
async function removePoolDevice() {
  const pool = document.getElementById('vdev-pool').value;
  const device = await ui.prompt('Remove Device', 'Device to remove (cache/log only):', '', 'sdc');
  if (!pool || !device) { ui.toast('Pool and device required','warning'); return; }
  if (!await ui.confirm('Remove Device', 'Remove '+device+' from '+pool+'?')) return;
  try { const r = await csrfFetch('/api/zfs/pool/remove-device',{method:'POST',body:JSON.stringify({pool,device})}); const d = await r.json();
    d.success ? ui.toast('Device removed','success') : ui.toast(d.error,'error');
  } catch(e) { ui.toast('Failed','error'); }
}

// Capacity release
async function releaseReserve() {
  const pool = document.getElementById('vdev-pool').value || document.getElementById('scrub-pool').value;
  if (!pool) { ui.toast('Select a pool','warning'); return; }
  try { const r = await csrfFetch('/api/zfs/capacity/release?pool='+pool,{method:'POST'}); const d = await r.json();
    d.success ? ui.toast('Reserve released','success') : ui.toast(d.error,'error'); loadCapacityStatus();
  } catch(e) { ui.toast('Failed','error'); }
}

// Delegation revoke
async function revokeDeleg() {
  const dataset = await ui.prompt('Revoke Delegation', 'Dataset:','','tank/data');
  if (!dataset) return;
  const user = await ui.prompt('Revoke From', 'Username:');
  if (!user) return;
  try { const r = await csrfFetch('/api/zfs/delegation/revoke',{method:'POST',body:JSON.stringify({dataset,user})}); const d = await r.json();
    d.success ? ui.toast('Delegation revoked','success') : ui.toast(d.error,'error');
  } catch(e) { ui.toast('Failed','error'); }
}

// Scrub Scheduler
async function openScrubScheduler() {
  try { const r = await csrfFetch('/api/zfs/scrub/schedule'); const d = await r.json();
    const schedules = d.schedules || [];
    const pool = document.getElementById('scrub-pool').value;
    if (!pool) { ui.toast('Select a pool','warning'); return; }
    const interval = await ui.prompt('Scrub Schedule', 'Interval (daily/weekly/monthly):', 'weekly');
    if (!interval) return;
    const hour = await ui.prompt('Scrub Hour', 'Hour (0-23):', '3');
    if (hour === null) return;
    schedules.push({pool, interval, hour: parseInt(hour), day: 0});
    const sr = await csrfFetch('/api/zfs/scrub/schedule',{method:'POST',body:JSON.stringify(schedules)});
    const sd = await sr.json();
    sd.success ? ui.toast('Scrub scheduled for '+pool,'success') : ui.toast(sd.error,'error');
  } catch(e) { ui.toast('Failed','error'); }
}}
var __quotas_init=false;function init_quotas(){if(__quotas_init)return;__quotas_init=true;function formatBytes(b){if(!b||b===0)return'0 B';const k=1024,s=['B','KB','MB','GB','TB'],i=Math.floor(Math.log(b)/Math.log(k));return parseFloat((b/Math.pow(k,i)).toFixed(2))+' '+s[i];}
async function loadQuotas(){try{const r=await csrfFetch('/api/zfs/datasets');const d=await r.json();if(d.success)displayQuotas(d.datasets);else ui.toast('Failed','error');}catch(e){ui.toast('Failed','error');}}
function displayQuotas(ds){const c=document.getElementById('quotaList');if(!ds||ds.length===0){c.innerHTML='<div class="card"><div style="text-align:center;padding:40px;color:rgba(255,255,255,0.5);">No datasets</div></div>';return;}
c.innerHTML=ds.map(d=>{const q=d.quota||0,u=d.used||0,pct=q>0?(u/q*100):0,hasQ=q>0;return`<div class="card" style="margin-bottom:16px;"><div style="display:flex;justify-content:space-between;margin-bottom:16px;"><div><div style="font-weight:600;font-size:18px;margin-bottom:4px;">${d.name}</div><div style="font-size:13px;color:rgba(255,255,255,0.5);">${d.mountpoint||d.name}</div></div><div style="display:flex;gap:8px;"><button class="btn btn-sm" onclick="editQuota('"+JSON.stringify(d.name)+"',"+JSON.stringify(q)+")"><span class="material-symbols-rounded">edit</span></button><button class="btn btn-sm btn-danger" onclick="removeQuota('"+JSON.stringify(d.name)+"')" ${!hasQ?'disabled':''}><span class="material-symbols-rounded">delete</span></button></div></div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;margin-bottom:16px;"><div><div style="font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:4px;">USED</div><div style="font-size:20px;font-weight:600;">${formatBytes(u)}</div></div><div><div style="font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:4px;">QUOTA</div><div style="font-size:20px;font-weight:600;">${hasQ?formatBytes(q):'No limit'}</div></div><div><div style="font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:4px;">AVAILABLE</div><div style="font-size:20px;font-weight:600;">${hasQ?formatBytes(q-u):'Unlimited'}</div></div></div>${hasQ?`<div><div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span style="font-size:13px;">Usage</span><span style="font-size:13px;font-weight:600;color:${pct>90?'var(--error)':pct>75?'#FBBF24':'var(--success)'};">${pct.toFixed(1)}%</span></div><div class="progress-bar"><div class="progress-fill" style="width:${pct}%;background:${pct>90?'var(--error)':pct>75?'#FBBF24':'linear-gradient(90deg,var(--primary),var(--primary))'};"></div></div></div>`:'<div style="text-align:center;padding:16px;background:rgba(255,255,255,0.03);border-radius:8px;color:rgba(255,255,255,0.5);">No quota - unlimited space</div>'}</div>`;}).join('');}
async function showSetQuotaModal(){const r=await csrfFetch('/api/zfs/datasets');const d=await r.json();if(!d.success){ui.toast('Failed','error');return;}
const opts=d.datasets.map(ds=>`<option value="${ds.name}">${ds.name}</option>`).join('');const html=`<div class="form-group"><label class="form-label">Dataset</label><select id="dataset" class="form-input">${opts}</select></div><div class="form-group"><label class="form-label">Quota (GB)</label><input type="number" id="quota" class="form-input" placeholder="100" min="1" step="1" required></div>`;const ok=await ui.modal('Set Quota',html,[{label:'Cancel',value:false},{label:'Set',value:true,primary:true}]);if(ok){const ds=document.getElementById('dataset').value,q=parseInt(document.getElementById('quota').value);if(q>0)await setQuota(ds,q*1024*1024*1024);}}
async function editQuota(ds,currentBytes){const gb=Math.round(currentBytes/1024/1024/1024);const html=`<div class="form-group"><label class="form-label">Dataset</label><input type="text" value="${ds}" class="form-input" disabled></div><div class="form-group"><label class="form-label">Quota (GB)</label><input type="number" id="quota" class="form-input" value="${gb}" min="1" required></div>`;const ok=await ui.modal('Edit Quota',html,[{label:'Cancel',value:false},{label:'Save',value:true,primary:true}]);if(ok){const q=parseInt(document.getElementById('quota').value);if(q>0)await setQuota(ds,q*1024*1024*1024);}}
async function setQuota(dataset,bytes){try{const r=await csrfFetch('/api/zfs/datasets',{method:'POST',body:JSON.stringify({action:'set_quota',dataset:dataset,quota:bytes})});const d=await r.json();if(d.success){ui.toast('Quota set','success');loadQuotas();}else ui.toast(d.error||'Failed','error');}catch(e){ui.toast('Failed','error');}}
async function removeQuota(dataset){const ok=await ui.confirm('Remove Quota',`Remove limit from ${dataset}?`);if(ok){try{const r=await csrfFetch('/api/zfs/datasets',{method:'POST',body:JSON.stringify({action:'set_quota',dataset:dataset,quota:0})});const d=await r.json();if(d.success){ui.toast('Removed','success');loadQuotas();}else ui.toast(d.error||'Failed','error');}catch(e){ui.toast('Failed','error');}}}
async function handleLogout(){if(!await ui.confirm('Logout','Sure?'))return;try{const r=await csrfFetch('/api/auth/logout',{method:'POST'});if(r.ok){window.location.href='/login';return;}ui.toast('Logout failed','error');}catch(e){ui.toast('Logout failed','error');}}
async function loadCurrentUser(){try{const r=await csrfFetch('/api/auth/session');const d=await r.json();if(d.success&&d.user)document.getElementById('currentUser').textContent=d.user.username;}catch(e){}}
document.addEventListener('DOMContentLoaded',()=>{loadQuotas();loadCurrentUser();});}
var __encryption_init=false;function init_encryption(){if(__encryption_init)return;__encryption_init=true;async function loadDatasets() {
  const status = document.getElementById('status');
  const datasetsDiv = document.getElementById('datasets');
  
  status.textContent = 'Loading encrypted datasets...';
  datasetsDiv.innerHTML = '';
  
  try {
    const data = await daemonAPI.zfs_encryption_list();
    
    if (!data.success) {
      status.textContent = `Error: ${data.error || 'Failed to load datasets'}`;
      return;
    }
    
    const datasets = data.datasets || [];
    status.textContent = `Found ${datasets.length} encrypted datasets`;
    
    if (datasets.length === 0) {
      datasetsDiv.innerHTML = '<div style="text-align:center; padding:40px; opacity:0.5;">No encrypted datasets found</div>';
      return;
    }
    
    datasets.forEach(dataset => {
      const isLocked = dataset.keystatus === 'unavailable';
      const item = document.createElement('div');
      item.className = 'dataset-item ' + (isLocked ? 'locked' : 'unlocked');
      
      const statusBadge = isLocked ? 
        '<span class="dataset-status status-unavailable">üîí LOCKED</span>' :
        '<span class="dataset-status status-available">üîì UNLOCKED</span>';
      
      const actions = isLocked ?
        `<button class="btn" onclick="unlockDataset('"+JSON.stringify(dataset.name)+"')">üîì Unlock</button>` :
        `<button class="btn btn-danger" onclick="lockDataset('"+JSON.stringify(dataset.name)+"')">üîí Lock</button>
         <button class="btn" onclick="changeKey('"+JSON.stringify(dataset.name)+"')">üîë Change Key</button>`;
      
      item.innerHTML = `
        <div class="dataset-header">
          <div>
            <div class="dataset-name">${dataset.name}</div>
            ${statusBadge}
          </div>
          <div class="dataset-actions">
            ${actions}
          </div>
        </div>
        <div class="dataset-details">
          <div><strong>Encryption:</strong> ${dataset.encryption}</div>
          <div><strong>Key Format:</strong> ${dataset.keyformat}</div>
          <div><strong>Key Location:</strong> ${dataset.keylocation}</div>
        </div>
      `;
      
      datasetsDiv.appendChild(item);
    });
    
  } catch (error) {
    status.textContent = `Error: ${error.message}`;
    console.error('Failed to load datasets:', error);
  }
}

async function unlockDataset(name) {
  const key = await ui.prompt('Unlock Dataset', `Enter passphrase for ${name}:`);
  if (!key) return;
  
  try {
    const result = await daemonAPI.zfs_encryption_unlock(name, key);
    if (result.success) {
      ui.toast('Dataset unlocked', 'success');
      loadDatasets();
    } else {
      ui.toast('Failed to unlock: ' + (result.error || 'Unknown error'), 'error');
    }
  } catch (error) {
    ui.toast('Error: ' + error.message, 'error');
  }
}

async function lockDataset(name) {
  if (!await ui.confirm('Lock Dataset', `Lock ${name}? This will make it inaccessible until unlocked.`)) return;
  
  try {
    const result = await daemonAPI.zfs_encryption_lock(name);
    if (result.success) {
      ui.toast('Dataset locked', 'success');
      loadDatasets();
    } else {
      ui.toast('Failed to lock: ' + (result.error || 'Unknown error'), 'error');
    }
  } catch (error) {
    ui.toast('Error: ' + error.message, 'error');
  }
}

async function changeKey(name) {
  const oldKey = await ui.prompt('Change Key', `Enter current passphrase for ${name}:`);
  if (!oldKey) return;
  
  const newKey = await ui.prompt('New Passphrase', 'Enter new passphrase:');
  if (!newKey) return;
  
  const confirmKey = await ui.prompt('Confirm Passphrase', 'Confirm new passphrase:');
  if (newKey !== confirmKey) {
    ui.toast('Passphrases do not match', 'error');
    return;
  }
  
  try {
    const result = await daemonAPI.zfs_encryption_change_key(name, oldKey, newKey);
    if (result.success) {
      ui.toast('Key changed', 'success');
      loadDatasets();
    } else {
      ui.toast('Failed to change key: ' + (result.error || 'Unknown error'), 'error');
    }
  } catch (error) {
    ui.toast('Error: ' + error.message, 'error');
  }
}

async function createEncryptedDataset() {
  const name = await ui.prompt('Create Encrypted Dataset', 'Dataset name:', '', 'tank/encrypted');
  if (!name) return;
  
  const key = await ui.prompt('Passphrase', 'Enter passphrase:');
  if (!key) return;
  
  const confirmKey = await ui.prompt('Confirm', 'Confirm passphrase:');
  if (key !== confirmKey) {
    ui.toast('Passphrases do not match', 'error');
    return;
  }
  
  try {
    const result = await daemonAPI.zfs_encryption_create(name, 'aes-256-gcm', key);
    if (result.success) {
      ui.toast('Encrypted dataset created', 'success');
      loadDatasets();
    } else {
      ui.toast('Failed to create: ' + (result.error || 'Unknown error'), 'error');
    }
  } catch (error) {
    ui.toast('Error: ' + error.message, 'error');
  }
}

document.addEventListener('DOMContentLoaded', loadDatasets);}
</script>
</body></html>
