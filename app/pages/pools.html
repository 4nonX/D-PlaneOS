<!DOCTYPE html>
<!-- saved from url=(0139)pools.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Storage - D-PlaneOS</title>
    <link rel="stylesheet" href="/assets/css/design-tokens.css">
    <link rel="stylesheet" href="/assets/css/dplaneos-ui-complete.css">
<link rel="stylesheet" href="/assets/css/m3-tokens.css">
<link rel="stylesheet" href="/assets/css/m3-components.css">
<link rel="stylesheet" href="/assets/css/m3-icons.css">
  <link rel="stylesheet" href="/assets/css/enhanced-ui.css">
<link rel="stylesheet" href="/assets/css/m3-animations.css">
<style>
.logo { font-size: 20px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; cursor: pointer; }


.nav-link:hover, 
.main { max-width: 1600px; margin: 140px auto 60px; padding: 0 40px; }
.page-header { margin-bottom: 48px; }
.page-title { font-size: 32px; font-weight: 700; letter-spacing: -1.5px; margin-bottom: 12px; }
.page-subtitle { font-size: 18px; color: rgba(255,255,255,0.6); }
.pool-card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: var(--radius-xl); padding: 32px; margin-bottom: 24px; border-left: 4px solid var(--primary); }
.pool-header { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
.pool-icon { font-size: 32px; color: var(--primary); }
.pool-info { flex: 1; }
.pool-name { font-size: 28px; font-weight: 700; margin-bottom: 6px; }
.pool-details { font-size: 15px; color: rgba(255,255,255,0.6); }
.capacity-bar { height: 12px; background: rgba(255,255,255,0.05); border-radius: 24px; overflow: hidden; margin: 20px 0; }
.capacity-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--primary)); border-radius: 24px; transition: width 0.5s; }
/* Badge styles are in m3-components.css */
.icon-btn { width: 40px; height: 40px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,0.8); cursor: pointer; transition: all 0.3s; border: none; }
.icon-btn:hover { background: rgba(255,255,255,0.1); color: var(--text); }
.btn { background: rgba(255,255,255,0.1); color: var(--text); padding: 12px 24px; border-radius: 10px; font-weight: 500; font-size: 14px; border: none; cursor: pointer; transition: all 0.3s; }
.btn:hover { background: rgba(255,255,255,0.15); }
.btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--primary) 100%); }
.btn-primary:hover { box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4); }
.fab { position: fixed; bottom: 32px; right: 32px; width: 64px; height: 64px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary) 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4); cursor: pointer; transition: all 0.3s; border: none; color: var(--text); }
.fab:hover { transform: translateY(-4px); box-shadow: 0 12px 48px rgba(102, 126, 234, 0.6); }
</style>
<style type="text/css" id="operaUserStyle"></style><link rel="stylesheet" href="/assets/css/ui-components.css">
<script src="/assets/js/core.js"></script>
<script src="/assets/js/nav-flyout.js"></script>
<script src="/assets/js/hybrid-router.js"></script>
  <script src="/assets/js/enhanced-ui.js"></script>
  <script src="/assets/js/connection-monitor.js"></script>
  <script src="/assets/js/keyboard-shortcuts.js"></script>
  <script src="/assets/js/form-validator.js"></script>
  <link rel="stylesheet" href="/assets/css/material-symbols-local.css">
  <link rel="stylesheet" href="/assets/css/ui-consistency.css">
  <link rel="stylesheet" href="/assets/css/ui-polish.css">
  <script src="/assets/js/daemon-api.js"></script>
</head>
<body>
<!-- D-PlaneOS - Hierarchical Navigation -->
<!-- This navigation maintains all security (CSRF, Auth) and real system state -->

<div id="nav-root"></div>

<script src="/assets/js/nav-shared.js"></script>

<main class="main">
<div class="page-header">
<h1 class="page-title">ZFS Storage</h1>
<p class="page-subtitle">Pools ‚Ä¢ Advanced ‚Ä¢ Quotas ‚Ä¢ Encryption</p>
</div>
<div class="consolidation-tabs">
  <button class="consolidation-tab active" data-tab="pools" onclick="switchConsolidatedTab('pools')">Pools</button>
  <button class="consolidation-tab" data-tab="advanced" onclick="switchConsolidatedTab('advanced')">Advanced</button>
  <button class="consolidation-tab" data-tab="quotas" onclick="switchConsolidatedTab('quotas')">Quotas</button>
  <button class="consolidation-tab" data-tab="encryption" onclick="switchConsolidatedTab('encryption')">Encryption</button>
</div>

<div id="tab-pools" class="consolidation-content active">


<div class="page-header">
<h1 class="page-title">ZFS Storage</h1>
<p class="page-subtitle">Enterprise redundancy ‚Ä¢ Snapshots ‚Ä¢ Compression ‚Ä¢ Data integrity</p>
</div>
<div id="poolList" style="padding:40px;text-align:center;color:rgba(255,255,255,0.5);">
  Loading ZFS pools...
</div>
<button class="fab" onclick="showPoolMenu()"><span class="material-symbols-rounded" style="font-size:28px;">add</span></button>

<!-- Quick Menu for Pool Actions -->
<div id="poolQuickMenu" class="context-menu" style="display:none;">
  <div class="context-menu-item" onclick="createPool(); document.getElementById('poolQuickMenu').style.display='none';">
    <span class="material-symbols-rounded">add_circle</span>
    <span>Create New Pool</span>
  </div>
  <div class="context-menu-item" onclick="importPool(); document.getElementById('poolQuickMenu').style.display='none';">
    <span class="material-symbols-rounded">drive_folder_upload</span>
    <span>Import Existing Pool</span>
  </div>
</div>

<script>
function escapeHtml(s) {
  if (s == null) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

function showPoolMenu() {
  const menu = document.getElementById('poolQuickMenu');
  const fab = document.querySelector('.fab');
  const rect = fab.getBoundingClientRect();
  menu.style.display = 'block';
  menu.style.bottom = '100px';
  menu.style.right = '32px';
  menu.style.left = 'auto';
  menu.style.top = 'auto';
}

// Close menu when clicking outside
document.addEventListener('click', (e) => {
  const menu = document.getElementById('poolQuickMenu');
  const fab = document.querySelector('.fab');
  if (!menu.contains(e.target) && e.target !== fab && !fab.contains(e.target)) {
    menu.style.display = 'none';
  }
});
</script>

<script src="/assets/js/m3-ripple.js"></script>
<script src="/assets/js/ui-components.js"></script>
</div>
<div id="tab-advanced" class="consolidation-content">


	<div id="network-interfaces-container">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Advanced ZFS Management</h1>
                    <p class="page-subtitle">Encryption ‚Ä¢ Caching ‚Ä¢ Dedup ‚Ä¢ Automation</p>
                </div>
                <a href="pools.html" class="btn">‚Üê Back to Pools</a>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('encryption')">Encryption</button>
                <button class="tab" onclick="switchTab('cache')">Cache & Log</button>
                <button class="tab" onclick="switchTab('compression')">Compression</button>
                <button class="tab" onclick="switchTab('snapshots')">Snapshots</button>
            </div>

            <!-- Encryption Tab -->
            <div id="encryption-tab" class="tab-content active">
                <div class="card">
                    <h2>Create Encrypted Dataset</h2>
                    <div class="form-group">
                        <label>Dataset Name</label>
                        <input type="text" id="enc-dataset" placeholder="pool/encrypted-data" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Encryption Algorithm</label>
                        <select id="enc-algorithm" class="form-input">
                            <option value="aes-256-gcm">AES-256-GCM (Recommended)</option>
                            <option value="aes-128-gcm">AES-128-GCM</option>
                            <option value="aes-256-ccm">AES-256-CCM</option>
                            <option value="aes-128-ccm">AES-128-CCM</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Passphrase (16+ characters)</label>
                        <input type="password" id="enc-passphrase" class="form-input">
                    </div>
                    <div class="warning-box">
                        ‚ö†Ô∏è <strong>WARNING:</strong> Store your passphrase securely! Lost passphrase = permanent data loss.
                    </div>
                    <button class="btn btn-primary" onclick="createEncryptedDataset()">Create Encrypted Dataset</button>
                </div>
            </div>

            <!-- Cache & Log Tab -->
            <div id="cache-tab" class="tab-content">
                <div class="card">
                    <h2>L2ARC (Read Cache)</h2>
                    <p>Add SSD/NVMe as read cache to accelerate frequently accessed data</p>
                    <div class="form-group">
                        <label>Pool</label>
                        <select id="l2arc-pool" class="form-input"></select>
                    </div>
                    <div class="form-group">
                        <label>Cache Device</label>
                        <select id="l2arc-device" class="form-input"></select>
                    </div>
                    <button class="btn btn-primary" onclick="addL2ARC()">Add L2ARC</button>
                </div>

                <div class="card">
                    <h2>ZIL (Write Log)</h2>
                    <p>Separate log device for synchronous writes</p>
                    <div class="form-group">
                        <label>Pool</label>
                        <select id="zil-pool" class="form-input"></select>
                    </div>
                    <div class="form-group">
                        <label>Log Device</label>
                        <select id="zil-device" class="form-input"></select>
                    </div>
                    <div class="form-group">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;"><input type="checkbox" id="zil-mirror" style="accent-color:var(--md-sys-color-primary);width:18px;height:18px;"> Mirror ZIL (recommended)</label>
                    </div>
                    <button class="btn btn-primary" onclick="addZIL()">Add ZIL</button>
                </div>
            </div>

            <!-- Compression Tab -->
            <div id="compression-tab" class="tab-content">
                <div class="card">
                    <h2>Compression Settings</h2>
                    <div class="form-group">
                        <label>Dataset</label>
                        <select id="comp-dataset" class="form-input"></select>
                    </div>
                    <div class="form-group">
                        <label>Compression Algorithm</label>
                        <select id="comp-algorithm" class="form-input">
                            <option value="lz4">LZ4 (Fast, Recommended)</option>
                            <option value="gzip">GZIP (Balanced)</option>
                            <option value="gzip-9">GZIP-9 (Max Compression)</option>
                            <option value="zstd">ZSTD (Modern)</option>
                            <option value="off">Off</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="setCompression()">Apply Compression</button>
                </div>

                <div class="card">
                    <h2>Deduplication</h2>
                    <div class="warning-box">
                        ‚ö†Ô∏è <strong>WARNING:</strong> Dedup requires ~5GB RAM per 1TB of data!
                    </div>
                    <div class="form-group">
                        <label>Dataset</label>
                        <select id="dedup-dataset" class="form-input"></select>
                    </div>
                    <div class="form-group">
                        <label>Deduplication</label>
                        <select id="dedup-setting" class="form-input">
                            <option value="off">Off (Recommended)</option>
                            <option value="on">On</option>
                            <option value="verify">On with Verification</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="setDedup()">Apply Deduplication</button>
                </div>
            </div>

            <!-- Snapshots Tab -->
            <div id="snapshots-tab" class="tab-content">
                <div class="card">
                    <h2>Automated Snapshot Schedules</h2>
                    <button class="btn btn-primary" onclick="createSnapshotSchedule()">+ Create Schedule</button>
                    <div id="snapshot-schedules" style="margin-top: 16px;"></div>
                </div>
            </div>
    </div>

    	    <script src="/assets/js/core.js"></script>
    <script>
    function switchTab(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector(`button[onclick="switchTab('"+JSON.stringify(tab)+"')"]`).classList.add('active');
        document.getElementById(`${tab}-tab`).classList.add('active');
    }

    async function createEncryptedDataset() {
        const dataset = document.getElementById('enc-dataset').value;
        const algorithm = document.getElementById('enc-algorithm').value;
        const passphrase = document.getElementById('enc-passphrase').value;

        if (!dataset || !passphrase) {
            showToast('Please fill all fields', 'error');
            return;
        }
        if (passphrase.length < 8) {
            showToast('Passphrase must be at least 8 characters', 'error');
            return;
        }
        // Validate dataset name
        if (!/^[a-zA-Z0-9_\-]+\/[a-zA-Z0-9_\-/]+$/.test(dataset)) {
            showToast('Dataset must be in pool/name format', 'error');
            return;
        }

        try {
            showLoading('Creating encrypted dataset...');
            const response = await csrfFetch('/api/zfs/encryption/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: dataset,
                    encryption: algorithm || 'aes-256-gcm',
                    key: passphrase
                })
            });
            const data = await response.json();
            if (data.success) {
                showToast('Encrypted dataset ' + dataset + ' created', 'success');
                document.getElementById('enc-dataset').value = '';
                document.getElementById('enc-passphrase').value = '';
                setTimeout(() => loadPools(), 1500);
            } else {
                showToast(data.error || 'Failed to create dataset', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    async function addL2ARC() {
        const pool = document.getElementById('l2arc-pool').value;
        const device = document.getElementById('l2arc-device').value;

        if (!pool || !device) {
            showToast('Please select pool and device', 'error');
            return;
        }

        try {
            showLoading('Adding L2ARC...');
            const sessionId = document.cookie.replace(/(?:(?:^|.*;\s*)session_id\s*=\s*([^;]*).*$)|^.*$/, '$1') || '';
            const user = document.cookie.replace(/(?:(?:^|.*;\s*)username\s*=\s*([^;]*).*$)|^.*$/, '$1') || 'admin';
            const response = await csrfFetch('/api/zfs/command', {
                method: 'POST',
                body: JSON.stringify({ command: 'zpool_add_cache', args: ['add', pool, 'cache', device], session_id: sessionId, user })
            });
            const data = await response.json();
            if (data.success) {
                showToast('L2ARC cache added to ' + pool, 'success');
                setTimeout(() => loadPools(), 1500);
            } else {
                showToast(data.error || 'Failed to add L2ARC', 'error');
            }
        } catch (error) {
            showToast('Error adding L2ARC: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    async function addZIL() {
        const pool = document.getElementById('zil-pool').value;
        const device = document.getElementById('zil-device').value;

        if (!pool || !device) {
            showToast('Please select pool and device', 'error');
            return;
        }

        try {
            showLoading('Adding ZIL...');
            // zpool add <pool> log <device>
            const r = await csrfFetch('/api/zfs/command', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    command: 'zpool_add_log',
                    args: ['add', pool, 'log', device],
                    session_id: (document.cookie.match(/session_id=([^;]+)/) || ['',''])[1],
                    user: (document.cookie.match(/username=([^;]+)/) || ['','admin'])[1]
                })
            });
            const data = await r.json();
            if (data.success) {
                showToast('ZIL log device added to ' + pool, 'success');
                setTimeout(() => loadPools(), 1500);
            } else {
                showToast(data.error || 'Failed to add ZIL', 'error');
            }
        } catch (error) {
            showToast('Error adding ZIL: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    async function setCompression() {
        const dataset = document.getElementById('comp-dataset').value;
        const compression = document.getElementById('comp-algorithm').value;
        if (!dataset) { showToast('Select a dataset first', 'warning'); return; }
        try {
            showLoading('Setting compression...');
            const r = await csrfFetch('/api/zfs/command', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    command: 'zfs_set_property',
                    args: ['set', 'compression=' + compression, dataset],
                    session_id: (document.cookie.match(/session_id=([^;]+)/) || ['',''])[1],
                    user: (document.cookie.match(/username=([^;]+)/) || ['','admin'])[1]
                })
            });
            const data = await r.json();
            if (data.success) {
                showToast('Compression set to ' + compression + ' on ' + dataset, 'success');
            } else {
                showToast(data.error || 'Failed to set compression', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    async function setDedup() {
        const dataset = document.getElementById('dedup-dataset').value;
        const dedup = document.getElementById('dedup-setting').value;
        if (!dataset) { showToast('Select a dataset first', 'warning'); return; }

        if (dedup !== 'off') {
            if (!await ui.confirmWithCheckbox(
                'Enable Deduplication',
                'Deduplication requires significant RAM (~5GB per 1TB of data). This can impact system performance if insufficient RAM is available.',
                'I understand the RAM requirements and want to proceed'
            )) return;
        }

        try {
            showLoading('Setting deduplication...');
            const r = await csrfFetch('/api/zfs/command', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    command: 'zfs_set_property',
                    args: ['set', 'dedup=' + dedup, dataset],
                    session_id: (document.cookie.match(/session_id=([^;]+)/) || ['',''])[1],
                    user: (document.cookie.match(/username=([^;]+)/) || ['','admin'])[1]
                })
            });
            const data = await r.json();
            if (data.success) {
                showToast('Deduplication set to ' + dedup + ' on ' + dataset, 'success');
            } else {
                showToast(data.error || 'Failed to set dedup', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    async function createSnapshotSchedule() {
        const dataset = await ui.prompt('Create Snapshot Schedule', 'Dataset name:', '', 'tank/data');
        if (!dataset) return;

        const result = await ui.form('Snapshot Schedule', [
            { name: 'frequency', label: 'Frequency', type: 'select', options: [
                { value: 'hourly', label: 'Hourly' },
                { value: 'daily', label: 'Daily' },
                { value: 'weekly', label: 'Weekly' },
                { value: 'monthly', label: 'Monthly' }
            ], value: 'daily' },
            { name: 'retention', label: 'Keep (count)', type: 'number', value: '7', placeholder: '7' }
        ], 'Create');
        if (!result) return;

        try {
            showLoading('Creating schedule...');
            // Load current schedules, append new one, save all
            const getResp = await csrfFetch('/api/snapshots/schedules');
            const getData = await getResp.json();
            const schedules = (getData.success && getData.schedules) ? getData.schedules : [];
            schedules.push({
                dataset,
                frequency: result.frequency,
                retention: parseInt(result.retention) || 7,
                enabled: true
            });
            const saveResp = await csrfFetch('/api/snapshots/schedules', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(schedules)
            });
            const saveData = await saveResp.json();
            if (saveData.success) {
                showToast('Schedule created for ' + dataset, 'success');
                loadSnapshotSchedules();
            } else {
                showToast(saveData.error || 'Failed to create schedule', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    async function loadSnapshotSchedules() {
        try {
            const response = await csrfFetch('/api/snapshots/schedules');
            const data = await response.json();
            const container = document.getElementById('snapshot-schedules');
            if (!container) return;
            if (!data.success || !data.schedules || !data.schedules.length) {
                container.innerHTML = '<p style="color:rgba(255,255,255,0.4);padding:12px;">No schedules configured.</p>';
                return;
            }
            container.innerHTML = data.schedules.map((s, idx) => `
                <div class="schedule-item" style="display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.08);">
                    <span style="flex:1;font-weight:500;">${escapeHtml(s.dataset)}</span>
                    <span style="color:rgba(255,255,255,0.6);">${s.frequency || 'daily'}</span>
                    <span style="color:rgba(255,255,255,0.4);font-size:12px;">keep ${s.retention || 7}</span>
                    <span style="padding:2px 8px;border-radius:4px;font-size:11px;background:${s.enabled !== false ? 'rgba(74,222,128,0.15)' : 'rgba(255,255,255,0.05)'};color:${s.enabled !== false ? '#4ade80' : 'rgba(255,255,255,0.4)'};">${s.enabled !== false ? 'active' : 'disabled'}</span>
                    <button onclick="deleteSchedule(${idx})" style="background:none;border:1px solid rgba(239,68,68,0.3);border-radius:6px;padding:3px 8px;cursor:pointer;color:#ef4444;font-size:12px;" title="Delete schedule">‚úï</button>
                </div>
            `).join('');
        } catch (error) {
            const container = document.getElementById('snapshot-schedules');
            if (container) container.innerHTML = '<p style="color:#ef4444;padding:12px;">Failed to load schedules</p>';
        }
    }

    async function deleteSchedule(index) {
        if (!await ui.confirm('Delete Schedule', 'Delete this snapshot schedule? Existing snapshots will be kept.')) return;
        try {
            showLoading('Deleting schedule...');
            const getResp = await csrfFetch('/api/snapshots/schedules');
            const getData = await getResp.json();
            if (!getData.success || !getData.schedules) { showToast('Failed to load schedules', 'error'); return; }
            const schedules = getData.schedules.filter((_, i) => i !== index);
            const saveResp = await csrfFetch('/api/snapshots/schedules', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(schedules)
            });
            const saveData = await saveResp.json();
            if (saveData.success) {
                showToast('Schedule deleted', 'success');
                loadSnapshotSchedules();
            } else {
                showToast(saveData.error || 'Failed to delete', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadSnapshotSchedules();
    });
    </script>

    <style>
    .tabs { display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 1px solid var(--border); }
    .tab { padding: 12px 24px; background: none; border: none; cursor: pointer; border-bottom: 2px solid transparent; }
    .tab.active { border-bottom-color: var(--primary); color: var(--primary); font-weight: 600; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .warning-box { background: var(--warning-bg); border: 1px solid var(--warning-border); padding: 12px; border-radius: 4px; margin: 16px 0; color: var(--text); }
    .schedule-item { padding: 12px; background: var(--surface); margin-top: 8px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
    </style>
  <script src="/assets/js/realtime-client.js"></script>

<!-- v3.0.0: Scrub, VDEV, Disk Replace, Capacity Guardian -->
</div>
<div id="tab-quotas" class="consolidation-content">



<div class="nav-glass"><div class="nav-inner"><div class="logo" onclick="window.location.href='index.html'">D-PlaneOS</div><div class="nav-links"><a href="index.html" class="nav-link">Dashboard</a><a href="files.html" class="nav-link">Files</a><a href="pools.html" class="nav-link">Storage</a><a href="quotas.html" class="nav-link active">Quotas</a><a href="users.html" class="nav-link">Users</a><a href="settings.html" class="nav-link">Settings</a></div><div class="nav-user"><span class="nav-username" id="currentUser">Loading...</span><button class="btn btn-sm btn-logout" onclick="handleLogout()"><span class="material-symbols-rounded" style="font-size:18px;">logout</span>Logout</button></div></div></div>
<div class="main"><div class="page-header"><div><h1 class="page-title">Quota Management</h1><p class="page-meta">Manage dataset quotas and usage limits</p></div><button class="btn btn-primary" onclick="showSetQuotaModal()"><span class="material-symbols-rounded">data_usage</span>Set Quota</button></div><div id="quotaList"></div></div>
</div>
<div id="tab-encryption" class="consolidation-content">
<h1>ZFS Encryption Management</h1>

<div class="toolbar">
  <button class="btn" onclick="loadDatasets()">üîÑ Refresh</button>
  <button class="btn" onclick="createEncryptedDataset()">‚ûï Create Encrypted Dataset</button>
</div>

<div id="status" class="loading">Loading...</div>
<div id="datasets" class="dataset-list"></div>


</div>

</main>
<button class="fab" onclick="showPoolMenu()"><span class="material-symbols-rounded" style="font-size:28px;">add</span></button>

<!-- Quick Menu for Pool Actions -->
<div id="poolQuickMenu" class="context-menu" style="display:none;">
  <div class="context-menu-item" onclick="createPool(); document.getElementById('poolQuickMenu').style.display='none';">
    <span class="material-symbols-rounded">add_circle</span>
    <span>Create New Pool</span>
  </div>
  <div class="context-menu-item" onclick="importPool(); document.getElementById('poolQuickMenu').style.display='none';">
    <span class="material-symbols-rounded">drive_folder_upload</span>
    <span>Import Existing Pool</span>
  </div>
</div>

<script>
function showPoolMenu() {
  const menu = document.getElementById('poolQuickMenu');
  const fab = document.querySelector('.fab');
  const rect = fab.getBoundingClientRect();
  menu.style.display = 'block';
  menu.style.bottom = '100px';
  menu.style.right = '32px';
  menu.style.left = 'auto';
  menu.style.top = 'auto';
}

// Close menu when clicking outside
document.addEventListener('click', (e) => {
  const menu = document.getElementById('poolQuickMenu');
  const fab = document.querySelector('.fab');
  if (!menu.contains(e.target) && e.target !== fab && !fab.contains(e.target)) {
    menu.style.display = 'none';
  }
});
</script>

<script src="/assets/js/m3-ripple.js"></script>
<script src="/assets/js/ui-components.js"></script>
<script>
function switchConsolidatedTab(t){document.querySelectorAll('.consolidation-content').forEach(function(c){c.classList.remove('active')});document.querySelectorAll('.consolidation-tab').forEach(function(b){b.classList.remove('active')});var el=document.getElementById('tab-'+t);var btn=document.querySelector('[data-tab="'+t+'"]');if(el)el.classList.add('active');if(btn)btn.classList.add('active');if(typeof window['init_'+t]==='function')window['init_'+t]();}window.addEventListener('load',function(){var h=window.location.hash.replace('#','');if(h&&document.getElementById('tab-'+h))switchConsolidatedTab(h);});
// Initialize UI components
const ui = new DPlaneUI();

async function createPool() {
  const result = await ui.form('Create ZFS Pool', [
    { name: 'name', label: 'Pool Name', type: 'text', required: true },
    { name: 'type', label: 'Pool Type', type: 'select', options: [
      { value: 'stripe', label: 'Stripe (No redundancy)' },
      { value: 'mirror', label: 'Mirror (2-way redundancy)' },
      { value: 'raidz1', label: 'RAID-Z1 (Single parity)' },
      { value: 'raidz2', label: 'RAID-Z2 (Double parity)' }
    ], required: true },
    { name: 'disks', label: 'Disks (comma-separated)', type: 'text', required: true }
  ], 'Create Pool');
  
  if (result) {
    ui.showLoading('Creating pool...');
    
    try {
      const response = await csrfFetch('/api/zfs/command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'create', ...result })
      });
      
      const data = await response.json();
      ui.hideLoading();
      
      if (data.success) {
        ui.toast('Pool created successfully', 'success');
        setTimeout(() => location.reload(), 1000);
      } else {
        ui.toast(data.error || 'Failed to create pool', 'error');
      }
    } catch (error) {
      ui.hideLoading();
      ui.toast('Network error: ' + error.message, 'error');
    }
  }
}

async function managePool(name) {
  const action = await ui.modal(`Manage: ${name}`, `
    <div style="display:flex;flex-direction:column;gap:12px;">
      <button class="btn btn-primary" onclick="createDataset('"+JSON.stringify(name)+"')">+ Create Dataset</button>
      <button class="btn" onclick="listDatasets('"+JSON.stringify(name)+"')">View Datasets</button>
      <button class="btn" onclick="exportPool('"+JSON.stringify(name)+"')">Export Pool</button>
      <button class="btn" onclick="viewProperties('"+JSON.stringify(name)+"')">View Properties</button>
      <button class="btn" style="background:rgba(239,68,68,0.2);color:#ef4444;" onclick="destroyPool('"+JSON.stringify(name)+"')">Destroy Pool</button>
    </div>
  `, [{ text: 'Close', primary: true }]);
}

async function createDataset(parentName) {
  // parentName is the full ZFS path of the parent (e.g. "tank" or "tank/data")
  const parts = parentName.split('/');
  const poolName = parts[0];
  const defaultMount = '/' + parentName + '/';

  const result = await ui.form(`New Dataset under ${parentName}`, [
    { name: 'childName', label: 'Dataset Name', type: 'text', required: true,
      placeholder: 'e.g., photos (no slashes)' },
    { name: 'mountpoint', label: 'Mount Point (optional)', type: 'text',
      placeholder: defaultMount + 'dataset-name' },
    { name: 'quota', label: 'Quota (optional)', type: 'text',
      placeholder: '100G, 1T, 500M‚Ä¶' },
    { name: 'compression', label: 'Compression', type: 'select', options: [
      { value: 'lz4',  label: 'LZ4 (recommended)' },
      { value: 'zstd', label: 'ZSTD (best ratio)' },
      { value: 'gzip', label: 'GZIP' },
      { value: 'off',  label: 'Off' }
    ], value: 'lz4' }
  ], 'Create');

  if (!result) return;

  // Validate child name: alphanumeric, dash, underscore only
  const nameOk = /^[a-zA-Z0-9_\-]+$/.test(result.childName);
  if (!nameOk) {
    ui.toast('Dataset name may only contain letters, numbers, - and _', 'error');
    return;
  }

  const fullName = parentName + '/' + result.childName;
  const mountpoint = result.mountpoint || ('/' + fullName);

  try {
    ui.showLoading('Creating dataset‚Ä¶');

    const response = await csrfFetch('/api/zfs/datasets', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name:        fullName,
        mountpoint:  mountpoint,
        quota:       result.quota || '',
        compression: result.compression || 'lz4'
      })
    });

    const data = await response.json();
    ui.hideLoading();

    if (data.success) {
      ui.toast(`Dataset ${fullName} created`, 'success');
      setTimeout(() => loadPools(), 1000);
    } else {
      ui.toast(data.error || 'Failed to create dataset', 'error');
    }
  } catch (error) {
    ui.hideLoading();
    ui.toast('Error: ' + error.message, 'error');
  }
}

// ‚îÄ‚îÄ Dataset Tree Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/** Build a nested tree from flat ZFS dataset list.
 *  Input:  [{name:'tank',...},{name:'tank/data',...},{name:'tank/data/photos',...}]
 *  Output: tree nodes with .children[]
 */
function buildDatasetTree(datasets, poolName) {
  const nodes = {};
  const roots = [];

  // Index all nodes
  datasets.forEach(d => {
    nodes[d.name] = { ...d, children: [] };
  });

  // Wire parent‚Üíchild
  datasets.forEach(d => {
    const parts = d.name.split('/');
    if (parts.length === 1) {
      // Top-level: pool root itself
      roots.push(nodes[d.name]);
    } else {
      const parentName = parts.slice(0, -1).join('/');
      if (nodes[parentName]) {
        nodes[parentName].children.push(nodes[d.name]);
      } else {
        // Parent not in list (filtered?) ‚Äî treat as root
        roots.push(nodes[d.name]);
      }
    }
  });

  // Only return the subtree rooted at poolName
  return nodes[poolName] ? [nodes[poolName]] : roots;
}

/** Format bytes nicely (ZFS already returns human-readable strings, pass-through) */
function fmtDatasetSize(val) {
  return val && val !== '-' ? val : '‚Äî';
}

/** Render one dataset tree node as HTML (recursive) */
function renderDatasetNode(node, depth) {
  const indent = depth * 20; // px per level
  const hasChildren = node.children && node.children.length > 0;
  const shortName = node.name.split('/').pop();
  const isMounted = node.mountpoint && node.mountpoint !== 'none' && node.mountpoint !== '-';
  const nodeId = 'ds-' + node.name.replace(/[^a-z0-9]/gi, '_');

  const mountBadge = isMounted
    ? `<span style="display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:6px;background:var(--success-bg);border:1px solid var(--success-border);color:var(--success);font-size:11px;font-weight:600;">
         <span class="material-symbols-rounded" style="font-size:13px;">check_circle</span>mounted
       </span>`
    : `<span style="display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:6px;background:var(--surface-variant);border:1px solid var(--border);color:var(--text-dim);font-size:11px;">
         <span class="material-symbols-rounded" style="font-size:13px;">do_not_disturb_on</span>none
       </span>`;

  const expandBtn = hasChildren
    ? `<button onclick="toggleDatasetNode('${nodeId}')" style="background:none;border:none;cursor:pointer;color:var(--text-dim);padding:0;display:flex;align-items:center;transition:color 0.15s;" title="Expand/Collapse">
         <span class="material-symbols-rounded ds-chevron" id="${nodeId}-chevron" style="font-size:18px;transition:transform 0.2s;">chevron_right</span>
       </button>`
    : `<span style="width:18px;display:inline-block;"></span>`;

  const icon = depth === 0
    ? `<span class="material-symbols-rounded" style="font-size:18px;color:var(--primary);flex-shrink:0;">storage</span>`
    : hasChildren
      ? `<span class="material-symbols-rounded" style="font-size:16px;color:var(--info);flex-shrink:0;">folder</span>`
      : `<span class="material-symbols-rounded" style="font-size:16px;color:var(--text-dim);flex-shrink:0;">dataset</span>`;

  const childrenHtml = hasChildren
    ? `<div id="${nodeId}-children" style="display:none;">${node.children.map(c => renderDatasetNode(c, depth + 1)).join('')}</div>`
    : '';

  return `
    <div class="ds-row" style="display:flex;flex-direction:column;">
      <div style="display:flex;align-items:center;gap:8px;padding:10px 16px 10px ${16 + indent}px;border-radius:10px;transition:background 0.15s;cursor:default;"
           onmouseenter="this.style.background='var(--surface-hover)'" onmouseleave="this.style.background=''"
           title="${escapeHtml(node.mountpoint || '')}">
        ${expandBtn}
        ${icon}
        <div style="flex:1;min-width:0;">
          <div style="font-size:14px;font-weight:${depth === 0 ? 700 : 500};white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
            ${escapeHtml(shortName)}
          </div>
          <div style="font-size:12px;color:var(--text-dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
            ${isMounted ? escapeHtml(node.mountpoint) : 'not mounted'}
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:12px;flex-shrink:0;">
          ${mountBadge}
          <div style="text-align:right;">
            <div style="font-size:13px;font-weight:600;">${fmtDatasetSize(node.used)}</div>
            <div style="font-size:11px;color:var(--text-dim);">used</div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:13px;">${fmtDatasetSize(node.avail)}</div>
            <div style="font-size:11px;color:var(--text-dim);">avail</div>
          </div>
          <button onclick="createDataset('${escapeHtml(node.name)}')"
                  style="background:none;border:1px solid var(--border);border-radius:8px;padding:4px 8px;cursor:pointer;color:var(--text-dim);font-size:12px;display:flex;align-items:center;gap:4px;transition:all 0.15s;"
                  onmouseenter="this.style.borderColor='var(--primary)';this.style.color='var(--primary)'"
                  onmouseleave="this.style.borderColor='var(--border)';this.style.color='var(--text-dim)'"
                  title="Create child dataset">
            <span class="material-symbols-rounded" style="font-size:14px;">add</span>
          </button>
        </div>
      </div>
      ${childrenHtml}
    </div>`;
}

function toggleDatasetNode(nodeId) {
  const children = document.getElementById(nodeId + '-children');
  const chevron  = document.getElementById(nodeId + '-chevron');
  if (!children) return;
  const open = children.style.display !== 'none';
  children.style.display = open ? 'none' : 'block';
  if (chevron) chevron.style.transform = open ? '' : 'rotate(90deg)';
}

/** Attach the inline dataset tree section to a pool card element */
function attachDatasetTree(card, poolName, allDatasets) {
  // Filter to this pool's datasets only
  const poolDatasets = allDatasets.filter(d =>
    d.name === poolName || d.name.startsWith(poolName + '/')
  );

  if (poolDatasets.length === 0) return;

  const tree = buildDatasetTree(poolDatasets, poolName);

  const section = document.createElement('div');
  section.style.cssText = 'margin-top:16px;border-top:1px solid var(--border);padding-top:12px;';

  // Section header ‚Äî clickable to toggle
  const sectionId = 'tree-' + poolName.replace(/[^a-z0-9]/gi, '_');
  section.innerHTML = `
    <button onclick="togglePoolTree('${sectionId}')"
            style="width:100%;background:none;border:none;cursor:pointer;display:flex;align-items:center;gap:8px;padding:4px 0 8px;color:var(--text-dim);font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">
      <span class="material-symbols-rounded" id="${sectionId}-chevron" style="font-size:16px;transition:transform 0.2s;transform:rotate(90deg);">chevron_right</span>
      <span class="material-symbols-rounded" style="font-size:16px;">account_tree</span>
      Datasets (${poolDatasets.length})
    </button>
    <div id="${sectionId}" style="display:block;">
      ${tree.map(n => renderDatasetNode(n, 0)).join('')}
    </div>`;

  card.appendChild(section);
}

function togglePoolTree(sectionId) {
  const el = document.getElementById(sectionId);
  const chevron = document.getElementById(sectionId + '-chevron');
  if (!el) return;
  const open = el.style.display !== 'none';
  el.style.display = open ? 'none' : 'block';
  if (chevron) chevron.style.transform = open ? '' : 'rotate(90deg)';
}

// ‚îÄ‚îÄ listDatasets: now just delegates to the inline tree ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function listDatasets(poolName) {
  // The tree is already rendered inline on the pool card.
  // This function is kept for compat with the managePool button ‚Äî scroll to pool.
  const cards = document.querySelectorAll('.pool-card');
  for (const card of cards) {
    try {
      const ctx = JSON.parse(card.dataset.contextData || '{}');
      if (ctx.name === poolName) {
        card.scrollIntoView({ behavior: 'smooth', block: 'start' });
        card.style.transition = 'box-shadow 0.3s';
        card.style.boxShadow = '0 0 0 2px var(--primary)';
        setTimeout(() => { card.style.boxShadow = ''; }, 1500);
        return;
      }
    } catch(_) {}
  }
}

async function exportPool(name) {
  if (await ui.confirm('Export Pool?', `Export ${name}? The pool will be unmounted and can be imported later.`)) {
    ui.showLoading(`Exporting ${name}...`);
    
    try {
      const response = await csrfFetch('/api/zfs/command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'export', pool: name })
      });
      
      const result = await response.json();
      ui.hideLoading();
      
      if (result.success) {
        ui.toast(`${name} exported`, 'success');
        setTimeout(() => location.reload(), 1000);
      } else {
        ui.toast(result.error || 'Export failed', 'error');
      }
    } catch (error) {
      ui.hideLoading();
      ui.toast('Network error: ' + error.message, 'error');
    }
  }
}

async function viewProperties(name) {
  ui.showLoading(`Loading ${name} properties...`);
  
  try {
    const response = await csrfFetch(`/api/zfs/pools?pool=${name}`);
    const result = await response.json();
    ui.hideLoading();
    
    if (result.success) {
      const pools = result.pools || result.data || [];
      const pool = pools.find(p => (p.name || p.Name) === name) || {};
      await ui.modal(`Properties: ${name}`, `<pre style="font-family:monospace;font-size:13px;line-height:1.6;">${JSON.stringify(pool, null, 2)}</pre>`, [
        { text: 'Close', primary: true }
      ]);
    } else {
      ui.toast(result.error || 'Failed to load properties', 'error');
    }
  } catch (error) {
    ui.hideLoading();
    ui.toast('Network error: ' + error.message, 'error');
  }
}

async function destroyPool(name) {
  if (await ui.confirm('Destroy Pool?', `WARNING: This will permanently destroy ${name} and ALL data in it. This cannot be undone!`, 'Destroy', 'Cancel', true)) {
    ui.showLoading(`Destroying ${name}...`);
    
    try {
      const response = await csrfFetch('/api/zfs/command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'destroy', pool: name })
      });
      
      const result = await response.json();
      ui.hideLoading();
      
      if (result.success) {
        ui.toast(`${name} destroyed`, 'success');
        setTimeout(() => location.reload(), 1000);
      } else {
        ui.toast(result.error || 'Destroy failed', 'error');
      }
    } catch (error) {
      ui.hideLoading();
      ui.toast('Network error: ' + error.message, 'error');
    }
  }
}

async function importPool() {
  ui.showLoading('Scanning for importable pools...');
  
  try {
    // Step 1: Scan for importable pools
    const scanRes = await csrfFetch('/api/zfs/pools');
    const scan = await scanRes.json();
    ui.hideLoading();
    
    if (!scan.success || !scan.pools || scan.pools.length === 0) {
      ui.toast('No importable pools found', 'info');
      return;
    }
    
    // Step 2: Show list of pools
    const poolNames = scan.pools.map(p => p.name);
    const selectedPool = await ui.form('Import Existing Pool', [
      {
        name: 'pool',
        label: 'Select Pool to Import',
        type: 'select',
        required: true,
        options: poolNames.map(name => {
          const pool = scan.pools.find(p => p.name === name);
          return {
            value: name,
            label: `${name} (${pool.state})`
          };
        })
      },
      {
        name: 'force',
        label: 'Force import (if pool was not cleanly exported)',
        type: 'checkbox'
      }
    ], 'Import');
    
    if (!selectedPool) return;
    
    // Step 3: Import selected pool
    ui.showLoading(`Importing pool ${selectedPool.pool}...`);
    
    const importRes = await csrfFetch('/api/zfs/command', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'import',
        name: selectedPool.pool,
        force: selectedPool.force || false
      })
    });
    
    const result = await importRes.json();
    ui.hideLoading();
    
    if (result.success) {
      ui.toast(`‚úì Pool ${selectedPool.pool} imported successfully`, 'success', 5000);
      setTimeout(() => location.reload(), 2000);
    } else {
      ui.toast(result.error || 'Import failed', 'error');
    }
    
  } catch (error) {
    ui.hideLoading();
    ui.toast('Failed to import pool: ' + error.message, 'error');
  }
}


async function scrubPool(name) {
  if (await ui.confirm('Scrub Pool?', `Scrub ${name}? This will verify data integrity across all disks.`)) {
    ui.showLoading('Starting scrub...');
    
    try {
      const response = await csrfFetch('/api/zfs/command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'scrub', pool: name })
      });
      
      const result = await response.json();
      ui.hideLoading();
      
      if (result.success) {
        ui.toast('Scrub started', 'success');
      } else {
        ui.toast(result.error || 'Scrub failed to start', 'error');
      }
    } catch (error) {
      ui.hideLoading();
      ui.toast('Network error: ' + error.message, 'error');
    }
  }
}

// ===== DYNAMIC POOL LOADING =====
async function loadPools() {
  const poolList = document.getElementById('poolList');
  
  // Show skeleton
  poolList.innerHTML = '';
  for (let i = 0; i < 2; i++) {
    const skeleton = document.createElement('div');
    skeleton.className = 'skeleton skeleton-card';
    skeleton.style.marginBottom = '16px';
    skeleton.style.height = '120px';
    poolList.appendChild(skeleton);
  }
  
  try {
    const response = await csrfFetch('/api/zfs/pools', { showLoading: false });
    const data = await response.json();
    
    if (data.success && data.pools) {
      // Fetch datasets in parallel ‚Äî non-blocking, tree attaches after cards render
      const dsResponse = await csrfFetch('/api/zfs/datasets', { showLoading: false }).catch(() => null);
      const dsData = dsResponse ? await dsResponse.json().catch(() => null) : null;
      const allDatasets = (dsData && dsData.data) ? dsData.data : [];
      updatePoolList(data.pools, allDatasets);
    } else {
      poolList.innerHTML = '';
      const emptyState = EnhancedUI.emptyState({
        icon: '<svg width="80" height="80" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12z"/></svg>',
        title: 'No ZFS pools found',
        message: 'Create a pool to start storing data',
        action: { label: 'Create Pool', onclick: 'createPool()' }
      });
      poolList.appendChild(emptyState);
    }
  } catch (error) {
    EnhancedUI.toast('Failed to load pools', 'error');
  }
}

function updatePoolList(pools, allDatasets = []) {
  const poolList = document.getElementById('poolList');
  
  if (!pools || pools.length === 0) {
    poolList.innerHTML = '';
    const emptyState = EnhancedUI.emptyState({
      icon: '<svg width="80" height="80" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12z"/></svg>',
      title: 'No pools',
      message: 'Create your first ZFS pool',
      action: { label: 'Create Pool', onclick: 'createPool()' }
    });
    poolList.appendChild(emptyState);
    return;
  }
  
  poolList.innerHTML = '';
  
	  pools.forEach(pool => {
	    const badgeClass = pool.health === 'ONLINE' ? 'badge-success' : 'badge-error';
	    const healthIcon = pool.health === 'ONLINE' ? 'check_circle' : 'error';
	    const usedPercent = pool.capacity ? parseInt(pool.capacity.replace('%', '')) : 0;

	    const card = document.createElement('div');
	    card.className = 'pool-card';
	    card.dataset.contextMenu = 'pool';
	    card.dataset.contextData = JSON.stringify({name: pool.name || '', type: pool.type || '', health: pool.health || ''});

	    const header = document.createElement('div');
	    header.className = 'pool-header';

	    const icon = document.createElement('span');
	    icon.className = 'material-symbols-rounded pool-icon';
	    icon.textContent = 'storage';

	    const info = document.createElement('div');
	    info.className = 'pool-info';
	    const name = document.createElement('div');
	    name.className = 'pool-name';
	    name.textContent = pool.name || 'Unknown';
	    const details = document.createElement('div');
	    details.className = 'pool-details';
	    details.textContent = `${pool.type || 'Unknown'} ‚Ä¢ ${pool.used || 'N/A'} / ${pool.size || 'N/A'} used (${pool.capacity || '0%'})`;
	    info.appendChild(name);
	    info.appendChild(details);

	    const badge = document.createElement('div');
	    badge.className = `badge ${badgeClass}`;
	    const badgeIcon = document.createElement('span');
	    badgeIcon.className = 'material-symbols-rounded';
	    badgeIcon.style.fontSize = '16px';
	    badgeIcon.textContent = healthIcon;
	    badge.appendChild(badgeIcon);
	    badge.appendChild(document.createTextNode(` ${pool.health || 'Unknown'}`));

	    const manageBtn = document.createElement('button');
	    manageBtn.className = 'icon-btn';
	    manageBtn.addEventListener('click', () => managePool(pool.name));
	    manageBtn.innerHTML = '<span class="material-symbols-rounded">settings</span>';

	    const scrubBtn = document.createElement('button');
	    scrubBtn.className = 'icon-btn';
	    scrubBtn.addEventListener('click', () => scrubPool(pool.name));
	    scrubBtn.innerHTML = '<span class="material-symbols-rounded">cleaning_services</span>';

	    header.append(icon, info, badge, manageBtn, scrubBtn);

	    const capacityBar = document.createElement('div');
	    capacityBar.className = 'capacity-bar';
	    const capacityFill = document.createElement('div');
	    capacityFill.className = 'capacity-fill';
	    capacityFill.style.width = `${Math.max(0, Math.min(100, usedPercent || 0))}%`;
	    capacityBar.appendChild(capacityFill);

	    const meta = document.createElement('div');
	    meta.style.display = 'flex';
	    meta.style.gap = '12px';
	    const compression = document.createElement('span');
	    compression.style.cssText = 'padding:6px 12px;background:rgba(255,255,255,0.05);border-radius:8px;font-size:13px;';
	    compression.textContent = `Compression: ${pool.compression || 'Unknown'}`;
	    const dedup = document.createElement('span');
	    dedup.style.cssText = 'padding:6px 12px;background:rgba(255,255,255,0.05);border-radius:8px;font-size:13px;';
	    dedup.textContent = `Dedup: ${pool.dedup || 'Off'}`;
	    meta.append(compression, dedup);

	    card.append(header, capacityBar, meta);
	    if (allDatasets.length > 0) {
	      attachDatasetTree(card, pool.name, allDatasets);
	    }
	    poolList.appendChild(card);
	  });
}

// Load pools on page load
window.addEventListener('DOMContentLoaded', loadPools);

// Auto-refresh pools every 10 seconds
setInterval(loadPools, 10000);
var __advanced_init=false;function init_advanced(){if(__advanced_init)return;__advanced_init=true;document.addEventListener('DOMContentLoaded', () => {
  const main = document.querySelector('.main');
  if (!main) return;

  // Inject new sections after existing content
  const newSections = document.createElement('div');
  newSections.innerHTML = `
    <div style="margin-top:48px;">
      <h2 class="page-title" style="font-size:28px;">Pool Operations</h2>
      <p class="page-subtitle" style="margin-bottom:32px;">Scrub ‚Ä¢ Expand ‚Ä¢ Replace ‚Ä¢ Capacity</p>

      <!-- Scrub Section -->
      <div class="card" style="padding:32px;margin-bottom:24px;border-left:4px solid var(--md-sys-color-success);">
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;">
          <span class="material-symbols-rounded" style="font-size:32px;color:var(--md-sys-color-success);">verified_user</span>
          <div style="flex:1;">
            <div style="font-size:20px;font-weight:800;">ZFS Scrub</div>
            <div style="font-size:14px;color:rgba(255,255,255,0.5);">Data integrity verification</div>
          </div>
          <div style="display:flex;gap:8px;">
            <select id="scrub-pool" class="btn" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:var(--md-sys-shape-corner-medium);padding:10px 16px;color:#fff;appearance:none;">
              <option value="">Select pool...</option>
            </select>
            <button class="btn btn-primary" onclick="startScrub()">
              <span class="material-symbols-rounded" style="font-size:18px;">play_arrow</span> Start
            </button>
            <button class="btn" onclick="stopScrub()" style="background:rgba(255,255,255,0.05);">
              <span class="material-symbols-rounded" style="font-size:18px;">stop</span> Stop
            </button>
          </div>
        </div>
        <div id="scrub-status" style="font-family:monospace;font-size:13px;color:rgba(255,255,255,0.6);padding:12px;background:rgba(0,0,0,0.3);border-radius:var(--md-sys-shape-corner-small);">No scrub running</div>
      </div>

      <!-- VDEV Add Section -->
      <div class="card" style="padding:32px;margin-bottom:24px;border-left:4px solid #f59e0b;">
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;">
          <span class="material-symbols-rounded" style="font-size:32px;color:#f59e0b;">add_circle</span>
          <div>
            <div style="font-size:20px;font-weight:800;">Expand Pool</div>
            <div style="font-size:14px;color:rgba(255,255,255,0.5);">Add VDEV, L2ARC cache, or SLOG device</div>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:12px;align-items:end;">
          <div>
            <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px;">Pool</label>
            <select id="vdev-pool" class="btn" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:var(--md-sys-shape-corner-medium);padding:10px 16px;color:#fff;appearance:none;">
              <option value="">Select...</option>
            </select>
          </div>
          <div>
            <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px;">VDEV Type</label>
            <select id="vdev-type" class="btn" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:var(--md-sys-shape-corner-medium);padding:10px 16px;color:#fff;appearance:none;">
              <option value="mirror">Mirror</option>
              <option value="raidz">RAIDZ</option>
              <option value="raidz2">RAIDZ2</option>
              <option value="cache">L2ARC (Cache)</option>
              <option value="log">SLOG (Log)</option>
              <option value="special">Special</option>
              <option value="">Stripe (no redundancy)</option>
            </select>
          </div>
          <div>
            <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px;">Disks (comma-separated)</label>
            <input id="vdev-disks" type="text" placeholder="sdc,sdd" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:var(--md-sys-shape-corner-medium);padding:10px 16px;color:#fff;font-family:monospace;">
          </div>
          <button class="btn btn-primary" onclick="addVdev()" style="white-space:nowrap;">
            <span class="material-symbols-rounded" style="font-size:18px;">add</span> Add VDEV
          </button>
        </div>
      </div>

      <!-- Disk Replace Section -->
      <div class="card" style="padding:32px;margin-bottom:24px;border-left:4px solid #ef4444;">
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;">
          <span class="material-symbols-rounded" style="font-size:32px;color:#ef4444;">swap_horiz</span>
          <div>
            <div style="font-size:20px;font-weight:800;">Replace Failed Disk</div>
            <div style="font-size:14px;color:rgba(255,255,255,0.5);">Swap and resilver</div>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:12px;align-items:end;">
          <div>
            <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px;">Pool</label>
            <select id="replace-pool" class="btn" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:var(--md-sys-shape-corner-medium);padding:10px 16px;color:#fff;appearance:none;">
              <option value="">Select...</option>
            </select>
          </div>
          <div>
            <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px;">Failed Disk</label>
            <input id="replace-old" type="text" placeholder="sda" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:var(--md-sys-shape-corner-medium);padding:10px 16px;color:#fff;font-family:monospace;">
          </div>
          <div>
            <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px;">New Disk</label>
            <input id="replace-new" type="text" placeholder="sde" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:var(--md-sys-shape-corner-medium);padding:10px 16px;color:#fff;font-family:monospace;">
          </div>
          <button class="btn" onclick="replaceDisk()" style="white-space:nowrap;background:rgba(239,68,68,0.2);border:1px solid rgba(239,68,68,0.3);color:#ef4444;">
            <span class="material-symbols-rounded" style="font-size:18px;">swap_horiz</span> Replace
          </button>
        </div>
      </div>

      <!-- Capacity Guardian -->
      <div class="card" style="padding:32px;margin-bottom:24px;border-left:4px solid var(--md-sys-color-primary);">
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;">
          <span class="material-symbols-rounded" style="font-size:32px;color:var(--md-sys-color-primary);">shield</span>
          <div style="flex:1;">
            <div style="font-size:20px;font-weight:800;">Capacity Guardian</div>
            <div style="font-size:14px;color:rgba(255,255,255,0.5);">Emergency reserve protects against ZFS full freeze</div>
          </div>
          <button class="btn btn-primary" onclick="setupReserve()" style="white-space:nowrap;">Setup 2% Reserve</button>
          <button class="btn" onclick="releaseReserve()" style="white-space:nowrap;background:rgba(255,255,255,0.05);">Release</button>
        </div>
        <div id="capacity-status" style="font-family:monospace;font-size:13px;color:rgba(255,255,255,0.6);"></div>
      </div>

      <!-- Extra Actions Row -->
      <div style="display:flex;flex-wrap:wrap;gap:12px;margin-top:24px;">
        <button class="btn" onclick="runSMART('short')" style="background:rgba(255,255,255,0.05);">
          <span class="material-symbols-rounded" style="font-size:18px;">health_and_safety</span> SMART Short</button>
        <button class="btn" onclick="runSMART('long')" style="background:rgba(255,255,255,0.05);">
          <span class="material-symbols-rounded" style="font-size:18px;">health_and_safety</span> SMART Long</button>
        <button class="btn" onclick="showSMARTResults()" style="background:rgba(255,255,255,0.05);">
          <span class="material-symbols-rounded" style="font-size:18px;">assignment</span> SMART Results</button>
        <button class="btn" onclick="rollbackSnapshot()" style="background:rgba(239,68,68,0.15);color:#ef4444;">
          <span class="material-symbols-rounded" style="font-size:18px;">undo</span> Rollback Snapshot</button>
        <button class="btn" onclick="removePoolDevice()" style="background:rgba(255,255,255,0.05);">
          <span class="material-symbols-rounded" style="font-size:18px;">eject</span> Remove Device</button>
        <button class="btn" onclick="openScrubScheduler()" style="background:rgba(255,255,255,0.05);">
          <span class="material-symbols-rounded" style="font-size:18px;">calendar_month</span> Schedule Scrub</button>
        <button class="btn" onclick="revokeDeleg()" style="background:rgba(255,255,255,0.05);">
          <span class="material-symbols-rounded" style="font-size:18px;">person_remove</span> Revoke Delegation</button>
      </div>
    </div>
  `;
  main.appendChild(newSections);

  // Load pools for dropdowns
  loadPoolSelectors();
  loadCapacityStatus();
  refreshScrubStatus();
});

async function loadPoolSelectors() {
  try {
    const r = await csrfFetch('/api/zfs/pools');
    const d = await r.json();
    if (!d.success || !d.pools) return;
    ['scrub-pool','vdev-pool','replace-pool'].forEach(id => {
      const sel = document.getElementById(id);
      if (!sel) return;
      d.pools.forEach(p => {
        const o = document.createElement('option');
        o.value = p.name || p;
        o.textContent = p.name || p;
        sel.appendChild(o);
      });
    });
  } catch(e) {}
}

async function startScrub() {
  const pool = document.getElementById('scrub-pool').value;
  if (!pool) { ui.toast('Select a pool', 'warning'); return; }
  try {
    const r = await csrfFetch('/api/zfs/scrub/start', { method:'POST', body:JSON.stringify({pool}) });
    const d = await r.json();
    d.success ? ui.toast('Scrub started', 'success') : ui.toast(d.error, 'error');
    refreshScrubStatus();
  } catch(e) { ui.toast('Failed', 'error'); }
}

async function stopScrub() {
  const pool = document.getElementById('scrub-pool').value;
  if (!pool) return;
  try {
    const r = await csrfFetch('/api/zfs/scrub/stop', { method:'POST', body:JSON.stringify({pool}) });
    const d = await r.json();
    d.success ? ui.toast('Scrub stopped', 'success') : ui.toast(d.error, 'error');
    refreshScrubStatus();
  } catch(e) { ui.toast('Failed', 'error'); }
}

async function refreshScrubStatus() {
  const pool = document.getElementById('scrub-pool').value;
  if (!pool) return;
  try {
    const r = await csrfFetch('/api/zfs/scrub/status?pool=' + pool);
    const d = await r.json();
    document.getElementById('scrub-status').textContent = d.scrub || 'No scrub running';
  } catch(e) {}
}

async function addVdev() {
  const pool = document.getElementById('vdev-pool').value;
  const type = document.getElementById('vdev-type').value;
  const disks = document.getElementById('vdev-disks').value.split(',').map(s=>s.trim()).filter(Boolean);
  if (!pool || !disks.length) { ui.toast('Pool and disks required', 'warning'); return; }
  if (!await ui.confirm('Add VDEV', `Add ${type||'stripe'} (${disks.join(', ')}) to ${pool}? This cannot be undone.`)) return;
  try {
    const r = await csrfFetch('/api/zfs/pool/add-vdev', { method:'POST', body:JSON.stringify({pool, vdev_type:type, disks}) });
    const d = await r.json();
    if (d.success) { ui.toast('VDEV added ‚Äî pool topology updated', 'success'); setTimeout(() => loadPools(), 1000); } else { ui.toast(d.error, 'error'); }
  } catch(e) { ui.toast('Failed', 'error'); }
}

async function replaceDisk() {
  const pool = document.getElementById('replace-pool').value;
  const old_disk = document.getElementById('replace-old').value.trim();
  const new_disk = document.getElementById('replace-new').value.trim();
  if (!pool || !old_disk || !new_disk) { ui.toast('All fields required', 'warning'); return; }
  if (!await ui.confirm('Replace Disk', `Replace ${old_disk} with ${new_disk} in ${pool}? Resilver will start.`)) return;
  try {
    const r = await csrfFetch('/api/zfs/pool/replace', { method:'POST', body:JSON.stringify({pool, old_disk, new_disk}) });
    const d = await r.json();
    if (d.success) { ui.toast('Resilver started ‚Äî pool health will update as resilver progresses', 'success'); setTimeout(() => loadPools(), 2000); } else { ui.toast(d.error, 'error'); }
  } catch(e) { ui.toast('Failed', 'error'); }
}

async function loadCapacityStatus() {
  try {
    const r = await csrfFetch('/api/zfs/capacity');
    const d = await r.json();
    if (!d.success) return;
    const el = document.getElementById('capacity-status');
    if (!d.pools || !d.pools.length) { el.textContent = 'No pools found'; return; }
    el.innerHTML = d.pools.map(p => {
      const color = p.state==='emergency'?'#ef4444':p.state==='critical'?'#f59e0b':p.state==='warning'?'#eab308':'var(--md-sys-color-success)';
      return `<div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
        <span style="width:8px;height:8px;border-radius:50%;background:${color};"></span>
        <strong>${p.pool}</strong>
        <span>${p.used_percent}% used</span>
        <span class="badge badge-${p.state==='ok'?'success':p.state==='warning'?'warning':'error'}">${p.state}</span>
        ${p.has_reserve?'<span class="badge badge-info">Reserve active</span>':''}
      </div>`;
    }).join('');
  } catch(e) {}
}

async function setupReserve() {
  const pool = document.getElementById('vdev-pool').value || document.getElementById('scrub-pool').value;
  if (!pool) { ui.toast('Select a pool first', 'warning'); return; }
  try {
    const r = await csrfFetch('/api/zfs/capacity/reserve?pool='+pool, { method:'POST' });
    const d = await r.json();
    d.success ? ui.toast(`Reserve set: ${d.reserve_human}`, 'success') : ui.toast(d.error, 'error');
    loadCapacityStatus();
  } catch(e) { ui.toast('Failed', 'error'); }
}

// SMART Tests
async function runSMART(type) {
  const disk = await ui.prompt('SMART Test', 'Disk device:', '', 'sda');
  if (!disk) return;
  try { const r = await csrfFetch('/api/zfs/smart/test',{method:'POST',body:JSON.stringify({disk,test_type:type||'short'})}); const d = await r.json();
    if (d.success) { ui.toast('SMART '+type+' test started on '+disk+' ‚Äî results available in ~2 min (short) or 20+ min (long)', 'success'); setTimeout(() => loadPools(), 3000); } else { ui.toast(d.error,'error'); }
  } catch(e) { ui.toast('Failed','error'); }
}
async function showSMARTResults() {
  const disk = await ui.prompt('SMART Results', 'Disk device:', '', 'sda');
  if (!disk) return;
  try { const r = await csrfFetch('/api/zfs/smart/results?disk='+encodeURIComponent(disk)); const d = await r.json();
    await ui.modal('SMART Results: '+disk, '<pre style="max-height:400px;overflow:auto;font-family:monospace;font-size:12px;">'+(d.output||d.error||JSON.stringify(d,null,2))+'</pre>');
  } catch(e) { ui.toast('Failed','error'); }
}

// Snapshot Rollback
async function rollbackSnapshot() {
  const snap = await ui.prompt('Rollback Snapshot', 'Full snapshot name:', '', 'tank/data@daily-2025-01-01');
  if (!snap) return;
  if (!await ui.confirm('DANGEROUS: Rollback', 'Rollback to '+snap+'? ALL data written after this snapshot will be LOST.')) return;
  try { const r = await csrfFetch('/api/zfs/snapshots/rollback',{method:'POST',body:JSON.stringify({snapshot:snap})}); const d = await r.json();
    if (d.success) { ui.toast('Rolled back to '+snap+' ‚Äî reloading pools', 'success'); setTimeout(() => loadPools(), 1000); } else { ui.toast(d.error, 'error'); }
  } catch(e) { ui.toast('Failed','error'); }
}

// Remove cache/log device
async async function removePoolDevice() {
  const pool = document.getElementById('vdev-pool').value;
  const device = await ui.prompt('Remove Device', 'Device to remove (cache/log only):', '', 'sdc');
  if (!pool || !device) { ui.toast('Pool and device required','warning'); return; }
  if (!await ui.confirm('Remove Device', 'Remove '+device+' from '+pool+'?')) return;
  try { const r = await csrfFetch('/api/zfs/pool/remove-device',{method:'POST',body:JSON.stringify({pool,device})}); const d = await r.json();
    if (d.success) { ui.toast('Device removed', 'success'); setTimeout(() => loadPools(), 1000); } else { ui.toast(d.error,'error'); }
  } catch(e) { ui.toast('Failed','error'); }
}

// Capacity release
async function releaseReserve() {
  const pool = document.getElementById('vdev-pool').value || document.getElementById('scrub-pool').value;
  if (!pool) { ui.toast('Select a pool','warning'); return; }
  try { const r = await csrfFetch('/api/zfs/capacity/release?pool='+pool,{method:'POST'}); const d = await r.json();
    d.success ? ui.toast('Reserve released','success') : ui.toast(d.error,'error'); loadCapacityStatus();
  } catch(e) { ui.toast('Failed','error'); }
}

// Delegation revoke
async function revokeDeleg() {
  const dataset = await ui.prompt('Revoke Delegation', 'Dataset:','','tank/data');
  if (!dataset) return;
  const user = await ui.prompt('Revoke From', 'Username:');
  if (!user) return;
  try { const r = await csrfFetch('/api/zfs/delegation/revoke',{method:'POST',body:JSON.stringify({dataset,user})}); const d = await r.json();
    if (d.success) { ui.toast('Delegation revoked', 'success'); showDeleg(); } else { ui.toast(d.error,'error'); }
  } catch(e) { ui.toast('Failed','error'); }
}

// Scrub Scheduler
async function openScrubScheduler() {
  try { const r = await csrfFetch('/api/zfs/scrub/schedule'); const d = await r.json();
    const schedules = d.schedules || [];
    const pool = document.getElementById('scrub-pool').value;
    if (!pool) { ui.toast('Select a pool','warning'); return; }
    const interval = await ui.prompt('Scrub Schedule', 'Interval (daily/weekly/monthly):', 'weekly');
    if (!interval) return;
    const hour = await ui.prompt('Scrub Hour', 'Hour (0-23):', '3');
    if (hour === null) return;
    schedules.push({pool, interval, hour: parseInt(hour), day: 0});
    const sr = await csrfFetch('/api/zfs/scrub/schedule',{method:'POST',body:JSON.stringify(schedules)});
    const sd = await sr.json();
    sd.success ? ui.toast('Scrub scheduled for '+pool,'success') : ui.toast(sd.error,'error');
  } catch(e) { ui.toast('Failed','error'); }
}}
var __quotas_init=false;function init_quotas(){if(__quotas_init)return;__quotas_init=true;function formatBytes(b){if(!b||b===0)return'0 B';const k=1024,s=['B','KB','MB','GB','TB'],i=Math.floor(Math.log(b)/Math.log(k));return parseFloat((b/Math.pow(k,i)).toFixed(2))+' '+s[i];}
async function loadQuotas(){try{const r=await csrfFetch('/api/zfs/datasets');const d=await r.json();if(d.success)displayQuotas(d.datasets||d.data||[]);else ui.toast('Failed','error');}catch(e){ui.toast('Failed','error');}}
function displayQuotas(ds){const c=document.getElementById('quotaList');if(!ds||ds.length===0){c.innerHTML='<div class="card"><div style="text-align:center;padding:40px;color:rgba(255,255,255,0.5);">No datasets</div></div>';return;}
c.innerHTML=ds.map(d=>{const q=d.quota||0,u=d.used||0,pct=q>0?(u/q*100):0,hasQ=q>0;return`<div class="card" style="margin-bottom:16px;"><div style="display:flex;justify-content:space-between;margin-bottom:16px;"><div><div style="font-weight:600;font-size:18px;margin-bottom:4px;">${escapeHtml(d.name)}</div><div style="font-size:13px;color:rgba(255,255,255,0.5);">${escapeHtml(d.mountpoint||d.name)}</div></div><div style="display:flex;gap:8px;"><button class="btn btn-sm" onclick="editQuota('"+JSON.stringify(d.name)+"',"+JSON.stringify(q)+")"><span class="material-symbols-rounded">edit</span></button><button class="btn btn-sm btn-danger" onclick="removeQuota('"+JSON.stringify(d.name)+"')" ${!hasQ?'disabled':''}><span class="material-symbols-rounded">delete</span></button></div></div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;margin-bottom:16px;"><div><div style="font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:4px;">USED</div><div style="font-size:20px;font-weight:600;">${formatBytes(u)}</div></div><div><div style="font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:4px;">QUOTA</div><div style="font-size:20px;font-weight:600;">${hasQ?formatBytes(q):'No limit'}</div></div><div><div style="font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:4px;">AVAILABLE</div><div style="font-size:20px;font-weight:600;">${hasQ?formatBytes(q-u):'Unlimited'}</div></div></div>${hasQ?`<div><div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span style="font-size:13px;">Usage</span><span style="font-size:13px;font-weight:600;color:${pct>90?'var(--error)':pct>75?'#FBBF24':'var(--success)'};">${pct.toFixed(1)}%</span></div><div class="progress-bar"><div class="progress-fill" style="width:${pct}%;background:${pct>90?'var(--error)':pct>75?'#FBBF24':'linear-gradient(90deg,var(--primary),var(--primary))'};"></div></div></div>`:'<div style="text-align:center;padding:16px;background:rgba(255,255,255,0.03);border-radius:8px;color:rgba(255,255,255,0.5);">No quota - unlimited space</div>'}</div>`;}).join('');}
async function showSetQuotaModal(){const r=await csrfFetch('/api/zfs/datasets');const d=await r.json();if(!d.success){ui.toast('Failed','error');return;}
const list=d.datasets||d.data||[];const opts=list.map(ds=>`<option value="${ds.name}">${ds.name}</option>`).join('');const html=`<div class="form-group"><label class="form-label">Dataset</label><select id="dataset" class="form-input">${opts}</select></div><div class="form-group"><label class="form-label">Quota (GB)</label><input type="number" id="quota" class="form-input" placeholder="100" min="1" step="1" required></div>`;const ok=await ui.modal('Set Quota',html,[{label:'Cancel',value:false},{label:'Set',value:true,primary:true}]);if(ok){const ds=document.getElementById('dataset').value,q=parseInt(document.getElementById('quota').value);if(q>0)await setQuota(ds,q*1024*1024*1024);}}
async function editQuota(ds,currentBytes){const gb=Math.round(currentBytes/1024/1024/1024);const html=`<div class="form-group"><label class="form-label">Dataset</label><input type="text" value="${ds}" class="form-input" disabled></div><div class="form-group"><label class="form-label">Quota (GB)</label><input type="number" id="quota" class="form-input" value="${gb}" min="1" required></div>`;const ok=await ui.modal('Edit Quota',html,[{label:'Cancel',value:false},{label:'Save',value:true,primary:true}]);if(ok){const q=parseInt(document.getElementById('quota').value);if(q>0)await setQuota(ds,q*1024*1024*1024);}}
function bytesToZfsQuota(bytes){if(!bytes||bytes<=0)return 'none';const g=1024*1024*1024,t=g*1024;if(bytes>=t)return Math.round(bytes/t)+'T';return Math.round(bytes/g)+'G';}
async function setQuota(dataset,bytes){try{const r=await csrfFetch('/api/zfs/dataset/quota',{method:'POST',body:JSON.stringify({dataset:dataset,refquota:bytesToZfsQuota(bytes),refreservation:''})});const d=await r.json();if(d.success){ui.toast('Quota set','success');loadQuotas();}else ui.toast(d.error||d.refquota_error||'Failed','error');}catch(e){ui.toast('Failed','error');}}
async function removeQuota(dataset){const ok=await ui.confirm('Remove Quota',`Remove limit from ${dataset}?`);if(ok){try{const r=await csrfFetch('/api/zfs/dataset/quota',{method:'POST',body:JSON.stringify({dataset:dataset,refquota:'none',refreservation:''})});const d=await r.json();if(d.success){ui.toast('Removed','success');loadQuotas();}else ui.toast(d.error||d.refquota_error||'Failed','error');}catch(e){ui.toast('Failed','error');}}}
async function handleLogout(){if(!await ui.confirm('Logout','Sure?'))return;try{const r=await csrfFetch('/api/auth/logout',{method:'POST'});if(r.ok){window.location.href='/login';return;}ui.toast('Logout failed','error');}catch(e){ui.toast('Logout failed','error');}}
async function loadCurrentUser(){try{const r=await csrfFetch('/api/auth/session');const d=await r.json();if(d.success&&d.user)document.getElementById('currentUser').textContent=d.user.username;}catch(e){}}
document.addEventListener('DOMContentLoaded',()=>{loadQuotas();loadCurrentUser();});}
var __encryption_init=false;function init_encryption(){if(__encryption_init)return;__encryption_init=true;async function loadDatasets() {
  const status = document.getElementById('status');
  const datasetsDiv = document.getElementById('datasets');
  
  status.textContent = 'Loading encrypted datasets...';
  datasetsDiv.innerHTML = '';
  
  try {
    const data = await daemonAPI.zfs_encryption_list();
    
    if (!data.success) {
      status.textContent = `Error: ${data.error || 'Failed to load datasets'}`;
      return;
    }
    
    const datasets = data.datasets || [];
    status.textContent = `Found ${datasets.length} encrypted datasets`;
    
    if (datasets.length === 0) {
      datasetsDiv.innerHTML = '<div style="text-align:center; padding:40px; opacity:0.5;">No encrypted datasets found</div>';
      return;
    }
    
    datasets.forEach(dataset => {
      const isLocked = dataset.keystatus === 'unavailable';
      const item = document.createElement('div');
      item.className = 'dataset-item ' + (isLocked ? 'locked' : 'unlocked');
      
      const statusBadge = isLocked ? 
        '<span class="dataset-status status-unavailable">üîí LOCKED</span>' :
        '<span class="dataset-status status-available">üîì UNLOCKED</span>';
      
      const actions = isLocked ?
        `<button class="btn" onclick="unlockDataset('"+JSON.stringify(dataset.name)+"')">üîì Unlock</button>` :
        `<button class="btn btn-danger" onclick="lockDataset('"+JSON.stringify(dataset.name)+"')">üîí Lock</button>
         <button class="btn" onclick="changeKey('"+JSON.stringify(dataset.name)+"')">üîë Change Key</button>`;
      
      item.innerHTML = `
        <div class="dataset-header">
          <div>
            <div class="dataset-name">${escapeHtml(dataset.name)}</div>
            ${statusBadge}
          </div>
          <div class="dataset-actions">
            ${actions}
          </div>
        </div>
        <div class="dataset-details">
          <div><strong>Encryption:</strong> ${dataset.encryption}</div>
          <div><strong>Key Format:</strong> ${dataset.keyformat}</div>
          <div><strong>Key Location:</strong> ${dataset.keylocation}</div>
        </div>
      `;
      
      datasetsDiv.appendChild(item);
    });
    
  } catch (error) {
    status.textContent = `Error: ${error.message}`;
    console.error('Failed to load datasets:', error);
  }
}

async function unlockDataset(name) {
  const key = await ui.prompt('Unlock Dataset', `Enter passphrase for ${name}:`);
  if (!key) return;
  
  try {
    const result = await daemonAPI.zfs_encryption_unlock(name, key);
    if (result.success) {
      ui.toast('Dataset unlocked', 'success');
      loadDatasets();
    } else {
      ui.toast('Failed to unlock: ' + (result.error || 'Unknown error'), 'error');
    }
  } catch (error) {
    ui.toast('Error: ' + error.message, 'error');
  }
}

async function lockDataset(name) {
  if (!await ui.confirm('Lock Dataset', `Lock ${name}? This will make it inaccessible until unlocked.`)) return;
  
  try {
    const result = await daemonAPI.zfs_encryption_lock(name);
    if (result.success) {
      ui.toast('Dataset locked', 'success');
      loadDatasets();
    } else {
      ui.toast('Failed to lock: ' + (result.error || 'Unknown error'), 'error');
    }
  } catch (error) {
    ui.toast('Error: ' + error.message, 'error');
  }
}

async function changeKey(name) {
  const oldKey = await ui.prompt('Change Key', `Enter current passphrase for ${name}:`);
  if (!oldKey) return;
  
  const newKey = await ui.prompt('New Passphrase', 'Enter new passphrase:');
  if (!newKey) return;
  
  const confirmKey = await ui.prompt('Confirm Passphrase', 'Confirm new passphrase:');
  if (newKey !== confirmKey) {
    ui.toast('Passphrases do not match', 'error');
    return;
  }
  
  try {
    const result = await daemonAPI.zfs_encryption_change_key(name, oldKey, newKey);
    if (result.success) {
      ui.toast('Key changed', 'success');
      loadDatasets();
    } else {
      ui.toast('Failed to change key: ' + (result.error || 'Unknown error'), 'error');
    }
  } catch (error) {
    ui.toast('Error: ' + error.message, 'error');
  }
}

async function createEncryptedDataset() {
  const name = await ui.prompt('Create Encrypted Dataset', 'Dataset name:', '', 'tank/encrypted');
  if (!name) return;
  
  const key = await ui.prompt('Passphrase', 'Enter passphrase:');
  if (!key) return;
  
  const confirmKey = await ui.prompt('Confirm', 'Confirm passphrase:');
  if (key !== confirmKey) {
    ui.toast('Passphrases do not match', 'error');
    return;
  }
  
  try {
    const result = await daemonAPI.zfs_encryption_create(name, 'aes-256-gcm', key);
    if (result.success) {
      ui.toast('Encrypted dataset created', 'success');
      loadDatasets();
    } else {
      ui.toast('Failed to create: ' + (result.error || 'Unknown error'), 'error');
    }
  } catch (error) {
    ui.toast('Error: ' + error.message, 'error');
  }
}

document.addEventListener('DOMContentLoaded', loadDatasets);}
</script>
</body></html>
