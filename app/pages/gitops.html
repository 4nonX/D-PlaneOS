<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GitOps - D-PlaneOS</title>
<link rel="stylesheet" href="/assets/css/design-tokens.css">
<link rel="stylesheet" href="/assets/css/dplaneos-ui-complete.css">
<link rel="stylesheet" href="/assets/css/m3-tokens.css">
<link rel="stylesheet" href="/assets/css/m3-components.css">
<link rel="stylesheet" href="/assets/css/m3-icons.css">
<link rel="stylesheet" href="/assets/css/enhanced-ui.css">
<link rel="stylesheet" href="/assets/css/m3-animations.css">
<link rel="stylesheet" href="/assets/css/material-symbols-local.css">
<link rel="stylesheet" href="/assets/css/ui-consistency.css">
<link rel="stylesheet" href="/assets/css/ui-polish.css">
<link rel="stylesheet" href="/assets/css/ui-components.css">
<script src="/assets/js/core.js"></script>
<script src="/assets/js/nav-flyout.js"></script>
<script src="/assets/js/enhanced-ui.js"></script>
<script src="/assets/js/connection-monitor.js"></script>
<script src="/assets/js/permission-checker.js"></script>
<style>
.main { max-width: 1400px; margin: 140px auto 60px; padding: 0 40px; }
.page-title { font-size: 32px; font-weight: 700; letter-spacing: -1.5px; margin-bottom: 8px; }
.page-subtitle { font-size: 16px; color: rgba(255,255,255,0.5); margin-bottom: 32px; }

/* Status bar */
.status-bar { display: flex; align-items: center; gap: 16px; padding: 20px 24px;
  background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);
  border-radius: 16px; margin-bottom: 24px; flex-wrap: wrap; }
.status-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.status-dot.synced  { background: #4caf50; box-shadow: 0 0 8px rgba(76,175,80,0.5); }
.status-dot.drifted { background: #ff9800; box-shadow: 0 0 8px rgba(255,152,0,0.5); animation: pulse 2s infinite; }
.status-dot.error   { background: #f44336; box-shadow: 0 0 8px rgba(244,67,54,0.5); }
.status-dot.pending { background: rgba(255,255,255,0.3); }
@keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.4} }
.status-label { font-size: 15px; font-weight: 600; }
.status-time { font-size: 13px; color: rgba(255,255,255,0.4); margin-left: auto; }
.status-action { margin-left: 8px; }

/* Tabs */
.tabs { display: flex; gap: 4px; margin-bottom: 24px;
  background: rgba(255,255,255,0.03); padding: 6px; border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.06); width: fit-content; }
.tab-btn { padding: 10px 20px; border-radius: 10px; border: none; cursor: pointer;
  font-size: 14px; font-weight: 500; color: rgba(255,255,255,0.5);
  background: transparent; transition: all 0.2s; }
.tab-btn.active { background: var(--primary); color: #fff;
  box-shadow: 0 4px 12px rgba(102,126,234,0.4); }
.tab-btn:hover:not(.active) { background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.8); }
.tab-pane { display: none; }
.tab-pane.active { display: block; }

/* Plan items */
.plan-grid { display: flex; flex-direction: column; gap: 8px; }
.plan-item { padding: 16px 20px; border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.02);
  display: flex; align-items: flex-start; gap: 16px; transition: all 0.2s; }
.plan-item:hover { background: rgba(255,255,255,0.04); }
.plan-action-badge { padding: 4px 10px; border-radius: 8px; font-size: 11px;
  font-weight: 700; letter-spacing: 0.5px; flex-shrink: 0; margin-top: 2px; }
.badge-CREATE  { background: rgba(76,175,80,0.2);  color: #81c784; border: 1px solid rgba(76,175,80,0.3); }
.badge-MODIFY  { background: rgba(33,150,243,0.2); color: #64b5f6; border: 1px solid rgba(33,150,243,0.3); }
.badge-DELETE  { background: rgba(244,67,54,0.2);  color: #ef9a9a; border: 1px solid rgba(244,67,54,0.3); }
.badge-BLOCKED { background: rgba(255,152,0,0.2);  color: #ffb74d; border: 1px solid rgba(255,152,0,0.3); }
.badge-NOP     { background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.4); border: 1px solid rgba(255,255,255,0.08); }
.badge-APPROVED { background: rgba(76,175,80,0.3); color: #a5d6a7; border: 1px solid rgba(76,175,80,0.4); }

.plan-item-body { flex: 1; min-width: 0; }
.plan-item-name { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
.plan-item-kind { font-size: 12px; color: rgba(255,255,255,0.4); text-transform: uppercase;
  letter-spacing: 0.5px; margin-bottom: 6px; }
.plan-changes { list-style: none; padding: 0; margin: 6px 0 0 0; }
.plan-changes li { font-size: 13px; color: rgba(255,255,255,0.5); padding: 2px 0; }
.plan-changes li::before { content: '→ '; color: rgba(255,255,255,0.25); }
.plan-block-reason { font-size: 13px; color: #ffb74d; margin-top: 8px; padding: 8px 12px;
  background: rgba(255,152,0,0.08); border-radius: 8px; border-left: 3px solid rgba(255,152,0,0.5); }

.risk-badge { padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: 600;
  flex-shrink: 0; margin-top: 2px; }
.risk-low      { background: rgba(76,175,80,0.15);  color: #a5d6a7; }
.risk-medium   { background: rgba(255,193,7,0.15);  color: #fff176; }
.risk-high     { background: rgba(255,87,34,0.15);  color: #ffab91; }
.risk-critical { background: rgba(244,67,54,0.2);   color: #ef9a9a; }

.approve-btn { padding: 6px 14px; border-radius: 8px; border: 1px solid rgba(255,152,0,0.4);
  background: rgba(255,152,0,0.1); color: #ffb74d; cursor: pointer; font-size: 13px;
  transition: all 0.2s; flex-shrink: 0; }
.approve-btn:hover { background: rgba(255,152,0,0.2); }
.approve-btn.approved { border-color: rgba(76,175,80,0.4); background: rgba(76,175,80,0.1);
  color: #a5d6a7; cursor: default; }

/* Summary bar */
.plan-summary { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 20px; }
.summary-chip { padding: 8px 16px; border-radius: 10px; font-size: 13px; font-weight: 600;
  display: flex; align-items: center; gap: 6px; }
.chip-create  { background: rgba(76,175,80,0.15);  color: #81c784; }
.chip-modify  { background: rgba(33,150,243,0.15); color: #64b5f6; }
.chip-delete  { background: rgba(244,67,54,0.15);  color: #ef9a9a; }
.chip-blocked { background: rgba(255,152,0,0.15);  color: #ffb74d; }
.chip-nop     { background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.4); }

/* YAML editor */
.yaml-editor { width: 100%; min-height: 480px; font-family: 'Fira Code', 'JetBrains Mono', monospace;
  font-size: 13px; line-height: 1.7; padding: 20px; border-radius: 14px;
  background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1);
  color: rgba(255,255,255,0.85); resize: vertical; outline: none; tab-size: 2;
  box-sizing: border-box; }
.yaml-editor:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(102,126,234,0.15); }

.editor-toolbar { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
.btn { padding: 10px 20px; border-radius: 10px; border: none; cursor: pointer;
  font-size: 14px; font-weight: 500; color: rgba(255,255,255,0.85);
  background: rgba(255,255,255,0.08); transition: all 0.2s; }
.btn:hover { background: rgba(255,255,255,0.12); }
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover { box-shadow: 0 6px 20px rgba(102,126,234,0.4); }
.btn-danger  { background: rgba(244,67,54,0.15); color: #ef9a9a;
  border: 1px solid rgba(244,67,54,0.3); }
.btn-danger:hover { background: rgba(244,67,54,0.25); }
.btn-warn    { background: rgba(255,152,0,0.15); color: #ffb74d;
  border: 1px solid rgba(255,152,0,0.3); }
.btn:disabled { opacity: 0.4; cursor: not-allowed; }

.validation-result { padding: 12px 16px; border-radius: 10px; margin-top: 12px;
  font-size: 13px; display: none; }
.validation-ok   { background: rgba(76,175,80,0.1);  border: 1px solid rgba(76,175,80,0.3);  color: #a5d6a7; }
.validation-err  { background: rgba(244,67,54,0.1);  border: 1px solid rgba(244,67,54,0.3);  color: #ef9a9a; }

/* Empty state */
.empty-state { text-align: center; padding: 60px 40px; color: rgba(255,255,255,0.4); }
.empty-state .material-symbols-rounded { font-size: 48px; margin-bottom: 16px; display: block;
  color: rgba(255,255,255,0.15); }
.empty-state h3 { font-size: 18px; margin-bottom: 8px; color: rgba(255,255,255,0.5); }

/* Apply result */
.apply-result { padding: 16px 20px; border-radius: 12px; margin-top: 16px; display: none; }
.apply-ok   { background: rgba(76,175,80,0.1);  border: 1px solid rgba(76,175,80,0.3); }
.apply-fail { background: rgba(244,67,54,0.1);  border: 1px solid rgba(244,67,54,0.3); }
.apply-result-title { font-size: 15px; font-weight: 600; margin-bottom: 8px; }
.apply-result-list  { list-style: none; padding: 0; margin: 0; font-size: 13px;
  color: rgba(255,255,255,0.6); }
.apply-result-list li { padding: 3px 0; }
.apply-result-list li::before { content: '✓ '; color: #81c784; }
.apply-result-fail li::before { content: '✗ '; color: #ef9a9a; }

.card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);
  border-radius: 16px; padding: 24px; margin-bottom: 20px; }
.card-title { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
.card-sub   { font-size: 13px; color: rgba(255,255,255,0.4); }
.spinner { display: inline-block; width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.2);
  border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>
<div id="nav-root"></div>
<script src="/assets/js/nav-shared.js"></script>

<main class="main">
<div class="page-header">
  <h1 class="page-title">GitOps — Declarative State</h1>
  <p class="page-subtitle">Define your NAS configuration in state.yaml. The system continuously drifts toward your desired state.</p>
</div>

<!-- Live status bar -->
<div class="status-bar" id="statusBar">
  <div class="status-dot pending" id="statusDot"></div>
  <span class="status-label" id="statusLabel">Checking drift...</span>
  <span id="statusCounts" style="font-size:13px;color:rgba(255,255,255,0.4);"></span>
  <span class="status-time" id="statusTime"></span>
  <button class="btn status-action" onclick="triggerCheck()" id="checkBtn">
    <span class="material-symbols-rounded" style="font-size:16px;vertical-align:-3px;">refresh</span>
    Check Now
  </button>
</div>

<div class="tabs">
  <button class="tab-btn active" onclick="switchTab('plan')">Plan</button>
  <button class="tab-btn" onclick="switchTab('apply')">Apply</button>
  <button class="tab-btn" onclick="switchTab('state')">state.yaml</button>
</div>

<!-- TAB: Plan -->
<div id="tab-plan" class="tab-pane active">
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <div>
        <div class="card-title">Reconciliation Plan</div>
        <div class="card-sub">Live diff between desired state.yaml and actual ZFS/shares state</div>
      </div>
      <button class="btn btn-primary" onclick="loadPlan()" id="planBtn">
        <span class="material-symbols-rounded" style="font-size:16px;vertical-align:-3px;">compare_arrows</span>
        Compute Plan
      </button>
    </div>
    <div id="planSummary" class="plan-summary" style="display:none;"></div>
    <div id="planItems" class="plan-grid">
      <div class="empty-state">
        <span class="material-symbols-rounded">account_tree</span>
        <h3>No plan computed yet</h3>
        <p>Click "Compute Plan" to diff your desired state against live ZFS state.</p>
      </div>
    </div>
  </div>
</div>

<!-- TAB: Apply -->
<div id="tab-apply" class="tab-pane">
  <div class="card">
    <div class="card-title">Apply Plan</div>
    <div class="card-sub" style="margin-bottom:20px;">Execute the reconciliation plan against live state. Blocked items require explicit approval first.</div>

    <div id="applyBlockedWarning" style="display:none;padding:16px;border-radius:12px;
      background:rgba(255,152,0,0.08);border:1px solid rgba(255,152,0,0.3);margin-bottom:16px;">
      <div style="font-weight:600;color:#ffb74d;margin-bottom:6px;">
        <span class="material-symbols-rounded" style="vertical-align:-4px;font-size:18px;">warning</span>
        Blocked items require approval
      </div>
      <div id="applyBlockedList" style="font-size:13px;color:rgba(255,255,255,0.6);"></div>
      <div style="font-size:12px;color:rgba(255,255,255,0.4);margin-top:8px;">
        Go to the Plan tab, approve each blocked item, then return here to apply.
      </div>
    </div>

    <div style="display:flex;gap:12px;flex-wrap:wrap;">
      <button class="btn btn-primary" onclick="applyPlan()" id="applyBtn"
        data-permission="system:admin" data-permission-mode="disable">
        <span class="material-symbols-rounded" style="font-size:16px;vertical-align:-3px;">play_arrow</span>
        Apply Plan
      </button>
      <button class="btn" onclick="loadPlanForApply()">
        <span class="material-symbols-rounded" style="font-size:16px;vertical-align:-3px;">preview</span>
        Preview Plan
      </button>
    </div>

    <div id="applyPreview" style="margin-top:16px;display:none;"></div>
    <div id="applyResult" class="apply-result"></div>
  </div>
</div>

<!-- TAB: state.yaml editor -->
<div id="tab-state" class="tab-pane">
  <div class="card">
    <div class="card-title">state.yaml Editor</div>
    <div class="card-sub" style="margin-bottom:16px;">
      Edit your declarative configuration. Validation runs before every save.
      Disks MUST use <code style="color:#a5d6a7;">/dev/disk/by-id/</code> paths.
    </div>

    <div class="editor-toolbar">
      <button class="btn btn-primary" onclick="saveState()" id="saveBtn"
        data-permission="system:admin" data-permission-mode="disable">
        <span class="material-symbols-rounded" style="font-size:16px;vertical-align:-3px;">save</span>
        Validate &amp; Save
      </button>
      <button class="btn" onclick="validateState()">
        <span class="material-symbols-rounded" style="font-size:16px;vertical-align:-3px;">check_circle</span>
        Validate Only
      </button>
      <button class="btn" onclick="loadState()">
        <span class="material-symbols-rounded" style="font-size:16px;vertical-align:-3px;">refresh</span>
        Reload from Disk
      </button>
    </div>

    <textarea id="yamlEditor" class="yaml-editor" spellcheck="false"
      placeholder="Loading state.yaml..."></textarea>

    <div id="validationResult" class="validation-result"></div>

    <div style="margin-top:16px;padding:12px 16px;background:rgba(255,255,255,0.02);
      border-radius:10px;border:1px solid rgba(255,255,255,0.06);">
      <div style="font-size:12px;font-weight:600;color:rgba(255,255,255,0.4);
        text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">Requirements</div>
      <ul style="list-style:none;padding:0;margin:0;font-size:13px;
        color:rgba(255,255,255,0.5);display:flex;flex-direction:column;gap:4px;">
        <li><span style="color:#81c784;">✓</span> version: "1" must be present</li>
        <li><span style="color:#81c784;">✓</span> Pool disks: /dev/disk/by-id/ paths only (/dev/sdX rejected)</li>
        <li><span style="color:#81c784;">✓</span> Dataset destroy is BLOCKED if used &gt; 0 bytes</li>
        <li><span style="color:#81c784;">✓</span> Pool destroy is always BLOCKED (requires manual approval)</li>
        <li><span style="color:#81c784;">✓</span> Share removal is BLOCKED if active SMB clients are connected</li>
      </ul>
    </div>
  </div>
</div>
</main>

<script>
let currentPlan = null;
let approvedItems = new Set();

// ── Tab switching ──────────────────────────────────────────────────────────────
function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach((b,i) => {
    const names = ['plan','apply','state'];
    b.classList.toggle('active', names[i] === name);
  });
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  if (name === 'state') loadState();
}

// ── Status bar ─────────────────────────────────────────────────────────────────
async function loadStatus() {
  try {
    const r = await csrfFetch('/api/gitops/status');
    const d = await r.json();
    updateStatusBar(d);
  } catch(e) {
    setStatusError('Cannot reach daemon');
  }
}

function updateStatusBar(d) {
  const dot  = document.getElementById('statusDot');
  const lbl  = document.getElementById('statusLabel');
  const time = document.getElementById('statusTime');
  const counts = document.getElementById('statusCounts');

  if (d.status === 'pending') {
    dot.className = 'status-dot pending';
    lbl.textContent = 'Pending first check…';
    return;
  }
  if (d.error) {
    dot.className = 'status-dot error';
    lbl.textContent = 'Error: ' + d.error;
    return;
  }
  if (d.drifted) {
    dot.className = 'status-dot drifted';
    lbl.textContent = 'Configuration drift detected';
  } else {
    dot.className = 'status-dot synced';
    lbl.textContent = 'In sync — no drift detected';
  }
  if (d.checked_at) {
    time.textContent = 'Last checked ' + fmtRelative(d.checked_at);
  }
  if (d.plan_summary) {
    const s = d.plan_summary;
    const parts = [];
    if (s.create_count > 0)  parts.push(`+${s.create_count} create`);
    if (s.modify_count > 0)  parts.push(`~${s.modify_count} modify`);
    if (s.delete_count > 0)  parts.push(`-${s.delete_count} delete`);
    if (s.blocked_count > 0) parts.push(`⚠ ${s.blocked_count} blocked`);
    counts.textContent = parts.join('  ');
  }
}

function setStatusError(msg) {
  document.getElementById('statusDot').className = 'status-dot error';
  document.getElementById('statusLabel').textContent = msg;
}

// ── Drift check ────────────────────────────────────────────────────────────────
async function triggerCheck() {
  const btn = document.getElementById('checkBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Checking…';
  try {
    const r = await csrfFetch('/api/gitops/check', { method: 'POST' });
    const d = await r.json();
    updateStatusBar(d);
  } catch(e) {
    setStatusError('Check failed');
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<span class="material-symbols-rounded" style="font-size:16px;vertical-align:-3px;">refresh</span> Check Now';
  }
}

// ── Plan ───────────────────────────────────────────────────────────────────────
async function loadPlan() {
  const btn = document.getElementById('planBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Computing…';
  document.getElementById('planItems').innerHTML = '<div style="padding:40px;text-align:center;color:rgba(255,255,255,0.4);"><span class="spinner"></span> Computing diff…</div>';
  document.getElementById('planSummary').style.display = 'none';

  try {
    const r = await csrfFetch('/api/gitops/plan');
    const d = await r.json();

    if (!d.success) {
      document.getElementById('planItems').innerHTML = errorBox(d.error || 'Failed to compute plan');
      return;
    }

    currentPlan = d.plan;
    renderPlan(d.plan);
    renderSummary(d.plan);
    document.getElementById('planSummary').style.display = 'flex';
  } catch(e) {
    document.getElementById('planItems').innerHTML = errorBox('Network error: ' + e.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<span class="material-symbols-rounded" style="font-size:16px;vertical-align:-3px;">compare_arrows</span> Compute Plan';
  }
}

function renderSummary(plan) {
  const chips = [];
  if (plan.create_count > 0)  chips.push(`<div class="summary-chip chip-create"><span class="material-symbols-rounded" style="font-size:16px;">add_circle</span> ${plan.create_count} Create</div>`);
  if (plan.modify_count > 0)  chips.push(`<div class="summary-chip chip-modify"><span class="material-symbols-rounded" style="font-size:16px;">edit</span> ${plan.modify_count} Modify</div>`);
  if (plan.delete_count > 0)  chips.push(`<div class="summary-chip chip-delete"><span class="material-symbols-rounded" style="font-size:16px;">delete</span> ${plan.delete_count} Delete</div>`);
  if (plan.blocked_count > 0) chips.push(`<div class="summary-chip chip-blocked"><span class="material-symbols-rounded" style="font-size:16px;">block</span> ${plan.blocked_count} Blocked</div>`);
  if (plan.nop_count > 0)     chips.push(`<div class="summary-chip chip-nop"><span class="material-symbols-rounded" style="font-size:16px;">check</span> ${plan.nop_count} In Sync</div>`);
  document.getElementById('planSummary').innerHTML = chips.join('');
}

function renderPlan(plan) {
  const el = document.getElementById('planItems');
  if (!plan || !plan.items || plan.items.length === 0) {
    el.innerHTML = '<div class="empty-state"><span class="material-symbols-rounded">check_circle</span><h3>All in sync</h3><p>Desired state matches live state — nothing to do.</p></div>';
    return;
  }

  // Filter: don't show NOP items by default unless all are NOP
  const visibleItems = plan.nop_count === plan.items.length
    ? plan.items
    : plan.items.filter(i => i.action !== 'NOP');

  if (visibleItems.length === 0) {
    el.innerHTML = '<div class="empty-state"><span class="material-symbols-rounded">check_circle</span><h3>All in sync</h3><p>No changes needed.</p></div>';
    return;
  }

  el.innerHTML = visibleItems.map(item => renderPlanItem(item)).join('');
}

function renderPlanItem(item) {
  const isBlocked = item.action === 'BLOCKED';
  const isApproved = item.approved || approvedItems.has(item.kind + '/' + item.name);
  const badgeClass = isBlocked && isApproved ? 'badge-APPROVED' : 'badge-' + item.action;
  const badgeText  = isBlocked && isApproved ? 'APPROVED' : item.action;

  const changes = (item.changes || []).map(c =>
    `<li>${esc(c)}</li>`).join('');

  const blockSection = isBlocked && !isApproved ? `
    <div class="plan-block-reason">
      <strong>⚠ Blocked:</strong> ${esc(item.block_reason || 'Requires explicit approval')}
    </div>` : '';

  const approveBtn = isBlocked ? `
    <button class="approve-btn ${isApproved ? 'approved' : ''}"
      onclick="approveItem('${esc(item.kind)}','${esc(item.name)}')"
      ${isApproved ? 'disabled' : ''}>
      ${isApproved ? '✓ Approved' : 'Approve'}
    </button>` : '';

  return `<div class="plan-item" id="item-${item.kind}-${item.name.replace(/\//g,'-')}">
    <span class="plan-action-badge ${badgeClass}">${badgeText}</span>
    <div class="plan-item-body">
      <div class="plan-item-name">${esc(item.name)}</div>
      <div class="plan-item-kind">${esc(item.kind)}</div>
      ${changes ? `<ul class="plan-changes">${changes}</ul>` : ''}
      ${blockSection}
    </div>
    <span class="risk-badge risk-${item.risk_level || 'low'}">${item.risk_level || 'low'}</span>
    ${approveBtn}
  </div>`;
}

// ── Approve ────────────────────────────────────────────────────────────────────
async function approveItem(kind, name) {
  const reason = prompt(`Approve ${kind}/${name} for deletion/destruction.\n\nEnter reason (shown in audit log):`);
  if (reason === null) return; // cancelled

  try {
    const r = await csrfFetch('/api/gitops/approve', {
      method: 'POST',
      body: JSON.stringify({ kind, name, reason: reason || 'Operator approved via UI' })
    });
    const d = await r.json();
    if (d.success) {
      approvedItems.add(kind + '/' + name);
      // Re-render just this item
      const el = document.getElementById(`item-${kind}-${name.replace(/\//g,'-')}`);
      if (el && currentPlan) {
        const item = currentPlan.items.find(i => i.kind === kind && i.name === name);
        if (item) { item.approved = true; el.outerHTML = renderPlanItem(item); }
      }
      if (window.ui) ui.toast(`${kind}/${name} approved`, 'success');
    } else {
      alert('Approval failed: ' + (d.error || 'Unknown error'));
    }
  } catch(e) {
    alert('Network error: ' + e.message);
  }
}

// ── Apply ──────────────────────────────────────────────────────────────────────
async function loadPlanForApply() {
  const preview = document.getElementById('applyPreview');
  preview.innerHTML = '<div style="padding:20px;text-align:center;"><span class="spinner"></span></div>';
  preview.style.display = 'block';
  try {
    const r = await csrfFetch('/api/gitops/plan');
    const d = await r.json();
    if (!d.success) { preview.innerHTML = errorBox(d.error); return; }
    const plan = d.plan;
    currentPlan = plan;

    const blocked = (plan.items || []).filter(i => i.action === 'BLOCKED' && !i.approved);
    if (blocked.length > 0) {
      document.getElementById('applyBlockedWarning').style.display = 'block';
      document.getElementById('applyBlockedList').innerHTML =
        blocked.map(i => `<div>• ${esc(i.kind)}/${esc(i.name)}</div>`).join('');
    } else {
      document.getElementById('applyBlockedWarning').style.display = 'none';
    }

    if (plan.safe_to_apply && plan.items.filter(i => i.action !== 'NOP').length === 0) {
      preview.innerHTML = '<div style="color:#81c784;padding:16px;">✓ Nothing to apply — already in sync.</div>';
    } else {
      renderSummary(plan);
      preview.innerHTML = `<div style="margin-bottom:8px;font-size:13px;color:rgba(255,255,255,0.5);">
        Plan: ${plan.create_count} create, ${plan.modify_count} modify, ${plan.delete_count} delete, ${plan.blocked_count} blocked
      </div>` + (plan.items || []).filter(i => i.action !== 'NOP').map(renderPlanItem).join('');
    }
  } catch(e) {
    preview.innerHTML = errorBox('Network error: ' + e.message);
  }
}

async function applyPlan() {
  if (!await ui.confirm('Apply Plan', 'Apply the current plan against live state? This will modify your ZFS pools, datasets, and SMB shares.', 'Apply', 'Cancel', true)) return;

  const btn = document.getElementById('applyBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Applying…';
  const result = document.getElementById('applyResult');
  result.style.display = 'none';

  try {
    const r = await csrfFetch('/api/gitops/apply', { method: 'POST' });
    const d = await r.json();
    result.style.display = 'block';

    if (d.success) {
      result.className = 'apply-result apply-ok';
      result.innerHTML = `<div class="apply-result-title" style="color:#81c784;">✓ Plan applied successfully — ${d.count || 0} operations in ${d.duration || '?'}</div>
        <ul class="apply-result-list">${(d.applied || []).map(a => `<li>${esc(a)}</li>`).join('')}</ul>`;
      approvedItems.clear();
      loadStatus();
    } else if (d.unapproved) {
      result.className = 'apply-result apply-fail';
      result.innerHTML = `<div class="apply-result-title" style="color:#ffb74d;">⚠ Blocked — approve all BLOCKED items first</div>
        <ul class="apply-result-list apply-result-fail">${(d.unapproved || []).map(u => `<li>${esc(u)}</li>`).join('')}</ul>`;
    } else {
      result.className = 'apply-result apply-fail';
      result.innerHTML = `<div class="apply-result-title" style="color:#ef9a9a;">✗ Apply failed: ${esc(d.error || 'Unknown error')}</div>
        ${d.failed ? `<ul class="apply-result-list apply-result-fail">${d.failed.map(f => `<li>${esc(f)}</li>`).join('')}</ul>` : ''}`;
    }
  } catch(e) {
    result.style.display = 'block';
    result.className = 'apply-result apply-fail';
    result.innerHTML = `<div class="apply-result-title" style="color:#ef9a9a;">✗ Network error: ${esc(e.message)}</div>`;
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<span class="material-symbols-rounded" style="font-size:16px;vertical-align:-3px;">play_arrow</span> Apply Plan';
  }
}

// ── state.yaml editor ──────────────────────────────────────────────────────────
async function loadState() {
  const editor = document.getElementById('yamlEditor');
  editor.value = 'Loading…';
  try {
    const r = await csrfFetch('/api/gitops/state');
    const d = await r.json();
    editor.value = d.content || '';
  } catch(e) {
    editor.value = '# Error loading state.yaml: ' + e.message;
  }
}

async function validateState() {
  const content = document.getElementById('yamlEditor').value;
  const el = document.getElementById('validationResult');
  el.style.display = 'none';

  try {
    const r = await csrfFetch('/api/gitops/check', {
      method: 'POST',
      body: JSON.stringify({ validate_only: true, content })
    });
    // The /check endpoint triggers a real check — for validation-only we use /state PUT logic
    // Instead, do a dry-run via PUT which validates but we won't actually save
    const vr = await csrfFetch('/api/gitops/state', {
      method: 'PUT',
      body: JSON.stringify({ content, dry_run: true })
    });
    const vd = await vr.json();
    showValidation(vd.valid !== false, vd.error || 'Validation passed — state.yaml is valid');
  } catch(e) {
    showValidation(false, 'Network error: ' + e.message);
  }
}

async function saveState() {
  const content = document.getElementById('yamlEditor').value.trim();
  if (!content) { showValidation(false, 'Content is empty'); return; }

  const btn = document.getElementById('saveBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Saving…';

  try {
    const r = await csrfFetch('/api/gitops/state', {
      method: 'PUT',
      body: JSON.stringify({ content })
    });
    const d = await r.json();
    if (d.valid !== false && d.success) {
      showValidation(true, `Saved (${d.bytes} bytes) — drift check triggered`);
      setTimeout(loadStatus, 1500);
    } else {
      showValidation(false, d.error || 'Save failed');
    }
  } catch(e) {
    showValidation(false, 'Network error: ' + e.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<span class="material-symbols-rounded" style="font-size:16px;vertical-align:-3px;">save</span> Validate & Save';
  }
}

function showValidation(ok, msg) {
  const el = document.getElementById('validationResult');
  el.className = 'validation-result ' + (ok ? 'validation-ok' : 'validation-err');
  el.textContent = (ok ? '✓ ' : '✗ ') + msg;
  el.style.display = 'block';
}

// ── Utils ──────────────────────────────────────────────────────────────────────
function esc(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function errorBox(msg) {
  return `<div style="padding:20px;color:#ef9a9a;background:rgba(244,67,54,0.1);border-radius:10px;
    border:1px solid rgba(244,67,54,0.3);">✗ ${esc(msg)}</div>`;
}
function fmtRelative(iso) {
  const diff = Math.floor((Date.now() - new Date(iso)) / 1000);
  if (diff < 60) return diff + 's ago';
  if (diff < 3600) return Math.floor(diff/60) + 'm ago';
  return Math.floor(diff/3600) + 'h ago';
}

// ── WebSocket drift events ─────────────────────────────────────────────────────
function connectDriftWS() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  const ws = new WebSocket(`${proto}//${location.host}/ws/monitor`);
  ws.onmessage = function(e) {
    try {
      const msg = JSON.parse(e.data);
      if (msg.type === 'gitops.drift') loadStatus();
    } catch(_) {}
  };
  ws.onclose = function() { setTimeout(connectDriftWS, 5000); };
}

// ── Init ───────────────────────────────────────────────────────────────────────
loadStatus();
setInterval(loadStatus, 60000);
connectDriftWS();
</script>
</body>
</html>
