<!DOCTYPE html>
<html lang="en"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Docker Stacks - D-PlaneOS</title>
<link rel="stylesheet" href="/assets/css/design-tokens.css">
<link rel="stylesheet" href="/assets/css/m3-tokens.css">
<link rel="stylesheet" href="/assets/css/m3-components.css">
<link rel="stylesheet" href="/assets/css/m3-icons.css">
<link rel="stylesheet" href="/assets/css/enhanced-ui.css">
<link rel="stylesheet" href="/assets/css/m3-animations.css">
<link rel="stylesheet" href="/assets/css/material-symbols-local.css">
<link rel="stylesheet" href="/assets/css/ui-consistency.css">
<link rel="stylesheet" href="/assets/css/ui-polish.css">
<link rel="stylesheet" href="/assets/css/ui-components.css">
<style>
/* ═══════════════════════════════════════════════════════════
   D-PlaneOS Docker Stacks — Dockge-inspired M3 Layout
   ═══════════════════════════════════════════════════════════ */
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",system-ui,sans-serif; background:var(--bg,#0a0a0a); color:var(--text,#fff); overflow-x:hidden; }

/* ─── App Shell: sidebar + main ──────────────────────────── */
.dock-shell { display:grid; grid-template-columns:280px 1fr; min-height:100vh; margin-top:120px; }
@media(max-width:900px) { .dock-shell { grid-template-columns:1fr; } .dock-sidebar { display:none; } }

/* ─── Left Sidebar ───────────────────────────────────────── */
.dock-sidebar {
  background:var(--bg-elevated,#0f0f0f);
  border-right:1px solid var(--border-subtle,rgba(255,255,255,0.05));
  position:sticky; top:120px;
  height:calc(100vh - 120px);
  overflow-y:auto;
  scrollbar-width:thin;
  scrollbar-color:rgba(255,255,255,0.1) transparent;
}

.sidebar-header {
  padding:20px 16px 12px;
  display:flex; align-items:center; gap:12px;
  border-bottom:1px solid var(--border-subtle);
  position:sticky; top:0;
  background:var(--bg-elevated,#0f0f0f);
  z-index:2;
}
.sidebar-header h2 { font-size:15px; font-weight:700; flex:1; letter-spacing:-0.3px; }

.btn-compose {
  display:inline-flex; align-items:center; gap:6px;
  padding:8px 14px; border:none; border-radius:var(--radius-md,10px);
  background:linear-gradient(135deg,var(--primary,#8a9cff) 0%,#764ba2 100%);
  color:#fff; font-size:13px; font-weight:600; cursor:pointer;
  transition:box-shadow var(--dp-micro,140ms) var(--dp-ease);
}
.btn-compose:hover { box-shadow:0 4px 16px rgba(138,156,255,0.35); }

.sidebar-search {
  padding:12px 16px;
  position:sticky; top:57px;
  background:var(--bg-elevated);
  z-index:2;
}
.sidebar-search input {
  width:100%; padding:9px 12px 9px 36px;
  background:var(--surface,rgba(255,255,255,0.05));
  border:1px solid var(--border,rgba(255,255,255,0.1));
  border-radius:var(--radius-md,10px);
  color:var(--text); font-size:13px;
  transition:border-color var(--dp-micro) var(--dp-ease);
}
.sidebar-search input:focus { outline:none; border-color:var(--primary); }
.sidebar-search .s-icon {
  position:absolute; left:28px; top:50%; transform:translateY(-50%);
  font-size:18px; color:var(--text-dim); pointer-events:none;
}

.stack-list { padding:4px 8px 16px; }

.stack-item {
  display:flex; align-items:center; gap:10px;
  padding:10px 12px; border-radius:var(--radius-md,10px);
  cursor:pointer; transition:background var(--dp-micro) var(--dp-ease);
  margin-bottom:2px; user-select:none; border:1px solid transparent;
}
.stack-item:hover { background:var(--surface-hover,rgba(255,255,255,0.08)); }
.stack-item.active { background:var(--primary-bg,rgba(138,156,255,0.1)); border-color:rgba(138,156,255,0.2); }

.stack-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
.stack-dot.running { background:var(--success,#00ff7f); box-shadow:0 0 6px rgba(0,255,127,0.4); }
.stack-dot.partial { background:var(--warning,#ffca28); }
.stack-dot.stopped { background:var(--text-dimmer,rgba(255,255,255,0.3)); }

.stack-item-name { flex:1; font-size:14px; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.stack-item-count { font-size:11px; color:var(--text-dim); background:var(--surface); padding:2px 7px; border-radius:6px; }

/* ─── Main Content Area ──────────────────────────────────── */
.dock-main { padding:24px 32px 48px; max-width:1200px; }

.stack-header { display:flex; align-items:center; gap:16px; margin-bottom:24px; flex-wrap:wrap; }
.stack-status-badge {
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 14px; border-radius:20px; font-size:13px; font-weight:600;
}
.stack-status-badge.running { background:rgba(16,185,129,0.15); color:#34d399; }
.stack-status-badge.partial { background:rgba(255,202,40,0.15); color:#fbbf24; }
.stack-status-badge.stopped { background:rgba(239,68,68,0.15); color:#f87171; }

.stack-title { font-size:28px; font-weight:800; letter-spacing:-1px; flex:1; }

.stack-actions { display:flex; gap:8px; flex-wrap:wrap; }
.action-btn {
  display:inline-flex; align-items:center; gap:6px;
  padding:8px 16px; border:1px solid var(--border);
  border-radius:var(--radius-md,10px); background:transparent;
  color:var(--text-dim); font-size:13px; font-weight:500;
  cursor:pointer; transition:all var(--dp-micro) var(--dp-ease);
}
.action-btn:hover { background:var(--surface-hover); color:var(--text); border-color:var(--border-strong); }
.action-btn.danger { border-color:rgba(239,68,68,0.3); color:#f87171; }
.action-btn.danger:hover { background:rgba(239,68,68,0.1); }

/* ─── Tab Bar ────────────────────────────────────────────── */
.tab-bar { display:flex; gap:0; border-bottom:1px solid var(--border); margin-bottom:24px; }
.tab-btn {
  padding:12px 20px; border:none; background:transparent;
  color:var(--text-dim); font-size:14px; font-weight:500;
  cursor:pointer; position:relative;
  transition:color var(--dp-micro) var(--dp-ease);
}
.tab-btn:hover { color:var(--text); }
.tab-btn.active { color:var(--primary); }
.tab-btn.active::after {
  content:''; position:absolute; bottom:-1px; left:0; right:0;
  height:2px; background:var(--primary); border-radius:2px 2px 0 0;
}

.tab-panel { display:none; }
.tab-panel.active { display:block; animation:fadeIn 0.2s var(--dp-ease); }
@keyframes fadeIn { from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:none} }

/* ─── Container Cards ────────────────────────────────────── */
.container-card {
  background:var(--surface,rgba(255,255,255,0.03));
  border:1px solid var(--border,rgba(255,255,255,0.08));
  border-radius:var(--md-sys-shape-corner-large,16px);
  padding:20px; margin-bottom:12px;
  transition:border-color var(--dp-micro) var(--dp-ease);
}
.container-card:hover { border-color:var(--border-strong); }

.container-row { display:flex; align-items:center; gap:16px; flex-wrap:wrap; }
.container-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
.container-dot.running { background:#10b981; box-shadow:0 0 8px rgba(16,185,129,0.5); }
.container-dot.exited { background:#ef4444; }
.container-dot.paused { background:#f59e0b; }
.container-dot.created { background:#6366f1; }

.container-detail { flex:1; min-width:120px; }
.container-name-text { font-size:17px; font-weight:700; margin-bottom:2px; }
.container-image { font-size:12px; color:var(--text-dim); font-family:'Consolas','Monaco',monospace; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:350px; }

.port-chips { display:flex; gap:6px; flex-wrap:wrap; }
.port-chip {
  display:inline-flex; align-items:center; gap:4px;
  padding:4px 10px; border-radius:8px;
  background:rgba(138,156,255,0.1); border:1px solid rgba(138,156,255,0.2);
  color:var(--primary); font-size:12px; font-weight:600;
  font-family:'Consolas','Monaco',monospace;
  text-decoration:none; transition:all var(--dp-micro) var(--dp-ease);
  cursor:pointer;
}
.port-chip:hover { background:rgba(138,156,255,0.2); border-color:var(--primary); box-shadow:0 2px 8px rgba(138,156,255,0.2); }
.port-chip .material-symbols-rounded { font-size:13px; }
.port-chip.internal { opacity:0.4; cursor:default; border-style:dashed; }
.port-chip.internal:hover { opacity:0.4; background:rgba(138,156,255,0.1); box-shadow:none; }

.status-pill {
  display:inline-flex; align-items:center; gap:4px;
  padding:3px 10px; border-radius:12px; font-size:11px; font-weight:600; white-space:nowrap;
}
.status-pill.running { background:rgba(16,185,129,0.12); color:#34d399; }
.status-pill.exited { background:rgba(239,68,68,0.12); color:#f87171; }
.status-pill.paused { background:rgba(245,158,11,0.12); color:#fbbf24; }
.status-pill.created { background:rgba(99,102,241,0.12); color:#818cf8; }

.c-btn {
  display:inline-flex; align-items:center; gap:4px;
  padding:6px 12px; border:1px solid var(--border);
  border-radius:8px; background:transparent;
  color:var(--text-dim); font-size:12px; font-weight:500;
  cursor:pointer; transition:all var(--dp-micro) var(--dp-ease);
}
.c-btn:hover { background:var(--surface-hover); color:var(--text); }
.c-btn .material-symbols-rounded { font-size:15px; }

/* ─── YAML Editor ────────────────────────────────────────── */
.yaml-wrap {
  display:grid; grid-template-columns:44px 1fr;
  border:1px solid var(--border); border-radius:var(--md-sys-shape-corner-large,16px);
  overflow:hidden; background:#050508;
  font-family:'Consolas','Monaco','Fira Code',monospace; font-size:13px; line-height:1.7;
}
.yaml-lines {
  padding:16px 0; text-align:right; color:var(--text-dimmer);
  background:rgba(255,255,255,0.02); border-right:1px solid var(--border-subtle);
  user-select:none; font-size:12px; line-height:1.7;
  overflow:hidden;
}
.yaml-lines div { padding:0 8px 0 4px; }
.yaml-editor {
  width:100%; min-height:400px; padding:16px; resize:vertical;
  background:transparent; border:none; color:#c9d1d9;
  font-family:inherit; font-size:inherit; line-height:inherit;
  outline:none; tab-size:2;
}
.yaml-actions { display:flex; gap:8px; padding:12px 0; align-items:center; }
.yaml-filename {
  font-size:13px; color:var(--text-dim);
  font-family:'Consolas','Monaco',monospace;
  display:flex; align-items:center; gap:6px;
}

/* ─── Terminal / Logs Panel ──────────────────────────────── */
.log-panel {
  background:#050508; border:1px solid var(--border);
  border-radius:var(--md-sys-shape-corner-large,16px); overflow:hidden;
}
.log-header {
  display:flex; align-items:center; gap:12px;
  padding:12px 16px;
  background:rgba(255,255,255,0.02);
  border-bottom:1px solid var(--border-subtle);
}
.log-header h3 { font-size:13px; font-weight:600; flex:1; }
.log-select {
  padding:5px 10px; background:var(--surface); border:1px solid var(--border);
  border-radius:8px; color:var(--text); font-size:12px;
}
.log-body {
  padding:16px; font-family:'Consolas','Monaco',monospace;
  font-size:12px; line-height:1.6; color:#8b949e;
  max-height:500px; overflow-y:auto;
  white-space:pre-wrap; word-break:break-all;
  scrollbar-width:thin; scrollbar-color:rgba(255,255,255,0.1) transparent;
}
.log-line-error { color:#f87171; }
.log-line-warn { color:#fbbf24; }

/* ─── Empty / Loading States ─────────────────────────────── */
.empty-state {
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  padding:80px 40px; text-align:center; color:var(--text-dim);
}
.empty-state .material-symbols-rounded { font-size:64px; margin-bottom:16px; opacity:0.3; }
.empty-state h3 { font-size:20px; font-weight:700; color:var(--text); margin-bottom:8px; }
.empty-state p { font-size:14px; max-width:400px; line-height:1.6; }

.skeleton { background:linear-gradient(90deg,var(--surface) 25%,var(--surface-hover) 50%,var(--surface) 75%); background-size:200% 100%; animation:shimmer 1.5s infinite; border-radius:var(--radius-md,10px); }
@keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

/* ─── Permission Issue Banners ───────────────────────────── */
.perm-banner { background:rgba(255,202,40,0.08); border:1px solid rgba(255,202,40,0.25); border-radius:var(--radius-md,12px); padding:14px 18px; margin-bottom:12px; display:flex; align-items:flex-start; gap:12px; animation:fadeIn 0.2s; }
.perm-banner-icon { color:var(--warning,#ffca28); font-size:20px; flex-shrink:0; margin-top:1px; }
.perm-banner-body { flex:1; min-width:0; }
.perm-banner-title { font-size:13px; font-weight:700; color:var(--warning); margin-bottom:4px; }
.perm-banner-detail { font-size:12px; color:var(--text-dim); line-height:1.5; }
.perm-banner-detail code { background:rgba(255,255,255,0.06); padding:1px 5px; border-radius:4px; font-size:11px; }
.perm-banner-dismiss { background:none; border:none; color:var(--text-dimmer); font-size:18px; cursor:pointer; padding:0 4px; line-height:1; }
.perm-banner-dismiss:hover { color:var(--text); }

/* ─── New Stack Modal ────────────────────────────────────── */
.modal-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,0.6);
  backdrop-filter:blur(4px); z-index:100;
  display:flex; align-items:center; justify-content:center;
  opacity:0; pointer-events:none;
  transition:opacity var(--dp-panel,260ms) var(--dp-ease);
}
.modal-overlay.open { opacity:1; pointer-events:all; }
.modal-box {
  background:var(--bg-elevated,#0f0f0f); border:1px solid var(--border);
  border-radius:20px; padding:32px; width:min(560px,90vw);
  transform:translateY(12px);
  transition:transform var(--dp-panel) var(--dp-ease-soft);
}
.modal-overlay.open .modal-box { transform:none; }
.modal-title { font-size:20px; font-weight:800; margin-bottom:20px; }
.modal-field { margin-bottom:16px; }
.modal-field label { display:block; font-size:12px; color:var(--text-dim); margin-bottom:6px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; }
.modal-field input {
  width:100%; padding:10px 14px; background:var(--surface); border:1px solid var(--border);
  border-radius:var(--radius-md,10px); color:var(--text); font-size:14px;
  font-family:'Consolas','Monaco',monospace;
}
.modal-field input:focus { outline:none; border-color:var(--primary); }
.modal-footer { display:flex; gap:8px; justify-content:flex-end; margin-top:24px; }
</style>
<script src="/assets/js/core.js"></script>
<script src="/assets/js/nav-flyout.js"></script>
<script src="/assets/js/hybrid-router.js"></script>
<script src="/assets/js/enhanced-ui.js"></script>
<script src="/assets/js/connection-monitor.js"></script>
<script src="/assets/js/keyboard-shortcuts.js"></script>
<script src="/assets/js/daemon-api.js"></script>
</head>
<body>
<!-- D-PlaneOS v3.0.0 Navigation -->
<nav class="nav-container">
  <div class="nav-main">
    <div style="display:flex;align-items:center;gap:16px;">
      <div class="logo">D-PlaneOS<span class="version-badge">v3.0.0</span></div>
    </div>
    <div class="nav-links">
      <button class="nav-link" onclick="navigateToSection('dashboard')" data-section="dashboard">Dashboard</button>
      <button class="nav-link" onclick="toggleSubNav('storage',this)" data-section="storage">Storage</button>
      <button class="nav-link active" onclick="toggleSubNav('compute',this)" data-section="compute">Compute</button>
      <button class="nav-link" onclick="toggleSubNav('network',this)" data-section="network">Network</button>
      <button class="nav-link" onclick="toggleSubNav('identity',this)" data-section="identity">Identity</button>
      <button class="nav-link" onclick="toggleSubNav('security',this)" data-section="security">Security</button>
      <button class="nav-link" onclick="toggleSubNav('system',this)" data-section="system">System</button>
    </div>
    <div class="nav-actions">
      <button class="nav-action-btn" onclick="showKeyboardHelp()" title="Keyboard Shortcuts (?)"><span class="material-symbols-rounded">keyboard</span></button>
      <div class="connection-status online" id="navConnectionStatus"><span class="status-dot"></span><span>Connected</span></div>
    </div>
  </div>
  <div id="sub-storage" class="nav-sub"><div class="nav-sub-inner">
    <a href="pools.html" class="sub-link" data-page="pools"><span class="material-symbols-rounded">database</span>ZFS Pools</a>
    <a href="pools-advanced.html" class="sub-link" data-page="pools-advanced"><span class="material-symbols-rounded">photo_camera</span>Snapshots</a>
    <a href="shares.html" class="sub-link" data-page="shares"><span class="material-symbols-rounded">folder_shared</span>Shares</a>
    <a href="replication.html" class="sub-link" data-page="replication"><span class="material-symbols-rounded">sync</span>Replication</a>
  </div></div>
  <div id="sub-compute" class="nav-sub" style="display:flex;"><div class="nav-sub-inner">
    <a href="docker.html" class="sub-link active" data-page="docker"><span class="material-symbols-rounded">dns</span>Docker Stacks</a>
    <a href="git-sync.html" class="sub-link" data-page="git-sync"><span class="material-symbols-rounded">sync</span>Git Sync</a>
    <a href="modules.html" class="sub-link" data-page="modules"><span class="material-symbols-rounded">extension</span>App Modules</a>
  </div></div>
  <div id="sub-network" class="nav-sub"><div class="nav-sub-inner">
    <a href="network.html" class="sub-link" data-page="network"><span class="material-symbols-rounded">lan</span>Interfaces</a>
    <a href="dns.html" class="sub-link" data-page="dns"><span class="material-symbols-rounded">dns</span>DNS</a>
    <a href="vpn.html" class="sub-link" data-page="vpn"><span class="material-symbols-rounded">vpn_lock</span>VPN</a>
  </div></div>
  <div id="sub-identity" class="nav-sub"><div class="nav-sub-inner">
    <a href="users.html" class="sub-link" data-page="users"><span class="material-symbols-rounded">group</span>Users</a>
    <a href="permissions.html" class="sub-link" data-page="permissions"><span class="material-symbols-rounded">admin_panel_settings</span>Permissions</a>
  </div></div>
  <div id="sub-security" class="nav-sub"><div class="nav-sub-inner">
    <a href="security.html" class="sub-link" data-page="security"><span class="material-symbols-rounded">shield</span>Overview</a>
    <a href="audit-log.html" class="sub-link" data-page="audit-log"><span class="material-symbols-rounded">history</span>Audit Log</a>
  </div></div>
  <div id="sub-system" class="nav-sub"><div class="nav-sub-inner">
    <a href="settings.html" class="sub-link" data-page="settings"><span class="material-symbols-rounded">settings</span>Settings</a>
    <a href="reporting.html" class="sub-link" data-page="reporting"><span class="material-symbols-rounded">monitoring</span>Monitoring</a>
    <a href="notifications.html" class="sub-link" data-page="notifications"><span class="material-symbols-rounded">notifications</span>Alerts</a>
  </div></div>
</nav>

<!-- ═══════════════════════════════════════════════════════════ -->
<div class="dock-shell">

  <!-- ─── Left Sidebar ─────────────────────────────────────── -->
  <aside class="dock-sidebar">
    <div class="sidebar-header">
      <h2>Stacks</h2>
      <button class="btn-compose" onclick="openNewStackModal()">
        <span class="material-symbols-rounded" style="font-size:16px;">add</span> Compose
      </button>
    </div>
    <div class="sidebar-search" style="position:relative;">
      <span class="material-symbols-rounded s-icon">search</span>
      <input type="text" id="stackSearch" placeholder="Search stacks..." oninput="renderSidebar()">
    </div>
    <div class="stack-list" id="stackList">
      <div class="skeleton" style="height:36px;margin:4px 0;"></div>
      <div class="skeleton" style="height:36px;margin:4px 0;"></div>
      <div class="skeleton" style="height:36px;margin:4px 0;"></div>
    </div>
    <!-- Status Counts (like Dockge) -->
    <div style="padding:8px 16px;border-top:1px solid var(--border-subtle);" id="statusCounts">
      <div style="display:flex;gap:8px;justify-content:center;">
        <span style="font-size:11px;padding:3px 8px;border-radius:6px;background:rgba(16,185,129,0.12);color:#34d399;" id="countActive">0 active</span>
        <span style="font-size:11px;padding:3px 8px;border-radius:6px;background:rgba(239,68,68,0.12);color:#f87171;" id="countExited">0 exited</span>
        <span style="font-size:11px;padding:3px 8px;border-radius:6px;background:rgba(255,255,255,0.06);color:var(--text-dim);" id="countInactive">0 inactive</span>
      </div>
    </div>
    <!-- Docker Run → Compose Converter -->
    <div style="padding:12px 16px;border-top:1px solid var(--border-subtle);">
      <div style="font-size:11px;color:var(--text-dim);margin-bottom:6px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Docker Run</div>
      <div style="display:flex;gap:6px;">
        <input type="text" id="dockerRunInput" placeholder="docker run -d -p 8080:80 nginx" style="flex:1;padding:7px 10px;background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:12px;font-family:monospace;">
        <button class="c-btn" onclick="convertDockerRun()" style="white-space:nowrap;font-size:11px;padding:6px 10px;">Convert</button>
      </div>
    </div>
  </aside>

  <!-- ─── Main Content ─────────────────────────────────────── -->
  <main class="dock-main" id="mainContent">
    <div id="permIssues"></div>
    <div class="empty-state" id="welcomeState">
      <span class="material-symbols-rounded">deployed_code</span>
      <h3>Docker Stack Management</h3>
      <p>Select a stack from the sidebar, or create a new one. Paste any docker-compose.yml and deploy instantly — native ZFS snapshots protect your data.</p>
      <button class="btn-compose" style="margin-top:20px;" onclick="openNewStackModal()">
        <span class="material-symbols-rounded" style="font-size:16px;">add</span> New Stack
      </button>
    </div>

    <div id="stackDetail" style="display:none;">
      <div class="stack-header">
        <div class="stack-status-badge" id="detailBadge">running</div>
        <div class="stack-title" id="detailTitle">my-stack</div>
        <div class="stack-actions" id="stackActions">
          <!-- Edit mode buttons (shown when editing) -->
          <span id="editModeButtons" style="display:none;">
            <button class="action-btn" style="background:rgba(138,156,255,0.12);color:var(--primary);border-color:rgba(138,156,255,0.3);" onclick="deployFromEdit()"><span class="material-symbols-rounded" style="font-size:16px;">rocket_launch</span> Deploy</button>
            <button class="action-btn" onclick="saveDraft()"><span class="material-symbols-rounded" style="font-size:16px;">save</span> Save Draft</button>
            <button class="action-btn" onclick="discardEdit()"><span class="material-symbols-rounded" style="font-size:16px;">undo</span> Discard</button>
          </span>
          <!-- View mode buttons (shown by default) -->
          <span id="viewModeButtons">
            <button class="action-btn" onclick="enableEditMode()"><span class="material-symbols-rounded" style="font-size:16px;">edit</span> Edit</button>
            <button class="action-btn" id="btnStart" onclick="doStackAction('start')"><span class="material-symbols-rounded" style="font-size:16px;">play_arrow</span> Start</button>
            <button class="action-btn" id="btnRestart" onclick="doStackAction('restart')"><span class="material-symbols-rounded" style="font-size:16px;">refresh</span> Restart</button>
            <button class="action-btn" onclick="pullAndRedeploy()"><span class="material-symbols-rounded" style="font-size:16px;">cloud_download</span> Update</button>
            <button class="action-btn" id="btnStop" onclick="doStackAction('stop')"><span class="material-symbols-rounded" style="font-size:16px;">stop</span> Stop</button>
            <button class="action-btn" id="btnDown" onclick="doStackAction('down')" title="Stop and remove containers"><span class="material-symbols-rounded" style="font-size:16px;">delete_sweep</span> Down</button>
            <button class="action-btn danger" onclick="deleteCurrentStack()"><span class="material-symbols-rounded" style="font-size:16px;">delete</span> Delete</button>
          </span>
        </div>
      </div>

      <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('containers',this)"><span class="material-symbols-rounded" style="font-size:16px;vertical-align:-3px;">dns</span> Containers</button>
        <button class="tab-btn" onclick="switchTab('yaml',this)"><span class="material-symbols-rounded" style="font-size:16px;vertical-align:-3px;">code</span> compose.yaml</button>
        <button class="tab-btn" onclick="switchTab('logs',this)"><span class="material-symbols-rounded" style="font-size:16px;vertical-align:-3px;">terminal</span> Logs</button>
      </div>

      <!-- Tab: Containers -->
      <div class="tab-panel active" id="tab-containers">
        <div id="containerCards"></div>
      </div>

      <!-- Tab: YAML + .env (side by side like Dockge) -->
      <div class="tab-panel" id="tab-yaml">
        <div class="yaml-actions" id="yamlActions">
          <span class="yaml-filename"><span class="material-symbols-rounded" style="font-size:16px;">description</span> docker-compose.yml</span>
          <div style="flex:1;"></div>
          <span id="yamlEditBtns" style="display:none;">
            <button class="action-btn" onclick="saveYAML(false)"><span class="material-symbols-rounded" style="font-size:16px;">save</span> Save</button>
            <button class="action-btn" style="background:rgba(138,156,255,0.1);color:var(--primary);border-color:rgba(138,156,255,0.3);" onclick="saveYAML(true)"><span class="material-symbols-rounded" style="font-size:16px;">rocket_launch</span> Save &amp; Deploy</button>
          </span>
          <span id="yamlViewBtns">
            <span style="font-size:12px;color:var(--text-dimmer);padding:6px 10px;border:1px dashed var(--border-subtle);border-radius:8px;">Read-only — click Edit to modify</span>
          </span>
        </div>
        <div style="display:grid;grid-template-columns:1fr 340px;gap:16px;">
          <div>
            <div class="yaml-wrap">
              <div class="yaml-lines" id="yamlLines"></div>
              <textarea class="yaml-editor" id="yamlEditor" spellcheck="false" readonly oninput="updateLineNumbers()" onscroll="document.getElementById('yamlLines').scrollTop=this.scrollTop"></textarea>
            </div>
          </div>
          <div>
            <div style="font-size:12px;color:var(--text-dim);margin-bottom:8px;display:flex;align-items:center;gap:6px;">
              <span class="material-symbols-rounded" style="font-size:16px;">key</span> .env
            </div>
            <div class="yaml-wrap" style="grid-template-columns:1fr;">
              <textarea class="yaml-editor" id="envEditor" spellcheck="false" readonly placeholder="# Environment variables&#10;DB_HOST=localhost&#10;DB_PORT=5432&#10;SECRET_KEY=change-me" style="min-height:400px;padding:16px;font-size:12px;"></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab: Logs -->
      <div class="tab-panel" id="tab-logs">
        <div class="log-panel">
          <div class="log-header">
            <span class="material-symbols-rounded" style="font-size:18px;color:var(--primary);">terminal</span>
            <h3>Container Logs</h3>
            <select class="log-select" id="logContainerSelect" onchange="loadLogs()"><option value="">Select container...</option></select>
            <button class="c-btn" onclick="loadLogs()"><span class="material-symbols-rounded">refresh</span></button>
            <button class="c-btn" onclick="toggleAutoScroll()" title="Auto-scroll"><span class="material-symbols-rounded" id="autoScrollIcon">vertical_align_bottom</span></button>
          </div>
          <div class="log-body" id="logBody">Select a container to view logs...</div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- ─── New Stack Modal ──────────────────────────────────── -->
<div class="modal-overlay" id="newStackModal">
  <div class="modal-box">
    <div class="modal-title">+ New Stack</div>
    <div class="modal-field">
      <label>Stack Name</label>
      <input type="text" id="newStackName" placeholder="my-app" oninput="this.value=this.value.toLowerCase().replace(/[^a-z0-9_-]/g,'')">
    </div>
    <div class="modal-field">
      <label>compose.yaml</label>
      <div class="yaml-wrap" style="max-height:300px;">
        <div class="yaml-lines" id="modalYamlLines"></div>
        <textarea class="yaml-editor" id="modalYamlEditor" spellcheck="false" style="min-height:240px;" oninput="updateModalLines()" onscroll="document.getElementById('modalYamlLines').scrollTop=this.scrollTop">services:
  app:
    image: nginx:latest
    ports:
      - "8080:80"
    restart: unless-stopped</textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="action-btn" onclick="closeModal()">Cancel</button>
      <button class="btn-compose" onclick="deployNewStack()"><span class="material-symbols-rounded" style="font-size:16px;">rocket_launch</span> Deploy</button>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════════
     Application Logic
     ═══════════════════════════════════════════════════════════ -->
<script>
/* ─── State ──────────────────────────────────────────────── */
let allStacks = [];
let currentStack = null;
let autoScroll = true;
let logTimer = null;

/* ─── Init ───────────────────────────────────────────────── */
document.addEventListener('DOMContentLoaded', () => {
  loadAllData();
  setInterval(loadAllData, 12000);
  updateModalLines();
});

/* ─── Data Loading ───────────────────────────────────────── */
async function loadAllData() {
  try {
    const [sRes, cRes] = await Promise.all([
      csrfFetch('/api/docker/stacks').then(r=>r.json()).catch(()=>({success:false})),
      csrfFetch('/api/docker/containers').then(r=>r.json()).catch(()=>({success:false}))
    ]);

    const managed = (sRes.success && sRes.stacks) ? sRes.stacks : [];
    const containers = (cRes.success && cRes.containers) ? cRes.containers : [];

    // Group containers by compose project
    const managedNames = new Set(managed.map(s=>s.name));
    const byProject = {};
    containers.forEach(c => {
      const k = c.Stack || 'ungrouped';
      if (!byProject[k]) byProject[k] = [];
      byProject[k].push(c);
    });

    const unified = [];

    // Managed stacks
    managed.forEach(s => {
      const cs = byProject[s.name] || [];
      unified.push({
        name:s.name, managed:true,
        status: cs.length ? computeStatus(cs) : (s.status||'stopped'),
        containers:cs, count:Math.max(cs.length,(s.services||[]).length), path:s.path
      });
    });

    // Unmanaged compose projects
    Object.keys(byProject).forEach(k => {
      if (!managedNames.has(k) && k !== 'ungrouped') {
        const cs = byProject[k];
        unified.push({ name:k, managed:false, status:computeStatus(cs), containers:cs, count:cs.length });
      }
    });

    // Standalone containers
    if (byProject['ungrouped'] && byProject['ungrouped'].length) {
      unified.push({ name:'ungrouped', managed:false, status:computeStatus(byProject['ungrouped']), containers:byProject['ungrouped'], count:byProject['ungrouped'].length });
    }

    allStacks = unified;
    renderSidebar();
    updateStatusCounts();

    if (currentStack) {
      const found = allStacks.find(s=>s.name===currentStack);
      if (found) renderDetail(found);
    }

    // Load stats in background (non-blocking)
    loadContainerStats();
    // Check exited containers for permission issues (non-blocking)
    checkPermissionIssues(containers);
  } catch(e) { console.error('loadAllData:',e); }
}

let containerStats = {}; // name → {cpu, memory, mem_perc, net_io, block_io}

async function loadContainerStats() {
  try {
    const r = await csrfFetch('/api/docker/stats');
    const d = await r.json();
    if (d.success && d.containers) {
      containerStats = {};
      d.containers.forEach(s => { containerStats[s.name] = s; });
      // Re-render current detail if visible
      if (currentStack) {
        const found = allStacks.find(s=>s.name===currentStack);
        if (found) renderContainers(found.containers);
      }
    }
  } catch(e) { /* stats are optional */ }
}

function updateStatusCounts() {
  let active=0, exited=0, inactive=0;
  allStacks.forEach(s => {
    if (s.status==='running') active++;
    else if (s.status==='stopped') inactive++;
    else exited++;
  });
  const ea = document.getElementById('countActive');
  const ee = document.getElementById('countExited');
  const ei = document.getElementById('countInactive');
  if(ea) ea.textContent = active+' active';
  if(ee) ee.textContent = exited+' exited';
  if(ei) ei.textContent = inactive+' inactive';
}

function computeStatus(cs) {
  if (!cs||!cs.length) return 'stopped';
  const r = cs.filter(c=>c.State==='running').length;
  return r===cs.length ? 'running' : r>0 ? 'partial' : 'stopped';
}

/* ─── Sidebar ────────────────────────────────────────────── */
function renderSidebar() {
  const el = document.getElementById('stackList');
  const q = (document.getElementById('stackSearch').value||'').toLowerCase();
  const list = allStacks.filter(s=>s.name.includes(q));

  if (!list.length) {
    el.innerHTML = '<div style="padding:24px 16px;text-align:center;color:var(--text-dim);font-size:13px;">'+(q?'No match for "'+q+'"':'No stacks yet — click + Compose')+'</div>';
    return;
  }

  el.innerHTML = list.map(s =>
    '<div class="stack-item'+(currentStack===s.name?' active':'')+'" onclick="selectStack(\''+s.name+'\')">' +
      '<span class="stack-dot '+s.status+'"></span>' +
      '<span class="stack-item-name">'+s.name+'</span>' +
      (!s.managed?'<span style="font-size:10px;color:var(--text-dimmer);" title="External project">ext</span>':'') +
      '<span class="stack-item-count">'+s.count+'</span>' +
    '</div>'
  ).join('');
}

/* ─── Stack Selection ────────────────────────────────────── */
function selectStack(name) {
  currentStack = name;
  const s = allStacks.find(x=>x.name===name);
  if (!s) return;
  document.getElementById('welcomeState').style.display='none';
  document.getElementById('stackDetail').style.display='block';
  renderSidebar();
  renderDetail(s);
  if (s.managed) loadStackYAML(name);
  else {
    document.getElementById('yamlEditor').value='# External compose project\n# YAML not managed by D-PlaneOS';
    updateLineNumbers();
  }
}

function renderDetail(s) {
  disableEditMode(); // Reset edit mode when switching stacks
  const b = document.getElementById('detailBadge');
  b.textContent = s.status; b.className='stack-status-badge '+s.status;
  document.getElementById('detailTitle').textContent = s.name;
  renderContainers(s.containers);

  // Show/hide Start vs Stop based on status
  const isRunning = s.status === 'running';
  const btnStart = document.getElementById('btnStart');
  const btnRestart = document.getElementById('btnRestart');
  const btnStop = document.getElementById('btnStop');
  if (btnStart) btnStart.style.display = isRunning ? 'none' : '';
  if (btnRestart) btnRestart.style.display = isRunning ? '' : 'none';
  if (btnStop) btnStop.style.display = isRunning ? '' : 'none';

  const sel = document.getElementById('logContainerSelect');
  sel.innerHTML = '<option value="">Select container...</option>' +
    s.containers.map(c=>'<option value="'+(c.Name||c.name)+'">'+(c.Name||c.name)+'</option>').join('');
}

/* ─── Container Cards ────────────────────────────────────── */
function renderContainers(containers) {
  const el = document.getElementById('containerCards');
  if (!containers||!containers.length) {
    el.innerHTML='<div class="empty-state" style="padding:40px;"><span class="material-symbols-rounded">cloud_off</span><h3>No containers</h3><p>Start the stack or check compose.yaml.</p></div>';
    return;
  }

  el.innerHTML = containers.map(c => {
    const name = c.Name||c.name||'?';
    const image = c.Image||'';
    const state = (c.State||'unknown').toLowerCase();
    const status = c.Status||c.State||'';
    const ports = c.Ports||[];

    const webPorts = ports.filter(p=>p.PublicPort>0).map(p =>
      '<a href="http://'+location.hostname+':'+p.PublicPort+'" target="_blank" rel="noopener" class="port-chip" title="Open in new tab">' +
        '<span class="material-symbols-rounded">open_in_new</span>' +
        ':'+p.PublicPort+(p.PrivatePort!==p.PublicPort?'&#8594;'+p.PrivatePort:'') +
      '</a>'
    );
    const intPorts = ports.filter(p=>!p.PublicPort&&p.PrivatePort).map(p =>
      '<span class="port-chip internal">'+p.PrivatePort+'/'+(p.Type||'tcp')+'</span>'
    );
    const allPorts = webPorts.concat(intPorts);

    // Stats from background fetch
    const st = containerStats[name] || {};
    const statsHTML = st.cpu ? (
      '<div style="display:flex;gap:12px;margin-top:10px;padding-top:10px;border-top:1px solid var(--border-subtle);font-size:11px;color:var(--text-dim);">' +
        '<span title="CPU"><span class="material-symbols-rounded" style="font-size:13px;vertical-align:-2px;">speed</span> '+esc(st.cpu)+'</span>' +
        '<span title="Memory"><span class="material-symbols-rounded" style="font-size:13px;vertical-align:-2px;">memory</span> '+esc(st.memory)+'</span>' +
        '<span title="Network I/O"><span class="material-symbols-rounded" style="font-size:13px;vertical-align:-2px;">swap_horiz</span> '+esc(st.net_io)+'</span>' +
        '<span title="Block I/O"><span class="material-symbols-rounded" style="font-size:13px;vertical-align:-2px;">storage</span> '+esc(st.block_io)+'</span>' +
      '</div>'
    ) : '';

    // Network info from labels
    const labels = c.Labels || {};
    const nets = Object.keys(labels).filter(k=>k.startsWith('com.docker.compose.network')).map(k=>labels[k]);
    const netHTML = nets.length ? '<span style="font-size:11px;color:var(--text-dimmer);margin-left:8px;">net: '+nets.join(', ')+'</span>' : '';

    return '<div class="container-card"><div class="container-row">' +
      '<span class="container-dot '+state+'"></span>' +
      '<div class="container-detail">' +
        '<div class="container-name-text">'+name+netHTML+'</div>' +
        '<div class="container-image">'+esc(image)+'</div>' +
      '</div>' +
      '<div class="port-chips">'+(allPorts.length?allPorts.join(''):'<span style="color:var(--text-dimmer);font-size:12px;">no ports</span>')+'</div>' +
      '<div class="status-pill '+state+'">'+esc(status)+'</div>' +
      '<div style="display:flex;gap:4px;">' +
        '<button class="c-btn" onclick="viewLogs(\''+esc(name)+'\')" title="Logs"><span class="material-symbols-rounded">description</span></button>' +
        '<button class="c-btn" onclick="doContainerAction(\''+esc(name)+'\',\''+(state==='running'?'stop':'start')+'\')" title="'+(state==='running'?'Stop':'Start')+'"><span class="material-symbols-rounded">'+(state==='running'?'stop':'play_arrow')+'</span></button>' +
        '<button class="c-btn" onclick="doContainerAction(\''+esc(name)+'\',\'restart\')" title="Restart"><span class="material-symbols-rounded">refresh</span></button>' +
      '</div>' +
    '</div>'+statsHTML+'</div>';
  }).join('');
}

/* ─── Actions ────────────────────────────────────────────── */
async function doContainerAction(name, action) {
  try {
    const r = await csrfFetch('/api/docker/action',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:action,container:name})});
    const d = await r.json();
    d.success ? EnhancedUI.toast(name+' '+action+'ed','success') : EnhancedUI.toast(d.error||'Failed','error');
    setTimeout(loadAllData,1000);
  } catch(e){ EnhancedUI.toast('Error: '+e.message,'error'); }
}

async function doStackAction(action) {
  if (!currentStack) return;
  const s = allStacks.find(x=>x.name===currentStack);
  if (!s) return;

  if (s.managed) {
    try {
      const r = await csrfFetch('/api/docker/stacks/action',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:currentStack,action:action})});
      const d = await r.json();
      d.success ? EnhancedUI.toast('Stack '+action+'ed','success') : EnhancedUI.toast(d.error||'Failed','error');
      setTimeout(loadAllData,1500);
    } catch(e){ EnhancedUI.toast('Error: '+e.message,'error'); }
  } else {
    for (const c of s.containers) await doContainerAction(c.Name||c.name,action);
  }
}

async function pullAndRedeploy() {
  if (!currentStack) return;
  const s = allStacks.find(x=>x.name===currentStack);
  if (!s||!s.managed) { EnhancedUI.toast('Only managed stacks can be updated','warning'); return; }

  EnhancedUI.toast('Pulling latest images...','info');
  try {
    const images = [...new Set(s.containers.map(c=>c.Image).filter(Boolean))];
    for (const img of images) {
      await csrfFetch('/api/docker/pull',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({image:img})});
    }
    await csrfFetch('/api/docker/stacks/action',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:currentStack,action:'start'})});
    EnhancedUI.toast('Stack updated','success');
    setTimeout(loadAllData,2000);
  } catch(e){ EnhancedUI.toast('Update failed: '+e.message,'error'); }
}

async function deleteCurrentStack() {
  if (!currentStack) return;
  const s = allStacks.find(x=>x.name===currentStack);
  if (!s||!s.managed) { EnhancedUI.toast('Only managed stacks can be deleted','warning'); return; }
  if (!confirm('Delete stack "'+currentStack+'"?\n\nThis stops all containers and removes the compose file.')) return;

  try {
    const r = await csrfFetch('/api/docker/stacks?name='+encodeURIComponent(currentStack),{method:'DELETE'});
    const d = await r.json();
    if (d.success) {
      EnhancedUI.toast('Stack deleted','success');
      currentStack = null;
      document.getElementById('stackDetail').style.display='none';
      document.getElementById('welcomeState').style.display='flex';
      setTimeout(loadAllData,500);
    } else { EnhancedUI.toast(d.error||'Failed','error'); }
  } catch(e){ EnhancedUI.toast('Error: '+e.message,'error'); }
}

/* ─── YAML Editor ────────────────────────────────────────── */
async function loadStackYAML(name) {
  try {
    const r = await csrfFetch('/api/docker/stacks/yaml?name='+encodeURIComponent(name));
    const d = await r.json();
    document.getElementById('yamlEditor').value = (d.success&&d.yaml) ? d.yaml : '# YAML not available';
    document.getElementById('envEditor').value = (d.success&&d.env) ? d.env : '';
    updateLineNumbers();
  } catch(e){ document.getElementById('yamlEditor').value='# Error loading YAML'; updateLineNumbers(); }
}

async function saveYAML(redeploy) {
  if (!currentStack) return;
  const yaml = document.getElementById('yamlEditor').value;
  const env = document.getElementById('envEditor').value;
  if (!yaml.trim()) { EnhancedUI.toast('YAML is empty','warning'); return; }
  try {
    const r = await csrfFetch('/api/docker/stacks/yaml',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:currentStack,yaml:yaml,env:env,redeploy:redeploy})});
    const d = await r.json();
    d.success ? EnhancedUI.toast(redeploy?'Saved & redeployed':'YAML saved','success') : EnhancedUI.toast(d.error||d.redeploy_error||'Failed','error');
    if (redeploy) setTimeout(loadAllData,2000);
  } catch(e){ EnhancedUI.toast('Error: '+e.message,'error'); }
}

function updateLineNumbers() {
  const ed = document.getElementById('yamlEditor');
  const n = ed.value.split('\n').length;
  const el = document.getElementById('yamlLines');
  let h = '';
  for (let i=1;i<=Math.max(n,20);i++) h+='<div>'+i+'</div>';
  el.innerHTML = h;
}

function updateModalLines() {
  const ed = document.getElementById('modalYamlEditor');
  const n = ed.value.split('\n').length;
  const el = document.getElementById('modalYamlLines');
  let h='';
  for(let i=1;i<=Math.max(n,8);i++) h+='<div>'+i+'</div>';
  el.innerHTML=h;
}

/* ─── Logs ───────────────────────────────────────────────── */
function viewLogs(name) {
  switchTab('logs',document.querySelectorAll('.tab-btn')[2]);
  document.getElementById('logContainerSelect').value = name;
  loadLogs();
}

async function loadLogs() {
  const name = document.getElementById('logContainerSelect').value;
  const body = document.getElementById('logBody');
  if (!name) { body.textContent='Select a container to view logs...'; return; }
  try {
    const r = await csrfFetch('/api/docker/logs?container='+encodeURIComponent(name)+'&lines=500');
    const d = await r.json();
    if (d.success && d.logs) {
      body.innerHTML = d.logs.split('\n').map(line => {
        if (/error|fatal|panic|exception/i.test(line)) return '<span class="log-line-error">'+esc(line)+'</span>';
        if (/warn|warning/i.test(line)) return '<span class="log-line-warn">'+esc(line)+'</span>';
        return esc(line);
      }).join('\n');
      if (autoScroll) body.scrollTop = body.scrollHeight;
    } else { body.textContent = d.error||'No logs available'; }
  } catch(e){ body.textContent='Error: '+e.message; }
}

function toggleAutoScroll() {
  autoScroll=!autoScroll;
  document.getElementById('autoScrollIcon').textContent = autoScroll?'vertical_align_bottom':'expand_less';
}

/* ─── Tabs ───────────────────────────────────────────────── */
function switchTab(id, btn) {
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  if(btn) btn.classList.add('active');
  const p = document.getElementById('tab-'+id);
  if(p) p.classList.add('active');

  if (id==='logs') {
    if(logTimer) clearInterval(logTimer);
    logTimer = setInterval(loadLogs,5000);
  } else {
    if(logTimer){clearInterval(logTimer);logTimer=null;}
  }
}

/* ─── Modal ──────────────────────────────────────────────── */
function openNewStackModal() {
  document.getElementById('newStackModal').classList.add('open');
  setTimeout(()=>document.getElementById('newStackName').focus(),200);
}
function closeModal() { document.getElementById('newStackModal').classList.remove('open'); }
document.getElementById('newStackModal').addEventListener('click',function(e){ if(e.target===this) closeModal(); });

async function deployNewStack() {
  const name = document.getElementById('newStackName').value.trim();
  const yaml = document.getElementById('modalYamlEditor').value.trim();
  if (!name) { EnhancedUI.toast('Stack name required','warning'); return; }
  if (!/^[a-z0-9][a-z0-9_-]{0,62}$/.test(name)) { EnhancedUI.toast('Invalid name','warning'); return; }
  if (!yaml||!yaml.includes('services:')) { EnhancedUI.toast('YAML must contain services:','warning'); return; }

  try {
    const r = await csrfFetch('/api/docker/stacks/deploy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:name,yaml:yaml})});
    const d = await r.json();
    if (d.success) {
      EnhancedUI.toast('Stack "'+name+'" deployed','success');
      closeModal();
      setTimeout(()=>loadAllData().then(()=>selectStack(name)),2000);
    } else {
      EnhancedUI.toast(d.error||'Deploy failed','error');
      if(d.output) console.error('Compose:',d.output);
    }
  } catch(e){ EnhancedUI.toast('Error: '+e.message,'error'); }
}

/* ─── Edit Mode (like Dockge) ────────────────────────────── */
let isEditMode = false;
let savedYAML = '', savedENV = ''; // for discard

function enableEditMode() {
  isEditMode = true;
  savedYAML = document.getElementById('yamlEditor').value;
  savedENV = document.getElementById('envEditor').value;
  document.getElementById('yamlEditor').removeAttribute('readonly');
  document.getElementById('envEditor').removeAttribute('readonly');
  document.getElementById('editModeButtons').style.display = '';
  document.getElementById('viewModeButtons').style.display = 'none';
  document.getElementById('yamlEditBtns').style.display = '';
  document.getElementById('yamlViewBtns').style.display = 'none';
}

function disableEditMode() {
  isEditMode = false;
  document.getElementById('yamlEditor').setAttribute('readonly','');
  document.getElementById('envEditor').setAttribute('readonly','');
  document.getElementById('editModeButtons').style.display = 'none';
  document.getElementById('viewModeButtons').style.display = '';
  document.getElementById('yamlEditBtns').style.display = 'none';
  document.getElementById('yamlViewBtns').style.display = '';
}

function discardEdit() {
  document.getElementById('yamlEditor').value = savedYAML;
  document.getElementById('envEditor').value = savedENV;
  updateLineNumbers();
  disableEditMode();
  EnhancedUI.toast('Changes discarded','info');
}

async function saveDraft() {
  // Save YAML+ENV without deploying
  await saveYAML(false);
  disableEditMode();
}

async function deployFromEdit() {
  // Save YAML+ENV and deploy
  await saveYAML(true);
  disableEditMode();
}

/* ─── Keyboard ───────────────────────────────────────────── */
document.addEventListener('keydown',e=>{
  if(e.key==='Escape') closeModal();
  if((e.ctrlKey||e.metaKey)&&e.key==='n'&&!e.target.closest('textarea,input')){e.preventDefault();openNewStackModal();}
});

/* ─── Docker Run → Compose Converter ─────────────────────── */
async function convertDockerRun() {
  const cmd = document.getElementById('dockerRunInput').value.trim();
  if (!cmd) { EnhancedUI.toast('Paste a docker run command','warning'); return; }
  try {
    const r = await csrfFetch('/api/docker/convert-run',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({command:cmd})});
    const d = await r.json();
    if (d.success && d.yaml) {
      // Open new stack modal pre-filled with converted YAML
      document.getElementById('newStackModal').classList.add('open');
      document.getElementById('newStackName').value = d.name || 'app';
      document.getElementById('modalYamlEditor').value = d.yaml;
      updateModalLines();
      document.getElementById('dockerRunInput').value = '';
      EnhancedUI.toast('Converted to compose.yaml','success');
    } else {
      EnhancedUI.toast(d.error||'Conversion failed','error');
    }
  } catch(e){ EnhancedUI.toast('Error: '+e.message,'error'); }
}

/* ─── Helpers ────────────────────────────────────────────── */
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

/* ─── Permission Issue Detection ─────────────────────────── */
const _permChecked = new Set();
const _permIssues = new Map();

function checkPermissionIssues(containers) {
  for (const c of containers) {
    if (_permChecked.has(c.Name)) continue;
    if (c.State === 'running' || c.State === 'created') continue;
    _permChecked.add(c.Name);
    _fetchPermLogs(c.Name, c.Image);
  }
  // Clear banners for containers that recovered
  for (const [name] of _permIssues) {
    const c = containers.find(x => x.Name === name);
    if (c && c.State === 'running') { dismissPermIssue(name); _permChecked.delete(name); }
  }
}

async function _fetchPermLogs(name, image) {
  try {
    const r = await csrfFetch('/api/docker/logs?container=' + encodeURIComponent(name));
    const d = await r.json();
    if (!d.success || !d.logs) return;
    const patterns = [/permission denied/i, /EACCES/, /operation not permitted/i, /read.only file system/i];
    if (!patterns.some(p => p.test(d.logs))) return;
    // Extract path from error
    let path = null;
    const pathRe = [
      /(?:open|stat|mkdir|chown|access|touch|write)\s+['"]?([/][^\s'",:)\]]+)/i,
      /Permission denied:\s*'([/][^']+)'/i,
      /EACCES[^/]*([/][^\s'",:)\]]+)/
    ];
    for (const re of pathRe) { const m = d.logs.match(re); if (m) { path = m[1]; break; } }
    _permIssues.set(name, { image, path });
    _renderPermBanners();
  } catch(e) { /* silent */ }
}

function dismissPermIssue(name) { _permIssues.delete(name); _renderPermBanners(); }

function _renderPermBanners() {
  const el = document.getElementById('permIssues');
  if (!el) return;
  if (_permIssues.size === 0) { el.innerHTML = ''; return; }
  let html = '';
  _permIssues.forEach((info, name) => {
    const sn = esc(name), si = esc((info.image||'').split(':')[0]);
    const pathLine = info.path ? '<br>Container path: <code>' + esc(info.path) + '</code>' : '';
    html += '<div class="perm-banner">' +
      '<span class="material-symbols-rounded perm-banner-icon">warning</span>' +
      '<div class="perm-banner-body">' +
        '<div class="perm-banner-title">Permission issue — ' + sn + '</div>' +
        '<div class="perm-banner-detail"><strong>' + sn + '</strong> (' + si + ') exited with file permission errors.' + pathLine + '</div>' +
      '</div>' +
      '<button class="perm-banner-dismiss" onclick="dismissPermIssue(' + JSON.stringify(name) + ')" title="Dismiss">&times;</button>' +
    '</div>';
  });
  el.innerHTML = html;
}
</script>
</body></html>
