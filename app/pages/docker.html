<!DOCTYPE html>
<!-- saved from url=(0140)docker.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Docker - D-PlaneOS</title>
    <link rel="stylesheet" href="/assets/css/design-tokens.css">
    <link rel="stylesheet" href="/assets/css/dplaneos-ui-complete.css">
<link rel="stylesheet" href="/assets/css/m3-tokens.css">
<link rel="stylesheet" href="/assets/css/m3-components.css">
<link rel="stylesheet" href="/assets/css/m3-icons.css">
  <link rel="stylesheet" href="/assets/css/enhanced-ui.css">
<link rel="stylesheet" href="/assets/css/m3-animations.css">
<style>
.logo { font-size: 20px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; cursor: pointer; }


.nav-link:hover, 
.main { max-width: 1600px; margin: 140px auto 60px; padding: 0 40px; }
.page-header { margin-bottom: 48px; }
.page-title { font-size: 32px; font-weight: 700; letter-spacing: -1.5px; margin-bottom: 12px; }
.page-subtitle { font-size: 18px; color: rgba(255,255,255,0.6); }
.editor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 48px; }
.card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: var(--radius-xl); padding: 32px; }
.card-title { font-size: 20px; font-weight: 800; margin-bottom: 20px; }
.yaml-editor { width: 100%; min-height: 500px; font-family: 'Consolas', 'Monaco', monospace; font-size: 14px; line-height: 1.6; padding: 20px; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: var(--text); resize: vertical; }
.yaml-editor:focus { outline: none; border-color: var(--primary); }
.btn-group { display: flex; gap: 12px; margin-top: 20px; }
.btn { background: rgba(255,255,255,0.1); color: var(--text); padding: 12px 24px; border-radius: 10px; text-decoration: none; font-weight: 500; font-size: 14px; border: none; cursor: pointer; transition: all 0.3s; }
.btn:hover { background: rgba(255,255,255,0.15); }
.btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--primary) 100%); }
.btn-primary:hover { box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4); }
.container-item { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: var(--radius-xl); padding: 24px; margin-bottom: 16px; border-left: 4px solid var(--primary); }
.container-header { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; }
.container-icon { font-size: 40px; color: var(--primary); }
.container-info { flex: 1; }
.container-name { font-size: 20px; font-weight: 700; }
.container-meta { font-size: 14px; color: rgba(255,255,255,0.5); margin-top: 4px; }
/* Badge styles are in m3-components.css */
.icon-btn { width: 40px; height: 40px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,0.8); cursor: pointer; transition: all 0.3s; border: none; }
.icon-btn:hover { background: rgba(255,255,255,0.1); color: var(--text); }
.fab { position: fixed; bottom: 32px; right: 32px; width: 64px; height: 64px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary) 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4); cursor: pointer; transition: all 0.3s; border: none; color: var(--text); }
.fab:hover { transform: translateY(-4px); box-shadow: 0 12px 48px rgba(102, 126, 234, 0.6); }
@media (max-width: 1024px) { .editor-grid { grid-template-columns: 1fr; } }
</style>
<style type="text/css" id="operaUserStyle"></style><link rel="stylesheet" href="/assets/css/ui-components.css">
<script src="/assets/js/core.js"></script>
<script src="/assets/js/nav-flyout.js"></script>
<script src="/assets/js/hybrid-router.js"></script>
  <script src="/assets/js/enhanced-ui.js"></script>
  <script src="/assets/js/connection-monitor.js"></script>
  <script src="/assets/js/keyboard-shortcuts.js"></script>
  <script src="/assets/js/form-validator.js"></script>
  <link rel="stylesheet" href="/assets/css/material-symbols-local.css">
  <link rel="stylesheet" href="/assets/css/ui-consistency.css">
  <link rel="stylesheet" href="/assets/css/ui-polish.css">
  <script src="/assets/js/daemon-api.js"></script>
</head>
<body>
<!-- D-PlaneOS v3.2.0 - Hierarchical Navigation -->
<!-- This navigation maintains all security (CSRF, Auth) and real system state -->

<div id="nav-root"></div>

<script>
// Navigation behavior
function navigateToSection(section) {
  if (section === 'dashboard') {
    window.location.href = 'index.html';
  }
}

function toggleSubNav(section, button) {
  // Remove active from all nav links
  document.querySelectorAll('.nav-link').forEach(link => {
    link.classList.remove('active');
  });
  
  // Add active to clicked button
  if (button) {
    button.classList.add('active');
  }
  
  // Hide all sub-navs
  document.querySelectorAll('.nav-sub').forEach(sub => {
    sub.classList.remove('active');
  });
  
  // Show selected sub-nav
  const subNav = document.getElementById(`sub-${section}`);
  if (subNav) {
    subNav.classList.add('active');
    document.body.classList.add('has-subnav');
  }
}

// Auto-detect current section and page on load
(function() {
  const currentPage = window.location.pathname.split('/').pop() || 'index.html';
  
  // Page to section mapping
  const pageMap = {
    'acl-manager.html': { section: 'storage', page: 'acl-manager' },
    'audit.html': { section: 'security', page: 'audit' },
    'certificates.html': { section: 'security', page: 'certificates' },
    'cloud-sync.html': { section: 'storage', page: 'cloud-sync' },
    'directory-service.html': { section: 'identity', page: 'directory-service' },
    'docker.html': { section: 'compute', page: 'docker' },
    'files-enhanced.html': { section: 'storage', page: 'files-enhanced' },
    'files.html': { section: 'storage', page: 'files' },
    'firewall.html': { section: 'security', page: 'firewall' },
    'groups.html': { section: 'identity', page: 'groups' },
    'hardware.html': { section: 'system', page: 'hardware' },
    'index.html': { section: 'dashboard', page: null },
    'ipmi.html': { section: 'system', page: 'ipmi' },
    'logs.html': { section: 'system', page: 'logs' },
    'modules.html': { section: 'compute', page: 'modules' },
    'network-dns.html': { section: 'network', page: 'network-dns' },
    'network-interfaces.html': { section: 'network', page: 'network-interfaces' },
    'network-routing.html': { section: 'network', page: 'network-routing' },
    'network.html': { section: 'network', page: 'network' },
    'pools-advanced.html': { section: 'storage', page: 'pools-advanced' },
    'pools.html': { section: 'storage', page: 'pools' },
    'power-management.html': { section: 'system', page: 'power-management' },
    'quotas.html': { section: 'storage', page: 'quotas' },
    'rbac-management.html': { section: 'identity', page: 'rbac-management' },
    'removable-media-ui.html': { section: 'system', page: 'removable-media-ui' },
    'replication.html': { section: 'storage', page: 'replication' },
    'reporting.html': { section: 'system', page: 'reporting' },
    'security.html': { section: 'security', page: 'security' },
    'settings.html': { section: 'system', page: 'settings' },
    'shares.html': { section: 'storage', page: 'shares' },
    'snapshot-scheduler.html': { section: 'storage', page: 'snapshot-scheduler' },
    'system-monitoring.html': { section: 'system', page: 'system-monitoring' },
    'system-settings.html': { section: 'system', page: 'system-settings' },
    'ups.html': { section: 'system', page: 'ups' },
    'users.html': { section: 'identity', page: 'users' },
    'zfs-encryption.html': { section: 'storage', page: 'zfs-encryption' }
  };
  
  const current = pageMap[currentPage];
  if (current) {
    // Activate section button
    const sectionBtn = document.querySelector(`[data-section="${current.section}"]`);
    if (sectionBtn) {
      sectionBtn.classList.add('active');
    }
    
    // Show and activate sub-nav if not dashboard
    if (current.section !== 'dashboard') {
      const subNav = document.getElementById(`sub-${current.section}`);
      if (subNav) {
        subNav.classList.add('active');
        document.body.classList.add('has-subnav');
        
        // Activate current page in sub-nav
        if (current.page) {
          const pageLink = subNav.querySelector(`[data-page="${current.page}"]`);
          if (pageLink) {
            pageLink.classList.add('active');
          }
        }
      }
    }
  }
})();

// Keyboard shortcuts
function showKeyboardHelp() {
  if (window.EnhancedUI) {
    const shortcuts = `Keyboard Shortcuts:

g + d → Dashboard
g + s → Storage
g + c → Compute
g + n → Network
g + u → Identity
g + e → Security
g + y → System

r → Refresh page
Esc → Close modals
? → Show this help`;
    EnhancedUI.toast(shortcuts, 'info', 8000);
  }
}

// Enhanced keyboard shortcuts for sections
(function() {
  let keySequence = '';
  let keyTimeout;
  
  document.addEventListener('keydown', (e) => {
    if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) return;
    
    keySequence += e.key;
    clearTimeout(keyTimeout);
    
    const shortcuts = {
      'gd': 'index.html',
      'gs': () => toggleSubNav('storage', document.querySelector('[data-section="storage"]')),
      'gc': () => toggleSubNav('compute', document.querySelector('[data-section="compute"]')),
      'gn': () => toggleSubNav('network', document.querySelector('[data-section="network"]')),
      'gu': () => toggleSubNav('identity', document.querySelector('[data-section="identity"]')),
      'ge': () => toggleSubNav('security', document.querySelector('[data-section="security"]')),
      'gy': () => toggleSubNav('system', document.querySelector('[data-section="system"]'))
    };
    
    if (shortcuts[keySequence]) {
      e.preventDefault();
      const action = shortcuts[keySequence];
      if (typeof action === 'function') {
        action();
      } else {
        window.location.href = action;
      }
      keySequence = '';
    } else if (e.key === '?') {
      e.preventDefault();
      showKeyboardHelp();
    }
    
    keyTimeout = setTimeout(() => keySequence = '', 1000);
  });
})();

// Connection status monitoring (integrates with existing connection-monitor.js)
if (window.ConnectionMonitor) {
  window.ConnectionMonitor.on('statusChange', (online) => {
    const status = document.getElementById('navConnectionStatus');
    if (status) {
      if (online) {
        status.classList.remove('offline');
        status.classList.add('online');
        status.innerHTML = '<span class="status-dot"></span><span>Connected</span>';
      } else {
        status.classList.remove('online');
        status.classList.add('offline');
        status.innerHTML = '<span class="status-dot"></span><span>Offline</span>';
      }
    }
  });
}
</script>

<main class="main">
<div class="page-header">
<h1 class="page-title">Docker Compose</h1>
<p class="page-subtitle">Native YAML editor • Copy from tutorials • Deploy instantly</p>
</div>
<div class="editor-grid">
<div class="card">
<h2 class="card-title">compose.yaml</h2>
<textarea id="yamlEditor" class="yaml-editor" placeholder="Paste your docker-compose.yaml here...">version: '3.8'

services:
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Berlin
    volumes:
      - /path/to/media:/media
      - /path/to/config/jellyfin:/config
    ports:
      - 8096:8096
    restart: unless-stopped

  nextcloud:
    image: nextcloud:latest
    container_name: nextcloud
    environment:
      - PUID=1000
      - PGID=1000
    volumes:
      - /path/to/nextcloud:/var/www/html
    ports:
      - 8080:80
    restart: unless-stopped</textarea>
<div class="btn-group">
<button class="btn btn-primary" onclick="deployStack()"><span class="material-symbols-rounded" style="font-size:16px;vertical-align:middle;">play_arrow</span> Deploy Stack</button>
<button class="btn" onclick="validateYAML()"><span class="material-symbols-rounded" style="font-size:16px;vertical-align:middle;">check_circle</span> Validate</button>
<button class="btn" onclick="document.getElementById(&#39;yamlEditor&#39;).value=&#39;&#39;"><span class="material-symbols-rounded" style="font-size:16px;vertical-align:middle;">delete</span> Clear</button>
</div>
</div>
<div class="card">
<h2 class="card-title">How to Use</h2>
<div style="margin-bottom:24px;">
<div style="display:flex;align-items:start;gap:12px;margin-bottom:16px;">
<span class="material-symbols-rounded" style="font-size:24px;color:var(--primary);">lightbulb</span>
<div><strong>Copy &amp; Paste</strong><p style="color:rgba(255,255,255,0.6);margin-top:4px;">Find docker-compose.yaml on GitHub → Copy → Paste → Deploy</p></div>
</div>
<div style="display:flex;align-items:start;gap:12px;margin-bottom:16px;">
<span class="material-symbols-rounded" style="font-size:24px;color:var(--primary);">edit</span>
<div><strong>Edit Inline</strong><p style="color:rgba(255,255,255,0.6);margin-top:4px;">Modify ports, volumes, environment variables</p></div>
</div>
<div style="display:flex;align-items:start;gap:12px;">
<span class="material-symbols-rounded" style="font-size:24px;color:var(--primary);">deployed_code</span>
<div><strong>Deploy Multiple</strong><p style="color:rgba(255,255,255,0.6);margin-top:4px;">One YAML file can define entire stacks</p></div>
</div>
</div>
</div>
</div>
<div class="card">
<h2 class="card-title" style="margin-bottom:24px;">Running Containers</h2>
<div id="containerList" style="padding:20px;text-align:center;color:rgba(255,255,255,0.5);">
  Loading containers...
</div>
</div>
</main>
<button class="fab" onclick="deployStack()"><span class="material-symbols-rounded" style="font-size:28px;">play_arrow</span></button>
<script src="/assets/js/m3-ripple.js"></script>
<script src="/assets/js/ui-components.js"></script>
<script>
// Initialize UI components
const ui = new DPlaneUI();

async function deployStack() {
  const yaml = document.getElementById('yamlEditor').value;
  if (!yaml.trim()) {
    ui.toast('Please enter docker-compose.yaml', 'warning');
    return;
  }
  
  ui.showLoading('Deploying stack...');
  
  try {
    const response = await csrfFetch('/api/docker/action', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'deploy', yaml: yaml })
    });
    
    const result = await response.json();
    ui.hideLoading();
    
    if (result.success) {
      ui.toast('Stack deployed — checking health...', 'success');
      // Wait 8 seconds then check for quick crashes
      setTimeout(postDeployHealthCheck, 8000);
    } else {
      ui.toast(result.error || 'Deployment failed', 'error');
    }
  } catch (error) {
    ui.hideLoading();
    ui.toast('Network error: ' + error.message, 'error');
  }
}

async function postDeployHealthCheck() {
  try {
    var resp = await csrfFetch('/api/docker/containers', { showLoading: false, showError: false });
    var data = await resp.json();
    if (!data.success || !data.containers) return;
    
    var exited = data.containers.filter(function(c) { return c.state === 'exited'; });
    if (exited.length === 0) {
      ui.toast('All containers running', 'success');
      setTimeout(function() { location.reload(); }, 500);
      return;
    }
    
    // Check each exited container for permission errors
    var permIssues = [];
    for (var i = 0; i < exited.length; i++) {
      var c = exited[i];
      try {
        var logResp = await csrfFetch('/api/docker/logs?container=' + encodeURIComponent(c.name), { showLoading: false, showError: false });
        var logData = await logResp.json();
        if (!logData.success || !logData.logs) continue;
        if (/permission denied|EACCES|operation not permitted|read.only file system/i.test(logData.logs)) {
          permIssues.push(c.name);
        }
      } catch (e) { /* skip */ }
    }
    
    if (permIssues.length > 0) {
      ui.toast('⚠ Permission issues detected in: ' + permIssues.join(', ') + ' — Check container logs and dataset ownership', 'warning', 12000);
    }
    setTimeout(function() { location.reload(); }, 1500);
  } catch (e) {
    setTimeout(function() { location.reload(); }, 500);
  }
}

async function validateYAML() {
  const yaml = document.getElementById('yamlEditor').value;
  if (!yaml.trim()) {
    ui.toast('Please enter YAML', 'warning');
    return;
  }
  
  if (yaml.includes('version:') && yaml.includes('services:')) {
    const services = (yaml.match(/^  \w+:/gm) || []).length;
    ui.toast(`✓ YAML is valid (${services} services detected)`, 'success');
  } else {
    ui.toast('⚠ Missing required fields (version or services)', 'warning');
  }
}

async function stopContainer(name) {
  if (await ui.confirm('Stop Container?', `Stop ${name}? This will terminate the running container.`)) {
    ui.showLoading(`Stopping ${name}...`);
    
    try {
      const response = await csrfFetch('/api/docker/action', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'stop', container: name })
      });
      
      const result = await response.json();
      ui.hideLoading();
      
      if (result.success) {
        ui.toast(`${name} stopped`, 'success');
        setTimeout(() => location.reload(), 500);
      } else {
        ui.toast(result.error || 'Failed to stop container', 'error');
      }
    } catch (error) {
      ui.hideLoading();
      ui.toast('Network error: ' + error.message, 'error');
    }
  }
}

async function viewLogs(name) {
  ui.showLoading(`Loading logs for ${name}...`);
  
  try {
    const response = await csrfFetch(`/api/docker/logs?container=${name}`);
    const result = await response.json();
    ui.hideLoading();
    
    if (result.success) {
      await ui.modal(`Logs: ${name}`, `<pre style="max-height:400px;overflow:auto;font-family:monospace;font-size:12px;line-height:1.4;">${result.logs || 'No logs available'}</pre>`, [
        { text: 'Close', primary: true }
      ]);
    } else {
      ui.toast(result.error || 'Failed to load logs', 'error');
    }
  } catch (error) {
    ui.hideLoading();
    ui.toast('Network error: ' + error.message, 'error');
  }
}

// ===== DYNAMIC CONTAINER LOADING =====
async function loadContainers() {
  const containerList = document.getElementById('containerList');
  
  // Show skeleton loading
  containerList.innerHTML = '';
  for (let i = 0; i < 3; i++) {
    const skeleton = document.createElement('div');
    skeleton.className = 'skeleton skeleton-card';
    skeleton.style.marginBottom = '16px';
    skeleton.style.height = '80px';
    containerList.appendChild(skeleton);
  }
  
  try {
    const response = await csrfFetch('/api/docker/containers', { showLoading: false });
    const data = await response.json();
    
    if (data.success && data.containers) {
      updateContainerList(data.containers);
    } else {
      // Empty state
      containerList.innerHTML = '';
      const emptyState = EnhancedUI.emptyState({
        icon: '<svg width="80" height="80" viewBox="0 0 24 24" fill="currentColor"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path></svg>',
        title: 'No containers running',
        message: 'Deploy a container to get started',
        action: { label: 'Deploy Container', onclick: 'showDeployModal()' }
      });
      containerList.appendChild(emptyState);
    }
  } catch (error) {
    EnhancedUI.toast('Failed to load containers', 'error');
    containerList.innerHTML = '<div style="padding:20px;text-align:center;color:rgba(255,255,255,0.5);">Error loading containers</div>';
  }
}

function updateContainerList(containers) {
  const containerList = document.getElementById('containerList');
  
  if (!containers || containers.length === 0) {
    containerList.innerHTML = '';
    const emptyState = EnhancedUI.emptyState({
      icon: '<svg width="80" height="80" viewBox="0 0 24 24" fill="currentColor"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path></svg>',
      title: 'No containers',
      message: 'Deploy your first container',
      action: { label: 'Deploy Now', onclick: 'showDeployModal()' }
    });
    containerList.appendChild(emptyState);
    return;
  }
  
  containerList.innerHTML = '';
  
  containers.forEach(container => {
    const badgeClass = container.status === 'running' ? 'badge-success' : 'badge-error';
    const statusIcon = container.status === 'running' ? 'play_circle' : 'stop_circle';
    
    const html = `
      <div class="container-item" data-context-menu="container" data-context-data='${JSON.stringify({name: container.name, image: container.image})}'>
        <div class="container-header">
          <span class="material-symbols-rounded container-icon">deployed_code</span>
          <div class="container-info">
            <div class="container-name">${container.name}</div>
            <div class="container-meta">${container.image} • Port ${container.port || 'N/A'}</div>
          </div>
          <div class="badge ${badgeClass}">
            <span class="material-symbols-rounded" style="font-size:16px;">${statusIcon}</span> 
            ${container.status || 'Unknown'}
          </div>
          <button class="icon-btn" onclick="stopContainer('"+JSON.stringify(container.name)+"')">
            <span class="material-symbols-rounded">stop</span>
          </button>
          <button class="icon-btn" onclick="viewLogs('"+JSON.stringify(container.name)+"')">
            <span class="material-symbols-rounded">description</span>
          </button>
        </div>
        <div style="display:flex;gap:16px;text-align:center;">
          <div style="flex:1;"><div style="font-size:24px;font-weight:700;">${container.cpu || '0%'}</div><div style="font-size:13px;color:rgba(255,255,255,0.5);">CPU</div></div>
          <div style="flex:1;"><div style="font-size:24px;font-weight:700;">${container.memory || 'N/A'}</div><div style="font-size:13px;color:rgba(255,255,255,0.5);">Memory</div></div>
          <div style="flex:1;"><div style="font-size:24px;font-weight:700;">${container.uptime || 'N/A'}</div><div style="font-size:13px;color:rgba(255,255,255,0.5);">Uptime</div></div>
        </div>
      </div>
    `;
    containerList.insertAdjacentHTML('beforeend', html);
  });
}

// Load containers on page load
window.addEventListener('DOMContentLoaded', loadContainers);

// Auto-refresh containers every 5 seconds
setInterval(loadContainers, 5000);
</script>
  <script src="/assets/js/realtime-client.js"></script>
<script src="/assets/js/docker-icons.js"></script>
<!-- v3.0.0: Full Docker Management — Compose, Pull, Update, Stats, Sandbox -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const main = document.querySelector('.main');
  if (!main) return;
  const ds = document.createElement('div');
  ds.style.marginTop = '48px';
  ds.innerHTML = `
    <h2 class="page-title" style="font-size:28px;">Docker Compose</h2>
    <p class="page-subtitle" style="margin-bottom:32px;">Stacks • Pull • Update • Stats</p>

    <!-- Compose -->
    <div class="card" style="padding:32px;margin-bottom:24px;border-left:4px solid #06b6d4;">
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;">
        <span class="material-symbols-rounded" style="font-size:32px;color:#06b6d4;">layers</span>
        <div style="flex:1;"><div style="font-size:20px;font-weight:800;">Stack Management</div></div>
        <button class="btn" onclick="composeStatus()" style="background:rgba(255,255,255,0.05);">Status</button>
        <button class="btn btn-primary" onclick="composeUp()">Compose Up</button>
        <button class="btn" onclick="composeDown()" style="background:rgba(239,68,68,0.15);color:#ef4444;">Down</button>
      </div>
      <div>
        <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px;">Compose File Path</label>
        <input id="compose-path" type="text" placeholder="/opt/stacks/myapp/docker-compose.yml" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:var(--md-sys-shape-corner-medium);padding:10px 16px;color:#fff;font-family:monospace;">
      </div>
      <div id="compose-output" style="margin-top:12px;font-family:monospace;font-size:12px;color:rgba(255,255,255,0.5);padding:12px;background:rgba(0,0,0,0.3);border-radius:var(--md-sys-shape-corner-small);max-height:200px;overflow-y:auto;display:none;"></div>
    </div>

    <!-- Container Actions -->
    <div class="card" style="padding:32px;margin-bottom:24px;border-left:4px solid var(--md-sys-color-primary);">
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;">
        <span class="material-symbols-rounded" style="font-size:32px;color:var(--md-sys-color-primary);">deployed_code</span>
        <div style="flex:1;"><div style="font-size:20px;font-weight:800;">Container Operations</div></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr auto;gap:12px;align-items:end;margin-bottom:16px;">
        <div><label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px;">Image</label>
          <input id="pull-image" type="text" placeholder="nginx:latest" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:var(--md-sys-shape-corner-medium);padding:10px 16px;color:#fff;font-family:monospace;"></div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-primary" onclick="pullImage()"><span class="material-symbols-rounded" style="font-size:18px;">download</span> Pull</button>
          <button class="btn" onclick="preflightCheck()" style="background:rgba(255,255,255,0.05);">Preflight</button>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr auto;gap:12px;align-items:end;">
        <div><label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px;">Container Name (for remove/update)</label>
          <input id="container-name" type="text" placeholder="myapp" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:var(--md-sys-shape-corner-medium);padding:10px 16px;color:#fff;font-family:monospace;"></div>
        <div style="display:flex;gap:8px;">
          <button class="btn" onclick="updateContainer()" style="background:rgba(16,185,129,0.15);color:var(--md-sys-color-success);">Update</button>
          <button class="btn" onclick="removeContainer()" style="background:rgba(239,68,68,0.15);color:#ef4444;">Remove</button>
          <button class="btn" onclick="containerStats()" style="background:rgba(255,255,255,0.05);">Stats</button>
        </div>
      </div>
      <div id="container-output" style="margin-top:12px;font-family:monospace;font-size:12px;color:rgba(255,255,255,0.5);padding:12px;background:rgba(0,0,0,0.3);border-radius:var(--md-sys-shape-corner-small);max-height:200px;overflow-y:auto;display:none;"></div>
    </div>

    <!-- Sandbox -->
    <div class="card" style="padding:32px;margin-bottom:24px;border-left:4px solid #8b5cf6;">
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;">
        <span class="material-symbols-rounded" style="font-size:32px;color:#8b5cf6;">science</span>
        <div style="flex:1;"><div style="font-size:20px;font-weight:800;">Ephemeral Sandbox</div>
          <div style="font-size:14px;color:rgba(255,255,255,0.5);">Test containers in isolated environments</div></div>
        <button class="btn" onclick="sandboxList()" style="background:rgba(255,255,255,0.05);">List</button>
        <button class="btn btn-primary" onclick="sandboxCreate()">Create</button>
        <button class="btn" onclick="sandboxCleanup()" style="background:rgba(239,68,68,0.15);color:#ef4444;">Cleanup All</button>
      </div>
      <div id="sandbox-output" style="font-family:monospace;font-size:13px;color:rgba(255,255,255,0.5);"></div>
    </div>
  `;
  main.appendChild(ds);
});

async function composeUp() {
  const path = document.getElementById('compose-path').value;
  if (!path) { ui.toast('Enter compose file path', 'warning'); return; }
  ui.toast('Starting stack...', 'info');
  try { const r = await csrfFetch('/api/docker/compose/up',{method:'POST',body:JSON.stringify({path})}); const d = await r.json();
    showOutput('compose-output', d.output || d.error); if (d.success) { ui.toast('Stack started', 'success'); setTimeout(() => loadContainers(), 1500); } else { ui.toast(d.error, 'error'); }
  } catch(e) { ui.toast('Failed', 'error'); }
}
async function composeDown() {
  const path = document.getElementById('compose-path').value;
  if (!path) { ui.toast('Enter compose file path', 'warning'); return; }
  if (!await ui.confirm('Compose Down', 'Stop and remove all containers in this stack?')) return;
  try { const r = await csrfFetch('/api/docker/compose/down',{method:'POST',body:JSON.stringify({path})}); const d = await r.json();
    showOutput('compose-output', d.output || d.error); if (d.success) { ui.toast('Stack stopped', 'success'); setTimeout(() => loadContainers(), 1500); } else { ui.toast(d.error, 'error'); }
  } catch(e) { ui.toast('Failed', 'error'); }
}
async function composeStatus() {
  const path = document.getElementById('compose-path').value;
  if (!path) { ui.toast('Enter compose file path', 'warning'); return; }
  try { const r = await csrfFetch('/api/docker/compose/status?path='+encodeURIComponent(path)); const d = await r.json();
    showOutput('compose-output', d.output || JSON.stringify(d, null, 2));
  } catch(e) { ui.toast('Failed', 'error'); }
}
async function pullImage() {
  const image = document.getElementById('pull-image').value;
  if (!image) { ui.toast('Enter image name', 'warning'); return; }
  ui.toast('Pulling ' + image + '...', 'info');
  try { const r = await csrfFetch('/api/docker/pull',{method:'POST',body:JSON.stringify({image})}); const d = await r.json();
    showOutput('container-output', d.output || d.error); d.success ? ui.toast('Pull complete', 'success') : ui.toast(d.error, 'error');
  } catch(e) { ui.toast('Failed', 'error'); }
}
async function removeContainer() {
  const name = document.getElementById('container-name').value;
  if (!name) { ui.toast('Enter container name', 'warning'); return; }
  if (!await ui.confirm('Remove Container', 'Remove container ' + name + '?')) return;
  try { const r = await csrfFetch('/api/docker/remove',{method:'POST',body:JSON.stringify({container:name})}); const d = await r.json();
    if (d.success) { ui.toast('Container removed', 'success'); setTimeout(() => loadContainers(), 600); } else { ui.toast(d.error, 'error'); }
  } catch(e) { ui.toast('Failed', 'error'); }
}
async function updateContainer() {
  const name = document.getElementById('container-name').value;
  if (!name) { ui.toast('Enter container name', 'warning'); return; }
  if (!await ui.confirm('Update Container', 'Pull latest image and recreate ' + name + '?')) return;
  ui.toast('Updating...', 'info');
  try { const r = await csrfFetch('/api/docker/update',{method:'POST',body:JSON.stringify({container:name})}); const d = await r.json();
    showOutput('container-output', d.output || d.error); if (d.success) { ui.toast('Updated', 'success'); setTimeout(() => loadContainers(), 1000); } else { ui.toast(d.error, 'error'); }
  } catch(e) { ui.toast('Failed', 'error'); }
}
async function containerStats() {
  const name = document.getElementById('container-name').value;
  if (!name) { ui.toast('Enter container name', 'warning'); return; }
  try { const r = await csrfFetch('/api/docker/stats?container='+encodeURIComponent(name)); const d = await r.json();
    showOutput('container-output', d.stats || JSON.stringify(d, null, 2));
  } catch(e) { ui.toast('Failed', 'error'); }
}
async function preflightCheck() {
  const image = document.getElementById('pull-image').value || 'default';
  try { const r = await csrfFetch('/api/docker/preflight'); const d = await r.json();
    showOutput('container-output', JSON.stringify(d, null, 2)); d.success ? ui.toast('Preflight OK', 'success') : ui.toast('Issues found', 'warning');
  } catch(e) { ui.toast('Failed', 'error'); }
}
async function sandboxCreate() {
  const image = await ui.prompt('Create Sandbox', 'Image to sandbox:', 'alpine:latest');
  if (!image) return;
  try { const r = await csrfFetch('/api/sandbox/create',{method:'POST',body:JSON.stringify({image})}); const d = await r.json();
    d.success ? ui.toast('Sandbox created: ' + (d.container_id||'').substring(0,12), 'success') : ui.toast(d.error, 'error'); sandboxList();
  } catch(e) { ui.toast('Failed', 'error'); }
}
async function sandboxList() {
  try { const r = await csrfFetch('/api/sandbox/list'); const d = await r.json();
    const el = document.getElementById('sandbox-output');
    if (!d.sandboxes || !d.sandboxes.length) { el.textContent = 'No active sandboxes'; return; }
    el.innerHTML = d.sandboxes.map(s => `<div style="padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.05);">${s.id?.substring(0,12)||s.name} — ${s.image} — ${s.state||'running'}</div>`).join('');
  } catch(e) {}
}
async function sandboxDestroy(id) {
  if (!await ui.confirm("Destroy Sandbox","Destroy this sandbox?")) return;
  try { const r = await csrfFetch("/api/sandbox/destroy",{method:"POST",body:JSON.stringify({id})}); const d = await r.json();
    d.success ? ui.toast("Destroyed","success") : ui.toast(d.error,"error"); sandboxList();
  } catch(e) { ui.toast("Failed","error"); }
}
async function sandboxCleanup() {
  if (!await ui.confirm('Cleanup', 'Destroy ALL sandboxes?')) return;
  try { const r = await csrfFetch('/api/sandbox/cleanup',{method:'POST'}); const d = await r.json();
    d.success ? ui.toast('Cleaned up ' + (d.removed||0) + ' sandboxes', 'success') : ui.toast(d.error, 'error'); sandboxList();
  } catch(e) { ui.toast('Failed', 'error'); }
}
function showOutput(id, text) {
  const el = document.getElementById(id); el.style.display = 'block'; el.textContent = text || 'No output';
}
</script>
    <script src="/assets/js/nav-flyout.js"></script>
    <script src="/assets/js/nav-shared.js"></script>
</body></html>
