<!DOCTYPE html>
<!-- saved from url=(0141)network.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Network - D-PlaneOS</title>
    <link rel="stylesheet" href="/assets/css/design-tokens.css">
    <link rel="stylesheet" href="/assets/css/dplaneos-ui-complete.css">
<link rel="stylesheet" href="/assets/css/m3-tokens.css">
<link rel="stylesheet" href="/assets/css/m3-components.css">
<link rel="stylesheet" href="/assets/css/m3-icons.css">
  <link rel="stylesheet" href="/assets/css/enhanced-ui.css">
<link rel="stylesheet" href="/assets/css/m3-animations.css">
<style>
.logo { font-size: 20px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; cursor: pointer; }


.nav-link:hover, 
.main { max-width: 1600px; margin: 140px auto 60px; padding: 0 40px; }
.page-header { margin-bottom: 48px; }
.page-title { font-size: 32px; font-weight: 700; letter-spacing: -1.5px; margin-bottom: 12px; }
.page-subtitle { font-size: 18px; color: rgba(255,255,255,0.6); }
.interface-card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: var(--radius-xl); padding: 32px; margin-bottom: 24px; border-left: 4px solid var(--primary); }
.interface-header { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
.interface-icon { font-size: 32px; color: var(--primary); }
.interface-info { flex: 1; }
.interface-name { font-size: 20px; font-weight: 800; margin-bottom: 6px; }
.interface-details { font-size: 15px; color: rgba(255,255,255,0.6); }
/* Badge styles are in m3-components.css */
.icon-btn { width: 40px; height: 40px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,0.8); cursor: pointer; transition: all 0.3s; border: none; }
.icon-btn:hover { background: rgba(255,255,255,0.1); color: var(--text); }
.fab { position: fixed; bottom: 32px; right: 32px; width: 64px; height: 64px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary) 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4); cursor: pointer; transition: all 0.3s; border: none; color: var(--text); }
.fab:hover { transform: translateY(-4px); box-shadow: 0 12px 48px rgba(102, 126, 234, 0.6); }
</style>
<style type="text/css" id="operaUserStyle"></style><link rel="stylesheet" href="/assets/css/ui-components.css">
<script src="/assets/js/core.js"></script>
<script src="/assets/js/nav-flyout.js"></script>
<script src="/assets/js/hybrid-router.js"></script>
  <script src="/assets/js/enhanced-ui.js"></script>
  <script src="/assets/js/connection-monitor.js"></script>
  <script src="/assets/js/keyboard-shortcuts.js"></script>
  <script src="/assets/js/form-validator.js"></script>
  <link rel="stylesheet" href="/assets/css/material-symbols-local.css">
  <link rel="stylesheet" href="/assets/css/ui-consistency.css">
  <link rel="stylesheet" href="/assets/css/ui-polish.css">
  <script src="/assets/js/daemon-api.js"></script>
</head>
<body>
<!-- D-PlaneOS - Hierarchical Navigation -->
<!-- This navigation maintains all security (CSRF, Auth) and real system state -->

<div id="nav-root"></div>

<script>
// Navigation behavior
function navigateToSection(section) {
  if (section === 'dashboard') {
    window.location.href = 'index.html';
  }
}

function toggleSubNav(section, button) {
  // Remove active from all nav links
  document.querySelectorAll('.nav-link').forEach(link => {
    link.classList.remove('active');
  });
  
  // Add active to clicked button
  if (button) {
    button.classList.add('active');
  }
  
  // Hide all sub-navs
  document.querySelectorAll('.nav-sub').forEach(sub => {
    sub.classList.remove('active');
  });
  
  // Show selected sub-nav
  const subNav = document.getElementById(`sub-${section}`);
  if (subNav) {
    subNav.classList.add('active');
    document.body.classList.add('has-subnav');
  }
}

// Auto-detect current section and page on load
(function() {
  const currentPage = window.location.pathname.split('/').pop() || 'index.html';
  
  // Page to section mapping
  const pageMap = {
    'acl-manager.html': { section: 'storage', page: 'acl-manager' },
    'audit.html': { section: 'security', page: 'audit' },
    'certificates.html': { section: 'security', page: 'certificates' },
    'cloud-sync.html': { section: 'storage', page: 'cloud-sync' },
    'directory-service.html': { section: 'identity', page: 'directory-service' },
    'docker.html': { section: 'compute', page: 'docker' },
    'files-enhanced.html': { section: 'storage', page: 'files-enhanced' },
    'files.html': { section: 'storage', page: 'files' },
    'firewall.html': { section: 'security', page: 'firewall' },
    'groups.html': { section: 'identity', page: 'groups' },
    'hardware.html': { section: 'system', page: 'hardware' },
    'index.html': { section: 'dashboard', page: null },
    'ipmi.html': { section: 'system', page: 'ipmi' },
    'logs.html': { section: 'system', page: 'logs' },
    'modules.html': { section: 'compute', page: 'modules' },
    'network-dns.html': { section: 'network', page: 'network-dns' },
    'network-interfaces.html': { section: 'network', page: 'network-interfaces' },
    'network-routing.html': { section: 'network', page: 'network-routing' },
    'network.html': { section: 'network', page: 'network' },
    'pools-advanced.html': { section: 'storage', page: 'pools-advanced' },
    'pools.html': { section: 'storage', page: 'pools' },
    'power-management.html': { section: 'system', page: 'power-management' },
    'quotas.html': { section: 'storage', page: 'quotas' },
    'rbac-management.html': { section: 'identity', page: 'rbac-management' },
    'removable-media-ui.html': { section: 'system', page: 'removable-media-ui' },
    'replication.html': { section: 'storage', page: 'replication' },
    'reporting.html': { section: 'system', page: 'reporting' },
    'security.html': { section: 'security', page: 'security' },
    'settings.html': { section: 'system', page: 'settings' },
    'shares.html': { section: 'storage', page: 'shares' },
    'snapshot-scheduler.html': { section: 'storage', page: 'snapshot-scheduler' },
    'system-monitoring.html': { section: 'system', page: 'system-monitoring' },
    'system-settings.html': { section: 'system', page: 'system-settings' },
    'ups.html': { section: 'system', page: 'ups' },
    'users.html': { section: 'identity', page: 'users' },
    'zfs-encryption.html': { section: 'storage', page: 'zfs-encryption' }
  };
  
  const current = pageMap[currentPage];
  if (current) {
    // Activate section button
    const sectionBtn = document.querySelector(`[data-section="${current.section}"]`);
    if (sectionBtn) {
      sectionBtn.classList.add('active');
    }
    
    // Show and activate sub-nav if not dashboard
    if (current.section !== 'dashboard') {
      const subNav = document.getElementById(`sub-${current.section}`);
      if (subNav) {
        subNav.classList.add('active');
        document.body.classList.add('has-subnav');
        
        // Activate current page in sub-nav
        if (current.page) {
          const pageLink = subNav.querySelector(`[data-page="${current.page}"]`);
          if (pageLink) {
            pageLink.classList.add('active');
          }
        }
      }
    }
  }
})();

// Keyboard shortcuts
function showKeyboardHelp() {
  if (window.EnhancedUI) {
    const shortcuts = `Keyboard Shortcuts:

g + d → Dashboard
g + s → Storage
g + c → Compute
g + n → Network
g + u → Identity
g + e → Security
g + y → System

r → Refresh page
Esc → Close modals
? → Show this help`;
    EnhancedUI.toast(shortcuts, 'info', 8000);
  }
}

// Enhanced keyboard shortcuts for sections
(function() {
  let keySequence = '';
  let keyTimeout;
  
  document.addEventListener('keydown', (e) => {
    if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) return;
    
    keySequence += e.key;
    clearTimeout(keyTimeout);
    
    const shortcuts = {
      'gd': 'index.html',
      'gs': () => toggleSubNav('storage', document.querySelector('[data-section="storage"]')),
      'gc': () => toggleSubNav('compute', document.querySelector('[data-section="compute"]')),
      'gn': () => toggleSubNav('network', document.querySelector('[data-section="network"]')),
      'gu': () => toggleSubNav('identity', document.querySelector('[data-section="identity"]')),
      'ge': () => toggleSubNav('security', document.querySelector('[data-section="security"]')),
      'gy': () => toggleSubNav('system', document.querySelector('[data-section="system"]'))
    };
    
    if (shortcuts[keySequence]) {
      e.preventDefault();
      const action = shortcuts[keySequence];
      if (typeof action === 'function') {
        action();
      } else {
        window.location.href = action;
      }
      keySequence = '';
    } else if (e.key === '?') {
      e.preventDefault();
      showKeyboardHelp();
    }
    
    keyTimeout = setTimeout(() => keySequence = '', 1000);
  });
})();

// Connection status monitoring (integrates with existing connection-monitor.js)
if (window.ConnectionMonitor) {
  window.ConnectionMonitor.on('statusChange', (online) => {
    const status = document.getElementById('navConnectionStatus');
    if (status) {
      if (online) {
        status.classList.remove('offline');
        status.classList.add('online');
        status.innerHTML = '<span class="status-dot"></span><span>Connected</span>';
      } else {
        status.classList.remove('online');
        status.classList.add('offline');
        status.innerHTML = '<span class="status-dot"></span><span>Offline</span>';
      }
    }
  });
}
</script>

<main class="main">
<div class="page-header">
<h1 class="page-title">Security</h1>
<p class="page-subtitle">Overview • Firewall • Certificates</p>
</div>
<div class="consolidation-tabs">
  <button class="consolidation-tab active" data-tab="overview" onclick="switchConsolidatedTab('overview')">Overview</button>
  <button class="consolidation-tab" data-tab="firewall" onclick="switchConsolidatedTab('firewall')">Firewall</button>
  <button class="consolidation-tab" data-tab="certificates" onclick="switchConsolidatedTab('certificates')">Certificates</button>
</div>

<div id="tab-overview" class="consolidation-content active">
<script>
// Navigation behavior
function navigateToSection(section) {
  if (section === 'dashboard') {
    window.location.href = 'index.html';
  }
}

function toggleSubNav(section, button) {
  // Remove active from all nav links
  document.querySelectorAll('.nav-link').forEach(link => {
    link.classList.remove('active');
  });
  
  // Add active to clicked button
  if (button) {
    button.classList.add('active');
  }
  
  // Hide all sub-navs
  document.querySelectorAll('.nav-sub').forEach(sub => {
    sub.classList.remove('active');
  });
  
  // Show selected sub-nav
  const subNav = document.getElementById(`sub-${section}`);
  if (subNav) {
    subNav.classList.add('active');
    document.body.classList.add('has-subnav');
  }
}

// Auto-detect current section and page on load
(function() {
  const currentPage = window.location.pathname.split('/').pop() || 'index.html';
  
  // Page to section mapping
  const pageMap = {
    'acl-manager.html': { section: 'storage', page: 'acl-manager' },
    'audit.html': { section: 'security', page: 'audit' },
    'certificates.html': { section: 'security', page: 'certificates' },
    'cloud-sync.html': { section: 'storage', page: 'cloud-sync' },
    'directory-service.html': { section: 'identity', page: 'directory-service' },
    'docker.html': { section: 'compute', page: 'docker' },
    'files-enhanced.html': { section: 'storage', page: 'files-enhanced' },
    'files.html': { section: 'storage', page: 'files' },
    'firewall.html': { section: 'security', page: 'firewall' },
    'groups.html': { section: 'identity', page: 'groups' },
    'hardware.html': { section: 'system', page: 'hardware' },
    'index.html': { section: 'dashboard', page: null },
    'ipmi.html': { section: 'system', page: 'ipmi' },
    'logs.html': { section: 'system', page: 'logs' },
    'modules.html': { section: 'compute', page: 'modules' },
    'network-dns.html': { section: 'network', page: 'network-dns' },
    'network-interfaces.html': { section: 'network', page: 'network-interfaces' },
    'network-routing.html': { section: 'network', page: 'network-routing' },
    'network.html': { section: 'network', page: 'network' },
    'pools-advanced.html': { section: 'storage', page: 'pools-advanced' },
    'pools.html': { section: 'storage', page: 'pools' },
    'power-management.html': { section: 'system', page: 'power-management' },
    'quotas.html': { section: 'storage', page: 'quotas' },
    'rbac-management.html': { section: 'identity', page: 'rbac-management' },
    'removable-media-ui.html': { section: 'system', page: 'removable-media-ui' },
    'replication.html': { section: 'storage', page: 'replication' },
    'reporting.html': { section: 'system', page: 'reporting' },
    'security.html': { section: 'security', page: 'security' },
    'settings.html': { section: 'system', page: 'settings' },
    'shares.html': { section: 'storage', page: 'shares' },
    'snapshot-scheduler.html': { section: 'storage', page: 'snapshot-scheduler' },
    'system-monitoring.html': { section: 'system', page: 'system-monitoring' },
    'system-settings.html': { section: 'system', page: 'system-settings' },
    'ups.html': { section: 'system', page: 'ups' },
    'users.html': { section: 'identity', page: 'users' },
    'zfs-encryption.html': { section: 'storage', page: 'zfs-encryption' }
  };
  
  const current = pageMap[currentPage];
  if (current) {
    // Activate section button
    const sectionBtn = document.querySelector(`[data-section="${current.section}"]`);
    if (sectionBtn) {
      sectionBtn.classList.add('active');
    }
    
    // Show and activate sub-nav if not dashboard
    if (current.section !== 'dashboard') {
      const subNav = document.getElementById(`sub-${current.section}`);
      if (subNav) {
        subNav.classList.add('active');
        document.body.classList.add('has-subnav');
        
        // Activate current page in sub-nav
        if (current.page) {
          const pageLink = subNav.querySelector(`[data-page="${current.page}"]`);
          if (pageLink) {
            pageLink.classList.add('active');
          }
        }
      }
    }
  }
})();

// Keyboard shortcuts
function showKeyboardHelp() {
  if (window.EnhancedUI) {
    const shortcuts = `Keyboard Shortcuts:

g + d → Dashboard
g + s → Storage
g + c → Compute
g + n → Network
g + u → Identity
g + e → Security
g + y → System

r → Refresh page
Esc → Close modals
? → Show this help`;
    EnhancedUI.toast(shortcuts, 'info', 8000);
  }
}

// Enhanced keyboard shortcuts for sections
(function() {
  let keySequence = '';
  let keyTimeout;
  
  document.addEventListener('keydown', (e) => {
    if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) return;
    
    keySequence += e.key;
    clearTimeout(keyTimeout);
    
    const shortcuts = {
      'gd': 'index.html',
      'gs': () => toggleSubNav('storage', document.querySelector('[data-section="storage"]')),
      'gc': () => toggleSubNav('compute', document.querySelector('[data-section="compute"]')),
      'gn': () => toggleSubNav('network', document.querySelector('[data-section="network"]')),
      'gu': () => toggleSubNav('identity', document.querySelector('[data-section="identity"]')),
      'ge': () => toggleSubNav('security', document.querySelector('[data-section="security"]')),
      'gy': () => toggleSubNav('system', document.querySelector('[data-section="system"]'))
    };
    
    if (shortcuts[keySequence]) {
      e.preventDefault();
      const action = shortcuts[keySequence];
      if (typeof action === 'function') {
        action();
      } else {
        window.location.href = action;
      }
      keySequence = '';
    } else if (e.key === '?') {
      e.preventDefault();
      showKeyboardHelp();
    }
    
    keyTimeout = setTimeout(() => keySequence = '', 1000);
  });
})();

// Connection status monitoring (integrates with existing connection-monitor.js)
if (window.ConnectionMonitor) {
  window.ConnectionMonitor.on('statusChange', (online) => {
    const status = document.getElementById('navConnectionStatus');
    if (status) {
      if (online) {
        status.classList.remove('offline');
        status.classList.add('online');
        status.innerHTML = '<span class="status-dot"></span><span>Connected</span>';
      } else {
        status.classList.remove('online');
        status.classList.add('offline');
        status.innerHTML = '<span class="status-dot"></span><span>Offline</span>';
      }
    }
  });
}
</script>

<div class="page-header">
<h1 class="page-title">Network</h1>
<p class="page-subtitle">Configuration • VPN • Remote access</p>
</div>
<div id="network-interfaces-container">
            <div class="page-header">
                <h1 class="page-title">Security Center</h1>
                <p class="page-subtitle">Authentication • Access Control • Audit Log</p>
            </div>

            <!-- 2FA Section -->
            <div class="card" id="twoFACard">
                <h2>Two-Factor Authentication</h2>
                <div id="twofa-loading" style="color:var(--text-dim);font-size:14px;">Loading 2FA status…</div>

                <!-- Enabled state -->
                <div id="twofa-enabled" style="display:none;">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                        <span class="material-symbols-rounded" style="color:var(--success);font-size:28px;">verified_user</span>
                        <div>
                            <div style="font-weight:600;color:var(--success);">Two-Factor Authentication is ON</div>
                            <div style="font-size:13px;color:var(--text-dim);">Your account is protected with TOTP.</div>
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="disable2FA()">Disable 2FA</button>
                </div>

                <!-- Disabled state — step 1: prompt -->
                <div id="twofa-setup-prompt" style="display:none;">
                    <p style="color:var(--text-dim);margin:0 0 16px;">Add an extra layer of security. You'll need an authenticator app (Google Authenticator, Aegis, Bitwarden, etc.).</p>
                    <button class="btn btn-primary" onclick="startTOTPSetup()">Set Up Two-Factor Auth</button>
                </div>

                <!-- Disabled state — step 2: QR + verify -->
                <div id="twofa-setup-flow" style="display:none;">
                    <p style="font-size:14px;color:var(--text-dim);margin:0 0 16px;">
                        Scan this QR code with your authenticator app, then enter the 6-digit code to confirm.
                    </p>
                    <div style="display:flex;gap:24px;align-items:flex-start;flex-wrap:wrap;">
                        <div>
                            <canvas id="totpQrCanvas" width="180" height="180" style="border-radius:8px;background:#fff;padding:8px;display:block;"></canvas>
                            <div style="margin-top:8px;font-size:11px;color:var(--text-dim);text-align:center;">Can't scan? Use this key:</div>
                            <div id="totpSecretText" style="font-family:monospace;font-size:12px;letter-spacing:2px;color:var(--primary);text-align:center;margin-top:4px;word-break:break-all;"></div>
                        </div>
                        <div style="flex:1;min-width:200px;">
                            <div class="form-group" style="margin-bottom:12px;">
                                <label style="font-size:13px;margin-bottom:6px;display:block;">6-digit code from your app</label>
                                <input type="text" id="totpVerifyCode" class="form-input"
                                    inputmode="numeric" maxlength="6" pattern="[0-9]{6}"
                                    placeholder="000000"
                                    style="font-size:22px;letter-spacing:6px;text-align:center;width:160px;"
                                    oninput="this.value=this.value.replace(/\D/g,'');if(this.value.length===6)verifyTOTP()">
                            </div>
                            <div style="display:flex;gap:8px;">
                                <button class="btn btn-primary" onclick="verifyTOTP()" id="totpVerifyBtn">Verify &amp; Enable</button>
                                <button class="btn" onclick="cancelTOTPSetup()">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Backup codes — shown once after enabling -->
                <div id="twofa-backup-codes" style="display:none;margin-top:16px;">
                    <div style="background:rgba(74,222,128,0.08);border:1px solid rgba(74,222,128,0.25);border-radius:10px;padding:16px;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                            <span class="material-symbols-rounded" style="color:var(--success);">key</span>
                            <strong>Save your backup codes</strong>
                        </div>
                        <p style="font-size:13px;color:var(--text-dim);margin:0 0 12px;">
                            If you lose access to your authenticator app, use one of these codes to log in. Each code can only be used once.
                        </p>
                        <div id="backupCodesList" style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;font-family:monospace;font-size:13px;"></div>
                        <button class="btn" style="margin-top:12px;" onclick="copyBackupCodes()">
                            <span class="material-symbols-rounded" style="font-size:16px;vertical-align:middle;">content_copy</span> Copy Codes
                        </button>
                    </div>
                </div>

                <!-- Disable dialog -->
                <div id="twofa-disable-form" style="display:none;margin-top:16px;background:rgba(239,68,68,0.07);border:1px solid rgba(239,68,68,0.2);border-radius:10px;padding:16px;">
                    <p style="margin:0 0 12px;font-size:14px;">To disable 2FA, enter your password and current authenticator code.</p>
                    <div class="form-group" style="margin-bottom:10px;">
                        <label style="font-size:13px;">Password</label>
                        <input type="password" id="disableTotpPassword" class="form-input" placeholder="Current password">
                    </div>
                    <div class="form-group" style="margin-bottom:12px;">
                        <label style="font-size:13px;">Authenticator code</label>
                        <input type="text" id="disableTotpCode" class="form-input" inputmode="numeric"
                            maxlength="6" pattern="[0-9]{6}" placeholder="000000"
                            style="letter-spacing:4px;width:160px;"
                            oninput="this.value=this.value.replace(/\D/g,'')">
                    </div>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-danger" onclick="confirmDisable2FA()">Confirm Disable</button>
                        <button class="btn" onclick="cancelDisable2FA()">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Change Password -->
            <div class="card">
                <h2>Change Password</h2>
                <div class="form-group">
                    <label>Current Password</label>
                    <input type="password" id="currentPassword" class="form-input">
                </div>
                <div class="form-group">
                    <label>New Password</label>
                    <input type="password" id="newPassword" class="form-input">
                </div>
                <div class="form-group">
                    <label>Confirm New Password</label>
                    <input type="password" id="confirmPassword" class="form-input">
                </div>
                <button class="btn btn-primary" onclick="changePassword()">Change Password</button>
            </div>

            <!-- API Tokens -->
            <div class="card">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
                    <div>
                        <h2 style="margin:0 0 4px;">API Tokens</h2>
                        <p style="margin:0;font-size:13px;color:var(--text-dim);">Long-lived tokens for scripts and automation. Tokens are shown only once.</p>
                    </div>
                    <button class="btn btn-primary" onclick="openCreateTokenDialog()">
                        <span class="material-symbols-rounded" style="font-size:16px;vertical-align:middle;">add</span> New Token
                    </button>
                </div>
                <div id="apiTokensList"></div>

                <!-- Create token dialog -->
                <div id="createTokenForm" style="display:none;margin-top:16px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:16px;">
                    <h3 style="margin:0 0 14px;font-size:15px;">Create New Token</h3>
                    <div class="form-group" style="margin-bottom:10px;">
                        <label style="font-size:13px;">Name <span style="color:var(--error)">*</span></label>
                        <input type="text" id="newTokenName" class="form-input" placeholder="e.g. backup-script, monitoring" maxlength="64">
                    </div>
                    <div class="form-group" style="margin-bottom:10px;">
                        <label style="font-size:13px;">Scopes</label>
                        <select id="newTokenScopes" class="form-input">
                            <option value="read">read — View only</option>
                            <option value="read,write" selected>read,write — View + Modify</option>
                            <option value="read,write,admin">read,write,admin — Full access</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom:12px;">
                        <label style="font-size:13px;">Expires in</label>
                        <select id="newTokenExpiry" class="form-input">
                            <option value="0">Never</option>
                            <option value="30">30 days</option>
                            <option value="90">90 days</option>
                            <option value="365">1 year</option>
                        </select>
                    </div>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-primary" onclick="createAPIToken()">Create Token</button>
                        <button class="btn" onclick="closeCreateTokenDialog()">Cancel</button>
                    </div>
                </div>

                <!-- New token display — shown once -->
                <div id="newTokenReveal" style="display:none;margin-top:16px;background:rgba(74,222,128,0.07);border:1px solid rgba(74,222,128,0.25);border-radius:10px;padding:16px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                        <span class="material-symbols-rounded" style="color:var(--success);">vpn_key</span>
                        <strong>Your new API token — copy it now!</strong>
                    </div>
                    <p style="font-size:13px;color:var(--text-dim);margin:0 0 10px;">This token will NOT be shown again.</p>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <code id="newTokenValue" style="font-size:13px;background:rgba(0,0,0,0.3);border-radius:6px;padding:8px 12px;flex:1;word-break:break-all;"></code>
                        <button class="btn" onclick="copyNewToken()" title="Copy">
                            <span class="material-symbols-rounded" style="font-size:18px;">content_copy</span>
                        </button>
                    </div>
                    <button class="btn" style="margin-top:10px;" onclick="dismissNewToken()">Done</button>
                </div>
            </div>

            <!-- Security Log -->
            <div class="card">
                <h2>Security Log</h2>
                <div id="securityLog"></div>
            </div>
    </div>

    <script src="../assets/js/core.js"></script>
</div>
<div id="tab-firewall" class="consolidation-content">
<script>
// Navigation behavior
function navigateToSection(section) {
  if (section === 'dashboard') {
    window.location.href = 'index.html';
  }
}

function toggleSubNav(section, button) {
  // Remove active from all nav links
  document.querySelectorAll('.nav-link').forEach(link => {
    link.classList.remove('active');
  });
  
  // Add active to clicked button
  if (button) {
    button.classList.add('active');
  }
  
  // Hide all sub-navs
  document.querySelectorAll('.nav-sub').forEach(sub => {
    sub.classList.remove('active');
  });
  
  // Show selected sub-nav
  const subNav = document.getElementById(`sub-${section}`);
  if (subNav) {
    subNav.classList.add('active');
    document.body.classList.add('has-subnav');
  }
}

// Auto-detect current section and page on load
(function() {
  const currentPage = window.location.pathname.split('/').pop() || 'index.html';
  
  // Page to section mapping
  const pageMap = {
    'acl-manager.html': { section: 'storage', page: 'acl-manager' },
    'audit.html': { section: 'security', page: 'audit' },
    'certificates.html': { section: 'security', page: 'certificates' },
    'cloud-sync.html': { section: 'storage', page: 'cloud-sync' },
    'directory-service.html': { section: 'identity', page: 'directory-service' },
    'docker.html': { section: 'compute', page: 'docker' },
    'files-enhanced.html': { section: 'storage', page: 'files-enhanced' },
    'files.html': { section: 'storage', page: 'files' },
    'firewall.html': { section: 'security', page: 'firewall' },
    'groups.html': { section: 'identity', page: 'groups' },
    'hardware.html': { section: 'system', page: 'hardware' },
    'index.html': { section: 'dashboard', page: null },
    'ipmi.html': { section: 'system', page: 'ipmi' },
    'logs.html': { section: 'system', page: 'logs' },
    'modules.html': { section: 'compute', page: 'modules' },
    'network-dns.html': { section: 'network', page: 'network-dns' },
    'network-interfaces.html': { section: 'network', page: 'network-interfaces' },
    'network-routing.html': { section: 'network', page: 'network-routing' },
    'network.html': { section: 'network', page: 'network' },
    'pools-advanced.html': { section: 'storage', page: 'pools-advanced' },
    'pools.html': { section: 'storage', page: 'pools' },
    'power-management.html': { section: 'system', page: 'power-management' },
    'quotas.html': { section: 'storage', page: 'quotas' },
    'rbac-management.html': { section: 'identity', page: 'rbac-management' },
    'removable-media-ui.html': { section: 'system', page: 'removable-media-ui' },
    'replication.html': { section: 'storage', page: 'replication' },
    'reporting.html': { section: 'system', page: 'reporting' },
    'security.html': { section: 'security', page: 'security' },
    'settings.html': { section: 'system', page: 'settings' },
    'shares.html': { section: 'storage', page: 'shares' },
    'snapshot-scheduler.html': { section: 'storage', page: 'snapshot-scheduler' },
    'system-monitoring.html': { section: 'system', page: 'system-monitoring' },
    'system-settings.html': { section: 'system', page: 'system-settings' },
    'ups.html': { section: 'system', page: 'ups' },
    'users.html': { section: 'identity', page: 'users' },
    'zfs-encryption.html': { section: 'storage', page: 'zfs-encryption' }
  };
  
  const current = pageMap[currentPage];
  if (current) {
    // Activate section button
    const sectionBtn = document.querySelector(`[data-section="${current.section}"]`);
    if (sectionBtn) {
      sectionBtn.classList.add('active');
    }
    
    // Show and activate sub-nav if not dashboard
    if (current.section !== 'dashboard') {
      const subNav = document.getElementById(`sub-${current.section}`);
      if (subNav) {
        subNav.classList.add('active');
        document.body.classList.add('has-subnav');
        
        // Activate current page in sub-nav
        if (current.page) {
          const pageLink = subNav.querySelector(`[data-page="${current.page}"]`);
          if (pageLink) {
            pageLink.classList.add('active');
          }
        }
      }
    }
  }
})();

// Keyboard shortcuts
function showKeyboardHelp() {
  if (window.EnhancedUI) {
    const shortcuts = `Keyboard Shortcuts:

g + d → Dashboard
g + s → Storage
g + c → Compute
g + n → Network
g + u → Identity
g + e → Security
g + y → System

r → Refresh page
Esc → Close modals
? → Show this help`;
    EnhancedUI.toast(shortcuts, 'info', 8000);
  }
}

// Enhanced keyboard shortcuts for sections
(function() {
  let keySequence = '';
  let keyTimeout;
  
  document.addEventListener('keydown', (e) => {
    if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) return;
    
    keySequence += e.key;
    clearTimeout(keyTimeout);
    
    const shortcuts = {
      'gd': 'index.html',
      'gs': () => toggleSubNav('storage', document.querySelector('[data-section="storage"]')),
      'gc': () => toggleSubNav('compute', document.querySelector('[data-section="compute"]')),
      'gn': () => toggleSubNav('network', document.querySelector('[data-section="network"]')),
      'gu': () => toggleSubNav('identity', document.querySelector('[data-section="identity"]')),
      'ge': () => toggleSubNav('security', document.querySelector('[data-section="security"]')),
      'gy': () => toggleSubNav('system', document.querySelector('[data-section="system"]'))
    };
    
    if (shortcuts[keySequence]) {
      e.preventDefault();
      const action = shortcuts[keySequence];
      if (typeof action === 'function') {
        action();
      } else {
        window.location.href = action;
      }
      keySequence = '';
    } else if (e.key === '?') {
      e.preventDefault();
      showKeyboardHelp();
    }
    
    keyTimeout = setTimeout(() => keySequence = '', 1000);
  });
})();

// Connection status monitoring (integrates with existing connection-monitor.js)
if (window.ConnectionMonitor) {
  window.ConnectionMonitor.on('statusChange', (online) => {
    const status = document.getElementById('navConnectionStatus');
    if (status) {
      if (online) {
        status.classList.remove('offline');
        status.classList.add('online');
        status.innerHTML = '<span class="status-dot"></span><span>Connected</span>';
      } else {
        status.classList.remove('online');
        status.classList.add('offline');
        status.innerHTML = '<span class="status-dot"></span><span>Offline</span>';
      }
    }
  });
}
</script>

<div class="page-header">
  <h1 class="page-title">Firewall</h1>
  <div class="page-actions" id="fwActions">
    <button class="btn" id="fwToggleBtn" onclick="toggleFirewall()">Enable</button>
  </div>
</div>

<div class="card" id="fwStatusCard">
  <div class="card-header">
    <div class="card-title">Firewall Status</div>
    <div id="fwStatusBadge" style="padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600;"></div>
  </div>
  <div id="fwRules" style="font-family:monospace;font-size:13px;white-space:pre-wrap;color:rgba(255,255,255,0.7);max-height:400px;overflow-y:auto;"></div>
</div>

<div class="card">
  <div class="card-header"><div class="card-title">Add Rule</div></div>
  <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:end;">
    <div>
      <label style="display:block;font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:4px;">Action</label>
      <select class="form-input" id="fwAction" style="padding:8px 14px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.15);border-radius:8px;color:#fff;font-size:13px;">
        <option value="allow">Allow</option>
        <option value="deny">Deny</option>
      </select>
    </div>
    <div>
      <label style="display:block;font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:4px;">Port</label>
      <input type="text" id="fwPort" placeholder="80/tcp, 443, 22/tcp" style="padding:8px 14px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.15);border-radius:8px;color:#fff;font-size:13px;width:140px;">
    </div>
    <div>
      <label style="display:block;font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:4px;">From IP (optional)</label>
      <input type="text" id="fwFrom" placeholder="192.168.1.0/24" style="padding:8px 14px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.15);border-radius:8px;color:#fff;font-size:13px;width:160px;">
    </div>
    <button class="btn btn-primary" onclick="addRule()" style="height:38px;"><span class="material-symbols-rounded" style="font-size:16px;">add</span> Add Rule</button>
  </div>
</div>

<div class="card">
  <div class="card-header"><div class="card-title">Common Presets</div></div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;">
    <button class="btn" onclick="applyPreset('22/tcp')">SSH (22)</button>
    <button class="btn" onclick="applyPreset('80/tcp')">HTTP (80)</button>
    <button class="btn" onclick="applyPreset('443/tcp')">HTTPS (443)</button>
    <button class="btn" onclick="applyPreset('445/tcp')">SMB (445)</button>
    <button class="btn" onclick="applyPreset('2049/tcp')">NFS (2049)</button>
    <button class="btn" onclick="applyPreset('9000/tcp')">D-PlaneOS API (9000)</button>
  </div>
</div>

<style>
#fwRules .rule-line{padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.04);}
#fwRules .rule-num{color:var(--info);font-weight:600;min-width:30px;display:inline-block;}
#fwRules .rule-allow{color:var(--success);}
#fwRules .rule-deny{color:var(--error);}
</style>
</div>
<div id="tab-certificates" class="consolidation-content">
<script>
// Navigation behavior
function navigateToSection(section) {
  if (section === 'dashboard') {
    window.location.href = 'index.html';
  }
}

function toggleSubNav(section, button) {
  // Remove active from all nav links
  document.querySelectorAll('.nav-link').forEach(link => {
    link.classList.remove('active');
  });
  
  // Add active to clicked button
  if (button) {
    button.classList.add('active');
  }
  
  // Hide all sub-navs
  document.querySelectorAll('.nav-sub').forEach(sub => {
    sub.classList.remove('active');
  });
  
  // Show selected sub-nav
  const subNav = document.getElementById(`sub-${section}`);
  if (subNav) {
    subNav.classList.add('active');
    document.body.classList.add('has-subnav');
  }
}

// Auto-detect current section and page on load
(function() {
  const currentPage = window.location.pathname.split('/').pop() || 'index.html';
  
  // Page to section mapping
  const pageMap = {
    'acl-manager.html': { section: 'storage', page: 'acl-manager' },
    'audit.html': { section: 'security', page: 'audit' },
    'certificates.html': { section: 'security', page: 'certificates' },
    'cloud-sync.html': { section: 'storage', page: 'cloud-sync' },
    'directory-service.html': { section: 'identity', page: 'directory-service' },
    'docker.html': { section: 'compute', page: 'docker' },
    'files-enhanced.html': { section: 'storage', page: 'files-enhanced' },
    'files.html': { section: 'storage', page: 'files' },
    'firewall.html': { section: 'security', page: 'firewall' },
    'groups.html': { section: 'identity', page: 'groups' },
    'hardware.html': { section: 'system', page: 'hardware' },
    'index.html': { section: 'dashboard', page: null },
    'ipmi.html': { section: 'system', page: 'ipmi' },
    'logs.html': { section: 'system', page: 'logs' },
    'modules.html': { section: 'compute', page: 'modules' },
    'network-dns.html': { section: 'network', page: 'network-dns' },
    'network-interfaces.html': { section: 'network', page: 'network-interfaces' },
    'network-routing.html': { section: 'network', page: 'network-routing' },
    'network.html': { section: 'network', page: 'network' },
    'pools-advanced.html': { section: 'storage', page: 'pools-advanced' },
    'pools.html': { section: 'storage', page: 'pools' },
    'power-management.html': { section: 'system', page: 'power-management' },
    'quotas.html': { section: 'storage', page: 'quotas' },
    'rbac-management.html': { section: 'identity', page: 'rbac-management' },
    'removable-media-ui.html': { section: 'system', page: 'removable-media-ui' },
    'replication.html': { section: 'storage', page: 'replication' },
    'reporting.html': { section: 'system', page: 'reporting' },
    'security.html': { section: 'security', page: 'security' },
    'settings.html': { section: 'system', page: 'settings' },
    'shares.html': { section: 'storage', page: 'shares' },
    'snapshot-scheduler.html': { section: 'storage', page: 'snapshot-scheduler' },
    'system-monitoring.html': { section: 'system', page: 'system-monitoring' },
    'system-settings.html': { section: 'system', page: 'system-settings' },
    'ups.html': { section: 'system', page: 'ups' },
    'users.html': { section: 'identity', page: 'users' },
    'zfs-encryption.html': { section: 'storage', page: 'zfs-encryption' }
  };
  
  const current = pageMap[currentPage];
  if (current) {
    // Activate section button
    const sectionBtn = document.querySelector(`[data-section="${current.section}"]`);
    if (sectionBtn) {
      sectionBtn.classList.add('active');
    }
    
    // Show and activate sub-nav if not dashboard
    if (current.section !== 'dashboard') {
      const subNav = document.getElementById(`sub-${current.section}`);
      if (subNav) {
        subNav.classList.add('active');
        document.body.classList.add('has-subnav');
        
        // Activate current page in sub-nav
        if (current.page) {
          const pageLink = subNav.querySelector(`[data-page="${current.page}"]`);
          if (pageLink) {
            pageLink.classList.add('active');
          }
        }
      }
    }
  }
})();

// Keyboard shortcuts
function showKeyboardHelp() {
  if (window.EnhancedUI) {
    const shortcuts = `Keyboard Shortcuts:

g + d → Dashboard
g + s → Storage
g + c → Compute
g + n → Network
g + u → Identity
g + e → Security
g + y → System

r → Refresh page
Esc → Close modals
? → Show this help`;
    EnhancedUI.toast(shortcuts, 'info', 8000);
  }
}

// Enhanced keyboard shortcuts for sections
(function() {
  let keySequence = '';
  let keyTimeout;
  
  document.addEventListener('keydown', (e) => {
    if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) return;
    
    keySequence += e.key;
    clearTimeout(keyTimeout);
    
    const shortcuts = {
      'gd': 'index.html',
      'gs': () => toggleSubNav('storage', document.querySelector('[data-section="storage"]')),
      'gc': () => toggleSubNav('compute', document.querySelector('[data-section="compute"]')),
      'gn': () => toggleSubNav('network', document.querySelector('[data-section="network"]')),
      'gu': () => toggleSubNav('identity', document.querySelector('[data-section="identity"]')),
      'ge': () => toggleSubNav('security', document.querySelector('[data-section="security"]')),
      'gy': () => toggleSubNav('system', document.querySelector('[data-section="system"]'))
    };
    
    if (shortcuts[keySequence]) {
      e.preventDefault();
      const action = shortcuts[keySequence];
      if (typeof action === 'function') {
        action();
      } else {
        window.location.href = action;
      }
      keySequence = '';
    } else if (e.key === '?') {
      e.preventDefault();
      showKeyboardHelp();
    }
    
    keyTimeout = setTimeout(() => keySequence = '', 1000);
  });
})();

// Connection status monitoring (integrates with existing connection-monitor.js)
if (window.ConnectionMonitor) {
  window.ConnectionMonitor.on('statusChange', (online) => {
    const status = document.getElementById('navConnectionStatus');
    if (status) {
      if (online) {
        status.classList.remove('offline');
        status.classList.add('online');
        status.innerHTML = '<span class="status-dot"></span><span>Connected</span>';
      } else {
        status.classList.remove('online');
        status.classList.add('offline');
        status.innerHTML = '<span class="status-dot"></span><span>Offline</span>';
      }
    }
  });
}
</script>

<div class="page-header">
  <h1 class="page-title">SSL/TLS Certificates</h1>
  <div class="page-actions">
    <button class="btn btn-primary" onclick="showGenModal()"><span class="material-symbols-rounded" style="font-size:18px;">add</span> Generate Certificate</button>
  </div>
</div>

<div class="card" id="activeCertCard">
  <div class="card-header"><div class="card-title">Active Certificate</div></div>
  <div id="activeCertInfo" style="padding:4px 0;font-size:14px;color:rgba(255,255,255,0.6);">Loading...</div>
</div>

<div class="card">
  <div class="card-header">
    <div class="card-title">Installed Certificates</div>
    <div class="card-action" onclick="loadCerts()"><span class="material-symbols-rounded" style="font-size:18px;">refresh</span></div>
  </div>
  <div id="certList" style="padding:20px;text-align:center;color:rgba(255,255,255,0.4);">Loading...</div>
</div>

<div id="genCertModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9999;align-items:center;justify-content:center;">
  <div style="background:rgba(30,41,59,0.98);border-radius:16px;padding:32px;max-width:500px;width:90%;border:1px solid rgba(255,255,255,0.1);">
    <h3 style="margin:0 0 24px;font-size:18px;">Generate Self-Signed Certificate</h3>
    <div style="display:grid;gap:16px;">
      <div>
        <label style="display:block;font-size:13px;color:rgba(255,255,255,0.6);margin-bottom:6px;">Certificate Name</label>
        <input type="text" id="certName" value="dplaneos" placeholder="my-cert" style="width:100%;padding:10px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.15);border-radius:8px;color:#fff;font-size:14px;">
      </div>
      <div>
        <label style="display:block;font-size:13px;color:rgba(255,255,255,0.6);margin-bottom:6px;">Common Name (CN)</label>
        <input type="text" id="certCN" value="dplaneos.local" style="width:100%;padding:10px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.15);border-radius:8px;color:#fff;font-size:14px;">
      </div>
      <div>
        <label style="display:block;font-size:13px;color:rgba(255,255,255,0.6);margin-bottom:6px;">Validity (days)</label>
        <input type="number" id="certDays" value="365" min="1" max="3650" style="width:100%;padding:10px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.15);border-radius:8px;color:#fff;font-size:14px;">
      </div>
      <div>
        <label style="display:block;font-size:13px;color:rgba(255,255,255,0.6);margin-bottom:6px;">Subject Alternative Names (comma-separated)</label>
        <input type="text" id="certSANs" placeholder="192.168.1.100, nas.local" style="width:100%;padding:10px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.15);border-radius:8px;color:#fff;font-size:14px;">
      </div>
    </div>
    <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:24px;">
      <button class="btn" onclick="closeGenModal()">Cancel</button>
      <button class="btn btn-primary" onclick="generateCert()">Generate</button>
    </div>
  </div>
</div>

<style>
.cert-row{display:flex;align-items:center;gap:16px;padding:16px 0;border-bottom:1px solid rgba(255,255,255,0.06);}
.cert-row:last-child{border-bottom:none;}
.cert-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:rgba(74,222,128,0.1);}
.cert-icon span{color:var(--success);font-size:22px;}
.cert-info{flex:1;}
.cert-name{font-weight:600;font-size:15px;margin-bottom:4px;}
.cert-meta{font-size:12px;color:rgba(255,255,255,0.5);line-height:1.6;}
.cert-active-badge{padding:3px 10px;border-radius:20px;background:rgba(74,222,128,0.15);color:var(--success);font-size:11px;font-weight:600;}
.cert-actions{display:flex;gap:8px;}
</style>
</div>

</main>
    </div>

    <script src="../assets/js/core.js"></script>
    <script>
function switchConsolidatedTab(t){document.querySelectorAll('.consolidation-content').forEach(function(c){c.classList.remove('active')});document.querySelectorAll('.consolidation-tab').forEach(function(b){b.classList.remove('active')});var el=document.getElementById('tab-'+t);var btn=document.querySelector('[data-tab="'+t+'"]');if(el)el.classList.add('active');if(btn)btn.classList.add('active');if(typeof window['init_'+t]==='function')window['init_'+t]();}window.addEventListener('load',function(){var h=window.location.hash.replace('#','');if(h&&document.getElementById('tab-'+h))switchConsolidatedTab(h);});
    // ── 2FA / TOTP ──────────────────────────────────────────────────────────
    let _totpSecret = '';
    let _backupCodes = [];

    async function load2FAStatus() {
        try {
            const r = await csrfFetch('/api/auth/totp/setup');
            const d = await r.json();
            document.getElementById('twofa-loading').style.display = 'none';
            if (d.enabled) {
                document.getElementById('twofa-enabled').style.display = '';
            } else {
                document.getElementById('twofa-setup-prompt').style.display = '';
            }
        } catch(e) {
            document.getElementById('twofa-loading').textContent = 'Failed to load 2FA status.';
        }
    }

    async function startTOTPSetup() {
        document.getElementById('twofa-setup-prompt').style.display = 'none';
        try {
            const r = await csrfFetch('/api/auth/totp/setup');
            const d = await r.json();
            if (!d.secret) { showToast('Failed to start 2FA setup', 'error'); return; }
            _totpSecret = d.secret;
            document.getElementById('totpSecretText').textContent = d.secret.match(/.{1,4}/g).join(' ');
            renderQRCode('totpQrCanvas', d.otpauth_uri);
            document.getElementById('twofa-setup-flow').style.display = '';
            document.getElementById('totpVerifyCode').value = '';
            document.getElementById('totpVerifyCode').focus();
        } catch(e) {
            showToast('Failed to start 2FA setup', 'error');
            document.getElementById('twofa-setup-prompt').style.display = '';
        }
    }

    function cancelTOTPSetup() {
        document.getElementById('twofa-setup-flow').style.display = 'none';
        document.getElementById('twofa-setup-prompt').style.display = '';
    }

    async function verifyTOTP() {
        const code = document.getElementById('totpVerifyCode').value.trim();
        if (code.length !== 6) { showToast('Enter a 6-digit code', 'warning'); return; }
        const btn = document.getElementById('totpVerifyBtn');
        btn.disabled = true; btn.textContent = 'Verifying…';
        try {
            const r = await csrfFetch('/api/auth/totp/setup', {
                method: 'POST',
                body: JSON.stringify({ code })
            });
            const d = await r.json();
            if (!d.success) { showToast(d.error || 'Invalid code', 'error'); return; }
            _backupCodes = d.backup_codes || [];
            document.getElementById('twofa-setup-flow').style.display = 'none';
            document.getElementById('twofa-enabled').style.display = '';
            const bcList = document.getElementById('backupCodesList');
            bcList.innerHTML = _backupCodes.map(c =>
                '<div style="background:rgba(0,0,0,0.25);border-radius:5px;padding:5px 8px;text-align:center;">' + c + '</div>'
            ).join('');
            document.getElementById('twofa-backup-codes').style.display = '';
            showToast('Two-factor authentication enabled!', 'success');
        } catch(e) {
            showToast('Verification failed', 'error');
        } finally {
            btn.disabled = false; btn.textContent = 'Verify & Enable';
        }
    }

    function copyBackupCodes() {
        navigator.clipboard.writeText(_backupCodes.join('\n')).then(() => showToast('Backup codes copied', 'success'));
    }

    function disable2FA() {
        document.getElementById('twofa-disable-form').style.display = '';
        document.getElementById('disableTotpPassword').value = '';
        document.getElementById('disableTotpCode').value = '';
        document.getElementById('disableTotpPassword').focus();
    }

    function cancelDisable2FA() {
        document.getElementById('twofa-disable-form').style.display = 'none';
    }

    async function confirmDisable2FA() {
        const code = document.getElementById('disableTotpCode').value.trim();
        const password = document.getElementById('disableTotpPassword').value;
        if (!password || code.length < 6) { showToast('Enter your password and a 6-digit code', 'warning'); return; }
        try {
            const r = await csrfFetch('/api/auth/totp/setup', {
                method: 'DELETE',
                body: JSON.stringify({ code, password })
            });
            const d = await r.json();
            if (!d.success) { showToast(d.error || 'Failed to disable 2FA', 'error'); return; }
            document.getElementById('twofa-enabled').style.display = 'none';
            document.getElementById('twofa-disable-form').style.display = 'none';
            document.getElementById('twofa-backup-codes').style.display = 'none';
            document.getElementById('twofa-setup-prompt').style.display = '';
            showToast('Two-factor authentication disabled', 'success');
        } catch(e) {
            showToast('Failed to disable 2FA', 'error');
        }
    }

    function renderQRCode(canvasId, text) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        const encoded = encodeURIComponent(text);
        const size = canvas.width;
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => {
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, size, size);
            ctx.drawImage(img, 0, 0, size, size);
        };
        img.onerror = () => {
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, size, size);
            ctx.fillStyle = '#ffffff';
            ctx.font = '11px monospace';
            ctx.textAlign = 'center';
            ctx.fillText('QR unavailable (offline).', size/2, size/2 - 8);
            ctx.fillText('Use the key below.', size/2, size/2 + 8);
        };
        img.src = 'https://chart.googleapis.com/chart?cht=qr&chs=' + size + 'x' + size + '&chl=' + encoded + '&choe=UTF-8';
    }

    // ── Change Password ───────────────────────────────────────────────────────
    async function changePassword() {
        const current = document.getElementById('currentPassword').value;
        const newPass = document.getElementById('newPassword').value;
        const confirm = document.getElementById('confirmPassword').value;
        if (!current || !newPass) { showToast('Fill in all fields', 'warning'); return; }
        if (newPass !== confirm) { showToast('Passwords do not match', 'error'); return; }
        if (newPass.length < 8) { showToast('Password must be at least 8 characters', 'warning'); return; }
        try {
            const r = await csrfFetch('/api/auth/change-password', {
                method: 'POST',
                body: JSON.stringify({ current_password: current, new_password: newPass })
            });
            const d = await r.json();
            if (d.success) {
                showToast('Password changed successfully', 'success');
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            } else {
                showToast(d.error || 'Failed to change password', 'error');
            }
        } catch(e) {
            showToast('Failed to change password', 'error');
        }
    }

    // ── API Tokens ────────────────────────────────────────────────────────────
    let _newTokenValue = '';

    async function loadAPITokens() {
        const list = document.getElementById('apiTokensList');
        if (!list) return;
        list.innerHTML = '<div style="color:var(--text-dim);font-size:14px;padding:8px 0;">Loading…</div>';
        try {
            const r = await csrfFetch('/api/auth/tokens');
            const d = await r.json();
            if (!d.success) { list.innerHTML = '<div style="color:var(--error);">Failed to load tokens.</div>'; return; }
            if (!d.tokens || d.tokens.length === 0) {
                list.innerHTML = '<div style="color:var(--text-dim);font-size:14px;padding:8px 0;">No tokens yet. Create one to allow script and API access.</div>';
                return;
            }
            list.innerHTML = d.tokens.map(t => {
                const expires = t.expires_at ? 'Expires ' + new Date(t.expires_at).toLocaleDateString() : 'Never expires';
                const lastUsed = t.last_used ? 'Last used ' + new Date(t.last_used).toLocaleDateString() : 'Never used';
                const scopeColors = { read: '#64b5f6', write: '#ffd54f', admin: '#ef5350' };
                const scopes = (t.scopes || 'read').split(',').map(s => s.trim());
                const scopeTags = scopes.map(s =>
                    '<span style="padding:1px 7px;border-radius:10px;font-size:11px;font-weight:600;background:rgba(255,255,255,0.08);color:' + (scopeColors[s]||'#fff') + '">' + s + '</span>'
                ).join(' ');
                return '<div style="display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.06);">' +
                    '<span class="material-symbols-rounded" style="color:var(--primary);font-size:20px;">vpn_key</span>' +
                    '<div style="flex:1;min-width:0;">' +
                    '<div style="font-weight:600;font-size:14px;">' + escHtml(t.name) + '</div>' +
                    '<div style="font-size:12px;color:var(--text-dim);margin-top:2px;">' +
                    '<code style="background:rgba(0,0,0,0.2);padding:1px 5px;border-radius:3px;">dpl_' + escHtml(t.prefix) + '…</code>' +
                    '&nbsp;' + scopeTags + '&nbsp;·&nbsp;' + expires + '&nbsp;·&nbsp;' + lastUsed +
                    '</div></div>' +
                    '<button class="btn btn-danger" style="padding:5px 12px;font-size:12px;" onclick="revokeToken(' + t.id + ','' + escHtml(t.name) + '')">Revoke</button>' +
                    '</div>';
            }).join('');
        } catch(e) {
            list.innerHTML = '<div style="color:var(--error);">Failed to load tokens.</div>';
        }
    }

    function openCreateTokenDialog() {
        document.getElementById('createTokenForm').style.display = '';
        document.getElementById('newTokenReveal').style.display = 'none';
        document.getElementById('newTokenName').value = '';
        document.getElementById('newTokenName').focus();
    }

    function closeCreateTokenDialog() {
        document.getElementById('createTokenForm').style.display = 'none';
    }

    async function createAPIToken() {
        const name = document.getElementById('newTokenName').value.trim();
        const scopes = document.getElementById('newTokenScopes').value;
        const expiry = parseInt(document.getElementById('newTokenExpiry').value);
        if (!name) { showToast('Token name is required', 'warning'); return; }
        try {
            const r = await csrfFetch('/api/auth/tokens', {
                method: 'POST',
                body: JSON.stringify({ action: 'create', name, scopes, expires_in_days: expiry })
            });
            const d = await r.json();
            if (!d.success) { showToast(d.error || 'Failed to create token', 'error'); return; }
            _newTokenValue = d.token;
            document.getElementById('newTokenValue').textContent = d.token;
            document.getElementById('createTokenForm').style.display = 'none';
            document.getElementById('newTokenReveal').style.display = '';
            showToast('Token created — copy it now!', 'success');
            loadAPITokens();
        } catch(e) {
            showToast('Failed to create token', 'error');
        }
    }

    function copyNewToken() {
        if (_newTokenValue) navigator.clipboard.writeText(_newTokenValue).then(() => showToast('Token copied', 'success'));
    }

    function dismissNewToken() {
        document.getElementById('newTokenReveal').style.display = 'none';
        _newTokenValue = '';
    }

    async function revokeToken(id, name) {
        if (!await ui.confirm('Revoke Token', 'Revoke token "' + name + '"? Scripts using it will stop working immediately.')) return;
        try {
            const r = await csrfFetch('/api/auth/tokens', {
                method: 'POST',
                body: JSON.stringify({ action: 'revoke', id })
            });
            const d = await r.json();
            if (d.success) { showToast('Token revoked', 'success'); loadAPITokens(); }
            else showToast(d.error || 'Failed to revoke', 'error');
        } catch(e) {
            showToast('Failed to revoke token', 'error');
        }
    }

    function escHtml(s) {
        return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    document.addEventListener('DOMContentLoaded', () => {
        load2FAStatus();
        loadAPITokens();
    });
var __firewall_init=false;function init_firewall(){if(__firewall_init)return;__firewall_init=true;function getSessionId(){return document.cookie.replace(/(?:(?:^|.*;\s*)session_id\s*=\s*([^;]*).*$)|^.*$/,"$1")||localStorage.getItem("session_id")||"";}
function getUser(){return document.cookie.replace(/(?:(?:^|.*;\s*)username\s*=\s*([^;]*).*$)|^.*$/,"$1")||localStorage.getItem("username")||"admin";}

var fwActive=false;

async function loadStatus(){
  try{
    var res=await fetch("/api/firewall/status",{headers:{"X-Session-ID":getSessionId(),"X-User":getUser()}});
    var data=await res.json();
    fwActive=data.status==="active";
    var badge=document.getElementById("fwStatusBadge");
    badge.textContent=fwActive?"Active":"Inactive";
    badge.style.background=fwActive?"rgba(74,222,128,0.15)":"rgba(255,255,255,0.1)";
    badge.style.color=fwActive?"#4ade80":"rgba(255,255,255,0.5)";
    document.getElementById("fwToggleBtn").textContent=fwActive?"Disable":"Enable";
    
    // Parse and render rules with highlighting
    var rules=data.rules||"";
    var html=rules.split("\n").map(function(line){
      line=line.replace(/ALLOW/g,"<span class='rule-allow'>ALLOW</span>");
      line=line.replace(/DENY/g,"<span class='rule-deny'>DENY</span>");
      line=line.replace(/\[\s*(\d+)\]/,"<span class='rule-num'>[$1]</span>");
      return"<div class='rule-line'>"+line+"</div>";
    }).join("");
    document.getElementById("fwRules").innerHTML=html;
  }catch(e){document.getElementById("fwRules").textContent="Failed to load firewall status";}
}

async function toggleFirewall(){
  var action=fwActive?"disable":"enable";
  if(fwActive&&!await ui.confirm("Disable Firewall","Disable the firewall? This will allow all traffic."))return;
  try{
    await fetch("/api/firewall/rule",{method:"POST",headers:{"Content-Type":"application/json","X-Session-ID":getSessionId(),"X-User":getUser()},body:JSON.stringify({action:action})});
    if(window.EnhancedUI)EnhancedUI.toast("Firewall "+action+"d","success");
    setTimeout(loadStatus,500);
  }catch(e){if(window.EnhancedUI)EnhancedUI.toast("Error: "+e.message,"error");}
}

async function addRule(){
  var action=document.getElementById("fwAction").value;
  var port=document.getElementById("fwPort").value.trim();
  var from=document.getElementById("fwFrom").value.trim();
  if(!port){if(window.EnhancedUI)EnhancedUI.toast("Port is required","error");return;}
  try{
    var res=await fetch("/api/firewall/rule",{method:"POST",headers:{"Content-Type":"application/json","X-Session-ID":getSessionId(),"X-User":getUser()},body:JSON.stringify({action:action,port:port,from:from})});
    var data=await res.json();
    if(data.success){
      if(window.EnhancedUI)EnhancedUI.toast("Rule added: "+action+" "+port,"success");
      document.getElementById("fwPort").value="";
      document.getElementById("fwFrom").value="";
      loadStatus();
    }
  }catch(e){if(window.EnhancedUI)EnhancedUI.toast("Error: "+e.message,"error");}
}

function applyPreset(port){
  document.getElementById("fwPort").value=port;
  document.getElementById("fwAction").value="allow";
  addRule();
}

document.addEventListener("DOMContentLoaded",loadStatus);}
var __certificates_init=false;function init_certificates(){if(__certificates_init)return;__certificates_init=true;function getSessionId(){return document.cookie.replace(/(?:(?:^|.*;\s*)session_id\s*=\s*([^;]*).*$)|^.*$/,"$1")||localStorage.getItem("session_id")||"";}
function getUser(){return document.cookie.replace(/(?:(?:^|.*;\s*)username\s*=\s*([^;]*).*$)|^.*$/,"$1")||localStorage.getItem("username")||"admin";}
function esc(s){var d=document.createElement("div");d.textContent=s;return d.innerHTML;}

var activeCert="";

async function loadCerts(){
  try{
    var res=await fetch("/api/certs/list",{headers:{"X-Session-ID":getSessionId(),"X-User":getUser()}});
    var data=await res.json();
    activeCert=data.active_cert||"";
    document.getElementById("activeCertInfo").textContent=activeCert||"No certificate configured";
    
    var certs=data.certs||[];
    if(!certs.length){
      document.getElementById("certList").innerHTML="<div style='padding:40px;text-align:center;color:rgba(255,255,255,0.4);'><span class='material-symbols-rounded' style='font-size:48px;display:block;margin-bottom:12px;'>verified_user</span>No certificates installed<br><span style='font-size:13px;'>Click <strong>Generate Certificate</strong> to create one</span></div>";
      return;
    }
    
    var html="";
    certs.forEach(function(c){
      var isActive=activeCert.indexOf(c.name)!==-1;
      // Parse details
      var details=(c.details||"").split("\n");
      var subject="",expires="",issuer="";
      details.forEach(function(d){
        if(d.startsWith("subject="))subject=d.replace("subject=","").trim();
        if(d.startsWith("notAfter="))expires=d.replace("notAfter=","").trim();
        if(d.startsWith("issuer="))issuer=d.replace("issuer=","").trim();
      });
      
      html+="<div class='cert-row'>"+
        "<div class='cert-icon'><span class='material-symbols-rounded'>verified_user</span></div>"+
        "<div class='cert-info'><div class='cert-name'>"+esc(c.name)+(isActive?" <span class='cert-active-badge'>Active</span>":"")+"</div>"+
        "<div class='cert-meta'>Subject: "+esc(subject)+"<br>Expires: "+esc(expires)+"<br>Key: "+(c.has_key==="true"?"✓ Present":"✗ Missing")+"</div></div>"+
        "<div class='cert-actions'>"+
        (isActive?"":"<button class='btn' onclick=\"activateCert('"+esc(c.name)+"')\">Activate</button>")+
        "</div></div>";
    });
    document.getElementById("certList").innerHTML=html;
  }catch(e){document.getElementById("certList").textContent="Failed to load certificates";}
}

function showGenModal(){document.getElementById("genCertModal").style.display="flex";}
function closeGenModal(){document.getElementById("genCertModal").style.display="none";}

async function generateCert(){
  var name=document.getElementById("certName").value.trim();
  var cn=document.getElementById("certCN").value.trim();
  var days=parseInt(document.getElementById("certDays").value)||365;
  var sans=document.getElementById("certSANs").value.trim();
  if(!name){if(window.EnhancedUI)EnhancedUI.toast("Name is required","error");return;}
  try{
    var res=await fetch("/api/certs/generate",{method:"POST",headers:{"Content-Type":"application/json","X-Session-ID":getSessionId(),"X-User":getUser()},body:JSON.stringify({name:name,cn:cn,days:days,sans:sans})});
    var data=await res.json();
    if(data.success){
      closeGenModal();
      if(window.EnhancedUI)EnhancedUI.toast("Certificate generated: "+name,"success");
      loadCerts();
    }else{if(window.EnhancedUI)EnhancedUI.toast("Generation failed","error");}
  }catch(e){if(window.EnhancedUI)EnhancedUI.toast("Error: "+e.message,"error");}
}

async function activateCert(name){
  if(!await ui.confirm('Activate Certificate',"Activate '"+name+"'? This will reload nginx."))return;
  try{
    var res=await fetch("/api/certs/activate",{method:"POST",headers:{"Content-Type":"application/json","X-Session-ID":getSessionId(),"X-User":getUser()},body:JSON.stringify({name:name})});
    var data=await res.json();
    if(data.success){
      if(window.EnhancedUI)EnhancedUI.toast("Certificate activated — nginx reloaded","success");
      loadCerts();
    }else{if(window.EnhancedUI)EnhancedUI.toast("Activation failed","error");}
  }catch(e){if(window.EnhancedUI)EnhancedUI.toast("Error: "+e.message,"error");}
}

document.addEventListener("DOMContentLoaded",loadCerts);}
</script>
    <script src="/assets/js/nav-flyout.js"></script>
    <script src="/assets/js/nav-shared.js"></script>
</body>
</html>
