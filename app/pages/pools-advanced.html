<!DOCTYPE html>
<!-- saved from url=(0141)network.html -->
<html lang="en"><head><style>html{background:#0a0a0a}</style><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Network - D-PlaneOS</title>
  <link rel="stylesheet" href="/assets/css/design-tokens.css">
<link rel="stylesheet" href="/assets/css/m3-tokens.css">
<link rel="stylesheet" href="/assets/css/m3-components.css">
<link rel="stylesheet" href="/assets/css/m3-icons.css">
  <link rel="stylesheet" href="/assets/css/enhanced-ui.css">
<link rel="stylesheet" href="/assets/css/m3-animations.css">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif; background: #0a0a0a; color: #fff; overflow-x: hidden; }


.logo { font-size: 20px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; cursor: pointer; }


.nav-link:hover, 
.main { max-width: 1600px; margin: 140px auto 60px; padding: 0 40px; }
.page-header { margin-bottom: 48px; }
.page-title { font-size: 32px; font-weight: 700; letter-spacing: -1.5px; margin-bottom: 12px; }
.page-subtitle { font-size: 18px; color: rgba(255,255,255,0.6); }
.interface-card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: var(--radius-xl); padding: 32px; margin-bottom: 24px; border-left: 4px solid var(--primary); }
.interface-header { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
.interface-icon { font-size: 32px; color: var(--primary); }
.interface-info { flex: 1; }
.interface-name { font-size: 20px; font-weight: 800; margin-bottom: 6px; }
.interface-details { font-size: 15px; color: rgba(255,255,255,0.6); }
/* Badge styles are in m3-components.css */
.icon-btn { width: 40px; height: 40px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,0.8); cursor: pointer; transition: all 0.3s; border: none; }
.icon-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
.fab { position: fixed; bottom: 32px; right: 32px; width: 64px; height: 64px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary) 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4); cursor: pointer; transition: all 0.3s; border: none; color: #fff; }
.fab:hover { transform: translateY(-4px); box-shadow: 0 12px 48px rgba(102, 126, 234, 0.6); }
</style>
<style type="text/css" id="operaUserStyle"></style><link rel="stylesheet" href="/assets/css/ui-components.css">
<script src="/assets/js/core.js"></script>
<script src="/assets/js/nav-flyout.js"></script>
<script src="/assets/js/hybrid-router.js"></script>
  <script src="/assets/js/enhanced-ui.js"></script>
  <script src="/assets/js/connection-monitor.js"></script>
  <script src="/assets/js/keyboard-shortcuts.js"></script>
  <script src="/assets/js/form-validator.js"></script>
  <link rel="stylesheet" href="/assets/css/material-symbols-local.css">
  <link rel="stylesheet" href="/assets/css/ui-consistency.css">
  <link rel="stylesheet" href="/assets/css/ui-polish.css">
  <script src="/assets/js/daemon-api.js"></script>
</head>
<body>
<!-- D-PlaneOS v2.1.0 - Hierarchical Navigation -->
<!-- This navigation maintains all security (CSRF, Auth) and real system state -->

<nav class="nav-container">
  <div class="nav-main">
    <div style="display: flex; align-items: center; gap: 16px;">
      <div class="logo">
        D-PlaneOS
        <span class="version-badge">v2.1.0</span>
      </div>
    </div>
    
    <div class="nav-links">
      <button class="nav-link" onclick="navigateToSection('dashboard')" data-section="dashboard">
        Dashboard
      </button>
      <button class="nav-link" onclick="toggleSubNav('storage', this)" data-section="storage">
        Storage
      </button>
      <button class="nav-link" onclick="toggleSubNav('compute', this)" data-section="compute">
        Compute
      </button>
      <button class="nav-link" onclick="toggleSubNav('network', this)" data-section="network">
        Network
      </button>
      <button class="nav-link" onclick="toggleSubNav('identity', this)" data-section="identity">
        Identity
      </button>
      <button class="nav-link" onclick="toggleSubNav('security', this)" data-section="security">
        Security
      </button>
      <button class="nav-link" onclick="toggleSubNav('system', this)" data-section="system">
        System
      </button>
    </div>
    
    <div class="nav-actions">
      <button class="nav-action-btn" onclick="showKeyboardHelp()" title="Keyboard Shortcuts (?)">
        <span class="material-symbols-rounded">keyboard</span>
      </button>
      <div class="connection-status online" id="navConnectionStatus">
        <span class="status-dot"></span>
        <span>Connected</span>
      </div>
    </div>
  </div>

  <!-- Storage Sub-Navigation -->
  <div id="sub-storage" class="nav-sub">
    <div class="nav-sub-inner">
      <a href="pools.html" class="sub-link" data-page="pools">
        <span class="material-symbols-rounded">database</span>
        ZFS Pools
      </a>
      <a href="pools-advanced.html" class="sub-link" data-page="pools-advanced">
        <span class="material-symbols-rounded">photo_camera</span>
        Snapshots
      </a>
      <a href="shares.html" class="sub-link" data-page="shares">
        <span class="material-symbols-rounded">folder_shared</span>
        Shares
      </a>
      <a href="replication.html" class="sub-link" data-page="replication">
        <span class="material-symbols-rounded">sync</span>
        Replication
      </a>
      <a href="files.html" class="sub-link" data-page="files">
        <span class="material-symbols-rounded">folder_open</span>
        File Explorer
      </a>
      <a href="quotas.html" class="sub-link" data-page="quotas">
        <span class="material-symbols-rounded">pie_chart</span>
        Quotas
      </a>
      <a href="snapshot-scheduler.html" class="sub-link" data-page="snapshot-scheduler">
        <span class="material-symbols-rounded">schedule</span>
        Snapshot Scheduler
      </a>
      <a href="acl-manager.html" class="sub-link" data-page="acl-manager">
        <span class="material-symbols-rounded">admin_panel_settings</span>
        ACL Manager
      </a>
      <a href="zfs-encryption.html" class="sub-link" data-page="zfs-encryption">
        <span class="material-symbols-rounded">enhanced_encryption</span>
        Encryption
      </a>
      <a href="files-enhanced.html" class="sub-link" data-page="files-enhanced">
        <span class="material-symbols-rounded">upload_file</span>
        File Upload
      </a>
      <a href="cloud-sync.html" class="sub-link" data-page="cloud-sync">
        <span class="material-symbols-rounded">cloud_sync</span>
        Cloud Sync
      </a>
    </div>
  </div>

  <!-- Compute Sub-Navigation -->
  <div id="sub-compute" class="nav-sub">
    <div class="nav-sub-inner">
      <a href="docker.html" class="sub-link" data-page="docker">
        <span class="material-symbols-rounded">dns</span>
        Docker Containers
      </a>
      <a href="modules.html" class="sub-link" data-page="modules">
        <span class="material-symbols-rounded">extension</span>
        App Modules
      </a>
    </div>
  </div>

  <!-- Network Sub-Navigation -->
  <div id="sub-network" class="nav-sub">
    <div class="nav-sub-inner">
      <a href="network.html" class="sub-link" data-page="network">
        <span class="material-symbols-rounded">lan</span>
        Network Settings
      </a>
      <a href="network-interfaces.html" class="sub-link" data-page="network-interfaces">
        <span class="material-symbols-rounded">settings_ethernet</span>
        Interfaces
      </a>
      <a href="network-dns.html" class="sub-link" data-page="network-dns">
        <span class="material-symbols-rounded">dns</span>
        DNS
      </a>
      <a href="network-routing.html" class="sub-link" data-page="network-routing">
        <span class="material-symbols-rounded">route</span>
        Routing
      </a>
    </div>
  </div>

  <!-- Identity Sub-Navigation -->
  <div id="sub-identity" class="nav-sub">
    <div class="nav-sub-inner">
      <a href="users.html" class="sub-link" data-page="users">
        <span class="material-symbols-rounded">person</span>
        Users
      </a>
      <a href="groups.html" class="sub-link" data-page="groups">
        <span class="material-symbols-rounded">group</span>
        Groups
      </a>
      <a href="directory-service.html" class="sub-link" data-page="directory-service">
        <span class="material-symbols-rounded">domain</span>
        Directory Service
      </a>
      <a href="rbac-management.html" class="sub-link" data-page="rbac-management">
        <span class="material-symbols-rounded">admin_panel_settings</span>
        Roles & Permissions
      </a>
    </div>
  </div>

  <!-- Security Sub-Navigation -->
  <div id="sub-security" class="nav-sub">
    <div class="nav-sub-inner">
      <a href="security.html" class="sub-link" data-page="security">
        <span class="material-symbols-rounded">shield</span>
        Security Settings
      </a>
      <a href="audit.html" class="sub-link" data-page="audit">
        <span class="material-symbols-rounded">fact_check</span>
        Audit Logs
      </a>
      <a href="firewall.html" class="sub-link" data-page="firewall">
        <span class="material-symbols-rounded">local_fire_department</span>
        Firewall
      </a>
      <a href="certificates.html" class="sub-link" data-page="certificates">
        <span class="material-symbols-rounded">verified_user</span>
        Certificates
      </a>
    </div>
  </div>

  <!-- System Sub-Navigation -->
  <div id="sub-system" class="nav-sub">
    <div class="nav-sub-inner">
      <a href="settings.html" class="sub-link" data-page="settings">
        <span class="material-symbols-rounded">tune</span>
        General Settings
      </a>
      <a href="logs.html" class="sub-link" data-page="logs">
        <span class="material-symbols-rounded">description</span>
        System Logs
      </a>
      <a href="ups.html" class="sub-link" data-page="ups">
        <span class="material-symbols-rounded">battery_charging_full</span>
        UPS Management
      </a>
      <a href="reporting.html" class="sub-link" data-page="reporting">
        <span class="material-symbols-rounded">monitoring</span>
        Reporting
      </a>
      <a href="power-management.html" class="sub-link" data-page="power-management">
        <span class="material-symbols-rounded">power_settings_new</span>
        Power Management
      </a>
      <a href="system-settings.html" class="sub-link" data-page="system-settings">
        <span class="material-symbols-rounded">settings_suggest</span>
        System Settings
      </a>
      <a href="system-monitoring.html" class="sub-link" data-page="system-monitoring">
        <span class="material-symbols-rounded">monitor_heart</span>
        Monitoring
      </a>
      <a href="hardware.html" class="sub-link" data-page="hardware">
        <span class="material-symbols-rounded">developer_board</span>
        Hardware
      </a>
      <a href="ipmi.html" class="sub-link" data-page="ipmi">
        <span class="material-symbols-rounded">memory</span>
        IPMI
      </a>
      <a href="removable-media-ui.html" class="sub-link" data-page="removable-media-ui">
        <span class="material-symbols-rounded">usb</span>
        Removable Media
      </a>
    </div>
  </div>
</nav>

<script>
// Navigation behavior
function navigateToSection(section) {
  if (section === 'dashboard') {
    window.location.href = 'index.html';
  }
}

function toggleSubNav(section, button) {
  // Remove active from all nav links
  document.querySelectorAll('.nav-link').forEach(link => {
    link.classList.remove('active');
  });
  
  // Add active to clicked button
  if (button) {
    button.classList.add('active');
  }
  
  // Hide all sub-navs
  document.querySelectorAll('.nav-sub').forEach(sub => {
    sub.classList.remove('active');
  });
  
  // Show selected sub-nav
  const subNav = document.getElementById(`sub-${section}`);
  if (subNav) {
    subNav.classList.add('active');
    document.body.classList.add('has-subnav');
  }
}

// Auto-detect current section and page on load
(function() {
  const currentPage = window.location.pathname.split('/').pop() || 'index.html';
  
  // Page to section mapping
  const pageMap = {
    'acl-manager.html': { section: 'storage', page: 'acl-manager' },
    'audit.html': { section: 'security', page: 'audit' },
    'certificates.html': { section: 'security', page: 'certificates' },
    'cloud-sync.html': { section: 'storage', page: 'cloud-sync' },
    'directory-service.html': { section: 'identity', page: 'directory-service' },
    'docker.html': { section: 'compute', page: 'docker' },
    'files-enhanced.html': { section: 'storage', page: 'files-enhanced' },
    'files.html': { section: 'storage', page: 'files' },
    'firewall.html': { section: 'security', page: 'firewall' },
    'groups.html': { section: 'identity', page: 'groups' },
    'hardware.html': { section: 'system', page: 'hardware' },
    'index.html': { section: 'dashboard', page: null },
    'ipmi.html': { section: 'system', page: 'ipmi' },
    'logs.html': { section: 'system', page: 'logs' },
    'modules.html': { section: 'compute', page: 'modules' },
    'network-dns.html': { section: 'network', page: 'network-dns' },
    'network-interfaces.html': { section: 'network', page: 'network-interfaces' },
    'network-routing.html': { section: 'network', page: 'network-routing' },
    'network.html': { section: 'network', page: 'network' },
    'pools-advanced.html': { section: 'storage', page: 'pools-advanced' },
    'pools.html': { section: 'storage', page: 'pools' },
    'power-management.html': { section: 'system', page: 'power-management' },
    'quotas.html': { section: 'storage', page: 'quotas' },
    'rbac-management.html': { section: 'identity', page: 'rbac-management' },
    'removable-media-ui.html': { section: 'system', page: 'removable-media-ui' },
    'replication.html': { section: 'storage', page: 'replication' },
    'reporting.html': { section: 'system', page: 'reporting' },
    'security.html': { section: 'security', page: 'security' },
    'settings.html': { section: 'system', page: 'settings' },
    'shares.html': { section: 'storage', page: 'shares' },
    'snapshot-scheduler.html': { section: 'storage', page: 'snapshot-scheduler' },
    'system-monitoring.html': { section: 'system', page: 'system-monitoring' },
    'system-settings.html': { section: 'system', page: 'system-settings' },
    'ups.html': { section: 'system', page: 'ups' },
    'users.html': { section: 'identity', page: 'users' },
    'zfs-encryption.html': { section: 'storage', page: 'zfs-encryption' }
  };
  
  const current = pageMap[currentPage];
  if (current) {
    // Activate section button
    const sectionBtn = document.querySelector(`[data-section="${current.section}"]`);
    if (sectionBtn) {
      sectionBtn.classList.add('active');
    }
    
    // Show and activate sub-nav if not dashboard
    if (current.section !== 'dashboard') {
      const subNav = document.getElementById(`sub-${current.section}`);
      if (subNav) {
        subNav.classList.add('active');
        document.body.classList.add('has-subnav');
        
        // Activate current page in sub-nav
        if (current.page) {
          const pageLink = subNav.querySelector(`[data-page="${current.page}"]`);
          if (pageLink) {
            pageLink.classList.add('active');
          }
        }
      }
    }
  }
})();

// Keyboard shortcuts
function showKeyboardHelp() {
  if (window.EnhancedUI) {
    const shortcuts = `Keyboard Shortcuts:

g + d → Dashboard
g + s → Storage
g + c → Compute
g + n → Network
g + u → Identity
g + e → Security
g + y → System

r → Refresh page
Esc → Close modals
? → Show this help`;
    EnhancedUI.toast(shortcuts, 'info', 8000);
  }
}

// Enhanced keyboard shortcuts for sections
(function() {
  let keySequence = '';
  let keyTimeout;
  
  document.addEventListener('keydown', (e) => {
    if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) return;
    
    keySequence += e.key;
    clearTimeout(keyTimeout);
    
    const shortcuts = {
      'gd': 'index.html',
      'gs': () => toggleSubNav('storage', document.querySelector('[data-section="storage"]')),
      'gc': () => toggleSubNav('compute', document.querySelector('[data-section="compute"]')),
      'gn': () => toggleSubNav('network', document.querySelector('[data-section="network"]')),
      'gu': () => toggleSubNav('identity', document.querySelector('[data-section="identity"]')),
      'ge': () => toggleSubNav('security', document.querySelector('[data-section="security"]')),
      'gy': () => toggleSubNav('system', document.querySelector('[data-section="system"]'))
    };
    
    if (shortcuts[keySequence]) {
      e.preventDefault();
      const action = shortcuts[keySequence];
      if (typeof action === 'function') {
        action();
      } else {
        window.location.href = action;
      }
      keySequence = '';
    } else if (e.key === '?') {
      e.preventDefault();
      showKeyboardHelp();
    }
    
    keyTimeout = setTimeout(() => keySequence = '', 1000);
  });
})();

// Connection status monitoring (integrates with existing connection-monitor.js)
if (window.ConnectionMonitor) {
  window.ConnectionMonitor.on('statusChange', (online) => {
    const status = document.getElementById('navConnectionStatus');
    if (status) {
      if (online) {
        status.classList.remove('offline');
        status.classList.add('online');
        status.innerHTML = '<span class="status-dot"></span><span>Connected</span>';
      } else {
        status.classList.remove('online');
        status.classList.add('offline');
        status.innerHTML = '<span class="status-dot"></span><span>Offline</span>';
      }
    }
  });
}
</script>

<main class="main">
<div class="page-header">
<h1 class="page-title">Network</h1>
<p class="page-subtitle">Configuration • VPN • Remote access</p>
</div>
<div id="network-interfaces-container">
        <main class="main">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Advanced ZFS Management</h1>
                    <p class="page-subtitle">Encryption • Caching • Dedup • Automation</p>
                </div>
                <a href="pools.html" class="btn">← Back to Pools</a>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('encryption')">Encryption</button>
                <button class="tab" onclick="switchTab('cache')">Cache & Log</button>
                <button class="tab" onclick="switchTab('compression')">Compression</button>
                <button class="tab" onclick="switchTab('snapshots')">Snapshots</button>
            </div>

            <!-- Encryption Tab -->
            <div id="encryption-tab" class="tab-content active">
                <div class="card">
                    <h2>Create Encrypted Dataset</h2>
                    <div class="form-group">
                        <label>Dataset Name</label>
                        <input type="text" id="enc-dataset" placeholder="pool/encrypted-data" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Encryption Algorithm</label>
                        <select id="enc-algorithm" class="form-input">
                            <option value="aes-256-gcm">AES-256-GCM (Recommended)</option>
                            <option value="aes-128-gcm">AES-128-GCM</option>
                            <option value="aes-256-ccm">AES-256-CCM</option>
                            <option value="aes-128-ccm">AES-128-CCM</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Passphrase (16+ characters)</label>
                        <input type="password" id="enc-passphrase" class="form-input">
                    </div>
                    <div class="warning-box">
                        ⚠️ <strong>WARNING:</strong> Store your passphrase securely! Lost passphrase = permanent data loss.
                    </div>
                    <button class="btn btn-primary" onclick="createEncryptedDataset()">Create Encrypted Dataset</button>
                </div>
            </div>

            <!-- Cache & Log Tab -->
            <div id="cache-tab" class="tab-content">
                <div class="card">
                    <h2>L2ARC (Read Cache)</h2>
                    <p>Add SSD/NVMe as read cache to accelerate frequently accessed data</p>
                    <div class="form-group">
                        <label>Pool</label>
                        <select id="l2arc-pool" class="form-input"></select>
                    </div>
                    <div class="form-group">
                        <label>Cache Device</label>
                        <select id="l2arc-device" class="form-input"></select>
                    </div>
                    <button class="btn btn-primary" onclick="addL2ARC()">Add L2ARC</button>
                </div>

                <div class="card">
                    <h2>ZIL (Write Log)</h2>
                    <p>Separate log device for synchronous writes</p>
                    <div class="form-group">
                        <label>Pool</label>
                        <select id="zil-pool" class="form-input"></select>
                    </div>
                    <div class="form-group">
                        <label>Log Device</label>
                        <select id="zil-device" class="form-input"></select>
                    </div>
                    <div class="form-group">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;"><input type="checkbox" id="zil-mirror" style="accent-color:var(--md-sys-color-primary);width:18px;height:18px;"> Mirror ZIL (recommended)</label>
                    </div>
                    <button class="btn btn-primary" onclick="addZIL()">Add ZIL</button>
                </div>
            </div>

            <!-- Compression Tab -->
            <div id="compression-tab" class="tab-content">
                <div class="card">
                    <h2>Compression Settings</h2>
                    <div class="form-group">
                        <label>Dataset</label>
                        <select id="comp-dataset" class="form-input"></select>
                    </div>
                    <div class="form-group">
                        <label>Compression Algorithm</label>
                        <select id="comp-algorithm" class="form-input">
                            <option value="lz4">LZ4 (Fast, Recommended)</option>
                            <option value="gzip">GZIP (Balanced)</option>
                            <option value="gzip-9">GZIP-9 (Max Compression)</option>
                            <option value="zstd">ZSTD (Modern)</option>
                            <option value="off">Off</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="setCompression()">Apply Compression</button>
                </div>

                <div class="card">
                    <h2>Deduplication</h2>
                    <div class="warning-box">
                        ⚠️ <strong>WARNING:</strong> Dedup requires ~5GB RAM per 1TB of data!
                    </div>
                    <div class="form-group">
                        <label>Dataset</label>
                        <select id="dedup-dataset" class="form-input"></select>
                    </div>
                    <div class="form-group">
                        <label>Deduplication</label>
                        <select id="dedup-setting" class="form-input">
                            <option value="off">Off (Recommended)</option>
                            <option value="on">On</option>
                            <option value="verify">On with Verification</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="setDedup()">Apply Deduplication</button>
                </div>
            </div>

            <!-- Snapshots Tab -->
            <div id="snapshots-tab" class="tab-content">
                <div class="card">
                    <h2>Automated Snapshot Schedules</h2>
                    <button class="btn btn-primary" onclick="createSnapshotSchedule()">+ Create Schedule</button>
                    <div id="snapshot-schedules" style="margin-top: 16px;"></div>
                </div>
            </div>
        </main>
    </div>

    <script src="../assets/js/core.js"></script>
    <script>
    function switchTab(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector(`button[onclick="switchTab('${tab}')"]`).classList.add('active');
        document.getElementById(`${tab}-tab`).classList.add('active');
    }

    async function createEncryptedDataset() {
        const dataset = document.getElementById('enc-dataset').value;
        const algorithm = document.getElementById('enc-algorithm').value;
        const passphrase = document.getElementById('enc-passphrase').value;

        if (!dataset || !passphrase) {
            showToast('Please fill all fields', 'error');
            return;
        }

        if (passphrase.length < 16) {
            showToast('Passphrase must be at least 16 characters', 'error');
            return;
        }

        try {
            showLoading('Creating encrypted dataset...');
            const response = await csrfFetch('/api/snapshots/schedules', {
                method: 'POST',
                body: JSON.stringify({
                    action: 'create_encrypted_dataset',
                    dataset,
                    encryption: algorithm,
                    key_format: 'passphrase',
                    passphrase
                })
            });

            const data = await response.json();
            if (data.success) {
                showToast('Encrypted dataset created successfully!', 'success');
                document.getElementById('enc-dataset').value = '';
                document.getElementById('enc-passphrase').value = '';
            } else {
                showToast(data.error || 'Failed to create dataset', 'error');
            }
        } catch (error) {
            showToast('Error creating dataset', 'error');
        } finally {
            hideLoading();
        }
    }

    async function addL2ARC() {
        const pool = document.getElementById('l2arc-pool').value;
        const device = document.getElementById('l2arc-device').value;

        if (!pool || !device) {
            showToast('Please select pool and device', 'error');
            return;
        }

        try {
            showLoading('Adding L2ARC...');
            const response = await csrfFetch('/api/snapshots/schedules', {
                method: 'POST',
                body: JSON.stringify({ action: 'add_l2arc', pool, device })
            });

            const data = await response.json();
            if (data.success) {
                showToast('L2ARC added successfully!', 'success');
            } else {
                showToast(data.error, 'error');
            }
        } catch (error) {
            showToast('Error adding L2ARC', 'error');
        } finally {
            hideLoading();
        }
    }

    async function addZIL() {
        const pool = document.getElementById('zil-pool').value;
        const device = document.getElementById('zil-device').value;
        const mirror = document.getElementById('zil-mirror').checked;

        if (!pool || !device) {
            showToast('Please select pool and device', 'error');
            return;
        }

        try {
            showLoading('Adding ZIL...');
            const response = await csrfFetch('/api/snapshots/schedules', {
                method: 'POST',
                body: JSON.stringify({ action: 'add_zil', pool, device, mirror })
            });

            const data = await response.json();
            if (data.success) {
                showToast('ZIL added successfully!', 'success');
            } else {
                showToast(data.error, 'error');
            }
        } catch (error) {
            showToast('Error adding ZIL', 'error');
        } finally {
            hideLoading();
        }
    }

    async function setCompression() {
        const dataset = document.getElementById('comp-dataset').value;
        const compression = document.getElementById('comp-algorithm').value;

        try {
            showLoading('Setting compression...');
            const response = await csrfFetch('/api/snapshots/schedules', {
                method: 'POST',
                body: JSON.stringify({ action: 'set_compression', dataset, compression })
            });

            const data = await response.json();
            if (data.success) {
                showToast('Compression updated!', 'success');
            } else {
                showToast(data.error, 'error');
            }
        } catch (error) {
            showToast('Error setting compression', 'error');
        } finally {
            hideLoading();
        }
    }

    async function setDedup() {
        const dataset = document.getElementById('dedup-dataset').value;
        const dedup = document.getElementById('dedup-setting').value;

        if (dedup !== 'off') {
            if (!await ui.confirmWithCheckbox(
                'Enable Deduplication', 
                'Deduplication requires significant RAM (~5GB per 1TB of data). This can impact system performance if insufficient RAM is available.',
                'I understand the RAM requirements and want to proceed'
            )) {
                return;
            }
        }

        try {
            showLoading('Setting deduplication...');
            const response = await csrfFetch('/api/snapshots/schedules', {
                method: 'POST',
                body: JSON.stringify({ action: 'set_dedup', dataset, dedup })
            });

            const data = await response.json();
            if (data.success) {
                showToast('Deduplication updated!', 'success');
            } else {
                showToast(data.error, 'error');
            }
        } catch (error) {
            showToast('Error setting dedup', 'error');
        } finally {
            hideLoading();
        }
    }

    async function createSnapshotSchedule() {
        const dataset = await ui.prompt('Create Snapshot Schedule', 'Enter dataset name:', '', 'pool/dataset');
        if (!dataset) return;

        const schedule = await ui.prompt('Snapshot Schedule', 'Enter schedule (hourly/daily/weekly/monthly):', '', 'daily');
        if (!schedule) return;

        try {
            showLoading('Creating schedule...');
            const response = await csrfFetch('/api/snapshots/schedules', {
                method: 'POST',
                body: JSON.stringify({
                    action: 'create_snapshot_schedule',
                    dataset,
                    schedule,
                    retention_count: 7,
                    retention_days: 30
                })
            });

            const data = await response.json();
            if (data.success) {
                showToast('Schedule created!', 'success');
                loadSnapshotSchedules();
            } else {
                showToast(data.error, 'error');
            }
        } catch (error) {
            showToast('Error creating schedule', 'error');
        } finally {
            hideLoading();
        }
    }

    async function loadSnapshotSchedules() {
        try {
            const response = await csrfFetch('/api/snapshots/schedules');
            const data = await response.json();
            
            if (data.success) {
                const container = document.getElementById('snapshot-schedules');
                container.innerHTML = data.schedules.map(s => `
                    <div class="schedule-item">
                        <strong>${s.dataset}</strong> - ${s.schedule}
                        <button onclick="deleteSchedule(${s.id})" class="btn btn-sm">Delete</button>
                    </div>
                `).join('');
            }
        } catch (error) {
            console.error('Failed to load schedules', error);
        }
    }

    async function deleteSchedule(id) {
        if (!await ui.confirm('Delete Schedule', 'Delete this snapshot schedule? Existing snapshots will be kept.')) return;
        
        try {
            const response = await csrfFetch('/api/snapshots/schedules', {
                method: 'POST',
                body: JSON.stringify({ action: 'delete_snapshot_schedule', schedule_id: id })
            });

            const data = await response.json();
            if (data.success) {
                showToast('Schedule deleted', 'success');
                loadSnapshotSchedules();
            }
        } catch (error) {
            showToast('Error deleting schedule', 'error');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadSnapshotSchedules();
    });
    </script>

    <style>
    .tabs { display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 1px solid #e0e0e0; }
    .tab { padding: 12px 24px; background: none; border: none; cursor: pointer; border-bottom: 2px solid transparent; }
    .tab.active { border-bottom-color: var(--primary); color: var(--primary); font-weight: 600; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .warning-box { background: #fff3cd; border: 1px solid #ffc107; padding: 12px; border-radius: 4px; margin: 16px 0; }
    .schedule-item { padding: 12px; background: #f5f5f5; margin-top: 8px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
    </style>
  <script src="/assets/js/realtime-client.js"></script>

<!-- v2.1.0: Scrub, VDEV, Disk Replace, Capacity Guardian -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const main = document.querySelector('.main');
  if (!main) return;

  // Inject new sections after existing content
  const newSections = document.createElement('div');
  newSections.innerHTML = `
    <div style="margin-top:48px;">
      <h2 class="page-title" style="font-size:28px;">Pool Operations</h2>
      <p class="page-subtitle" style="margin-bottom:32px;">Scrub • Expand • Replace • Capacity</p>

      <!-- Scrub Section -->
      <div class="card" style="padding:32px;margin-bottom:24px;border-left:4px solid var(--md-sys-color-success);">
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;">
          <span class="material-symbols-rounded" style="font-size:32px;color:var(--md-sys-color-success);">verified_user</span>
          <div style="flex:1;">
            <div style="font-size:20px;font-weight:800;">ZFS Scrub</div>
            <div style="font-size:14px;color:rgba(255,255,255,0.5);">Data integrity verification</div>
          </div>
          <div style="display:flex;gap:8px;">
            <select id="scrub-pool" class="btn" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:var(--md-sys-shape-corner-medium);padding:10px 16px;color:#fff;appearance:none;">
              <option value="">Select pool...</option>
            </select>
            <button class="btn btn-primary" onclick="startScrub()">
              <span class="material-symbols-rounded" style="font-size:18px;">play_arrow</span> Start
            </button>
            <button class="btn" onclick="stopScrub()" style="background:rgba(255,255,255,0.05);">
              <span class="material-symbols-rounded" style="font-size:18px;">stop</span> Stop
            </button>
          </div>
        </div>
        <div id="scrub-status" style="font-family:monospace;font-size:13px;color:rgba(255,255,255,0.6);padding:12px;background:rgba(0,0,0,0.3);border-radius:var(--md-sys-shape-corner-small);">No scrub running</div>
      </div>

      <!-- VDEV Add Section -->
      <div class="card" style="padding:32px;margin-bottom:24px;border-left:4px solid #f59e0b;">
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;">
          <span class="material-symbols-rounded" style="font-size:32px;color:#f59e0b;">add_circle</span>
          <div>
            <div style="font-size:20px;font-weight:800;">Expand Pool</div>
            <div style="font-size:14px;color:rgba(255,255,255,0.5);">Add VDEV, L2ARC cache, or SLOG device</div>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:12px;align-items:end;">
          <div>
            <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px;">Pool</label>
            <select id="vdev-pool" class="btn" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:var(--md-sys-shape-corner-medium);padding:10px 16px;color:#fff;appearance:none;">
              <option value="">Select...</option>
            </select>
          </div>
          <div>
            <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px;">VDEV Type</label>
            <select id="vdev-type" class="btn" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:var(--md-sys-shape-corner-medium);padding:10px 16px;color:#fff;appearance:none;">
              <option value="mirror">Mirror</option>
              <option value="raidz">RAIDZ</option>
              <option value="raidz2">RAIDZ2</option>
              <option value="cache">L2ARC (Cache)</option>
              <option value="log">SLOG (Log)</option>
              <option value="special">Special</option>
              <option value="">Stripe (no redundancy)</option>
            </select>
          </div>
          <div>
            <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px;">Disks (comma-separated)</label>
            <input id="vdev-disks" type="text" placeholder="sdc,sdd" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:var(--md-sys-shape-corner-medium);padding:10px 16px;color:#fff;font-family:monospace;">
          </div>
          <button class="btn btn-primary" onclick="addVdev()" style="white-space:nowrap;">
            <span class="material-symbols-rounded" style="font-size:18px;">add</span> Add VDEV
          </button>
        </div>
      </div>

      <!-- Disk Replace Section -->
      <div class="card" style="padding:32px;margin-bottom:24px;border-left:4px solid #ef4444;">
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;">
          <span class="material-symbols-rounded" style="font-size:32px;color:#ef4444;">swap_horiz</span>
          <div>
            <div style="font-size:20px;font-weight:800;">Replace Failed Disk</div>
            <div style="font-size:14px;color:rgba(255,255,255,0.5);">Swap and resilver</div>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:12px;align-items:end;">
          <div>
            <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px;">Pool</label>
            <select id="replace-pool" class="btn" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:var(--md-sys-shape-corner-medium);padding:10px 16px;color:#fff;appearance:none;">
              <option value="">Select...</option>
            </select>
          </div>
          <div>
            <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px;">Failed Disk</label>
            <input id="replace-old" type="text" placeholder="sda" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:var(--md-sys-shape-corner-medium);padding:10px 16px;color:#fff;font-family:monospace;">
          </div>
          <div>
            <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px;">New Disk</label>
            <input id="replace-new" type="text" placeholder="sde" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:var(--md-sys-shape-corner-medium);padding:10px 16px;color:#fff;font-family:monospace;">
          </div>
          <button class="btn" onclick="replaceDisk()" style="white-space:nowrap;background:rgba(239,68,68,0.2);border:1px solid rgba(239,68,68,0.3);color:#ef4444;">
            <span class="material-symbols-rounded" style="font-size:18px;">swap_horiz</span> Replace
          </button>
        </div>
      </div>

      <!-- Capacity Guardian -->
      <div class="card" style="padding:32px;margin-bottom:24px;border-left:4px solid var(--md-sys-color-primary);">
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;">
          <span class="material-symbols-rounded" style="font-size:32px;color:var(--md-sys-color-primary);">shield</span>
          <div style="flex:1;">
            <div style="font-size:20px;font-weight:800;">Capacity Guardian</div>
            <div style="font-size:14px;color:rgba(255,255,255,0.5);">Emergency reserve protects against ZFS full freeze</div>
          </div>
          <button class="btn btn-primary" onclick="setupReserve()" style="white-space:nowrap;">Setup 2% Reserve</button>
          <button class="btn" onclick="releaseReserve()" style="white-space:nowrap;background:rgba(255,255,255,0.05);">Release</button>
        </div>
        <div id="capacity-status" style="font-family:monospace;font-size:13px;color:rgba(255,255,255,0.6);"></div>
      </div>

      <!-- Extra Actions Row -->
      <div style="display:flex;flex-wrap:wrap;gap:12px;margin-top:24px;">
        <button class="btn" onclick="runSMART('short')" style="background:rgba(255,255,255,0.05);">
          <span class="material-symbols-rounded" style="font-size:18px;">health_and_safety</span> SMART Short</button>
        <button class="btn" onclick="runSMART('long')" style="background:rgba(255,255,255,0.05);">
          <span class="material-symbols-rounded" style="font-size:18px;">health_and_safety</span> SMART Long</button>
        <button class="btn" onclick="showSMARTResults()" style="background:rgba(255,255,255,0.05);">
          <span class="material-symbols-rounded" style="font-size:18px;">assignment</span> SMART Results</button>
        <button class="btn" onclick="rollbackSnapshot()" style="background:rgba(239,68,68,0.15);color:#ef4444;">
          <span class="material-symbols-rounded" style="font-size:18px;">undo</span> Rollback Snapshot</button>
        <button class="btn" onclick="removePoolDevice()" style="background:rgba(255,255,255,0.05);">
          <span class="material-symbols-rounded" style="font-size:18px;">eject</span> Remove Device</button>
        <button class="btn" onclick="openScrubScheduler()" style="background:rgba(255,255,255,0.05);">
          <span class="material-symbols-rounded" style="font-size:18px;">calendar_month</span> Schedule Scrub</button>
        <button class="btn" onclick="revokeDeleg()" style="background:rgba(255,255,255,0.05);">
          <span class="material-symbols-rounded" style="font-size:18px;">person_remove</span> Revoke Delegation</button>
      </div>
    </div>
  `;
  main.appendChild(newSections);

  // Load pools for dropdowns
  loadPoolSelectors();
  loadCapacityStatus();
  refreshScrubStatus();
});

async function loadPoolSelectors() {
  try {
    const r = await csrfFetch('/api/zfs/pools');
    const d = await r.json();
    if (!d.success || !d.pools) return;
    ['scrub-pool','vdev-pool','replace-pool'].forEach(id => {
      const sel = document.getElementById(id);
      if (!sel) return;
      d.pools.forEach(p => {
        const o = document.createElement('option');
        o.value = p.name || p;
        o.textContent = p.name || p;
        sel.appendChild(o);
      });
    });
  } catch(e) {}
}

async function startScrub() {
  const pool = document.getElementById('scrub-pool').value;
  if (!pool) { ui.toast('Select a pool', 'warning'); return; }
  try {
    const r = await csrfFetch('/api/zfs/scrub/start', { method:'POST', body:JSON.stringify({pool}) });
    const d = await r.json();
    d.success ? ui.toast('Scrub started', 'success') : ui.toast(d.error, 'error');
    refreshScrubStatus();
  } catch(e) { ui.toast('Failed', 'error'); }
}

async function stopScrub() {
  const pool = document.getElementById('scrub-pool').value;
  if (!pool) return;
  try {
    const r = await csrfFetch('/api/zfs/scrub/stop', { method:'POST', body:JSON.stringify({pool}) });
    const d = await r.json();
    d.success ? ui.toast('Scrub stopped', 'success') : ui.toast(d.error, 'error');
    refreshScrubStatus();
  } catch(e) { ui.toast('Failed', 'error'); }
}

async function refreshScrubStatus() {
  const pool = document.getElementById('scrub-pool').value;
  if (!pool) return;
  try {
    const r = await csrfFetch('/api/zfs/scrub/status?pool=' + pool);
    const d = await r.json();
    document.getElementById('scrub-status').textContent = d.scrub || 'No scrub running';
  } catch(e) {}
}

async function addVdev() {
  const pool = document.getElementById('vdev-pool').value;
  const type = document.getElementById('vdev-type').value;
  const disks = document.getElementById('vdev-disks').value.split(',').map(s=>s.trim()).filter(Boolean);
  if (!pool || !disks.length) { ui.toast('Pool and disks required', 'warning'); return; }
  if (!await ui.confirm('Add VDEV', `Add ${type||'stripe'} (${disks.join(', ')}) to ${pool}? This cannot be undone.`)) return;
  try {
    const r = await csrfFetch('/api/zfs/pool/add-vdev', { method:'POST', body:JSON.stringify({pool, vdev_type:type, disks}) });
    const d = await r.json();
    d.success ? ui.toast('VDEV added', 'success') : ui.toast(d.error, 'error');
  } catch(e) { ui.toast('Failed', 'error'); }
}

async function replaceDisk() {
  const pool = document.getElementById('replace-pool').value;
  const old_disk = document.getElementById('replace-old').value.trim();
  const new_disk = document.getElementById('replace-new').value.trim();
  if (!pool || !old_disk || !new_disk) { ui.toast('All fields required', 'warning'); return; }
  if (!await ui.confirm('Replace Disk', `Replace ${old_disk} with ${new_disk} in ${pool}? Resilver will start.`)) return;
  try {
    const r = await csrfFetch('/api/zfs/pool/replace', { method:'POST', body:JSON.stringify({pool, old_disk, new_disk}) });
    const d = await r.json();
    d.success ? ui.toast('Resilver started', 'success') : ui.toast(d.error, 'error');
  } catch(e) { ui.toast('Failed', 'error'); }
}

async function loadCapacityStatus() {
  try {
    const r = await csrfFetch('/api/zfs/capacity');
    const d = await r.json();
    if (!d.success) return;
    const el = document.getElementById('capacity-status');
    if (!d.pools || !d.pools.length) { el.textContent = 'No pools found'; return; }
    el.innerHTML = d.pools.map(p => {
      const color = p.state==='emergency'?'#ef4444':p.state==='critical'?'#f59e0b':p.state==='warning'?'#eab308':'var(--md-sys-color-success)';
      return `<div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
        <span style="width:8px;height:8px;border-radius:50%;background:${color};"></span>
        <strong>${p.pool}</strong>
        <span>${p.used_percent}% used</span>
        <span class="badge badge-${p.state==='ok'?'success':p.state==='warning'?'warning':'error'}">${p.state}</span>
        ${p.has_reserve?'<span class="badge badge-info">Reserve active</span>':''}
      </div>`;
    }).join('');
  } catch(e) {}
}

async function setupReserve() {
  const pool = document.getElementById('vdev-pool').value || document.getElementById('scrub-pool').value;
  if (!pool) { ui.toast('Select a pool first', 'warning'); return; }
  try {
    const r = await csrfFetch('/api/zfs/capacity/reserve?pool='+pool, { method:'POST' });
    const d = await r.json();
    d.success ? ui.toast(`Reserve set: ${d.reserve_human}`, 'success') : ui.toast(d.error, 'error');
    loadCapacityStatus();
  } catch(e) { ui.toast('Failed', 'error'); }
}

// SMART Tests
async function runSMART(type) {
  const disk = await ui.prompt('SMART Test', 'Disk device:', '', 'sda');
  if (!disk) return;
  try { const r = await csrfFetch('/api/zfs/smart/test',{method:'POST',body:JSON.stringify({disk,test_type:type||'short'})}); const d = await r.json();
    d.success ? ui.toast('SMART '+type+' test started on '+disk,'success') : ui.toast(d.error,'error');
  } catch(e) { ui.toast('Failed','error'); }
}
async function showSMARTResults() {
  const disk = await ui.prompt('SMART Results', 'Disk device:', '', 'sda');
  if (!disk) return;
  try { const r = await csrfFetch('/api/zfs/smart/results?disk='+encodeURIComponent(disk)); const d = await r.json();
    await ui.modal('SMART Results: '+disk, '<pre style="max-height:400px;overflow:auto;font-family:monospace;font-size:12px;">'+(d.output||d.error||JSON.stringify(d,null,2))+'</pre>');
  } catch(e) { ui.toast('Failed','error'); }
}

// Snapshot Rollback
async function rollbackSnapshot() {
  const snap = await ui.prompt('Rollback Snapshot', 'Full snapshot name:', '', 'tank/data@daily-2025-01-01');
  if (!snap) return;
  if (!await ui.confirm('DANGEROUS: Rollback', 'Rollback to '+snap+'? ALL data written after this snapshot will be LOST.')) return;
  try { const r = await csrfFetch('/api/zfs/snapshots/rollback',{method:'POST',body:JSON.stringify({snapshot:snap})}); const d = await r.json();
    d.success ? ui.toast('Rolled back to '+snap,'success') : ui.toast(d.error,'error');
  } catch(e) { ui.toast('Failed','error'); }
}

// Remove cache/log device
async function removePoolDevice() {
  const pool = document.getElementById('vdev-pool').value;
  const device = await ui.prompt('Remove Device', 'Device to remove (cache/log only):', '', 'sdc');
  if (!pool || !device) { ui.toast('Pool and device required','warning'); return; }
  if (!await ui.confirm('Remove Device', 'Remove '+device+' from '+pool+'?')) return;
  try { const r = await csrfFetch('/api/zfs/pool/remove-device',{method:'POST',body:JSON.stringify({pool,device})}); const d = await r.json();
    d.success ? ui.toast('Device removed','success') : ui.toast(d.error,'error');
  } catch(e) { ui.toast('Failed','error'); }
}

// Capacity release
async function releaseReserve() {
  const pool = document.getElementById('vdev-pool').value || document.getElementById('scrub-pool').value;
  if (!pool) { ui.toast('Select a pool','warning'); return; }
  try { const r = await csrfFetch('/api/zfs/capacity/release?pool='+pool,{method:'POST'}); const d = await r.json();
    d.success ? ui.toast('Reserve released','success') : ui.toast(d.error,'error'); loadCapacityStatus();
  } catch(e) { ui.toast('Failed','error'); }
}

// Delegation revoke
async function revokeDeleg() {
  const dataset = await ui.prompt('Revoke Delegation', 'Dataset:','','tank/data');
  if (!dataset) return;
  const user = await ui.prompt('Revoke From', 'Username:');
  if (!user) return;
  try { const r = await csrfFetch('/api/zfs/delegation/revoke',{method:'POST',body:JSON.stringify({dataset,user})}); const d = await r.json();
    d.success ? ui.toast('Delegation revoked','success') : ui.toast(d.error,'error');
  } catch(e) { ui.toast('Failed','error'); }
}

// Scrub Scheduler
async function openScrubScheduler() {
  try { const r = await csrfFetch('/api/zfs/scrub/schedule'); const d = await r.json();
    const schedules = d.schedules || [];
    const pool = document.getElementById('scrub-pool').value;
    if (!pool) { ui.toast('Select a pool','warning'); return; }
    const interval = await ui.prompt('Scrub Schedule', 'Interval (daily/weekly/monthly):', 'weekly');
    if (!interval) return;
    const hour = await ui.prompt('Scrub Hour', 'Hour (0-23):', '3');
    if (hour === null) return;
    schedules.push({pool, interval, hour: parseInt(hour), day: 0});
    const sr = await csrfFetch('/api/zfs/scrub/schedule',{method:'POST',body:JSON.stringify(schedules)});
    const sd = await sr.json();
    sd.success ? ui.toast('Scrub scheduled for '+pool,'success') : ui.toast(sd.error,'error');
  } catch(e) { ui.toast('Failed','error'); }
}
</script>
</body>
</html>
