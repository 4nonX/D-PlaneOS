<!DOCTYPE html>
<html lang="en">
<head><style>html{background:#0a0a0a}</style><style></style>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>System Settings - D-PlaneOS</title>
  <link rel="stylesheet" href="/assets/css/design-tokens.css">
<link rel="stylesheet" href="/assets/css/m3-tokens.css">
<link rel="stylesheet" href="/assets/css/m3-components.css">
<link rel="stylesheet" href="/assets/css/m3-icons.css">
  <link rel="stylesheet" href="/assets/css/enhanced-ui.css">
<link rel="stylesheet" href="/assets/css/m3-animations.css">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif; background: #0a0a0a; color: #fff; overflow-x: hidden; }


.logo { font-size: 20px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; cursor: pointer; }


.nav-link:hover, 
.main { max-width: 1600px; margin: 140px auto 60px; padding: 0 40px; }
.page-header { margin-bottom: 48px; }
.page-title { font-size: 32px; font-weight: 700; letter-spacing: -1.5px; margin-bottom: 12px; }
.page-subtitle { font-size: 18px; color: rgba(255,255,255,0.6); }
.pool-card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: var(--radius-xl); padding: 32px; margin-bottom: 24px; border-left: 4px solid var(--primary); }
.pool-header { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
.pool-icon { font-size: 32px; color: var(--primary); }
.pool-info { flex: 1; }
.pool-name { font-size: 28px; font-weight: 700; margin-bottom: 6px; }
.pool-details { font-size: 15px; color: rgba(255,255,255,0.6); }
.capacity-bar { height: 12px; background: rgba(255,255,255,0.05); border-radius: 24px; overflow: hidden; margin: 20px 0; }
.capacity-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--primary)); border-radius: 24px; transition: width 0.5s; }
/* Badge styles are in m3-components.css */
.icon-btn { width: 40px; height: 40px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,0.8); cursor: pointer; transition: all 0.3s; border: none; }
.icon-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
.btn { background: rgba(255,255,255,0.1); color: #fff; padding: 12px 24px; border-radius: 10px; font-weight: 500; font-size: 14px; border: none; cursor: pointer; transition: all 0.3s; }
.btn:hover { background: rgba(255,255,255,0.15); }
.btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--primary) 100%); }
.btn-primary:hover { box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4); }
.fab { position: fixed; bottom: 32px; right: 32px; width: 64px; height: 64px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary) 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4); cursor: pointer; transition: all 0.3s; border: none; color: #fff; }
.fab:hover { transform: translateY(-4px); box-shadow: 0 12px 48px rgba(102, 126, 234, 0.6); }
</style>
<style type="text/css" id="operaUserStyle"></style><link rel="stylesheet" href="/assets/css/ui-components.css">
<script src="/assets/js/core.js"></script>
<script src="/assets/js/nav-flyout.js"></script>
<script src="/assets/js/hybrid-router.js"></script>
  <script src="/assets/js/enhanced-ui.js"></script>
  <script src="/assets/js/connection-monitor.js"></script>
  <script src="/assets/js/keyboard-shortcuts.js"></script>
  <script src="/assets/js/form-validator.js"></script>
  <link rel="stylesheet" href="/assets/css/material-symbols-local.css">
  <link rel="stylesheet" href="/assets/css/ui-consistency.css">
  <link rel="stylesheet" href="/assets/css/ui-polish.css">
  <script src="/assets/js/daemon-api.js"></script>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Header */
        .header {
            margin-bottom: 32px;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 400;
            margin-bottom: 8px;
            color: var(--md-sys-color-on-surface);
        }

        .header p {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
        }

        /* Cards */
        .settings-card {
            background: var(--md-sys-color-surface-container);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-header .material-icons {
            font-size: 24px;
            margin-right: 12px;
            color: var(--md-sys-color-primary);
        }

        .card-header h2 {
            font-size: 20px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
        }

        /* Status Indicators */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .status-item {
            background: var(--md-sys-color-surface);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .status-label {
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 8px;
        }

        .status-value {
            font-size: 28px;
            font-weight: 400;
            color: var(--md-sys-color-on-surface);
            margin-bottom: 4px;
        }

        .status-subtitle {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .status-bar {
            height: 8px;
            background: var(--md-sys-color-surface-variant);
            border-radius: 4px;
            margin-top: 12px;
            overflow: hidden;
        }

        .status-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease, background-color 0.3s ease;
        }

        .status-bar-fill.ok {
            background: var(--md-sys-color-tertiary);
        }

        .status-bar-fill.warning {
            background: #FB8C00;
        }

        .status-bar-fill.critical {
            background: var(--md-sys-color-error);
        }

        /* Alert Boxes */
        .alert {
            display: flex;
            align-items: flex-start;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .alert .material-icons {
            font-size: 24px;
            margin-right: 12px;
        }

        .alert-content h3 {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .alert-content p {
            font-size: 14px;
            line-height: 1.5;
        }

        .alert.warning {
            background: #FFF8E1;
            color: #F57F17;
        }

        .alert.error {
            background: #FFEBEE;
            color: #C62828;
        }

        .alert.info {
            background: #E3F2FD;
            color: #1565C0;
        }

        /* Slider Controls */
        .setting-row {
            margin-bottom: 32px;
        }

        .setting-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .setting-label h3 {
            font-size: 16px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
        }

        .setting-value {
            font-size: 16px;
            font-weight: 500;
            color: var(--md-sys-color-primary);
        }

        .setting-description {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 16px;
            line-height: 1.5;
        }

        /* Material Design 3 Slider */
        .slider-container {
            position: relative;
            margin-bottom: 8px;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: var(--md-sys-color-surface-variant);
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--md-sys-color-primary);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--md-sys-color-primary);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        /* Toggle Switch */
        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .toggle-row:last-child {
            border-bottom: none;
        }

        .toggle-info h3 {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 4px;
            color: var(--md-sys-color-on-surface);
        }

        .toggle-info p {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 32px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--md-sys-color-surface-variant);
            transition: 0.3s;
            border-radius: 16px;
        }

        .switch-slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 4px;
            bottom: 4px;
            background-color: var(--md-sys-color-outline);
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .switch-slider {
            background-color: var(--md-sys-color-primary);
        }

        input:checked + .switch-slider:before {
            transform: translateX(20px);
            background-color: var(--md-sys-color-on-primary);
        }

        /* Buttons */
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .md-button {
            padding: 12px 24px;
            border-radius: 20px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .md-button.filled {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }

        .md-button.outlined {
            background: transparent;
            color: var(--md-sys-color-primary);
            border: 1px solid var(--md-sys-color-outline);
        }

        .md-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        /* Live Monitoring Section */
        .monitoring-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .metric-card {
            background: var(--md-sys-color-surface);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .metric-icon {
            font-size: 32px;
            color: var(--md-sys-color-primary);
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
        }

        .metric-label {
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
            margin-top: 4px;
        }
    </style>
</head>
<body>

<nav class="nav-container">
  <div class="nav-main">
    <div style="display: flex; align-items: center; gap: 16px;">
      <div class="logo">
        D-PlaneOS
        <span class="version-badge">v2.0.0</span>
      </div>
    </div>
    
    <div class="nav-links">
      <button class="nav-link" onclick="navigateToSection('dashboard')" data-section="dashboard">
        Dashboard
      </button>
      <button class="nav-link" onclick="toggleSubNav('storage', this)" data-section="storage">
        Storage
      </button>
      <button class="nav-link" onclick="toggleSubNav('compute', this)" data-section="compute">
        Compute
      </button>
      <button class="nav-link" onclick="toggleSubNav('network', this)" data-section="network">
        Network
      </button>
      <button class="nav-link" onclick="toggleSubNav('identity', this)" data-section="identity">
        Identity
      </button>
      <button class="nav-link" onclick="toggleSubNav('security', this)" data-section="security">
        Security
      </button>
      <button class="nav-link" onclick="toggleSubNav('system', this)" data-section="system">
        System
      </button>
    </div>
    
    <div class="nav-actions">
      <button class="nav-action-btn" onclick="showKeyboardHelp()" title="Keyboard Shortcuts (?)">
        <span class="material-symbols-rounded">keyboard</span>
      </button>
      <div class="connection-status online" id="navConnectionStatus">
        <span class="status-dot"></span>
        <span>Connected</span>
      </div>
    </div>
  </div>

  <!-- Storage Sub-Navigation -->
  <div id="sub-storage" class="nav-sub">
    <div class="nav-sub-inner">
      <a href="pools.html" class="sub-link" data-page="pools">
        <span class="material-symbols-rounded">database</span>
        ZFS Pools
      </a>
      <a href="pools-advanced.html" class="sub-link" data-page="pools-advanced">
        <span class="material-symbols-rounded">photo_camera</span>
        Snapshots
      </a>
      <a href="shares.html" class="sub-link" data-page="shares">
        <span class="material-symbols-rounded">folder_shared</span>
        Shares
      </a>
      <a href="replication.html" class="sub-link" data-page="replication">
        <span class="material-symbols-rounded">sync</span>
        Replication
      </a>
      <a href="files.html" class="sub-link" data-page="files">
        <span class="material-symbols-rounded">folder_open</span>
        File Explorer
      </a>
      <a href="quotas.html" class="sub-link" data-page="quotas">
        <span class="material-symbols-rounded">pie_chart</span>
        Quotas
      </a>
      <a href="snapshot-scheduler.html" class="sub-link" data-page="snapshot-scheduler">
        <span class="material-symbols-rounded">schedule</span>
        Snapshot Scheduler
      </a>
      <a href="acl-manager.html" class="sub-link" data-page="acl-manager">
        <span class="material-symbols-rounded">admin_panel_settings</span>
        ACL Manager
      </a>
      <a href="zfs-encryption.html" class="sub-link" data-page="zfs-encryption">
        <span class="material-symbols-rounded">enhanced_encryption</span>
        Encryption
      </a>
      <a href="files-enhanced.html" class="sub-link" data-page="files-enhanced">
        <span class="material-symbols-rounded">upload_file</span>
        File Upload
      </a>
      <a href="cloud-sync.html" class="sub-link" data-page="cloud-sync">
        <span class="material-symbols-rounded">cloud_sync</span>
        Cloud Sync
      </a>
    </div>
  </div>

  <!-- Compute Sub-Navigation -->
  <div id="sub-compute" class="nav-sub">
    <div class="nav-sub-inner">
      <a href="docker.html" class="sub-link" data-page="docker">
        <span class="material-symbols-rounded">dns</span>
        Docker Containers
      </a>
      <a href="modules.html" class="sub-link" data-page="modules">
        <span class="material-symbols-rounded">extension</span>
        App Modules
      </a>
    </div>
  </div>

  <!-- Network Sub-Navigation -->
  <div id="sub-network" class="nav-sub">
    <div class="nav-sub-inner">
      <a href="network.html" class="sub-link" data-page="network">
        <span class="material-symbols-rounded">lan</span>
        Network Settings
      </a>
      <a href="network-interfaces.html" class="sub-link" data-page="network-interfaces">
        <span class="material-symbols-rounded">settings_ethernet</span>
        Interfaces
      </a>
      <a href="network-dns.html" class="sub-link" data-page="network-dns">
        <span class="material-symbols-rounded">dns</span>
        DNS
      </a>
      <a href="network-routing.html" class="sub-link" data-page="network-routing">
        <span class="material-symbols-rounded">route</span>
        Routing
      </a>
    </div>
  </div>

  <!-- Identity Sub-Navigation -->
  <div id="sub-identity" class="nav-sub">
    <div class="nav-sub-inner">
      <a href="users.html" class="sub-link" data-page="users">
        <span class="material-symbols-rounded">person</span>
        Users
      </a>
      <a href="groups.html" class="sub-link" data-page="groups">
        <span class="material-symbols-rounded">group</span>
        Groups
      </a>
      <a href="directory-service.html" class="sub-link" data-page="directory-service">
        <span class="material-symbols-rounded">domain</span>
        Directory Service
      </a>
      <a href="rbac-management.html" class="sub-link" data-page="rbac-management">
        <span class="material-symbols-rounded">admin_panel_settings</span>
        Roles & Permissions
      </a>
    </div>
  </div>

  <!-- Security Sub-Navigation -->
  <div id="sub-security" class="nav-sub">
    <div class="nav-sub-inner">
      <a href="security.html" class="sub-link" data-page="security">
        <span class="material-symbols-rounded">shield</span>
        Security Settings
      </a>
      <a href="audit.html" class="sub-link" data-page="audit">
        <span class="material-symbols-rounded">fact_check</span>
        Audit Logs
      </a>
      <a href="firewall.html" class="sub-link" data-page="firewall">
        <span class="material-symbols-rounded">local_fire_department</span>
        Firewall
      </a>
      <a href="certificates.html" class="sub-link" data-page="certificates">
        <span class="material-symbols-rounded">verified_user</span>
        Certificates
      </a>
    </div>
  </div>

  <!-- System Sub-Navigation -->
  <div id="sub-system" class="nav-sub">
    <div class="nav-sub-inner">
      <a href="settings.html" class="sub-link" data-page="settings">
        <span class="material-symbols-rounded">tune</span>
        General Settings
      </a>
      <a href="logs.html" class="sub-link" data-page="logs">
        <span class="material-symbols-rounded">description</span>
        System Logs
      </a>
      <a href="ups.html" class="sub-link" data-page="ups">
        <span class="material-symbols-rounded">battery_charging_full</span>
        UPS Management
      </a>
      <a href="reporting.html" class="sub-link" data-page="reporting">
        <span class="material-symbols-rounded">monitoring</span>
        Reporting
      </a>
      <a href="power-management.html" class="sub-link" data-page="power-management">
        <span class="material-symbols-rounded">power_settings_new</span>
        Power Management
      </a>
      <a href="system-settings.html" class="sub-link" data-page="system-settings">
        <span class="material-symbols-rounded">settings_suggest</span>
        System Settings
      </a>
      <a href="system-monitoring.html" class="sub-link" data-page="system-monitoring">
        <span class="material-symbols-rounded">monitor_heart</span>
        Monitoring
      </a>
      <a href="hardware.html" class="sub-link" data-page="hardware">
        <span class="material-symbols-rounded">developer_board</span>
        Hardware
      </a>
      <a href="ipmi.html" class="sub-link" data-page="ipmi">
        <span class="material-symbols-rounded">memory</span>
        IPMI
      </a>
      <a href="removable-media-ui.html" class="sub-link" data-page="removable-media-ui">
        <span class="material-symbols-rounded">usb</span>
        Removable Media
      </a>
    </div>
  </div>
</nav>

<main class="main">
<div class="container">
        <!-- Header -->
        <div class="header">
            <h1>System Settings</h1>
            <p>Configure resource limits and monitoring thresholds</p>
        </div>

        <!-- Live Status Overview -->
        <div class="settings-card">
            <div class="card-header">
                <span class="material-icons">dashboard</span>
                <h2>Live System Status</h2>
            </div>
            
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-label">Inotify Watches</div>
                    <div class="status-value" id="inotify-used">-</div>
                    <div class="status-subtitle">of <span id="inotify-limit">-</span> available</div>
                    <div class="status-bar">
                        <div class="status-bar-fill" id="inotify-bar" style="width: 0%"></div>
                    </div>
                </div>

                <div class="status-item">
                    <div class="status-label">Memory Usage</div>
                    <div class="status-value" id="memory-used">-</div>
                    <div class="status-subtitle">of <span id="memory-total">-</span> total</div>
                    <div class="status-bar">
                        <div class="status-bar-fill" id="memory-bar" style="width: 0%"></div>
                    </div>
                </div>

                <div class="status-item">
                    <div class="status-label">ZFS ARC</div>
                    <div class="status-value" id="arc-used">-</div>
                    <div class="status-subtitle">of <span id="arc-limit">-</span> limit</div>
                    <div class="status-bar">
                        <div class="status-bar-fill" id="arc-bar" style="width: 0%"></div>
                    </div>
                </div>

                <div class="status-item">
                    <div class="status-label">I/O Wait</div>
                    <div class="status-value" id="iowait-value">-</div>
                    <div class="status-subtitle">Current load</div>
                    <div class="status-bar">
                        <div class="status-bar-fill" id="iowait-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Alerts Container -->
            <div id="alerts-container"></div>
        </div>

        <!-- Inotify Settings -->
        <div class="settings-card">
            <div class="card-header">
                <span class="material-icons">visibility</span>
                <h2>File Monitoring (Inotify)</h2>
            </div>

            <div class="setting-row">
                <div class="setting-label">
                    <h3>Real-Time Indexing</h3>
                    <span class="setting-value" id="indexing-mode-value">Hybrid</span>
                </div>
                <div class="setting-description">
                    Controls how file changes are detected. Real-time uses inotify watches (limited). Periodic scans directories on interval (unlimited).
                </div>
                
                <div class="toggle-row">
                    <div class="toggle-info">
                        <h3>Enable Real-Time Monitoring</h3>
                        <p>Uses inotify watches for instant file detection</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="realtime-toggle" checked>
                        <span class="switch-slider"></span>
                    </label>
                </div>

                <div class="toggle-row">
                    <div class="toggle-info">
                        <h3>Periodic Background Scan</h3>
                        <p>Scans directories every 30 minutes (no watch limit)</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="periodic-toggle" checked>
                        <span class="switch-slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Memory Settings -->
        <div class="settings-card">
            <div class="card-header">
                <span class="material-icons">memory</span>
                <h2>Memory Management</h2>
            </div>

            <div class="setting-row">
                <div class="setting-label">
                    <h3>ZFS ARC Limit</h3>
                    <span class="setting-value" id="arc-limit-value">8 GB</span>
                </div>
                <div class="setting-description">
                    Maximum memory for ZFS cache. <strong>Warning:</strong> With Non-ECC RAM, keep ≤40% of total RAM to reduce bit-flip risk.
                </div>
                <div class="slider-container">
                    <input type="range" id="arc-slider" min="1" max="32" value="8" step="1">
                </div>
                <div class="setting-description" id="arc-recommendation" style="color: var(--md-sys-color-tertiary);"></div>
            </div>

            <div class="setting-row">
                <div class="setting-label">
                    <h3>Swap Aggressiveness</h3>
                    <span class="setting-value" id="swappiness-value">10</span>
                </div>
                <div class="setting-description">
                    How aggressively the kernel swaps to disk. Lower = keep apps in RAM. Higher = swap more freely.
                </div>
                <div class="slider-container">
                    <input type="range" id="swappiness-slider" min="0" max="100" value="10" step="5">
                </div>
            </div>
        </div>

        <!-- Monitoring Settings -->
        <div class="settings-card">
            <div class="card-header">
                <span class="material-icons">notifications</span>
                <h2>Alert Thresholds</h2>
            </div>

            <div class="setting-row">
                <div class="setting-label">
                    <h3>Inotify Warning Threshold</h3>
                    <span class="setting-value" id="inotify-warn-value">80%</span>
                </div>
                <div class="setting-description">
                    Alert when inotify watch usage exceeds this percentage
                </div>
                <div class="slider-container">
                    <input type="range" id="inotify-warn-slider" min="50" max="95" value="80" step="5">
                </div>
            </div>

            <div class="setting-row">
                <div class="setting-label">
                    <h3>Memory Warning Threshold</h3>
                    <span class="setting-value" id="memory-warn-value">85%</span>
                </div>
                <div class="setting-description">
                    Alert when memory usage exceeds this percentage
                </div>
                <div class="slider-container">
                    <input type="range" id="memory-warn-slider" min="70" max="95" value="85" step="5">
                </div>
            </div>

            <div class="setting-row">
                <div class="setting-label">
                    <h3>I/O Wait Warning Threshold</h3>
                    <span class="setting-value" id="iowait-warn-value">20%</span>
                </div>
                <div class="setting-description">
                    Alert when CPU I/O wait exceeds this percentage
                </div>
                <div class="slider-container">
                    <input type="range" id="iowait-warn-slider" min="10" max="50" value="20" step="5">
                </div>
            </div>

            <div class="toggle-row">
                <div class="toggle-info">
                    <h3>WebSocket Alerts</h3>
                    <p>Show real-time toast notifications for warnings</p>
                </div>
                <label class="switch">
                    <input type="checkbox" id="websocket-alerts-toggle" checked>
                    <span class="switch-slider"></span>
                </label>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="settings-card">
            <div class="button-group">
                <button class="md-button filled" onclick="saveSettings()">
                    <span class="material-icons">save</span>
                    Save Settings
                </button>
                <button class="md-button outlined" onclick="resetToDefaults()">
                    <span class="material-icons">restore</span>
                    Reset to Defaults
                </button>
                <button class="md-button outlined" onclick="runPreFlight()">
                    <span class="material-icons">check_circle</span>
                    Run Pre-Flight Check
                </button>
            </div>
        </div>
    </div>
</main>

<script>
// Navigation behavior
function navigateToSection(section) {
  if (section === 'dashboard') {
    window.location.href = 'index.html';
  }
}

function toggleSubNav(section, button) {
  // Remove active from all nav links
  document.querySelectorAll('.nav-link').forEach(link => {
    link.classList.remove('active');
  });
  
  // Add active to clicked button
  if (button) {
    button.classList.add('active');
  }
  
  // Hide all sub-navs
  document.querySelectorAll('.nav-sub').forEach(sub => {
    sub.classList.remove('active');
  });
  
  // Show selected sub-nav
  const subNav = document.getElementById(`sub-${section}`);
  if (subNav) {
    subNav.classList.add('active');
    document.body.classList.add('has-subnav');
  }
}

// Auto-detect current section and page on load
(function() {
  const currentPage = window.location.pathname.split('/').pop() || 'index.html';
  
  // Page to section mapping
  const pageMap = {
    'acl-manager.html': { section: 'storage', page: 'acl-manager' },
    'audit.html': { section: 'security', page: 'audit' },
    'certificates.html': { section: 'security', page: 'certificates' },
    'cloud-sync.html': { section: 'storage', page: 'cloud-sync' },
    'directory-service.html': { section: 'identity', page: 'directory-service' },
    'docker.html': { section: 'compute', page: 'docker' },
    'files-enhanced.html': { section: 'storage', page: 'files-enhanced' },
    'files.html': { section: 'storage', page: 'files' },
    'firewall.html': { section: 'security', page: 'firewall' },
    'groups.html': { section: 'identity', page: 'groups' },
    'hardware.html': { section: 'system', page: 'hardware' },
    'index.html': { section: 'dashboard', page: null },
    'ipmi.html': { section: 'system', page: 'ipmi' },
    'logs.html': { section: 'system', page: 'logs' },
    'modules.html': { section: 'compute', page: 'modules' },
    'network-dns.html': { section: 'network', page: 'network-dns' },
    'network-interfaces.html': { section: 'network', page: 'network-interfaces' },
    'network-routing.html': { section: 'network', page: 'network-routing' },
    'network.html': { section: 'network', page: 'network' },
    'pools-advanced.html': { section: 'storage', page: 'pools-advanced' },
    'pools.html': { section: 'storage', page: 'pools' },
    'power-management.html': { section: 'system', page: 'power-management' },
    'quotas.html': { section: 'storage', page: 'quotas' },
    'rbac-management.html': { section: 'identity', page: 'rbac-management' },
    'removable-media-ui.html': { section: 'system', page: 'removable-media-ui' },
    'replication.html': { section: 'storage', page: 'replication' },
    'reporting.html': { section: 'system', page: 'reporting' },
    'security.html': { section: 'security', page: 'security' },
    'settings.html': { section: 'system', page: 'settings' },
    'shares.html': { section: 'storage', page: 'shares' },
    'snapshot-scheduler.html': { section: 'storage', page: 'snapshot-scheduler' },
    'system-monitoring.html': { section: 'system', page: 'system-monitoring' },
    'system-settings.html': { section: 'system', page: 'system-settings' },
    'ups.html': { section: 'system', page: 'ups' },
    'users.html': { section: 'identity', page: 'users' },
    'zfs-encryption.html': { section: 'storage', page: 'zfs-encryption' }
  };
  
  const current = pageMap[currentPage];
  if (current) {
    // Activate section button
    const sectionBtn = document.querySelector(`[data-section="${current.section}"]`);
    if (sectionBtn) {
      sectionBtn.classList.add('active');
    }
    
    // Show and activate sub-nav if not dashboard
    if (current.section !== 'dashboard') {
      const subNav = document.getElementById(`sub-${current.section}`);
      if (subNav) {
        subNav.classList.add('active');
        document.body.classList.add('has-subnav');
        
        // Activate current page in sub-nav
        if (current.page) {
          const pageLink = subNav.querySelector(`[data-page="${current.page}"]`);
          if (pageLink) {
            pageLink.classList.add('active');
          }
        }
      }
    }
  }
})();

// Keyboard shortcuts
function showKeyboardHelp() {
  if (window.EnhancedUI) {
    const shortcuts = `Keyboard Shortcuts:

g + d → Dashboard
g + s → Storage
g + c → Compute
g + n → Network
g + u → Identity
g + e → Security
g + y → System

r → Refresh page
Esc → Close modals
? → Show this help`;
    EnhancedUI.toast(shortcuts, 'info', 8000);
  }
}

// Enhanced keyboard shortcuts for sections
(function() {
  let keySequence = '';
  let keyTimeout;
  
  document.addEventListener('keydown', (e) => {
    if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) return;
    
    keySequence += e.key;
    clearTimeout(keyTimeout);
    
    const shortcuts = {
      'gd': 'index.html',
      'gs': () => toggleSubNav('storage', document.querySelector('[data-section="storage"]')),
      'gc': () => toggleSubNav('compute', document.querySelector('[data-section="compute"]')),
      'gn': () => toggleSubNav('network', document.querySelector('[data-section="network"]')),
      'gu': () => toggleSubNav('identity', document.querySelector('[data-section="identity"]')),
      'ge': () => toggleSubNav('security', document.querySelector('[data-section="security"]')),
      'gy': () => toggleSubNav('system', document.querySelector('[data-section="system"]'))
    };
    
    if (shortcuts[keySequence]) {
      e.preventDefault();
      const action = shortcuts[keySequence];
      if (typeof action === 'function') {
        action();
      } else {
        window.location.href = action;
      }
      keySequence = '';
    } else if (e.key === '?') {
      e.preventDefault();
      showKeyboardHelp();
    }
    
    keyTimeout = setTimeout(() => keySequence = '', 1000);
  });
})();

// Connection status monitoring (integrates with existing connection-monitor.js)
if (window.ConnectionMonitor) {
  window.ConnectionMonitor.on('statusChange', (online) => {
    const status = document.getElementById('navConnectionStatus');
    if (status) {
      if (online) {
        status.classList.remove('offline');
        status.classList.add('online');
        status.innerHTML = '<span class="status-dot"></span><span>Connected</span>';
      } else {
        status.classList.remove('online');
        status.classList.add('offline');
        status.innerHTML = '<span class="status-dot"></span><span>Offline</span>';
      }
    }
  });
}
</script>

<script src="../assets/js/daemon-api.js"></script><script src="../assets/js/monitor-websocket.js"></script><script>
        // Initialize
        let systemProfile = null;
        let hasECC = false;

        // Load system profile
        async function loadSystemProfile() {
            try {
                const response = await daemonAPI('/api/system/profile');
                systemProfile = response;
                hasECC = systemProfile.has_ecc || false;
                
                // Update UI based on profile
                updateARCRecommendation();
            } catch (error) {
                console.error('Failed to load system profile:', error);
            }
        }

        // Update live metrics
        async function updateMetrics() {
            try {
                const metrics = await daemonAPI('/api/monitoring/metrics');
                
                // Inotify
                document.getElementById('inotify-used').textContent = formatNumber(metrics.inotify.used);
                document.getElementById('inotify-limit').textContent = formatNumber(metrics.inotify.limit);
                updateStatusBar('inotify-bar', metrics.inotify.percent);
                
                // Memory
                document.getElementById('memory-used').textContent = formatBytes(metrics.memory.used);
                document.getElementById('memory-total').textContent = formatBytes(metrics.memory.total);
                updateStatusBar('memory-bar', metrics.memory.percent);
                
                // ZFS ARC
                document.getElementById('arc-used').textContent = formatBytes(metrics.arc.used);
                document.getElementById('arc-limit').textContent = formatBytes(metrics.arc.limit);
                updateStatusBar('arc-bar', metrics.arc.percent);
                
                // I/O Wait
                document.getElementById('iowait-value').textContent = metrics.iowait + '%';
                updateStatusBar('iowait-bar', metrics.iowait);
                
                // Check for alerts
                checkThresholds(metrics);
                
            } catch (error) {
                console.error('Failed to update metrics:', error);
            }
        }

        function updateStatusBar(barId, percent) {
            const bar = document.getElementById(barId);
            bar.style.width = percent + '%';
            
            // Color coding
            if (percent < 70) {
                bar.className = 'status-bar-fill ok';
            } else if (percent < 90) {
                bar.className = 'status-bar-fill warning';
            } else {
                bar.className = 'status-bar-fill critical';
            }
        }

        function checkThresholds(metrics) {
            const alerts = [];
            
            // Inotify
            const inotifyWarn = parseInt(document.getElementById('inotify-warn-slider').value);
            if (metrics.inotify.percent >= inotifyWarn) {
                alerts.push({
                    type: 'warning',
                    icon: 'visibility_off',
                    title: 'Inotify Watches Critical',
                    message: `Usage at ${metrics.inotify.percent}%. Some file changes may not be detected. Consider stopping unused Docker containers or enabling periodic scan mode.`
                });
            }
            
            // Memory
            const memoryWarn = parseInt(document.getElementById('memory-warn-slider').value);
            if (metrics.memory.percent >= memoryWarn) {
                alerts.push({
                    type: 'warning',
                    icon: 'memory',
                    title: 'High Memory Usage',
                    message: `Memory at ${metrics.memory.percent}%. System may start swapping, causing performance degradation.`
                });
            }
            
            // I/O Wait
            const iowaitWarn = parseInt(document.getElementById('iowait-warn-slider').value);
            if (metrics.iowait >= iowaitWarn) {
                alerts.push({
                    type: 'warning',
                    icon: 'hourglass_empty',
                    title: 'High I/O Wait',
                    message: `CPU waiting ${metrics.iowait}% for disk I/O. UI may feel laggy. Check if ZFS scrub is running.`
                });
            }
            
            // Non-ECC Warning
            if (!hasECC && metrics.arc.percent > 40) {
                alerts.push({
                    type: 'error',
                    icon: 'warning',
                    title: 'Non-ECC RAM Risk',
                    message: `ZFS ARC using ${metrics.arc.percent}% of RAM. With Non-ECC RAM, keep ARC ≤40% to reduce bit-flip corruption risk.`
                });
            }
            
            displayAlerts(alerts);
        }

        function displayAlerts(alerts) {
            const container = document.getElementById('alerts-container');
            
            if (alerts.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = alerts.map(alert => `
                <div class="alert ${alert.type}">
                    <span class="material-icons">${alert.icon}</span>
                    <div class="alert-content">
                        <h3>${alert.title}</h3>
                        <p>${alert.message}</p>
                    </div>
                </div>
            `).join('');
        }

        // Slider updates
        document.getElementById('arc-slider').addEventListener('input', (e) => {
            const value = e.target.value;
            document.getElementById('arc-limit-value').textContent = value + ' GB';
            updateARCRecommendation();
        });

        document.getElementById('swappiness-slider').addEventListener('input', (e) => {
            const value = e.target.value;
            document.getElementById('swappiness-value').textContent = value;
        });

        document.getElementById('inotify-warn-slider').addEventListener('input', (e) => {
            const value = e.target.value;
            document.getElementById('inotify-warn-value').textContent = value + '%';
        });

        document.getElementById('memory-warn-slider').addEventListener('input', (e) => {
            const value = e.target.value;
            document.getElementById('memory-warn-value').textContent = value + '%';
        });

        document.getElementById('iowait-warn-slider').addEventListener('input', (e) => {
            const value = e.target.value;
            document.getElementById('iowait-warn-value').textContent = value + '%';
        });

        function updateARCRecommendation() {
            if (!systemProfile) return;
            
            const arcGB = parseInt(document.getElementById('arc-slider').value);
            const totalRAM = systemProfile.total_ram_gb;
            const percent = (arcGB / totalRAM * 100).toFixed(0);
            
            const recommendation = document.getElementById('arc-recommendation');
            
            if (!hasECC && percent > 40) {
                recommendation.textContent = `⚠️ WARNING: ${percent}% of RAM. With Non-ECC RAM, recommend ≤40% (≤${Math.floor(totalRAM * 0.4)}GB) to reduce corruption risk.`;
                recommendation.style.color = '#C62828';
            } else if (percent > 50) {
                recommendation.textContent = `⚠️ ${percent}% of RAM. May cause memory pressure under heavy load.`;
                recommendation.style.color = '#F57F17';
            } else {
                recommendation.textContent = `✓ ${percent}% of RAM. Safe for your ${totalRAM}GB system${hasECC ? ' with ECC' : ''}.`;
                recommendation.style.color = 'var(--md-sys-color-tertiary)';
            }
        }

        // Save settings
        async function saveSettings() {
            const settings = {
                arc_limit_gb: parseInt(document.getElementById('arc-slider').value),
                swappiness: parseInt(document.getElementById('swappiness-slider').value),
                realtime_enabled: document.getElementById('realtime-toggle').checked,
                periodic_enabled: document.getElementById('periodic-toggle').checked,
                inotify_warn_threshold: parseInt(document.getElementById('inotify-warn-slider').value),
                memory_warn_threshold: parseInt(document.getElementById('memory-warn-slider').value),
                iowait_warn_threshold: parseInt(document.getElementById('iowait-warn-slider').value),
                websocket_alerts: document.getElementById('websocket-alerts-toggle').checked
            };
            
            try {
                await daemonAPI('/api/system/settings', 'POST', settings);
                showToast('Settings saved successfully', 'success');
            } catch (error) {
                showToast('Failed to save settings: ' + error.message, 'error');
            }
        }

        function resetToDefaults() {
            if (confirm('Reset all settings to recommended defaults?')) {
                document.getElementById('arc-slider').value = 8;
                document.getElementById('swappiness-slider').value = 10;
                document.getElementById('inotify-warn-slider').value = 80;
                document.getElementById('memory-warn-slider').value = 85;
                document.getElementById('iowait-warn-slider').value = 20;
                
                // Trigger updates
                document.getElementById('arc-slider').dispatchEvent(new Event('input'));
                document.getElementById('swappiness-slider').dispatchEvent(new Event('input'));
                document.getElementById('inotify-warn-slider').dispatchEvent(new Event('input'));
                document.getElementById('memory-warn-slider').dispatchEvent(new Event('input'));
                document.getElementById('iowait-warn-slider').dispatchEvent(new Event('input'));
                
                showToast('Settings reset to defaults', 'info');
            }
        }

        async function runPreFlight() {
            try {
                const result = await daemonAPI('/api/system/preflight');
                
                if (result.errors > 0) {
                    showToast(`Pre-flight check failed with ${result.errors} critical issue(s)`, 'error');
                } else if (result.warnings > 0) {
                    showToast(`Pre-flight check passed with ${result.warnings} warning(s)`, 'warning');
                } else {
                    showToast('Pre-flight check passed - system ready', 'success');
                }
                
                // Show detailed results
                window.open('/system/preflight-results', '_blank');
            } catch (error) {
                showToast('Failed to run pre-flight check: ' + error.message, 'error');
            }
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        function formatBytes(bytes) {
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            let i = 0;
            while (bytes >= 1024 && i < units.length - 1) {
                bytes /= 1024;
                i++;
            }
            return bytes.toFixed(1) + ' ' + units[i];
        }

        function showToast(message, type) {
            // Simple toast implementation
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 24px;
                right: 24px;
                background: ${type === 'error' ? '#C62828' : type === 'warning' ? '#F57F17' : '#2E7D32'};
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // Initialize
        loadSystemProfile();
        updateMetrics();
        
        // Update metrics every 10 seconds
        setInterval(updateMetrics, 10000);
        
        // WebSocket monitoring
        if (window.monitorWS) {
            monitorWS.on('inotify_status', (event) => {
                updateMetrics();
            });
        }
    </script>

</body>
</html>