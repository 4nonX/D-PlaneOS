<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>System Updates - D-PlaneOS</title>
<link rel="stylesheet" href="/assets/css/design-tokens.css">
<link rel="stylesheet" href="/assets/css/dplaneos-ui-complete.css">
<link rel="stylesheet" href="/assets/css/m3-tokens.css">
<link rel="stylesheet" href="/assets/css/m3-components.css">
<link rel="stylesheet" href="/assets/css/m3-icons.css">
<link rel="stylesheet" href="/assets/css/enhanced-ui.css">
<link rel="stylesheet" href="/assets/css/m3-animations.css">
<link rel="stylesheet" href="/assets/css/material-symbols-local.css">
<link rel="stylesheet" href="/assets/css/ui-consistency.css">
<link rel="stylesheet" href="/assets/css/ui-polish.css">
<link rel="stylesheet" href="/assets/css/ui-components.css">
<script src="/assets/js/core.js"></script>
<script src="/assets/js/nav-shared.js"></script>
<script src="/assets/js/nav-flyout.js"></script>
<script src="/assets/js/enhanced-ui.js"></script>
<script src="/assets/js/connection-monitor.js"></script>
<script src="/assets/js/permission-checker.js"></script>
<style>
.main { max-width: 1100px; margin: 140px auto 60px; padding: 0 40px; }
.page-title { font-size: 32px; font-weight: 700; letter-spacing: -1.5px; margin-bottom: 8px; }
.page-subtitle { font-size: 16px; color: rgba(255,255,255,0.5); margin-bottom: 32px; }

/* Tabs */
.tabs { display: flex; gap: 4px; margin-bottom: 32px;
  background: rgba(255,255,255,0.03); padding: 6px; border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.06); width: fit-content; flex-wrap: wrap; }
.tab-btn { padding: 10px 20px; border-radius: 10px; border: none; cursor: pointer;
  font-size: 14px; font-weight: 500; color: rgba(255,255,255,0.5);
  background: transparent; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
.tab-btn.active { background: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(138,156,255,0.4); }
.tab-btn:hover:not(.active) { background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.8); }
.tab-pane { display: none; }
.tab-pane.active { display: block; }

/* Cards */
.card { padding: 28px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);
  border-radius: 16px; margin-bottom: 20px; }
.card-title { font-size: 16px; font-weight: 700; margin-bottom: 16px;
  display: flex; align-items: center; gap: 8px; }

/* Status banner */
.banner { display: flex; align-items: center; gap: 16px; padding: 20px 24px;
  border-radius: 14px; margin-bottom: 24px; }
.banner.nixos { background: rgba(126,87,194,0.12); border: 1px solid rgba(126,87,194,0.3); }
.banner.non-nixos { background: rgba(255,152,0,0.08); border: 1px solid rgba(255,152,0,0.25); }
.banner.watchdog-active { background: rgba(244,67,54,0.1); border: 1px solid rgba(244,67,54,0.3); animation: pulse-border 2s infinite; }
@keyframes pulse-border { 0%,100%{ border-color: rgba(244,67,54,0.3); } 50%{ border-color: rgba(244,67,54,0.7); } }
.banner-icon { font-size: 32px; flex-shrink: 0; }
.banner-content { flex: 1; }
.banner-title { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
.banner-desc { font-size: 14px; color: rgba(255,255,255,0.55); }

/* Generation table */
.gen-table { width: 100%; border-collapse: collapse; }
.gen-table th { font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.4);
  text-transform: uppercase; letter-spacing: 0.08em; padding: 10px 14px;
  border-bottom: 1px solid rgba(255,255,255,0.06); text-align: left; }
.gen-table td { padding: 14px; border-bottom: 1px solid rgba(255,255,255,0.04);
  font-size: 14px; vertical-align: middle; }
.gen-table tr:last-child td { border-bottom: none; }
.gen-table tr:hover td { background: rgba(255,255,255,0.02); }
.gen-row.current td { background: rgba(138,156,255,0.05); }
.gen-id { font-family: monospace; font-weight: 700; font-size: 15px; }
.gen-badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px;
  border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
.gen-badge.current { background: rgba(76,175,80,0.15); color: #81c784; border: 1px solid rgba(76,175,80,0.25); }
.gen-badge.old { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.4); border: 1px solid rgba(255,255,255,0.08); }
.gen-date { color: rgba(255,255,255,0.5); font-size: 13px; }
.gen-actions { display: flex; gap: 6px; }

/* Buttons */
.btn { padding: 10px 20px; border-radius: 12px; border: none; cursor: pointer;
  font-size: 14px; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover { opacity: 0.85; }
.btn-success { background: rgba(76,175,80,0.15); color: #81c784; border: 1px solid rgba(76,175,80,0.25); }
.btn-success:hover { background: rgba(76,175,80,0.25); }
.btn-warning { background: rgba(255,152,0,0.12); color: #ffb74d; border: 1px solid rgba(255,152,0,0.25); }
.btn-warning:hover { background: rgba(255,152,0,0.22); }
.btn-danger { background: rgba(244,67,54,0.12); color: #ef9a9a; border: 1px solid rgba(244,67,54,0.2); }
.btn-danger:hover { background: rgba(244,67,54,0.22); }
.btn-ghost { background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.7);
  border: 1px solid rgba(255,255,255,0.1); }
.btn-ghost:hover { background: rgba(255,255,255,0.1); color: #fff; }
.btn-sm { padding: 6px 14px; font-size: 13px; border-radius: 8px; }
.btn:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; align-items: center; }

/* Form */
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.form-group { display: flex; flex-direction: column; gap: 6px; }
.form-group.span2 { grid-column: 1 / -1; }
.form-label { font-size: 13px; color: rgba(255,255,255,0.6); }
.form-input { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.12);
  border-radius: 10px; padding: 10px 14px; color: #fff; font-size: 14px; width: 100%; box-sizing: border-box; }
.form-input:focus { outline: none; border-color: var(--primary); }
.form-hint { font-size: 12px; color: rgba(255,255,255,0.35); margin-top: 2px; }

/* Output log */
.output-log { font-family: monospace; font-size: 12px; background: rgba(0,0,0,0.35);
  border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; padding: 16px;
  max-height: 340px; overflow-y: auto; color: rgba(255,255,255,0.75);
  white-space: pre-wrap; word-break: break-all; line-height: 1.6; }
.output-log:empty { display: none; }
.output-log.error { border-color: rgba(244,67,54,0.3); }
.output-log.success { border-color: rgba(76,175,80,0.3); }

/* Watchdog timer display */
.watchdog-timer { font-size: 48px; font-weight: 700; font-family: monospace;
  color: #ef9a9a; text-align: center; padding: 24px 0 8px; letter-spacing: 4px; }
.watchdog-label { text-align: center; font-size: 13px; color: rgba(255,255,255,0.5); margin-bottom: 20px; }

/* Diff view */
.diff-view { font-family: monospace; font-size: 12.5px; background: rgba(0,0,0,0.3);
  border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; max-height: 440px;
  overflow-y: auto; line-height: 1.6; }
.diff-line { padding: 2px 16px; display: block; }
.diff-line.added { background: rgba(76,175,80,0.1); color: #a5d6a7; }
.diff-line.removed { background: rgba(244,67,54,0.08); color: #ef9a9a; }
.diff-line.context { color: rgba(255,255,255,0.45); }
.diff-line.header { color: rgba(138,156,255,0.9); font-weight: 700; }

/* Snapshot list */
.snap-item { padding: 14px 18px; background: rgba(255,255,255,0.02);
  border: 1px solid rgba(255,255,255,0.06); border-radius: 10px;
  margin-bottom: 8px; display: flex; align-items: center; gap: 14px; }
.snap-name { font-family: monospace; font-size: 13px; color: rgba(255,255,255,0.8); flex: 1; }
.snap-date { font-size: 12px; color: rgba(255,255,255,0.4); }
.snap-pool { font-size: 12px; padding: 2px 8px; border-radius: 6px;
  background: rgba(138,156,255,0.1); color: rgba(138,156,255,0.8); }

/* Info / warning boxes */
.info-box { background: var(--primary-bg); border: 1px solid rgba(138,156,255,0.2);
  border-radius: 10px; padding: 14px 18px; font-size: 13px; color: rgba(255,255,255,0.6);
  margin-bottom: 20px; display: flex; gap: 10px; align-items: flex-start; }
.warn-box { background: rgba(255,152,0,0.08); border: 1px solid rgba(255,152,0,0.25);
  border-radius: 10px; padding: 14px 18px; font-size: 13px; color: rgba(255,152,0,0.9);
  margin-bottom: 20px; display: flex; gap: 10px; align-items: flex-start; }
.info-box .icon, .warn-box .icon { font-size: 20px; flex-shrink: 0; margin-top: 1px; }

/* Spinner */
.spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.2);
  border-top-color: #fff; border-radius: 50%; animation: spin 0.7s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

.empty-state { text-align: center; padding: 48px 24px; color: rgba(255,255,255,0.3);
  border: 1px dashed rgba(255,255,255,0.1); border-radius: 12px; }
</style>
</head>
<body>
<div id="nav-placeholder"></div>

<div class="main">
  <div class="page-title">System Updates</div>
  <div class="page-subtitle">NixOS generation management · Atomic upgrades · Auto-rollback watchdog</div>

  <!-- NixOS detection banner -->
  <div id="nixosBanner" class="banner nixos" style="display:none">
    <span class="material-symbols-outlined banner-icon" style="color:#7e57c2">verified</span>
    <div class="banner-content">
      <div class="banner-title">NixOS Detected</div>
      <div class="banner-desc" id="nixosBannerDesc">Atomic upgrades and generation rollback available.</div>
    </div>
  </div>
  <div id="nonNixosBanner" class="banner non-nixos" style="display:none">
    <span class="material-symbols-outlined banner-icon" style="color:#ffa726">info</span>
    <div class="banner-content">
      <div class="banner-title">Non-NixOS System</div>
      <div class="banner-desc">Generation management requires NixOS. Standard package updates are available below.</div>
    </div>
  </div>

  <!-- Watchdog active warning -->
  <div id="watchdogBanner" class="banner watchdog-active" style="display:none">
    <span class="material-symbols-outlined banner-icon" style="color:#ef5350">timer</span>
    <div class="banner-content">
      <div class="banner-title">⚠ Watchdog Active — Confirm Update or System Will Roll Back</div>
      <div class="banner-desc">A NixOS apply is pending confirmation. Auto-rollback fires when timer reaches zero.</div>
    </div>
    <button class="btn btn-success" onclick="confirmApply()">
      <span class="material-symbols-outlined" style="font-size:16px">check_circle</span>Confirm Update
    </button>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('generations', this)">
      <span class="material-symbols-outlined" style="font-size:18px">history</span>Generations
    </button>
    <button class="tab-btn" onclick="switchTab('apply', this)">
      <span class="material-symbols-outlined" style="font-size:18px">upgrade</span>Apply Update
    </button>
    <button class="tab-btn" onclick="switchTab('diff', this)">
      <span class="material-symbols-outlined" style="font-size:18px">difference</span>Config Diff
    </button>
    <button class="tab-btn" onclick="switchTab('snapshots', this)">
      <span class="material-symbols-outlined" style="font-size:18px">photo_camera</span>Pre-Upgrade Snapshots
    </button>
    <button class="tab-btn" onclick="switchTab('watchdog', this)">
      <span class="material-symbols-outlined" style="font-size:18px">timer</span>Watchdog
    </button>
  </div>

  <!-- ══════════════ Generations tab ══════════════ -->
  <div class="tab-pane active" id="tab-generations">
    <div class="card">
      <div class="card-title">
        <span class="material-symbols-outlined">history</span>
        System Generations
        <button class="btn btn-ghost btn-sm" style="margin-left:auto" onclick="loadGenerations()">
          <span class="material-symbols-outlined" style="font-size:16px">refresh</span>Refresh
        </button>
      </div>
      <div class="info-box">
        <span class="material-symbols-outlined icon">info</span>
        Each NixOS rebuild creates a new generation. You can roll back to any previous generation instantly — the system switch is atomic and takes effect immediately.
      </div>
      <div id="generationsContainer">
        <div class="empty-state">Loading generations…</div>
      </div>
    </div>
  </div>

  <!-- ══════════════ Apply Update tab ══════════════ -->
  <div class="tab-pane" id="tab-apply">
    <div class="card">
      <div class="card-title">
        <span class="material-symbols-outlined">upgrade</span>
        Apply NixOS Configuration
      </div>
      <div class="warn-box">
        <span class="material-symbols-outlined icon">warning</span>
        Applying creates a new generation. The watchdog will auto-rollback if you don't confirm within the timeout period. ZFS pre-upgrade snapshots are taken automatically on all pools.
      </div>
      <div class="form-grid">
        <div class="form-group span2">
          <label class="form-label">Configuration Path</label>
          <input class="form-input" id="applyFlakePath" type="text" value="/etc/nixos"
            placeholder="/etc/nixos  (or flake path)">
          <span class="form-hint">Path to your NixOS configuration. If flake.nix exists here, it will be used automatically.</span>
        </div>
        <div class="form-group">
          <label class="form-label">Watchdog Timeout (seconds)</label>
          <input class="form-input" id="applyTimeout" type="number" value="120" min="30" max="600">
          <span class="form-hint">System auto-rolls-back if not confirmed within this time. Range: 30–600s.</span>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn btn-primary" id="applyBtn" onclick="applyConfig()">
          <span class="material-symbols-outlined" style="font-size:16px">upgrade</span>Apply Configuration
        </button>
        <button class="btn btn-success" id="confirmBtn" onclick="confirmApply()" style="display:none">
          <span class="material-symbols-outlined" style="font-size:16px">check_circle</span>Confirm (Apply Permanently)
        </button>
        <button class="btn btn-warning" onclick="rollbackPrevious()">
          <span class="material-symbols-outlined" style="font-size:16px">undo</span>Quick Rollback
        </button>
      </div>
      <div id="applyOutput" class="output-log" style="margin-top:16px"></div>
    </div>
  </div>

  <!-- ══════════════ Config Diff tab ══════════════ -->
  <div class="tab-pane" id="tab-diff">
    <div class="card">
      <div class="card-title">
        <span class="material-symbols-outlined">difference</span>
        Generation Diff
      </div>
      <div class="info-box">
        <span class="material-symbols-outlined icon">info</span>
        Compare any two generations to see what changed between NixOS rebuilds.
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">From Generation</label>
          <select class="form-input" id="diffFrom"></select>
        </div>
        <div class="form-group">
          <label class="form-label">To Generation</label>
          <select class="form-input" id="diffTo"></select>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn btn-primary" onclick="runDiff()">
          <span class="material-symbols-outlined" style="font-size:16px">compare</span>Compare Generations
        </button>
      </div>
      <div id="diffOutput" style="margin-top:16px"></div>
    </div>
  </div>

  <!-- ══════════════ Snapshots tab ══════════════ -->
  <div class="tab-pane" id="tab-snapshots">
    <div class="card">
      <div class="card-title">
        <span class="material-symbols-outlined">photo_camera</span>
        Pre-Upgrade ZFS Snapshots
        <button class="btn btn-ghost btn-sm" style="margin-left:auto" onclick="loadSnapshots()">
          <span class="material-symbols-outlined" style="font-size:16px">refresh</span>Refresh
        </button>
      </div>
      <div class="info-box">
        <span class="material-symbols-outlined icon">info</span>
        Snapshots are automatically taken on all ZFS pools before each <code>nixos-rebuild switch</code>. Use ZFS Pools → Snapshots to restore from these.
      </div>
      <div id="snapshotsList">
        <div class="empty-state">Loading…</div>
      </div>
    </div>
  </div>

  <!-- ══════════════ Watchdog tab ══════════════ -->
  <div class="tab-pane" id="tab-watchdog">
    <div class="card">
      <div class="card-title">
        <span class="material-symbols-outlined">timer</span>
        Auto-Rollback Watchdog
      </div>
      <div class="info-box">
        <span class="material-symbols-outlined icon">info</span>
        After each <code>nixos-rebuild switch</code>, a watchdog timer starts. If the system becomes unreachable (e.g. misconfigured network/SSH), it automatically rolls back to the previous generation — preventing you from being locked out.
      </div>
      <div id="watchdogStatusCard">
        <div class="empty-state">Checking watchdog status…</div>
      </div>
    </div>
  </div>
</div>

<script>
// ── Auth helpers ──────────────────────────────────────────────────────────────
const csrf = () => document.cookie.match(/csrf_token=([^;]+)/)?.[1] || '';
const session = () => localStorage.getItem('sessionId') || '';
const user = () => localStorage.getItem('username') || '';
const hdrs = (json=true) => {
  const h = { 'X-Session-ID': session(), 'X-User': user(), 'X-CSRF-Token': csrf() };
  if (json) h['Content-Type'] = 'application/json';
  return h;
};

// ── Tab switching ─────────────────────────────────────────────────────────────
function switchTab(name, btn) {
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  if (btn) btn.classList.add('active');
  // Lazy load per tab
  const loaders = { generations: loadGenerations, snapshots: loadSnapshots, watchdog: loadWatchdog, diff: loadDiffSelectors };
  if (loaders[name]) loaders[name]();
}

// ── NixOS detection ───────────────────────────────────────────────────────────
async function detectNixOS() {
  try {
    const r = await fetch('/api/nixos/detect', { headers: hdrs(false) });
    const d = await r.json();
    if (d.nixos) {
      document.getElementById('nixosBanner').style.display = 'flex';
      document.getElementById('nixosBannerDesc').textContent =
        `NixOS ${d.nixos_version || ''} · ${d.current_generation ? 'Generation ' + d.current_generation : ''} · ${d.flake ? 'Flake-based' : 'Traditional config'}`;
    } else {
      document.getElementById('nonNixosBanner').style.display = 'flex';
    }
  } catch { document.getElementById('nonNixosBanner').style.display = 'flex'; }
}

// ── Generations ───────────────────────────────────────────────────────────────
let generationList = [];

async function loadGenerations() {
  const el = document.getElementById('generationsContainer');
  el.innerHTML = '<div style="color:rgba(255,255,255,0.4);padding:8px">Loading…</div>';
  try {
    const r = await fetch('/api/nixos/generations', { headers: hdrs(false) });
    const d = await r.json();
    generationList = d.generations || [];

    if (!generationList.length) {
      el.innerHTML = '<div class="empty-state">No generations found. This system may not be NixOS.</div>';
      return;
    }

    // Newest first
    const sorted = [...generationList].reverse();
    el.innerHTML = `<table class="gen-table">
      <thead><tr>
        <th>Generation</th>
        <th>Date</th>
        <th>Status</th>
        <th style="text-align:right">Actions</th>
      </tr></thead>
      <tbody>
      ${sorted.map(g => `
        <tr class="gen-row ${g.current ? 'current' : ''}">
          <td><span class="gen-id">#${g.id}</span></td>
          <td><span class="gen-date">${g.date}</span></td>
          <td>
            <span class="gen-badge ${g.current ? 'current' : 'old'}">
              ${g.current ? '✓ current' : 'previous'}
            </span>
          </td>
          <td>
            <div class="gen-actions" style="justify-content:flex-end">
              ${!g.current ? `
                <button class="btn btn-warning btn-sm" onclick="rollbackTo('${g.id}')">
                  <span class="material-symbols-outlined" style="font-size:14px">undo</span>Rollback Here
                </button>` : ''}
              <button class="btn btn-ghost btn-sm" onclick="diffFromCurrent('${g.id}')">
                <span class="material-symbols-outlined" style="font-size:14px">compare</span>Diff
              </button>
            </div>
          </td>
        </tr>`).join('')}
      </tbody>
    </table>`;

    // Also populate diff selectors
    populateDiffSelectors(generationList);
  } catch (e) {
    el.innerHTML = `<div class="empty-state">Error: ${e.message}</div>`;
  }
}

async function rollbackTo(genId) {
  if (!confirm(`Roll back to generation #${genId}?\n\nThis will immediately switch your running system.`)) return;
  const r = await fetch('/api/nixos/rollback', {
    method: 'POST', headers: hdrs(),
    body: JSON.stringify({ generation: String(genId) })
  });
  const d = await r.json();
  const output = document.getElementById('applyOutput');
  output.textContent = d.output || '';
  output.className = 'output-log ' + (d.success ? 'success' : 'error');
  if (d.success) {
    showToast('Rolled back to generation #' + genId, 'success');
    setTimeout(loadGenerations, 1500);
  } else {
    showToast('Rollback failed: ' + (d.error || 'unknown'), 'error');
  }
  // Switch to Apply tab to show output
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-apply').classList.add('active');
  document.querySelectorAll('.tab-btn')[1].classList.add('active');
}

async function rollbackPrevious() {
  if (!confirm('Roll back to the previous generation?')) return;
  const r = await fetch('/api/nixos/rollback', {
    method: 'POST', headers: hdrs(), body: JSON.stringify({ generation: '' })
  });
  const d = await r.json();
  const output = document.getElementById('applyOutput');
  output.textContent = d.output || d.error || '';
  output.className = 'output-log ' + (d.success ? 'success' : 'error');
  if (d.success) { showToast('Rolled back successfully', 'success'); setTimeout(loadGenerations, 1500); }
  else showToast('Rollback failed: ' + (d.error || ''), 'error');
}

// ── Apply ─────────────────────────────────────────────────────────────────────
async function applyConfig() {
  const flakePath = document.getElementById('applyFlakePath').value.trim();
  const timeout = parseInt(document.getElementById('applyTimeout').value);
  if (!flakePath) { showToast('Enter a configuration path', 'error'); return; }

  const btn = document.getElementById('applyBtn');
  const output = document.getElementById('applyOutput');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Applying…';
  output.textContent = 'Running nixos-rebuild switch…\nThis may take several minutes.\n';
  output.className = 'output-log';

  try {
    const r = await fetch('/api/nixos/apply', {
      method: 'POST', headers: hdrs(),
      body: JSON.stringify({ flake_path: flakePath, timeout_seconds: timeout })
    });
    const d = await r.json();
    output.textContent = d.output || d.error || 'No output.';
    if (d.success) {
      output.className = 'output-log success';
      if (d.pre_snapshots?.length) {
        output.textContent += '\n\n── Pre-upgrade snapshots created ──\n' + d.pre_snapshots.join('\n');
      }
      // Show confirm button — watchdog is now running
      document.getElementById('confirmBtn').style.display = 'inline-flex';
      document.getElementById('watchdogBanner').style.display = 'flex';
      showToast('Apply succeeded — confirm to make it permanent', 'warning');
      loadWatchdog();
    } else {
      output.className = 'output-log error';
      showToast('Apply failed', 'error');
    }
  } catch (e) {
    output.textContent = 'Error: ' + e.message;
    output.className = 'output-log error';
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<span class="material-symbols-outlined" style="font-size:16px">upgrade</span>Apply Configuration';
  }
}

async function confirmApply() {
  const r = await fetch('/api/nixos/confirm', { method: 'POST', headers: hdrs(false) });
  const d = await r.json();
  if (d.success) {
    document.getElementById('confirmBtn').style.display = 'none';
    document.getElementById('watchdogBanner').style.display = 'none';
    showToast('Update confirmed — changes are now permanent', 'success');
    loadGenerations();
    loadWatchdog();
  } else {
    showToast('Confirm failed: ' + (d.error || ''), 'error');
  }
}

// ── Diff ──────────────────────────────────────────────────────────────────────
function populateDiffSelectors(gens) {
  const from = document.getElementById('diffFrom');
  const to = document.getElementById('diffTo');
  from.innerHTML = gens.map(g => `<option value="${g.id}">${g.id} — ${g.date.split(' ')[0]}${g.current ? ' (current)' : ''}</option>`).join('');
  to.innerHTML = gens.map(g => `<option value="${g.id}" ${g.current ? 'selected' : ''}>${g.id} — ${g.date.split(' ')[0]}${g.current ? ' (current)' : ''}</option>`).join('');
  // Default from to second-to-last
  if (gens.length >= 2) from.selectedIndex = gens.length - 2;
}

async function loadDiffSelectors() {
  if (generationList.length) { populateDiffSelectors(generationList); return; }
  await loadGenerations();
}

function diffFromCurrent(genId) {
  // Switch to diff tab and pre-fill
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-diff').classList.add('active');
  document.querySelectorAll('.tab-btn')[2].classList.add('active');
  loadDiffSelectors().then(() => {
    document.getElementById('diffFrom').value = genId;
    const current = generationList.find(g => g.current);
    if (current) document.getElementById('diffTo').value = current.id;
  });
}

async function runDiff() {
  const from = document.getElementById('diffFrom').value;
  const to = document.getElementById('diffTo').value;
  if (!from || !to || from === to) { showToast('Select two different generations', 'error'); return; }

  const el = document.getElementById('diffOutput');
  el.innerHTML = '<div style="color:rgba(255,255,255,0.4);padding:8px">Loading diff…</div>';

  try {
    const r = await fetch(`/api/nixos/diff?from=${from}&to=${to}`, { headers: hdrs(false) });
    const d = await r.json();

    if (!d.success) {
      el.innerHTML = `<div class="output-log error">${d.error || 'Diff failed'}</div>`;
      return;
    }

    const entries = d.changes || d.diff || [];
    if (!entries.length) {
      el.innerHTML = '<div class="empty-state">No differences found between these generations.</div>';
      return;
    }

    el.innerHTML = `<div class="diff-view">${entries.map(line => {
      const cls = line.startsWith('+') ? 'added' : line.startsWith('-') ? 'removed' : line.startsWith('@@') ? 'header' : 'context';
      return `<span class="diff-line ${cls}">${escapeHtml(line)}</span>`;
    }).join('')}</div>`;
  } catch (e) {
    el.innerHTML = `<div class="output-log error">Error: ${e.message}</div>`;
  }
}

// ── Snapshots ─────────────────────────────────────────────────────────────────
async function loadSnapshots() {
  const el = document.getElementById('snapshotsList');
  try {
    const r = await fetch('/api/nixos/pre-upgrade-snapshots', { headers: hdrs(false) });
    const d = await r.json();
    const snaps = d.snapshots || [];
    if (!snaps.length) {
      el.innerHTML = '<div class="empty-state">No pre-upgrade snapshots recorded yet.</div>';
      return;
    }
    el.innerHTML = snaps.map(s => `
      <div class="snap-item">
        <span class="material-symbols-outlined" style="color:var(--primary);font-size:20px">photo_camera</span>
        <span class="snap-name">${s.snapshot}</span>
        <span class="snap-pool">${s.pool}</span>
        <span class="snap-date">${s.created_at?.split('T')[0] || ''}</span>
        <span style="font-size:12px;color:${s.success ? '#81c784' : '#ef9a9a'}">${s.success ? '✓ OK' : '✗ Failed'}</span>
      </div>`).join('');
  } catch (e) {
    el.innerHTML = `<div class="empty-state">Error: ${e.message}</div>`;
  }
}

// ── Watchdog ──────────────────────────────────────────────────────────────────
let watchdogInterval = null;

async function loadWatchdog() {
  const el = document.getElementById('watchdogStatusCard');
  try {
    const r = await fetch('/api/nixos/watchdog', { headers: hdrs(false) });
    const d = await r.json();

    if (d.active) {
      const deadline = new Date(d.deadline).getTime();
      document.getElementById('watchdogBanner').style.display = 'flex';
      document.getElementById('confirmBtn').style.display = 'inline-flex';

      el.innerHTML = `
        <div class="watchdog-timer" id="wdCountdown">--:--</div>
        <div class="watchdog-label">Until automatic rollback to generation #${d.previous_generation || '?'}</div>
        <div class="btn-row" style="justify-content:center">
          <button class="btn btn-success" onclick="confirmApply()">
            <span class="material-symbols-outlined" style="font-size:16px">check_circle</span>Confirm — Keep Current Generation
          </button>
          <button class="btn btn-danger" onclick="rollbackPrevious()">
            <span class="material-symbols-outlined" style="font-size:16px">undo</span>Roll Back Now
          </button>
        </div>`;

      // Start live countdown
      clearInterval(watchdogInterval);
      watchdogInterval = setInterval(() => {
        const remaining = Math.max(0, deadline - Date.now());
        const m = Math.floor(remaining / 60000);
        const s = Math.floor((remaining % 60000) / 1000);
        const el2 = document.getElementById('wdCountdown');
        if (el2) el2.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        if (remaining === 0) clearInterval(watchdogInterval);
      }, 500);

    } else {
      clearInterval(watchdogInterval);
      document.getElementById('watchdogBanner').style.display = 'none';
      el.innerHTML = `
        <div style="text-align:center;padding:32px 0;color:rgba(255,255,255,0.5)">
          <span class="material-symbols-outlined" style="font-size:48px;display:block;margin-bottom:12px;color:rgba(76,175,80,0.7)">check_circle</span>
          <div style="font-size:16px;font-weight:600;color:#81c784">Watchdog Idle</div>
          <div style="font-size:13px;margin-top:6px">No pending confirmation required. System is stable.</div>
        </div>`;
    }
  } catch (e) {
    el.innerHTML = `<div class="empty-state">Error loading watchdog: ${e.message}</div>`;
  }
}

// ── Toast ─────────────────────────────────────────────────────────────────────
function showToast(msg, type='info') {
  if (window.ui?.toast) { window.ui.toast(msg, type); return; }
  const colors = { success:'#81c784', error:'#ef9a9a', warning:'#ffb74d', info:'rgba(255,255,255,0.8)' };
  const t = document.createElement('div');
  t.style.cssText = `position:fixed;bottom:32px;right:32px;z-index:9999;padding:14px 20px;background:#1a1a2e;border:1px solid rgba(255,255,255,0.1);border-radius:12px;font-size:14px;font-weight:500;color:${colors[type]||colors.info};box-shadow:0 8px 32px rgba(0,0,0,0.4);transition:opacity 0.3s`;
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => { t.style.opacity='0'; setTimeout(() => t.remove(), 300); }, 3500);
}

function escapeHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ── Init ──────────────────────────────────────────────────────────────────────
detectNixOS();
loadGenerations();
loadWatchdog();
// Poll watchdog status every 10s
setInterval(loadWatchdog, 10000);
</script>
</body>
</html>
