<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Snapshot Scheduler - D-PlaneOS</title>
    <link rel="stylesheet" href="/assets/css/design-tokens.css">
    <link rel="stylesheet" href="/assets/css/dplaneos-ui-complete.css">
<link rel="stylesheet" href="/assets/css/m3-tokens.css">
<link rel="stylesheet" href="/assets/css/m3-components.css">
<link rel="stylesheet" href="/assets/css/m3-icons.css">
  <link rel="stylesheet" href="/assets/css/enhanced-ui.css">
<link rel="stylesheet" href="/assets/css/ui-components.css">
<script src="/assets/js/core.js"></script>
<script src="/assets/js/nav-flyout.js"></script>
<script src="/assets/js/hybrid-router.js"></script>
  <script src="/assets/js/enhanced-ui.js"></script>
  <script src="/assets/js/connection-monitor.js"></script>
  <script src="/assets/js/keyboard-shortcuts.js"></script>
  <script src="/assets/js/form-validator.js"></script>
<script src="/assets/js/ui-components.js"></script>
  <link rel="stylesheet" href="/assets/css/material-symbols-local.css">
  <link rel="stylesheet" href="/assets/css/ui-consistency.css">
  <link rel="stylesheet" href="/assets/css/ui-polish.css">
  <script src="/assets/js/daemon-api.js"></script>
</head>
<body>
<!-- D-PlaneOS v3.0.0 - Hierarchical Navigation -->
<!-- This navigation maintains all security (CSRF, Auth) and real system state -->

<div id="nav-root"></div>

<script>
// Navigation behavior
function navigateToSection(section) {
  if (section === 'dashboard') {
    window.location.href = 'index.html';
  }
}

function toggleSubNav(section, button) {
  // Remove active from all nav links
  document.querySelectorAll('.nav-link').forEach(link => {
    link.classList.remove('active');
  });
  
  // Add active to clicked button
  if (button) {
    button.classList.add('active');
  }
  
  // Hide all sub-navs
  document.querySelectorAll('.nav-sub').forEach(sub => {
    sub.classList.remove('active');
  });
  
  // Show selected sub-nav
  const subNav = document.getElementById(`sub-${section}`);
  if (subNav) {
    subNav.classList.add('active');
    document.body.classList.add('has-subnav');
  }
}

// Auto-detect current section and page on load
(function() {
  const currentPage = window.location.pathname.split('/').pop() || 'index.html';
  
  // Page to section mapping
  const pageMap = {
    'acl-manager.html': { section: 'storage', page: 'acl-manager' },
    'audit.html': { section: 'security', page: 'audit' },
    'certificates.html': { section: 'security', page: 'certificates' },
    'cloud-sync.html': { section: 'storage', page: 'cloud-sync' },
    'directory-service.html': { section: 'identity', page: 'directory-service' },
    'docker.html': { section: 'compute', page: 'docker' },
    'files-enhanced.html': { section: 'storage', page: 'files-enhanced' },
    'files.html': { section: 'storage', page: 'files' },
    'firewall.html': { section: 'security', page: 'firewall' },
    'groups.html': { section: 'identity', page: 'groups' },
    'hardware.html': { section: 'system', page: 'hardware' },
    'index.html': { section: 'dashboard', page: null },
    'ipmi.html': { section: 'system', page: 'ipmi' },
    'logs.html': { section: 'system', page: 'logs' },
    'modules.html': { section: 'compute', page: 'modules' },
    'network-dns.html': { section: 'network', page: 'network-dns' },
    'network-interfaces.html': { section: 'network', page: 'network-interfaces' },
    'network-routing.html': { section: 'network', page: 'network-routing' },
    'network.html': { section: 'network', page: 'network' },
    'pools-advanced.html': { section: 'storage', page: 'pools-advanced' },
    'pools.html': { section: 'storage', page: 'pools' },
    'power-management.html': { section: 'system', page: 'power-management' },
    'quotas.html': { section: 'storage', page: 'quotas' },
    'rbac-management.html': { section: 'identity', page: 'rbac-management' },
    'removable-media-ui.html': { section: 'system', page: 'removable-media-ui' },
    'replication.html': { section: 'storage', page: 'replication' },
    'reporting.html': { section: 'system', page: 'reporting' },
    'security.html': { section: 'security', page: 'security' },
    'settings.html': { section: 'system', page: 'settings' },
    'shares.html': { section: 'storage', page: 'shares' },
    'snapshot-scheduler.html': { section: 'storage', page: 'snapshot-scheduler' },
    'system-monitoring.html': { section: 'system', page: 'system-monitoring' },
    'system-settings.html': { section: 'system', page: 'system-settings' },
    'ups.html': { section: 'system', page: 'ups' },
    'users.html': { section: 'identity', page: 'users' },
    'zfs-encryption.html': { section: 'storage', page: 'zfs-encryption' }
  };
  
  const current = pageMap[currentPage];
  if (current) {
    // Activate section button
    const sectionBtn = document.querySelector(`[data-section="${current.section}"]`);
    if (sectionBtn) {
      sectionBtn.classList.add('active');
    }
    
    // Show and activate sub-nav if not dashboard
    if (current.section !== 'dashboard') {
      const subNav = document.getElementById(`sub-${current.section}`);
      if (subNav) {
        subNav.classList.add('active');
        document.body.classList.add('has-subnav');
        
        // Activate current page in sub-nav
        if (current.page) {
          const pageLink = subNav.querySelector(`[data-page="${current.page}"]`);
          if (pageLink) {
            pageLink.classList.add('active');
          }
        }
      }
    }
  }
})();

// Keyboard shortcuts
function showKeyboardHelp() {
  if (window.EnhancedUI) {
    const shortcuts = `Keyboard Shortcuts:

g + d → Dashboard
g + s → Storage
g + c → Compute
g + n → Network
g + u → Identity
g + e → Security
g + y → System

r → Refresh page
Esc → Close modals
? → Show this help`;
    EnhancedUI.toast(shortcuts, 'info', 8000);
  }
}

// Enhanced keyboard shortcuts for sections
(function() {
  let keySequence = '';
  let keyTimeout;
  
  document.addEventListener('keydown', (e) => {
    if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) return;
    
    keySequence += e.key;
    clearTimeout(keyTimeout);
    
    const shortcuts = {
      'gd': 'index.html',
      'gs': () => toggleSubNav('storage', document.querySelector('[data-section="storage"]')),
      'gc': () => toggleSubNav('compute', document.querySelector('[data-section="compute"]')),
      'gn': () => toggleSubNav('network', document.querySelector('[data-section="network"]')),
      'gu': () => toggleSubNav('identity', document.querySelector('[data-section="identity"]')),
      'ge': () => toggleSubNav('security', document.querySelector('[data-section="security"]')),
      'gy': () => toggleSubNav('system', document.querySelector('[data-section="system"]'))
    };
    
    if (shortcuts[keySequence]) {
      e.preventDefault();
      const action = shortcuts[keySequence];
      if (typeof action === 'function') {
        action();
      } else {
        window.location.href = action;
      }
      keySequence = '';
    } else if (e.key === '?') {
      e.preventDefault();
      showKeyboardHelp();
    }
    
    keyTimeout = setTimeout(() => keySequence = '', 1000);
  });
})();

// Connection status monitoring (integrates with existing connection-monitor.js)
if (window.ConnectionMonitor) {
  window.ConnectionMonitor.on('statusChange', (online) => {
    const status = document.getElementById('navConnectionStatus');
    if (status) {
      if (online) {
        status.classList.remove('offline');
        status.classList.add('online');
        status.innerHTML = '<span class="status-dot"></span><span>Connected</span>';
      } else {
        status.classList.remove('online');
        status.classList.add('offline');
        status.innerHTML = '<span class="status-dot"></span><span>Offline</span>';
      }
    }
  });
}
</script>

<main class="main">
<div class="page-header">
  <h1 class="page-title">Snapshot Scheduler</h1>
  <div class="page-actions">
    <button class="btn btn-primary" onclick="addSchedule()"><span class="material-symbols-rounded">add</span> Add Schedule</button>
  </div>
</div>

<div class="card" id="schedulesCard">
  <div class="card-header">
    <div class="card-title">Automatic Snapshot Schedules</div>
    <div class="card-action" onclick="loadSchedules()"><span class="material-symbols-rounded" style="font-size:18px;">refresh</span></div>
  </div>
  <div id="schedulesList" style="padding:20px;text-align:center;color:rgba(255,255,255,0.5);">Loading schedules...</div>
</div>

<div class="card">
  <div class="card-header"><div class="card-title">How Snapshot Scheduling Works</div></div>
  <div style="padding:4px 0; color:rgba(255,255,255,0.7); font-size:14px; line-height:1.6;">
    Schedules are managed as system cron jobs under <code style="background:rgba(255,255,255,0.1);padding:2px 6px;border-radius:4px;">/etc/cron.d/dplaneos-snapshots</code>.
    Each schedule creates ZFS snapshots at the configured interval and automatically prunes old snapshots beyond the retention count.
    Use <strong>Run Now</strong> to create an immediate snapshot without waiting for the next scheduled run.
  </div>
</div>

<div id="addScheduleModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9999;display:none;align-items:center;justify-content:center;">
  <div style="background:rgba(30,41,59,0.98);border-radius:16px;padding:32px;max-width:500px;width:90%;border:1px solid rgba(255,255,255,0.1);">
    <h3 style="margin:0 0 24px;font-size:18px;">Add Snapshot Schedule</h3>
    <div style="display:grid;gap:16px;">
      <div>
        <label style="display:block;font-size:13px;color:rgba(255,255,255,0.6);margin-bottom:6px;">Dataset</label>
        <select id="schedDataset" style="width:100%;padding:10px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.15);border-radius:8px;color:#fff;font-size:14px;"></select>
      </div>
      <div>
        <label style="display:block;font-size:13px;color:rgba(255,255,255,0.6);margin-bottom:6px;">Frequency</label>
        <select id="schedFreq" style="width:100%;padding:10px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.15);border-radius:8px;color:#fff;font-size:14px;">
          <option value="hourly">Hourly</option>
          <option value="daily" selected>Daily (2:00 AM)</option>
          <option value="weekly">Weekly (Sunday 3:00 AM)</option>
          <option value="monthly">Monthly (1st, 4:00 AM)</option>
        </select>
      </div>
      <div>
        <label style="display:block;font-size:13px;color:rgba(255,255,255,0.6);margin-bottom:6px;">Retention (keep last N snapshots)</label>
        <input type="number" id="schedRetention" value="7" min="1" max="1000" style="width:100%;padding:10px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.15);border-radius:8px;color:#fff;font-size:14px;">
      </div>
      <div>
        <label style="display:block;font-size:13px;color:rgba(255,255,255,0.6);margin-bottom:6px;">Prefix</label>
        <input type="text" id="schedPrefix" value="auto" style="width:100%;padding:10px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.15);border-radius:8px;color:#fff;font-size:14px;">
      </div>
    </div>
    <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:24px;">
      <button class="btn" onclick="closeAddModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveNewSchedule()">Add Schedule</button>
    </div>
  </div>
</div>

<style>
.sched-row{display:flex;align-items:center;gap:16px;padding:16px 20px;border-bottom:1px solid rgba(255,255,255,0.06);}
.sched-row:last-child{border-bottom:none;}
.sched-info{flex:1;}
.sched-dataset{font-weight:600;font-size:15px;margin-bottom:4px;}
.sched-meta{font-size:13px;color:rgba(255,255,255,0.5);}
.sched-toggle{width:44px;height:24px;border-radius:12px;background:rgba(255,255,255,0.15);position:relative;cursor:pointer;transition:background 0.2s;}
.sched-toggle.active{background:var(--success);}
.sched-toggle::after{content:"";position:absolute;width:18px;height:18px;border-radius:50%;background:var(--text);top:3px;left:3px;transition:transform 0.2s;}
.sched-toggle.active::after{transform:translateX(20px);}
.sched-actions{display:flex;gap:8px;}
.sched-btn{padding:6px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.15);background:none;color:rgba(255,255,255,0.8);cursor:pointer;font-size:12px;display:flex;align-items:center;gap:4px;}
.sched-btn:hover{background:rgba(255,255,255,0.08);}
.sched-btn.danger:hover{background:rgba(239,68,68,0.15);border-color:rgba(239,68,68,0.4);color:var(--error);}
</style>

<script>
var schedules = [];
var datasets = [];

async function loadSchedules() {
  try {
    var res = await fetch("/api/snapshots/schedules", {headers:{"X-Session-ID":getSessionId(),"X-User":getUser()}});
    var data = await res.json();
    if (data.success) { schedules = data.schedules || []; renderSchedules(); }
  } catch(e) { document.getElementById("schedulesList").textContent = "Failed to load schedules"; }
}

async function loadDatasets() {
  try {
    var res = await fetch("/api/zfs/datasets", {headers:{"X-Session-ID":getSessionId(),"X-User":getUser()}});
    var data = await res.json();
    if (data.success) {
      datasets = data.datasets || [];
      var sel = document.getElementById("schedDataset");
      sel.innerHTML = "";
      datasets.forEach(function(d) {
        var opt = document.createElement("option");
        opt.value = d.name; opt.textContent = d.name + " (" + (d.used||"") + ")";
        sel.appendChild(opt);
      });
    }
  } catch(e) {}
}

function renderSchedules() {
  var el = document.getElementById("schedulesList");
  if (!schedules.length) { el.innerHTML = "<div style=\"padding:40px;text-align:center;color:rgba(255,255,255,0.4);\"><span class=\"material-symbols-rounded\" style=\"font-size:48px;display:block;margin-bottom:12px;\">schedule</span>No snapshot schedules configured<br><span style=\"font-size:13px;\">Click <strong>Add Schedule</strong> to create one</span></div>"; return; }
  var html = "";
  schedules.forEach(function(s, i) {
    var freqLabel = {hourly:"Every hour",daily:"Daily at 2:00 AM",weekly:"Weekly (Sun 3:00 AM)",monthly:"Monthly (1st, 4:00 AM)"}[s.frequency]||s.frequency;
    html += "<div class=\"sched-row\">" +
      "<div class=\"sched-toggle" + (s.enabled?" active":"") + "\" onclick=\"toggleSchedule("+i+")\"></div>" +
      "<div class=\"sched-info\"><div class=\"sched-dataset\">" + esc(s.dataset) + "</div>" +
      "<div class=\"sched-meta\">" + esc(freqLabel) + " · Keep last " + s.retention + " · Prefix: " + esc(s.prefix||"auto") + "</div></div>" +
      "<div class=\"sched-actions\">" +
      "<button class=\"sched-btn\" onclick=\"runNow("+i+")\"><span class=\"material-symbols-rounded\" style=\"font-size:16px;\">play_arrow</span> Run Now</button>" +
      "<button class=\"sched-btn danger\" onclick=\"removeSchedule("+i+")\"><span class=\"material-symbols-rounded\" style=\"font-size:16px;\">delete</span></button>" +
      "</div></div>";
  });
  el.innerHTML = html;
}

function esc(s) { var d=document.createElement("div");d.textContent=s;return d.innerHTML; }

function toggleSchedule(i) {
  schedules[i].enabled = !schedules[i].enabled;
  saveAllSchedules();
}

async function removeSchedule(i) {
  if (!await ui.confirm("Remove Schedule", "Remove schedule for " + schedules[i].dataset + "?")) return;
  schedules.splice(i, 1);
  saveAllSchedules();
}

async function saveAllSchedules() {
  try {
    const r = await fetch("/api/snapshots/schedules", {method:"POST",headers:{"Content-Type":"application/json","X-Session-ID":getSessionId(),"X-User":getUser()},body:JSON.stringify(schedules)});
    const d = await r.json();
    if (d.success || r.ok) {
      renderSchedules();
      if (window.EnhancedUI) EnhancedUI.toast("Schedules saved", "success");
    } else {
      if (window.EnhancedUI) EnhancedUI.toast("Failed to save: " + (d.error || "Unknown error"), "error");
    }
  } catch(e) { if (window.EnhancedUI) EnhancedUI.toast("Failed to save: " + e.message, "error"); }
}

async function runNow(i) {
  var s = schedules[i];
  try {
    var res = await fetch("/api/snapshots/run-now", {method:"POST",headers:{"Content-Type":"application/json","X-Session-ID":getSessionId(),"X-User":getUser()},body:JSON.stringify({dataset:s.dataset,prefix:s.prefix||"auto-"+s.frequency})});
    var data = await res.json();
    if (data.success) { if (window.EnhancedUI) EnhancedUI.toast("Snapshot created: " + data.snapshot, "success"); }
    else { if (window.EnhancedUI) EnhancedUI.toast("Snapshot failed", "error"); }
  } catch(e) { if (window.EnhancedUI) EnhancedUI.toast("Error: " + e.message, "error"); }
}

function addSchedule() {
  loadDatasets();
  document.getElementById("addScheduleModal").style.display = "flex";
}
function closeAddModal() { document.getElementById("addScheduleModal").style.display = "none"; }

function saveNewSchedule() {
  var ds = document.getElementById("schedDataset").value;
  var freq = document.getElementById("schedFreq").value;
  var ret = parseInt(document.getElementById("schedRetention").value)||7;
  var prefix = document.getElementById("schedPrefix").value||"auto";
  if (!ds) { ui.toast("Select a dataset", "warning"); return; }
  schedules.push({dataset:ds,frequency:freq,retention:ret,enabled:true,prefix:prefix});
  closeAddModal();
  saveAllSchedules();
}

function getSessionId() { return document.cookie.replace(/(?:(?:^|.*;\s*)session_id\s*=\s*([^;]*).*$)|^.*$/, "$1") || localStorage.getItem("session_id") || ""; }
function getUser() { return document.cookie.replace(/(?:(?:^|.*;\s*)username\s*=\s*([^;]*).*$)|^.*$/, "$1") || localStorage.getItem("username") || "admin"; }

document.addEventListener("DOMContentLoaded", loadSchedules);
</script>
<script src="/assets/js/realtime-client.js"></script>
<!-- v3.0.0: Time Machine Browse & Restore -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const main = document.querySelector('.main');
  if (!main) return;
  const tm = document.createElement('div');
  tm.style.marginTop = '48px';
  tm.innerHTML = `
    <h2 class="page-title" style="font-size:28px;">Time Machine</h2>
    <p class="page-subtitle" style="margin-bottom:32px;">Browse snapshots • Restore individual files</p>
    <div class="card" style="padding:32px;border-left:4px solid #8b5cf6;">
      <div style="display:grid;grid-template-columns:1fr 1fr auto;gap:12px;align-items:end;margin-bottom:20px;">
        <div><label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px;">Snapshot</label>
          <input id="tm-snapshot" type="text" placeholder="tank/data@daily-2025-01-01" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:var(--md-sys-shape-corner-medium);padding:10px 16px;color:#fff;font-family:monospace;"></div>
        <div><label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px;">Path</label>
          <input id="tm-path" type="text" value="/" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:var(--md-sys-shape-corner-medium);padding:10px 16px;color:#fff;font-family:monospace;"></div>
        <button class="btn btn-primary" onclick="browseTM()"><span class="material-symbols-rounded" style="font-size:18px;">folder_open</span> Browse</button>
      </div>
      <div id="tm-files" style="font-family:monospace;font-size:13px;max-height:400px;overflow-y:auto;"></div>
    </div>
  `;
  main.appendChild(tm);
});
async function loadVersions() {
  const snap = document.getElementById("tm-snapshot").value;
  if (!snap) return;
  try { const r = await csrfFetch("/api/timemachine/versions?snapshot="+encodeURIComponent(snap)); const d = await r.json();
    if (d.versions) { ui.toast("Found "+d.versions.length+" versions","info"); }
  } catch(e) {}
}
async function browseTM() {
  const snap = document.getElementById('tm-snapshot').value;
  const path = document.getElementById('tm-path').value;
  if (!snap) { ui.toast('Enter snapshot name','warning'); return; }
  try {
    const r = await csrfFetch('/api/timemachine/browse?snapshot='+encodeURIComponent(snap)+'&path='+encodeURIComponent(path));
    const d = await r.json();
    if (!d.success) { ui.toast(d.error||'Failed','error'); return; }
    const el = document.getElementById('tm-files');
    if (!d.files||!d.files.length) { el.innerHTML='<div style="padding:20px;text-align:center;color:rgba(255,255,255,0.4);">Empty directory</div>'; return; }
    el.innerHTML = d.files.map(f => `
      <div style="display:flex;align-items:center;gap:12px;padding:8px 12px;border-bottom:1px solid rgba(255,255,255,0.05);cursor:pointer;" ${f.is_dir?`onclick="document.getElementById('tm-path').value='${path==='/'?'':path}/${f.name}';browseTM()"`:''}> 
        <span class="material-symbols-rounded" style="font-size:20px;color:${f.is_dir?'#f59e0b':'rgba(255,255,255,0.4)'};">${f.is_dir?'folder':'description'}</span>
        <span style="flex:1;">${f.name}</span>
        <span style="color:rgba(255,255,255,0.3);font-size:12px;">${f.size_human||''}</span>
        ${!f.is_dir?`<button class="btn" style="padding:4px 12px;font-size:12px;background:rgba(255,255,255,0.05);" onclick="event.stopPropagation();restoreFile('"+JSON.stringify(snap)+"','"+JSON.stringify((path==='/'?'':path)+'/'+f.name)+"')">Restore</button>`:''}
      </div>
    `).join('');
  } catch(e) { ui.toast('Error','error'); }
}
async function restoreFile(snap, filePath) {
  if (!await ui.confirm('Restore File', 'Restore '+filePath+' from snapshot?')) return;
  try {
    const r = await csrfFetch('/api/timemachine/restore',{method:'POST',body:JSON.stringify({snapshot:snap,source_path:filePath})});
    const d = await r.json();
    d.success ? ui.toast('File restored','success') : ui.toast(d.error||'Failed','error');
  } catch(e) { ui.toast('Error','error'); }
}
</script>
    <script src="/assets/js/nav-flyout.js"></script>
    <script src="/assets/js/nav-shared.js"></script>
</body></html>
