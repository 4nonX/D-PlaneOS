<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cloud Sync - D-PlaneOS</title>
<link rel="stylesheet" href="/assets/css/design-tokens.css">
<link rel="stylesheet" href="/assets/css/dplaneos-ui-complete.css">
<link rel="stylesheet" href="/assets/css/m3-tokens.css">
<link rel="stylesheet" href="/assets/css/m3-components.css">
<link rel="stylesheet" href="/assets/css/m3-icons.css">
<link rel="stylesheet" href="/assets/css/enhanced-ui.css">
<link rel="stylesheet" href="/assets/css/m3-animations.css">
<link rel="stylesheet" href="/assets/css/ui-components.css">
<link rel="stylesheet" href="/assets/css/material-symbols-local.css">
<link rel="stylesheet" href="/assets/css/ui-consistency.css">
<link rel="stylesheet" href="/assets/css/ui-polish.css">
<script src="/assets/js/core.js"></script>
<script src="/assets/js/nav-flyout.js"></script>
<script src="/assets/js/hybrid-router.js"></script>
<script src="/assets/js/enhanced-ui.js"></script>
<script src="/assets/js/connection-monitor.js"></script>
<script src="/assets/js/keyboard-shortcuts.js"></script>
<script src="/assets/js/form-validator.js"></script>
<script src="/assets/js/daemon-api.js"></script>
<style>
.main{max-width:1400px;margin:140px auto 80px;padding:0 40px}
.page-header{margin-bottom:40px}
.page-title{font-size:32px;font-weight:700;letter-spacing:-1px;margin-bottom:8px;display:flex;align-items:center;gap:14px}
.page-subtitle{font-size:16px;color:var(--text-dim)}
.status-banner{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:20px 24px;margin-bottom:32px;display:flex;align-items:center;gap:16px}
.status-banner.online{background:var(--success-bg);border-color:var(--success-border)}
.status-banner.offline{background:var(--error-bg);border-color:var(--error-border)}
.status-banner-text{flex:1}
.status-banner-title{font-weight:700;font-size:15px}
.status-banner-sub{font-size:13px;color:var(--text-dim);margin-top:2px}
.section{margin-bottom:40px}
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.section-title{font-size:19px;font-weight:700}
.remote-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px}
.remote-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:20px;transition:all 0.18s;position:relative}
.remote-card:hover{background:var(--surface-hover);transform:translateY(-1px);box-shadow:0 4px 20px rgba(0,0,0,.15)}
.remote-card-header{display:flex;align-items:center;gap:14px;margin-bottom:16px}
.remote-icon{width:44px;height:44px;border-radius:12px;background:var(--primary-bg);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.remote-icon .material-symbols-rounded{font-size:22px;color:var(--primary)}
.remote-name{font-size:16px;font-weight:700}
.remote-type{font-size:12px;color:var(--text-dim);margin-top:2px;text-transform:uppercase;letter-spacing:.5px}
.remote-actions{display:flex;gap:8px}
.remote-btn{flex:1;background:var(--surface-variant);border:1px solid var(--border);border-radius:10px;padding:9px 12px;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.18s;display:flex;align-items:center;justify-content:center;gap:5px;color:var(--text)}
.remote-btn:hover{background:var(--surface-hover)}
.remote-btn.danger{border-color:var(--error-border);color:var(--error)}
.remote-btn.danger:hover{background:var(--error-bg)}
.remote-btn .material-symbols-rounded{font-size:16px}
.empty-state{text-align:center;padding:60px 40px;color:var(--text-dim);border:1px dashed var(--border);border-radius:16px}
.empty-state .material-symbols-rounded{font-size:48px;margin-bottom:16px;display:block}
.empty-state h3{font-size:18px;font-weight:700;margin-bottom:8px;color:var(--text)}
.empty-state p{font-size:14px;max-width:380px;margin:0 auto 24px}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1000;align-items:center;justify-content:center;padding:20px}
.modal-overlay.active{display:flex}
.modal{background:var(--bg-elevated);border:1px solid var(--border);border-radius:20px;padding:32px;width:100%;max-width:560px;max-height:90vh;overflow-y:auto;position:relative}
.modal-header{margin-bottom:24px}
.modal-title{font-size:22px;font-weight:700;margin-bottom:6px}
.modal-subtitle{font-size:14px;color:var(--text-dim)}
.modal-close{position:absolute;top:16px;right:16px;background:none;border:none;color:var(--text-dim);cursor:pointer;width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;transition:all .15s}
.modal-close:hover{background:var(--surface-hover);color:var(--text)}
.modal-footer{display:flex;gap:12px;justify-content:flex-end;margin-top:28px}
.wizard-steps{display:flex;gap:8px;margin-bottom:28px}
.wizard-step{flex:1;padding:10px;background:var(--surface);border:1px solid var(--border);border-radius:10px;text-align:center;font-size:12px;font-weight:600;color:var(--text-dim);transition:all .18s}
.wizard-step.active{background:var(--primary-bg);border-color:var(--primary);color:var(--primary)}
.wizard-step.done{background:var(--success-bg);border-color:var(--success-border);color:var(--success)}
.wizard-pane{display:none}
.wizard-pane.active{display:block}
.provider-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.provider-card{padding:16px 12px;background:var(--surface);border:1px solid var(--border);border-radius:12px;cursor:pointer;transition:all .15s;text-align:center}
.provider-card:hover{background:var(--surface-hover)}
.provider-card.selected{background:var(--primary-bg);border-color:var(--primary)}
.provider-card .material-symbols-rounded{font-size:28px;color:var(--primary);display:block;margin-bottom:8px}
.provider-card span.name{font-size:12px;font-weight:600}
.form-group{margin-bottom:18px}
.form-label{display:block;font-size:13px;font-weight:600;margin-bottom:6px}
.form-label .req{color:var(--error);margin-left:2px}
.form-input{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:11px 14px;color:var(--text);font-size:14px;transition:border-color .15s;box-sizing:border-box}
.form-input:focus{outline:none;border-color:var(--primary)}
.form-help{font-size:12px;color:var(--text-dim);margin-top:5px}
.test-result{padding:14px 16px;border-radius:12px;font-size:13px;font-weight:600;display:flex;align-items:center;gap:10px;margin-top:12px}
.test-result.ok{background:var(--success-bg);border:1px solid var(--success-border);color:var(--success)}
.test-result.fail{background:var(--error-bg);border:1px solid var(--error-border);color:var(--error)}
.sync-direction{display:flex;gap:12px;margin-bottom:20px}
.sync-dir-btn{flex:1;padding:14px;border:1px solid var(--border);border-radius:12px;cursor:pointer;text-align:center;transition:all .15s;background:var(--surface)}
.sync-dir-btn:hover{background:var(--surface-hover)}
.sync-dir-btn.selected{background:var(--primary-bg);border-color:var(--primary)}
.sync-dir-btn .material-symbols-rounded{font-size:24px;color:var(--primary);display:block;margin-bottom:6px}
.sync-dir-btn span{font-size:13px;font-weight:600}
.fab{position:fixed;bottom:32px;right:32px;width:60px;height:60px;background:var(--primary);border-radius:18px;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 24px rgba(0,0,0,.3);cursor:pointer;border:none;color:var(--text-on-primary);transition:all .2s}
.fab:hover{transform:translateY(-2px);box-shadow:0 10px 32px rgba(0,0,0,.4)}
.fab .material-symbols-rounded{font-size:26px}
.loading-row{display:flex;align-items:center;justify-content:center;gap:12px;padding:40px;color:var(--text-dim)}
.spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.output-terminal{background:#0d0d0d;border:1px solid var(--border);border-radius:12px;padding:16px;font-family:monospace;font-size:13px;max-height:300px;overflow-y:auto;white-space:pre-wrap;word-break:break-all;color:#a0e090;margin-top:16px}
.btn{background:var(--surface-variant);color:var(--text);padding:10px 20px;border-radius:10px;font-weight:600;font-size:14px;border:1px solid var(--border);cursor:pointer;transition:all .18s;display:inline-flex;align-items:center;gap:6px}
.btn:hover{background:var(--surface-hover)}
.btn-primary{background:var(--primary);color:var(--text-on-primary);border-color:var(--primary)}
.btn-primary:hover{opacity:.9}
.btn:disabled{opacity:.5;cursor:not-allowed}
</style>
</head>
<body>
<div id="nav-root"></div>
<div class="main">
  <div class="page-header">
    <div class="page-title">
      <span class="material-symbols-rounded" style="font-size:36px;color:var(--primary)">cloud_sync</span>
      Cloud Sync
    </div>
    <div class="page-subtitle">Connect cloud storage providers and sync your NAS data with rclone</div>
  </div>

  <div id="statusBanner" class="status-banner">
    <div class="spinner"></div>
    <div class="status-banner-text"><div class="status-banner-title">Checking rclone…</div></div>
  </div>

  <div class="section">
    <div class="section-header">
      <div class="section-title">Cloud Remotes</div>
      <button class="btn btn-primary" onclick="openAddRemote()" id="addBtn" style="display:none">
        <span class="material-symbols-rounded" style="font-size:18px">add</span> Add Remote
      </button>
    </div>
    <div id="remotesLoading" class="loading-row"><div class="spinner"></div> Loading remotes…</div>
    <div id="remotesEmpty" class="empty-state" style="display:none">
      <span class="material-symbols-rounded">cloud_off</span>
      <h3>No cloud remotes configured</h3>
      <p>Add a remote to connect your NAS to Amazon S3, Backblaze B2, SFTP servers, and more.</p>
      <button class="btn btn-primary" onclick="openAddRemote()">
        <span class="material-symbols-rounded" style="font-size:18px">add</span> Add Your First Remote
      </button>
    </div>
    <div id="remoteGrid" class="remote-grid" style="display:none"></div>
  </div>
</div>

<button class="fab" onclick="openAddRemote()" id="fab" style="display:none" title="Add Remote">
  <span class="material-symbols-rounded">add</span>
</button>

<!-- ADD REMOTE MODAL -->
<div class="modal-overlay" id="addModal">
  <div class="modal">
    <button class="modal-close" onclick="closeAddModal()"><span class="material-symbols-rounded">close</span></button>
    <div class="modal-header">
      <div class="modal-title">Add Cloud Remote</div>
      <div class="modal-subtitle">Connect a cloud storage provider</div>
    </div>
    <div class="wizard-steps">
      <div class="wizard-step active" id="si1">1. Provider</div>
      <div class="wizard-step" id="si2">2. Configure</div>
      <div class="wizard-step" id="si3">3. Test &amp; Save</div>
    </div>
    <div class="wizard-pane active" id="sp1">
      <div id="providerGrid" class="provider-grid">
        <div class="loading-row" style="grid-column:1/-1"><div class="spinner"></div> Loading…</div>
      </div>
    </div>
    <div class="wizard-pane" id="sp2">
      <div class="form-group">
        <label class="form-label">Remote Name <span class="req">*</span></label>
        <input type="text" class="form-input" id="remoteName" placeholder="my-b2-backup" oninput="validateRName(this)">
        <div class="form-help">Letters, digits, hyphens, underscores only</div>
        <div id="rnError" style="font-size:12px;color:var(--error);display:none"></div>
      </div>
      <div id="dynFields"></div>
    </div>
    <div class="wizard-pane" id="sp3">
      <p style="font-size:14px;color:var(--text-dim);margin-bottom:20px">Test the connection to confirm your credentials before saving.</p>
      <div id="testResultDiv" style="display:none"></div>
      <button class="btn" onclick="testConn()" id="testBtn" style="width:100%;justify-content:center;margin-bottom:16px">
        <span class="material-symbols-rounded" style="font-size:18px">wifi_tethering</span> Test Connection
      </button>
      <div class="form-group">
        <label class="form-label">Configuration Summary</label>
        <div id="cfgSummary" style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;font-size:13px;font-family:monospace;color:var(--text-dim);white-space:pre-wrap"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="wBack()" id="wBackBtn" style="display:none">Back</button>
      <button class="btn btn-primary" onclick="wNext()" id="wNextBtn" disabled>Next</button>
    </div>
  </div>
</div>

<!-- SYNC MODAL -->
<div class="modal-overlay" id="syncModal">
  <div class="modal">
    <button class="modal-close" onclick="closeSyncModal()"><span class="material-symbols-rounded">close</span></button>
    <div class="modal-header">
      <div class="modal-title" id="syncTitle">Sync Remote</div>
      <div class="modal-subtitle">Synchronize between NAS and cloud</div>
    </div>
    <div class="sync-direction">
      <div class="sync-dir-btn selected" id="du" onclick="setDir('upload')">
        <span class="material-symbols-rounded">cloud_upload</span><span>Upload to Cloud</span>
      </div>
      <div class="sync-dir-btn" id="dd" onclick="setDir('download')">
        <span class="material-symbols-rounded">cloud_download</span><span>Download from Cloud</span>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Local Path <span class="req">*</span></label>
      <input type="text" class="form-input" id="syncPath" placeholder="/mnt/tank/backups">
      <div class="form-help">Must be under /mnt/, /data/, or /tank/</div>
    </div>
    <div class="form-group">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:14px">
        <input type="checkbox" id="syncDry">
        Dry run — preview changes without applying them
      </label>
    </div>
    <div id="syncOut" style="display:none"></div>
    <div class="modal-footer">
      <button class="btn" onclick="closeSyncModal()">Cancel</button>
      <button class="btn btn-primary" onclick="doSync()" id="syncBtn">
        <span class="material-symbols-rounded" style="font-size:18px">sync</span> Start Sync
      </button>
    </div>
  </div>
</div>

<!-- DELETE CONFIRM -->
<div class="modal-overlay" id="delModal">
  <div class="modal" style="max-width:420px">
    <div class="modal-header"><div class="modal-title">Delete Remote</div></div>
    <p style="font-size:14px;color:var(--text-dim)">Delete remote <strong id="delName" style="color:var(--text)"></strong>? Your cloud data is not affected — only the configuration is removed.</p>
    <div class="modal-footer">
      <button class="btn" onclick="closeDelModal()">Cancel</button>
      <button class="btn" style="background:var(--error);color:#fff;border-color:var(--error)" onclick="doDelete()">Delete</button>
    </div>
  </div>
</div>

<script>
const API='/api/cloud-sync';
let providers=[],selProvider=null,wStep=1,syncRemote=null,syncDir='upload',delTarget=null;

document.addEventListener('DOMContentLoaded',()=>{loadStatus();loadRemotes();});

function csrfFetch(url,opts={}){
  const tok=document.cookie.match(/csrf_token=([^;]+)/)?.[1]||'';
  opts.headers={...(opts.headers||{}),'X-CSRF-Token':tok};
  return fetch(url,opts);
}
async function apiGet(action){return(await csrfFetch(`${API}?action=${action}`)).json();}
async function apiPost(action,body){return(await csrfFetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action,...body})})).json();}

function esc(s){return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function toast(m,t='info'){if(window.ui)ui.toast(m,t);else console.log(t,m);}

async function loadStatus(){
  try{
    const d=await apiGet('status');
    const b=document.getElementById('statusBanner');
    if(d.rclone_available){
      b.className='status-banner online';
      b.innerHTML=`<span class="material-symbols-rounded" style="font-size:28px;color:var(--success)">check_circle</span>
        <div class="status-banner-text">
          <div class="status-banner-title">rclone available</div>
          <div class="status-banner-sub">${esc(d.version)} · ${d.remote_count} remote${d.remote_count!==1?'s':''} · Config: ${esc(d.config_path)}</div>
        </div>`;
      document.getElementById('addBtn').style.display='';
      document.getElementById('fab').style.display='';
    }else{
      b.className='status-banner offline';
      b.innerHTML=`<span class="material-symbols-rounded" style="font-size:28px;color:var(--error)">error</span>
        <div class="status-banner-text">
          <div class="status-banner-title">rclone not available</div>
          <div class="status-banner-sub">${esc(d.message)}</div>
        </div>`;
    }
  }catch(e){console.error(e);}
}

async function loadRemotes(){
  const loading=document.getElementById('remotesLoading');
  const empty=document.getElementById('remotesEmpty');
  const grid=document.getElementById('remoteGrid');
  loading.style.display='flex';empty.style.display='none';grid.style.display='none';
  try{
    const d=await apiGet('remotes');
    loading.style.display='none';
    if(!d.success){toast('Failed to load remotes','error');empty.style.display='block';return;}
    if(!d.remotes||d.remotes.length===0){empty.style.display='block';return;}
    grid.innerHTML=d.remotes.map(r=>remoteCard(r)).join('');
    grid.style.display='grid';
  }catch(e){loading.style.display='none';empty.style.display='block';toast('Failed to load remotes','error');}
}

function provIcon(t){return{s3:'cloud',b2:'backup',azureblob:'cloud_queue',sftp:'terminal',ftp:'lan',webdav:'http',drive:'storage',dropbox:'folder_special',onedrive:'cloud_sync'}[t]||'storage';}

function remoteCard(r){
  return`<div class="remote-card">
    <div class="remote-card-header">
      <div class="remote-icon"><span class="material-symbols-rounded">${provIcon(r.type)}</span></div>
      <div><div class="remote-name">${esc(r.name)}</div><div class="remote-type">${esc(r.type||'unknown')}</div></div>
    </div>
    <div class="remote-actions">
      <button class="remote-btn" onclick="openSync('${esc(r.name)}')"><span class="material-symbols-rounded">sync</span>Sync</button>
      <button class="remote-btn" onclick="testExisting('${esc(r.name)}')"><span class="material-symbols-rounded">wifi_tethering</span>Test</button>
      <button class="remote-btn danger" onclick="openDel('${esc(r.name)}')"><span class="material-symbols-rounded">delete</span></button>
    </div>
  </div>`;
}

// — Wizard —
async function openAddRemote(){
  wStep=1;selProvider=null;
  document.getElementById('remoteName').value='';
  document.getElementById('dynFields').innerHTML='';
  document.getElementById('testResultDiv').style.display='none';
  document.getElementById('cfgSummary').textContent='';
  updateW();
  document.getElementById('addModal').classList.add('active');
  if(providers.length===0){
    try{const d=await apiGet('providers');providers=d.providers||[];}
    catch(e){toast('Failed to load providers','error');}
  }
  renderProviders();
}
function closeAddModal(){document.getElementById('addModal').classList.remove('active');}

function renderProviders(){
  document.getElementById('providerGrid').innerHTML=providers.map((p,i)=>`
    <div class="provider-card ${selProvider===i?'selected':''}" onclick="selectProv(${i})">
      <span class="material-symbols-rounded">${provIcon(p.id)}</span>
      <span class="name">${esc(p.name)}</span>
    </div>`).join('');
}
function selectProv(i){selProvider=i;renderProviders();document.getElementById('wNextBtn').disabled=false;}

function updateW(){
  for(let i=1;i<=3;i++){
    document.getElementById(`sp${i}`).classList.toggle('active',i===wStep);
    const s=document.getElementById(`si${i}`);
    s.className='wizard-step'+(i===wStep?' active':i<wStep?' done':'');
  }
  document.getElementById('wBackBtn').style.display=wStep>1?'':'none';
  document.getElementById('wNextBtn').textContent=wStep===3?'Save Remote':'Next';
  document.getElementById('wNextBtn').disabled=wStep===1&&selProvider===null;
}

async function wNext(){
  if(wStep===1){if(selProvider===null){toast('Select a provider','warning');return;}wStep=2;renderFields();document.getElementById('wNextBtn').disabled=false;}
  else if(wStep===2){if(!validateStep2())return;wStep=3;renderSummary();}
  else{await saveRemote();return;}
  updateW();
}
function wBack(){if(wStep>1){wStep--;updateW();if(wStep===1)renderProviders();}}

function renderFields(){
  const p=providers[selProvider];
  document.getElementById('dynFields').innerHTML=p.fields.map(f=>`
    <div class="form-group">
      <label class="form-label">${esc(f.label)}${f.required?'<span class="req">*</span>':''}</label>
      <input type="${f.type==='password'?'password':'text'}" class="form-input" id="f_${f.key}" data-key="${f.key}" data-req="${f.required}" placeholder="${esc(f.placeholder||'')}" autocomplete="${f.type==='password'?'new-password':'off'}">
      ${f.help?`<div class="form-help">${esc(f.help)}</div>`:''}
    </div>`).join('');
}

function validateStep2(){
  const name=document.getElementById('remoteName').value.trim();
  if(!name){toast('Remote name is required','warning');return false;}
  if(!/^[a-zA-Z0-9_-]+$/.test(name)){toast('Invalid remote name','warning');return false;}
  const p=providers[selProvider];
  for(const f of p.fields){
    const el=document.getElementById(`f_${f.key}`);
    if(f.required&&el&&!el.value.trim()){toast(f.label+' is required','warning');el.focus();return false;}
  }
  return true;
}

function validateRName(el){
  const err=document.getElementById('rnError');
  if(el.value&&!/^[a-zA-Z0-9_-]+$/.test(el.value)){err.textContent='Invalid characters';err.style.display='';}
  else err.style.display='none';
}

function renderSummary(){
  const p=providers[selProvider];
  const name=document.getElementById('remoteName').value.trim();
  const lines=[`Remote: ${name}`,`Type: ${p.name} (${p.id})`];
  for(const f of p.fields){
    const el=document.getElementById(`f_${f.key}`);
    if(el&&el.value.trim())lines.push(`${f.label}: ${f.type==='password'?'••••••••':el.value.trim()}`);
  }
  document.getElementById('cfgSummary').textContent=lines.join('\n');
  document.getElementById('testResultDiv').style.display='none';
}

function getConfig(){
  const p=providers[selProvider],cfg={};
  for(const f of p.fields){const el=document.getElementById(`f_${f.key}`);if(el&&el.value.trim())cfg[f.key]=el.value.trim();}
  return cfg;
}

async function doSave(name,showMsg=true){
  const p=providers[selProvider];
  try{
    const d=await apiPost('configure',{name,type:p.id,config:getConfig()});
    if(!d.success){toast('Save failed: '+(d.error||''),'error');return false;}
    if(showMsg)toast(`Remote '${name}' saved`,'success');
    return true;
  }catch(e){toast('Save error: '+e.message,'error');return false;}
}

async function testConn(){
  const name=document.getElementById('remoteName').value.trim();
  if(!name){toast('Enter a remote name first','warning');return;}
  const div=document.getElementById('testResultDiv');
  div.style.display='flex';div.className='test-result';div.innerHTML='<div class="spinner" style="width:16px;height:16px"></div> Testing…';
  const btn=document.getElementById('testBtn');btn.disabled=true;
  try{
    await doSave(name,false); // save first so rclone can test it
    const d=await apiPost('test',{remote:name});
    if(d.success&&d.connected){
      div.className='test-result ok';
      div.innerHTML='<span class="material-symbols-rounded">check_circle</span> Connection successful';
    }else{
      div.className='test-result fail';
      div.innerHTML=`<span class="material-symbols-rounded">error</span>${esc(d.error||'Connection failed')}`;
    }
  }catch(e){div.className='test-result fail';div.innerHTML=`<span class="material-symbols-rounded">error</span>${esc(e.message)}`;}
  btn.disabled=false;
}

async function saveRemote(){
  const name=document.getElementById('remoteName').value.trim();
  const btn=document.getElementById('wNextBtn');
  btn.disabled=true;btn.textContent='Saving…';
  const ok=await doSave(name,true);
  if(ok){closeAddModal();await loadRemotes();await loadStatus();}
  else{btn.disabled=false;btn.textContent='Save Remote';}
}

async function testExisting(name){
  toast(`Testing ${name}…`,'info');
  try{
    const d=await apiPost('test',{remote:name});
    if(d.success&&d.connected)toast(`✓ ${name}: connected`,'success');
    else toast(`✗ ${name}: ${d.error||'failed'}`,'error');
  }catch(e){toast(`Test error: ${e.message}`,'error');}
}

// — Sync —
function openSync(name){
  syncRemote=name;syncDir='upload';
  document.getElementById('syncTitle').textContent='Sync: '+name;
  document.getElementById('syncPath').value='';
  document.getElementById('syncDry').checked=false;
  document.getElementById('syncOut').style.display='none';
  setDir('upload');
  document.getElementById('syncModal').classList.add('active');
}
function closeSyncModal(){document.getElementById('syncModal').classList.remove('active');}
function setDir(d){syncDir=d;document.getElementById('du').classList.toggle('selected',d==='upload');document.getElementById('dd').classList.toggle('selected',d==='download');}

async function doSync(){
  const path=document.getElementById('syncPath').value.trim();
  if(!path){toast('Local path is required','warning');return;}
  const btn=document.getElementById('syncBtn');
  btn.disabled=true;btn.innerHTML='<div class="spinner" style="width:16px;height:16px;display:inline-block"></div> Syncing…';
  const out=document.getElementById('syncOut');out.style.display='none';
  try{
    const d=await apiPost('sync',{remote:syncRemote,local_path:path,direction:syncDir,dry_run:document.getElementById('syncDry').checked});
    out.style.display='block';
    if(d.success){
      out.innerHTML=`<div class="test-result ok"><span class="material-symbols-rounded">check_circle</span>Sync complete${document.getElementById('syncDry').checked?' (dry run)':''}</div>${d.output?`<div class="output-terminal">${esc(d.output)}</div>`:''}`;
      toast('Sync completed','success');
    }else{
      out.innerHTML=`<div class="test-result fail"><span class="material-symbols-rounded">error</span>Sync failed</div>${d.error?`<div class="output-terminal" style="color:#ff8080">${esc(d.error)}</div>`:''}`;
      toast('Sync failed','error');
    }
  }catch(e){toast('Sync error: '+e.message,'error');}
  btn.disabled=false;btn.innerHTML='<span class="material-symbols-rounded" style="font-size:18px">sync</span> Start Sync';
}

// — Delete —
function openDel(name){delTarget=name;document.getElementById('delName').textContent=name;document.getElementById('delModal').classList.add('active');}
function closeDelModal(){document.getElementById('delModal').classList.remove('active');delTarget=null;}
async function doDelete(){
  if(!delTarget)return;
  try{
    const d=await apiPost('delete',{remote:delTarget});
    if(d.success){toast(`Remote '${delTarget}' deleted`,'success');closeDelModal();await loadRemotes();await loadStatus();}
    else toast('Delete failed: '+(d.error||''),'error');
  }catch(e){toast('Delete error: '+e.message,'error');}
}
</script>
<script src="/assets/js/nav-shared.js"></script>
</body>
</html>
