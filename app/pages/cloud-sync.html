<!DOCTYPE html>
<html lang="en">
<head><style></style>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cloud Sync - D-PlaneOS</title>
    <link rel="stylesheet" href="/assets/css/design-tokens.css">
    <link rel="stylesheet" href="/assets/css/dplaneos-ui-complete.css">
<link rel="stylesheet" href="/assets/css/m3-tokens.css">
<link rel="stylesheet" href="/assets/css/m3-components.css">
<link rel="stylesheet" href="/assets/css/m3-icons.css">
  <link rel="stylesheet" href="/assets/css/enhanced-ui.css">
<link rel="stylesheet" href="/assets/css/m3-animations.css">
<style>
.logo { font-size: 20px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; cursor: pointer; }


.nav-link:hover, 
.main { max-width: 1600px; margin: 140px auto 60px; padding: 0 40px; }
.page-header { margin-bottom: 48px; }
.page-title { font-size: 32px; font-weight: 700; letter-spacing: -1.5px; margin-bottom: 12px; }
.page-subtitle { font-size: 18px; color: rgba(255,255,255,0.6); }
.pool-card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: var(--radius-xl); padding: 32px; margin-bottom: 24px; border-left: 4px solid var(--primary); }
.pool-header { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
.pool-icon { font-size: 32px; color: var(--primary); }
.pool-info { flex: 1; }
.pool-name { font-size: 28px; font-weight: 700; margin-bottom: 6px; }
.pool-details { font-size: 15px; color: rgba(255,255,255,0.6); }
.capacity-bar { height: 12px; background: rgba(255,255,255,0.05); border-radius: 24px; overflow: hidden; margin: 20px 0; }
.capacity-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--primary)); border-radius: 24px; transition: width 0.5s; }
/* Badge styles are in m3-components.css */
.icon-btn { width: 40px; height: 40px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,0.8); cursor: pointer; transition: all 0.3s; border: none; }
.icon-btn:hover { background: rgba(255,255,255,0.1); color: var(--text); }
.btn { background: rgba(255,255,255,0.1); color: var(--text); padding: 12px 24px; border-radius: 10px; font-weight: 500; font-size: 14px; border: none; cursor: pointer; transition: all 0.3s; }
.btn:hover { background: rgba(255,255,255,0.15); }
.btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--primary) 100%); }
.btn-primary:hover { box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4); }
.fab { position: fixed; bottom: 32px; right: 32px; width: 64px; height: 64px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary) 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4); cursor: pointer; transition: all 0.3s; border: none; color: var(--text); }
.fab:hover { transform: translateY(-4px); box-shadow: 0 12px 48px rgba(102, 126, 234, 0.6); }
</style>
<style type="text/css" id="operaUserStyle"></style><link rel="stylesheet" href="/assets/css/ui-components.css">
<script src="/assets/js/core.js"></script>
<script src="/assets/js/nav-flyout.js"></script>
<script src="/assets/js/hybrid-router.js"></script>
  <script src="/assets/js/enhanced-ui.js"></script>
  <script src="/assets/js/connection-monitor.js"></script>
  <script src="/assets/js/keyboard-shortcuts.js"></script>
  <script src="/assets/js/form-validator.js"></script>
  <link rel="stylesheet" href="/assets/css/material-symbols-local.css">
  <link rel="stylesheet" href="/assets/css/ui-consistency.css">
  <link rel="stylesheet" href="/assets/css/ui-polish.css">
  <script src="/assets/js/daemon-api.js"></script>
<style>
.main { max-width: 1600px; margin: 140px auto 60px; padding: 0 40px; }
.page-header { margin-bottom: 48px; }
.page-title { font-size: 32px; font-weight: 700; letter-spacing: -1.5px; margin-bottom: 12px; display: flex; align-items: center; gap: 16px; }
.page-subtitle { font-size: 18px; color: var(--text-dim); }

.status-banner { background: var(--surface-variant); border: 1px solid var(--border); border-radius: 16px; padding: 24px; margin-bottom: 32px; display: flex; align-items: center; gap: 20px; }
.status-banner.online { background: var(--success-bg); border-color: var(--success-border); }
.status-banner.offline { background: var(--error-bg); border-color: var(--error-border); }

.section { margin-bottom: 48px; }
.section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
.section-title { font-size: 20px; font-weight: 700; }

.remote-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
.remote-card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 24px; transition: all 0.2s; }
.remote-card:hover { background: var(--surface-hover); transform: translateY(-2px); }
.remote-header { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; }
.remote-icon { font-size: 32px; }
.remote-info { flex: 1; }
.remote-name { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
.remote-type { font-size: 13px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
.remote-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; padding: 16px; background: var(--surface-variant); border-radius: 12px; }
.remote-stat { text-align: center; }
.remote-stat-value { font-size: 18px; font-weight: 700; color: var(--primary); }
.remote-stat-label { font-size: 12px; color: var(--text-dim); margin-top: 4px; }
.remote-actions { display: flex; gap: 8px; }
.remote-btn { flex: 1; background: var(--surface-variant); border: 1px solid var(--border); border-radius: 10px; padding: 10px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
.remote-btn:hover { background: var(--surface-hover); }
.remote-btn.danger { border-color: var(--error-border); color: var(--error); }
.remote-btn.danger:hover { background: var(--error-bg); }

.fab { position: fixed; bottom: 32px; right: 32px; width: 64px; height: 64px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-active) 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 32px rgba(138, 156, 255, 0.4); cursor: pointer; transition: all 0.3s; border: none; color: var(--text-on-primary); }
.fab:hover { transform: translateY(-4px); box-shadow: 0 12px 48px rgba(138, 156, 255, 0.6); }

.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 1000; overflow-y: auto; }
.modal.active { display: flex; }
.modal-content { background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 20px; padding: 32px; max-width: 600px; width: 90%; margin: 40px auto; }
.modal-header { margin-bottom: 24px; }
.modal-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
.modal-subtitle { font-size: 14px; color: var(--text-dim); }
.modal-close { position: absolute; top: 16px; right: 16px; background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 24px; }

.wizard-steps { display: flex; gap: 12px; margin-bottom: 32px; }
.wizard-step { flex: 1; padding: 12px; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; text-align: center; font-size: 13px; font-weight: 600; color: var(--text-dim); transition: all 0.2s; }
.wizard-step.active { background: var(--primary-bg); border-color: var(--primary); color: var(--primary); }
.wizard-step.completed { background: var(--success-bg); border-color: var(--success-border); color: var(--success); }

.wizard-content { min-height: 300px; }
.wizard-page { display: none; }
.wizard-page.active { display: block; }

.provider-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
.provider-card { background: var(--surface); border: 2px solid var(--border); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s; text-align: center; }
.provider-card:hover { background: var(--surface-hover); border-color: var(--primary); }
.provider-card.selected { background: var(--primary-bg); border-color: var(--primary); }
.provider-icon { font-size: 48px; margin-bottom: 12px; }
.provider-name { font-size: 13px; font-weight: 600; }
.provider-popular { display: inline-block; background: var(--warning); color: var(--text-on-primary); font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 4px; margin-top: 6px; }

.form-group { margin-bottom: 20px; }
.form-label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; }
.form-input { width: 100%; padding: 12px 16px; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-size: 14px; transition: all 0.2s; }
.form-input:focus { outline: none; border-color: var(--primary); background: var(--surface-hover); }
.form-help { font-size: 12px; color: var(--text-dim); margin-top: 6px; }

.btn-group { display: flex; gap: 12px; margin-top: 24px; }
.btn { padding: 12px 24px; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; }
.btn-secondary { background: var(--surface); border: 1px solid var(--border); color: var(--text); }
.btn-secondary:hover { background: var(--surface-hover); }
.btn-primary { background: var(--primary); color: var(--text-on-primary); }
.btn-primary:hover { background: var(--primary-hover); }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

.job-list { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 24px; }
.job-item { border-bottom: 1px solid var(--border-subtle); padding: 16px 0; display: flex; align-items: center; gap: 16px; }
.job-item:last-child { border-bottom: none; }
.job-icon { font-size: 32px; color: var(--primary); }
.job-info { flex: 1; }
.job-command { font-size: 14px; font-weight: 600; margin-bottom: 4px; font-family: 'Courier New', monospace; }
.job-status { font-size: 12px; color: var(--text-dim); }
.job-pid { background: var(--surface-variant); padding: 4px 8px; border-radius: 6px; font-size: 12px; font-family: 'Courier New', monospace; }

.empty-state { text-align: center; padding: 60px 20px; color: var(--text-dim); }
.empty-state-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.3; }
.empty-state-message { font-size: 16px; margin-bottom: 8px; }
.empty-state-hint { font-size: 14px; color: var(--text-dimmer); }

.loading { text-align: center; padding: 40px; }
.spinner { display: inline-block; width: 40px; height: 40px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

.toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 12px; padding: 16px 24px; display: flex; align-items: center; gap: 12px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); z-index: 1001; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
.toast.show { opacity: 1; pointer-events: auto; }
.toast.success { border-color: var(--success-border); background: var(--success-bg); }
.toast.error { border-color: var(--error-border); background: var(--error-bg); }

.test-result { margin-top: 16px; padding: 16px; background: var(--surface-variant); border: 1px solid var(--border); border-radius: 12px; }
.test-result.success { background: var(--success-bg); border-color: var(--success-border); }
.test-result.error { background: var(--error-bg); border-color: var(--error-border); }
</style>
</head>
<body>

<div id="nav-root"></div>

<div class="main">
  <div class="page-header">
    <div class="page-title">
      <span class="material-symbols-rounded" style="font-size: 40px;">cloud_sync</span>
      Cloud Sync
    </div>
    <div class="page-subtitle">Automated cloud backup and sync via rclone</div>
  </div>

  <!-- Status Banner -->
  <div id="statusBanner" class="status-banner">
    <div class="loading">
      <div class="spinner"></div>
    </div>
  </div>

  <!-- Configured Remotes -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">Configured Remotes</div>
      <span id="remoteCount" style="font-size: 14px; color: var(--text-dim);"></span>
    </div>
    
    <div class="loading" id="remotesLoading">
      <div class="spinner"></div>
    </div>
    
    <div class="remote-grid" id="remoteGrid" style="display: none;"></div>
    
    <div class="empty-state" id="remotesEmpty" style="display: none;">
      <div class="material-symbols-rounded empty-state-icon">cloud_off</div>
      <div class="empty-state-message">No cloud remotes configured</div>
      <div class="empty-state-hint">Click the + button to add your first cloud storage</div>
    </div>
  </div>

  <!-- Active Jobs -->
  <div class="section">
    <div class="section-header">
      <div class="section-title">Active Sync Jobs</div>
      <button class="remote-btn" onclick="loadJobs()">
        <span class="material-symbols-rounded">refresh</span>
        Refresh
      </button>
    </div>
    
    <div class="job-list">
      <div class="loading" id="jobsLoading">
        <div class="spinner"></div>
      </div>
      <div id="jobList" style="display: none;"></div>
      <div class="empty-state" id="jobsEmpty" style="display: none;">
        <div class="material-symbols-rounded empty-state-icon">assignment</div>
        <div class="empty-state-message">No active sync jobs</div>
      </div>
    </div>
  </div>
</div>

<!-- Add Remote FAB -->
<button class="fab" onclick="openAddRemoteWizard()">
  <span class="material-symbols-rounded" style="font-size: 32px;">add</span>
</button>

<!-- Add Remote Wizard -->
<div id="addRemoteModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">Add Cloud Remote</div>
      <div class="modal-subtitle">Connect to your cloud storage provider</div>
    </div>

    <div class="wizard-steps">
      <div class="wizard-step active" data-step="1">1. Provider</div>
      <div class="wizard-step" data-step="2">2. Configure</div>
      <div class="wizard-step" data-step="3">3. Test</div>
      <div class="wizard-step" data-step="4">4. Name</div>
    </div>

    <div class="wizard-content">
      <!-- Step 1: Select Provider -->
      <div class="wizard-page active" data-page="1">
        <div class="form-label">Select Provider</div>
        <div class="form-help" style="margin-bottom: 16px;">Choose your cloud storage provider</div>
        
        <div id="popularProviders"></div>
        <div style="margin: 24px 0; text-align: center; color: var(--text-dim); font-size: 13px;">More Providers</div>
        <div id="allProviders"></div>
      </div>

      <!-- Step 2: Configure -->
      <div class="wizard-page" data-page="2">
        <div id="configForm"></div>
      </div>

      <!-- Step 3: Test Connection -->
      <div class="wizard-page" data-page="3">
        <div style="text-align: center; padding: 40px;">
          <div class="material-symbols-rounded" style="font-size: 64px; color: var(--primary); margin-bottom: 16px;">cloud_done</div>
          <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Test Connection</div>
          <div style="font-size: 14px; color: var(--text-dim); margin-bottom: 24px;">
            Click below to verify connection to <span id="testProviderName"></span>
          </div>
          <button class="btn btn-primary" onclick="testConnection()">
            <span class="material-symbols-rounded" style="margin-right: 8px;">play_arrow</span>
            Test Connection
          </button>
          <div id="testResult"></div>
        </div>
      </div>

      <!-- Step 4: Name & Save -->
      <div class="wizard-page" data-page="4">
        <div class="form-group">
          <label class="form-label">Remote Name</label>
          <input type="text" id="remoteName" class="form-input" placeholder="my-backup">
          <div class="form-help">A short name for this remote (letters, numbers, dashes, underscores only)</div>
        </div>
      </div>
    </div>

    <div class="btn-group">
      <button class="btn btn-secondary" onclick="closeWizard()">Cancel</button>
      <button class="btn btn-secondary" id="wizardBack" onclick="wizardBack()" style="display: none;">Back</button>
      <button class="btn btn-primary" id="wizardNext" onclick="wizardNext()">Next</button>
      <button class="btn btn-primary" id="wizardSave" onclick="saveRemote()" style="display: none;">Save</button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">Delete Remote?</div>
      <div class="modal-subtitle">This action cannot be undone</div>
    </div>
    <div style="padding: 20px 0;">
      Are you sure you want to delete remote "<span id="deleteRemoteName"></span>"?
    </div>
    <div class="btn-group">
      <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
      <button class="btn" style="background: var(--error); color: white;" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast">
  <span class="material-symbols-rounded" id="toastIcon">check_circle</span>
  <span id="toastMessage">Success</span>
</div>

<script>
function escapeHtml(s) {
  if (s == null) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

// Navigation behavior
function navigateToSection(section) {
  if (section === 'dashboard') {
    window.location.href = 'index.html';
  }
}

function toggleSubNav(section, button) {
  // Remove active from all nav links
  document.querySelectorAll('.nav-link').forEach(link => {
    link.classList.remove('active');
  });
  
  // Add active to clicked button
  if (button) {
    button.classList.add('active');
  }
  
  // Hide all sub-navs
  document.querySelectorAll('.nav-sub').forEach(sub => {
    sub.classList.remove('active');
  });
  
  // Show selected sub-nav
  const subNav = document.getElementById(`sub-${section}`);
  if (subNav) {
    subNav.classList.add('active');
    document.body.classList.add('has-subnav');
  }
}

// Auto-detect current section and page on load
(function() {
  const currentPage = window.location.pathname.split('/').pop() || 'index.html';
  
  // Page to section mapping
  const pageMap = {
    'acl-manager.html': { section: 'storage', page: 'acl-manager' },
    'audit.html': { section: 'security', page: 'audit' },
    'certificates.html': { section: 'security', page: 'certificates' },
    'cloud-sync.html': { section: 'storage', page: 'cloud-sync' },
    'directory-service.html': { section: 'identity', page: 'directory-service' },
    'docker.html': { section: 'compute', page: 'docker' },
    'files-enhanced.html': { section: 'storage', page: 'files-enhanced' },
    'files.html': { section: 'storage', page: 'files' },
    'firewall.html': { section: 'security', page: 'firewall' },
    'groups.html': { section: 'identity', page: 'groups' },
    'hardware.html': { section: 'system', page: 'hardware' },
    'index.html': { section: 'dashboard', page: null },
    'ipmi.html': { section: 'system', page: 'ipmi' },
    'logs.html': { section: 'system', page: 'logs' },
    'modules.html': { section: 'compute', page: 'modules' },
    'network-dns.html': { section: 'network', page: 'network-dns' },
    'network-interfaces.html': { section: 'network', page: 'network-interfaces' },
    'network-routing.html': { section: 'network', page: 'network-routing' },
    'network.html': { section: 'network', page: 'network' },
    'pools-advanced.html': { section: 'storage', page: 'pools-advanced' },
    'pools.html': { section: 'storage', page: 'pools' },
    'power-management.html': { section: 'system', page: 'power-management' },
    'quotas.html': { section: 'storage', page: 'quotas' },
    'rbac-management.html': { section: 'identity', page: 'rbac-management' },
    'removable-media-ui.html': { section: 'system', page: 'removable-media-ui' },
    'replication.html': { section: 'storage', page: 'replication' },
    'reporting.html': { section: 'system', page: 'reporting' },
    'security.html': { section: 'security', page: 'security' },
    'settings.html': { section: 'system', page: 'settings' },
    'shares.html': { section: 'storage', page: 'shares' },
    'snapshot-scheduler.html': { section: 'storage', page: 'snapshot-scheduler' },
    'system-monitoring.html': { section: 'system', page: 'system-monitoring' },
    'system-settings.html': { section: 'system', page: 'system-settings' },
    'ups.html': { section: 'system', page: 'ups' },
    'users.html': { section: 'identity', page: 'users' },
    'zfs-encryption.html': { section: 'storage', page: 'zfs-encryption' }
  };
  
  const current = pageMap[currentPage];
  if (current) {
    // Activate section button
    const sectionBtn = document.querySelector(`[data-section="${current.section}"]`);
    if (sectionBtn) {
      sectionBtn.classList.add('active');
    }
    
    // Show and activate sub-nav if not dashboard
    if (current.section !== 'dashboard') {
      const subNav = document.getElementById(`sub-${current.section}`);
      if (subNav) {
        subNav.classList.add('active');
        document.body.classList.add('has-subnav');
        
        // Activate current page in sub-nav
        if (current.page) {
          const pageLink = subNav.querySelector(`[data-page="${current.page}"]`);
          if (pageLink) {
            pageLink.classList.add('active');
          }
        }
      }
    }
  }
})();

// Keyboard shortcuts
function showKeyboardHelp() {
  if (window.EnhancedUI) {
    const shortcuts = `Keyboard Shortcuts:

g + d â†’ Dashboard
g + s â†’ Storage
g + c â†’ Compute
g + n â†’ Network
g + u â†’ Identity
g + e â†’ Security
g + y â†’ System

r â†’ Refresh page
Esc â†’ Close modals
? â†’ Show this help`;
    EnhancedUI.toast(shortcuts, 'info', 8000);
  }
}

// Enhanced keyboard shortcuts for sections
(function() {
  let keySequence = '';
  let keyTimeout;
  
  document.addEventListener('keydown', (e) => {
    if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) return;
    
    keySequence += e.key;
    clearTimeout(keyTimeout);
    
    const shortcuts = {
      'gd': 'index.html',
      'gs': () => toggleSubNav('storage', document.querySelector('[data-section="storage"]')),
      'gc': () => toggleSubNav('compute', document.querySelector('[data-section="compute"]')),
      'gn': () => toggleSubNav('network', document.querySelector('[data-section="network"]')),
      'gu': () => toggleSubNav('identity', document.querySelector('[data-section="identity"]')),
      'ge': () => toggleSubNav('security', document.querySelector('[data-section="security"]')),
      'gy': () => toggleSubNav('system', document.querySelector('[data-section="system"]'))
    };
    
    if (shortcuts[keySequence]) {
      e.preventDefault();
      const action = shortcuts[keySequence];
      if (typeof action === 'function') {
        action();
      } else {
        window.location.href = action;
      }
      keySequence = '';
    } else if (e.key === '?') {
      e.preventDefault();
      showKeyboardHelp();
    }
    
    keyTimeout = setTimeout(() => keySequence = '', 1000);
  });
})();

// Connection status monitoring (integrates with existing connection-monitor.js)
if (window.ConnectionMonitor) {
  window.ConnectionMonitor.on('statusChange', (online) => {
    const status = document.getElementById('navConnectionStatus');
    if (status) {
      if (online) {
        status.classList.remove('offline');
        status.classList.add('online');
        status.innerHTML = '<span class="status-dot"></span><span>Connected</span>';
      } else {
        status.classList.remove('online');
        status.classList.add('offline');
        status.innerHTML = '<span class="status-dot"></span><span>Offline</span>';
      }
    }
  });
}
</script>

<script>
const API_BASE = '/api/backup/rsync';
let providers = {};
let selectedProvider = null;
let currentStep = 1;
let remoteToDelete = null;
let wizardConfig = {};

function getCSRFToken() {
  const match = document.cookie.match(/csrf_token=([^;]+)/);
  return match ? match[1] : '';
}

function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  const icon = document.getElementById('toastIcon');
  const msg = document.getElementById('toastMessage');
  
  toast.className = 'toast show ' + type;
  icon.textContent = type === 'success' ? 'check_circle' : 'error';
  msg.textContent = message;
  
  setTimeout(() => toast.classList.remove('show'), 3000);
}

async function checkStatus() {
  try {
    const response = await fetch(`${API_BASE}?action=status`);
    const data = await response.json();
    
    const banner = document.getElementById('statusBanner');
    banner.innerHTML = data.rclone_available ? 
      `<span class="material-symbols-rounded" style="font-size: 32px; color: var(--success);">check_circle</span>
       <div style="flex: 1;">
         <div style="font-size: 18px; font-weight: 700;">rclone available</div>
         <div style="font-size: 14px; color: var(--text-dim);">${data.message}</div>
       </div>` :
      `<span class="material-symbols-rounded" style="font-size: 32px; color: var(--error);">error</span>
       <div style="flex: 1;">
         <div style="font-size: 18px; font-weight: 700;">rclone not available</div>
         <div style="font-size: 14px; color: var(--text-dim);">${data.message}</div>
       </div>`;
    
    banner.className = `status-banner ${data.rclone_available ? 'online' : 'offline'}`;
    
    if (data.rclone_available) {
      loadProviders();
      loadRemotes();
      loadJobs();
    }
  } catch (error) {
    console.error('Failed to check status:', error);
  }
}

async function loadProviders() {
  try {
    const response = await fetch(`${API_BASE}?action=providers`);
    const data = await response.json();
    if (data.success) {
      providers = data.providers;
    }
  } catch (error) {
    console.error('Failed to load providers:', error);
  }
}

async function loadRemotes() {
  const loading = document.getElementById('remotesLoading');
  const grid = document.getElementById('remoteGrid');
  const empty = document.getElementById('remotesEmpty');
  
  try {
    const response = await fetch(`${API_BASE}?action=remotes`);
    const data = await response.json();
    
    loading.style.display = 'none';
    
    if (data.success && data.remotes && data.remotes.length > 0) {
      document.getElementById('remoteCount').textContent = `${data.count} remote${data.count !== 1 ? 's' : ''}`;
      grid.style.display = 'grid';
      grid.innerHTML = data.remotes.map(remote => `
        <div class="remote-card">
          <div class="remote-header">
            <span class="remote-icon">${getProviderIcon(remote.type)}</span>
            <div class="remote-info">
              <div class="remote-name">${remote.name}</div>
              <div class="remote-type">${remote.type}</div>
            </div>
          </div>
          <div class="remote-stats">
            <div class="remote-stat">
              <div class="remote-stat-value">${remote.size_human}</div>
              <div class="remote-stat-label">Size</div>
            </div>
            <div class="remote-stat">
              <div class="remote-stat-value">${remote.file_count.toLocaleString()}</div>
              <div class="remote-stat-label">Files</div>
            </div>
          </div>
          <div class="remote-actions">
            <button class="remote-btn" onclick="testRemote('"+JSON.stringify(remote.name)+"')">
              <span class="material-symbols-rounded">verified</span>
              Test
            </button>
            <button class="remote-btn danger" onclick="deleteRemote('"+JSON.stringify(remote.name)+"')">
              <span class="material-symbols-rounded">delete</span>
              Delete
            </button>
          </div>
        </div>
      `).join('');
    } else {
      empty.style.display = 'block';
    }
  } catch (error) {
    console.error('Failed to load remotes:', error);
    loading.style.display = 'none';
    empty.style.display = 'block';
  }
}

async function loadJobs() {
  const loading = document.getElementById('jobsLoading');
  const list = document.getElementById('jobList');
  const empty = document.getElementById('jobsEmpty');
  
  try {
    const response = await fetch(`${API_BASE}?action=jobs`);
    const data = await response.json();
    
    loading.style.display = 'none';
    
    if (data.success && data.jobs && data.jobs.length > 0) {
      list.style.display = 'block';
      list.innerHTML = data.jobs.map(job => `
        <div class="job-item">
          <span class="material-symbols-rounded job-icon">sync</span>
          <div class="job-info">
            <div class="job-command">${job.command}</div>
            <div class="job-status">Status: ${job.status}</div>
          </div>
          <span class="job-pid">PID: ${job.pid}</span>
        </div>
      `).join('');
    } else {
      empty.style.display = 'block';
    }
  } catch (error) {
    console.error('Failed to load jobs:', error);
    loading.style.display = 'none';
    empty.style.display = 'block';
  }
}

function getProviderIcon(type) {
  const icons = {
    's3': 'â˜ï¸',
    'b2': 'ðŸ’¾',
    'drive': 'ðŸ“',
    'dropbox': 'ðŸ“¦',
    'onedrive': 'â˜ï¸',
    'azureblob': 'ðŸ”·',
    'gcs': 'ðŸ”´',
    'mega': 'ðŸ”’',
    'pcloud': 'â˜ï¸',
    'box': 'ðŸ“¦',
    'sftp': 'ðŸ”',
    'ftp': 'ðŸ“¡',
    'webdav': 'ðŸŒ'
  };
  return icons[type] || 'â˜ï¸';
}

function openAddRemoteWizard() {
  document.getElementById('addRemoteModal').classList.add('active');
  currentStep = 1;
  renderProviderSelection();
}

function renderProviderSelection() {
  const popular = Object.entries(providers).filter(([k, v]) => v.popular);
  const others = Object.entries(providers).filter(([k, v]) => !v.popular);
  
  document.getElementById('popularProviders').innerHTML = `
    <div class="provider-grid">
      ${popular.map(([type, info]) => `
        <div class="provider-card" onclick="selectProvider('"+JSON.stringify(type)+"')">
          <div class="provider-icon">${info.icon}</div>
          <div class="provider-name">${info.name}</div>
          <span class="provider-popular">POPULAR</span>
        </div>
      `).join('')}
    </div>
  `;
  
  document.getElementById('allProviders').innerHTML = `
    <div class="provider-grid">
      ${others.map(([type, info]) => `
        <div class="provider-card" onclick="selectProvider('"+JSON.stringify(type)+"')">
          <div class="provider-icon">${info.icon}</div>
          <div class="provider-name">${info.name}</div>
        </div>
      `).join('')}
    </div>
  `;
}

function selectProvider(type) {
  selectedProvider = type;
  document.querySelectorAll('.provider-card').forEach(card => card.classList.remove('selected'));
  event.target.closest('.provider-card').classList.add('selected');
}

function wizardNext() {
  if (currentStep === 1) {
    if (!selectedProvider) {
      showToast('Please select a provider', 'error');
      return;
    }
    renderConfigForm();
  } else if (currentStep === 2) {
    const form = document.getElementById('configForm');
    const inputs = form.querySelectorAll('input[required]');
    let valid = true;
    
    wizardConfig = {};
    inputs.forEach(input => {
      if (!input.value) {
        valid = false;
        input.style.borderColor = 'var(--error)';
      } else {
        wizardConfig[input.name] = input.value;
        input.style.borderColor = '';
      }
    });
    
    if (!valid) {
      showToast('Please fill all required fields', 'error');
      return;
    }
  } else if (currentStep === 3) {
    // Skip test if not performed
  }
  
  currentStep++;
  updateWizardUI();
}

function wizardBack() {
  currentStep--;
  updateWizardUI();
}

function updateWizardUI() {
  document.querySelectorAll('.wizard-step').forEach((step, idx) => {
    step.classList.toggle('active', idx + 1 === currentStep);
    step.classList.toggle('completed', idx + 1 < currentStep);
  });
  
  document.querySelectorAll('.wizard-page').forEach((page, idx) => {
    page.classList.toggle('active', idx + 1 === currentStep);
  });
  
  document.getElementById('wizardBack').style.display = currentStep > 1 ? 'inline-block' : 'none';
  document.getElementById('wizardNext').style.display = currentStep < 4 ? 'inline-block' : 'none';
  document.getElementById('wizardSave').style.display = currentStep === 4 ? 'inline-block' : 'none';
  
  if (currentStep === 3) {
    document.getElementById('testProviderName').textContent = providers[selectedProvider].name;
  }
}

function renderConfigForm() {
  const configs = {
    's3': [
      {name: 'access_key_id', label: 'Access Key ID', type: 'text', required: true},
      {name: 'secret_access_key', label: 'Secret Access Key', type: 'password', required: true},
      {name: 'region', label: 'Region', type: 'text', placeholder: 'us-east-1'},
      {name: 'endpoint', label: 'Endpoint (optional)', type: 'text'}
    ],
    'b2': [
      {name: 'account', label: 'Account ID', type: 'text', required: true},
      {name: 'key', label: 'Application Key', type: 'password', required: true}
    ],
    'drive': [
      {name: 'client_id', label: 'Client ID', type: 'text', required: true},
      {name: 'client_secret', label: 'Client Secret', type: 'password', required: true}
    ],
    'dropbox': [
      {name: 'token', label: 'Access Token', type: 'password', required: true}
    ]
  };
  
  const fields = configs[selectedProvider] || [];
  const form = document.getElementById('configForm');
  
  form.innerHTML = fields.map(field => `
    <div class="form-group">
      <label class="form-label">${field.label}${field.required ? ' *' : ''}</label>
      <input type="${field.type}" name="${field.name}" class="form-input" 
             placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''}>
    </div>
  `).join('');
}

async function testConnection() {
  const testResult = document.getElementById('testResult');
  testResult.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  
  try {
    // Create temporary remote for testing
    const response = await fetch(`${API_BASE}?action=test&remote=temp_test`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': getCSRFToken()
      }
    });
    
    const data = await response.json();
    
    testResult.innerHTML = `
      <div class="test-result ${data.success ? 'success' : 'error'}">
        <span class="material-symbols-rounded">${data.success ? 'check_circle' : 'error'}</span>
        ${escapeHtml(data.message || (data.success ? 'Connection successful!' : 'Connection failed'))}
      </div>
    `;
  } catch (error) {
    testResult.innerHTML = `
      <div class="test-result error">
        <span class="material-symbols-rounded">error</span>
        Test failed: ${escapeHtml(error.message)}
      </div>
    `;
  }
}

async function saveRemote() {
  const name = document.getElementById('remoteName').value.trim();
  
  if (!name) {
    showToast('Please enter a remote name', 'error');
    return;
  }
  
  if (!/^[a-zA-Z0-9_-]+$/.test(name)) {
    showToast('Invalid remote name (alphanumeric, dashes, underscores only)', 'error');
    return;
  }
  
  try {
    const response = await fetch(`${API_BASE}?action=configure`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': getCSRFToken()
      },
      body: JSON.stringify({
        name: name,
        type: selectedProvider,
        config: wizardConfig
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      showToast('Remote added successfully!', 'success');
      closeWizard();
      loadRemotes();
    } else {
      showToast(data.error || 'Failed to add remote', 'error');
    }
  } catch (error) {
    showToast('Failed to save remote: ' + escapeHtml(error.message), 'error');
  }
}

function closeWizard() {
  document.getElementById('addRemoteModal').classList.remove('active');
  selectedProvider = null;
  currentStep = 1;
  wizardConfig = {};
}

async function testRemote(name) {
  try {
    const response = await fetch(`${API_BASE}?action=test&remote=${name}`);
    const data = await response.json();
    
    showToast(data.success ? 
      `Remote "${name}" is accessible` : 
      `Failed to connect to "${name}"`,
      data.success ? 'success' : 'error'
    );
  } catch (error) {
    showToast('Test failed: ' + escapeHtml(error.message), 'error');
  }
}

function deleteRemote(name) {
  remoteToDelete = name;
  document.getElementById('deleteRemoteName').textContent = name;
  document.getElementById('deleteModal').classList.add('active');
}

async function confirmDelete() {
  if (!remoteToDelete) return;
  
  try {
    const response = await fetch(`${API_BASE}?action=delete&remote=${remoteToDelete}`, {
      method: 'POST',
      headers: {
        'X-CSRF-Token': getCSRFToken()
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      showToast('Remote deleted successfully', 'success');
      closeDeleteModal();
      loadRemotes();
    } else {
      showToast(data.error || 'Failed to delete remote', 'error');
    }
  } catch (error) {
    showToast('Delete failed: ' + escapeHtml(error.message), 'error');
  }
}

function closeDeleteModal() {
  document.getElementById('deleteModal').classList.remove('active');
  remoteToDelete = null;
}

document.addEventListener('DOMContentLoaded', () => {
  checkStatus();
  setInterval(loadJobs, 5000); // Refresh jobs every 5 seconds
});
</script>

    <script src="/assets/js/nav-flyout.js"></script>
    <script src="/assets/js/nav-shared.js"></script>
</body>
</html>