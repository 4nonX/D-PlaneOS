<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Alerts - D-PlaneOS</title>
<link rel="stylesheet" href="/assets/css/design-tokens.css">
<link rel="stylesheet" href="/assets/css/dplaneos-ui-complete.css">
<link rel="stylesheet" href="/assets/css/m3-tokens.css">
<link rel="stylesheet" href="/assets/css/m3-components.css">
<link rel="stylesheet" href="/assets/css/m3-icons.css">
<link rel="stylesheet" href="/assets/css/enhanced-ui.css">
<link rel="stylesheet" href="/assets/css/m3-animations.css">
<link rel="stylesheet" href="/assets/css/material-symbols-local.css">
<link rel="stylesheet" href="/assets/css/ui-consistency.css">
<link rel="stylesheet" href="/assets/css/ui-polish.css">
<link rel="stylesheet" href="/assets/css/ui-components.css">
<script src="/assets/js/core.js"></script>
<script src="/assets/js/nav-shared.js"></script>
<script src="/assets/js/nav-flyout.js"></script>
<script src="/assets/js/enhanced-ui.js"></script>
<script src="/assets/js/connection-monitor.js"></script>
<script src="/assets/js/permission-checker.js"></script>
<style>
.main { max-width: 1100px; margin: 140px auto 60px; padding: 0 40px; }
.page-title { font-size: 32px; font-weight: 700; letter-spacing: -1.5px; margin-bottom: 8px; }
.page-subtitle { font-size: 16px; color: rgba(255,255,255,0.5); margin-bottom: 32px; }

/* Tabs */
.tabs { display: flex; gap: 4px; margin-bottom: 32px;
  background: rgba(255,255,255,0.03); padding: 6px; border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.06); width: fit-content; }
.tab-btn { padding: 10px 24px; border-radius: 10px; border: none; cursor: pointer;
  font-size: 14px; font-weight: 500; color: rgba(255,255,255,0.5);
  background: transparent; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
.tab-btn.active { background: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(102,126,234,0.4); }
.tab-btn:hover:not(.active) { background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.8); }
.tab-pane { display: none; }
.tab-pane.active { display: block; }

/* Cards */
.card { padding: 28px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);
  border-radius: 16px; margin-bottom: 20px; }
.card-title { font-size: 16px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }

/* Forms */
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.form-grid.single { grid-template-columns: 1fr; }
.form-group { display: flex; flex-direction: column; gap: 6px; }
.form-group.span2 { grid-column: 1 / -1; }
.form-label { font-size: 13px; color: rgba(255,255,255,0.6); }
.form-input { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.12);
  border-radius: 10px; padding: 10px 14px; color: #fff; font-size: 14px; width: 100%; }
.form-input:focus { outline: none; border-color: var(--primary); background: rgba(102,126,234,0.08); }
.form-hint { font-size: 12px; color: rgba(255,255,255,0.35); margin-top: 2px; }
select.form-input option { background: #1a1a2e; }

/* Buttons */
.btn { padding: 10px 20px; border-radius: 12px; border: none; cursor: pointer;
  font-size: 14px; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover { opacity: 0.85; }
.btn-ghost { background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.7);
  border: 1px solid rgba(255,255,255,0.1); }
.btn-ghost:hover { background: rgba(255,255,255,0.1); color: #fff; }
.btn-danger { background: rgba(244,67,54,0.12); color: #ef9a9a; border: 1px solid rgba(244,67,54,0.2); }
.btn-danger:hover { background: rgba(244,67,54,0.22); }
.btn-sm { padding: 6px 14px; font-size: 13px; border-radius: 8px; }
.btn:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-row { display: flex; gap: 8px; margin-top: 20px; flex-wrap: wrap; }

/* Webhook list */
.webhook-item { padding: 16px 20px; background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.07); border-radius: 12px; margin-bottom: 10px;
  display: flex; align-items: center; gap: 16px; }
.webhook-url { font-family: monospace; font-size: 13px; color: rgba(255,255,255,0.7);
  flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.webhook-name { font-size: 14px; font-weight: 600; min-width: 140px; }
.webhook-events { font-size: 12px; color: rgba(255,255,255,0.4); }
.webhook-actions { display: flex; gap: 6px; flex-shrink: 0; }

/* Event checkboxes */
.events-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
.event-check { display: flex; align-items: center; gap: 8px; padding: 8px 12px;
  background: rgba(255,255,255,0.03); border-radius: 8px; cursor: pointer;
  border: 1px solid rgba(255,255,255,0.06); transition: all 0.15s; }
.event-check:hover { background: rgba(255,255,255,0.06); }
.event-check input { width: 14px; height: 14px; accent-color: var(--primary); cursor: pointer; }
.event-check label { font-size: 13px; color: rgba(255,255,255,0.7); cursor: pointer; }

/* Status indicators */
.status-ok   { color: #81c784; }
.status-err  { color: #ef9a9a; }
.status-warn { color: #ffb74d; }

/* Spinner */
.spinner { display: inline-block; width: 14px; height: 14px;
  border: 2px solid rgba(255,255,255,0.2); border-top-color: rgba(255,255,255,0.8);
  border-radius: 50%; animation: spin 0.6s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Test result */
.test-result { margin-top: 12px; padding: 12px 16px; border-radius: 10px;
  font-size: 13px; display: none; }
.test-result.ok  { background: rgba(76,175,80,0.1); color: #81c784; border: 1px solid rgba(76,175,80,0.2); }
.test-result.err { background: rgba(244,67,54,0.1); color: #ef9a9a; border: 1px solid rgba(244,67,54,0.2); }

/* Empty state */
.empty { text-align: center; padding: 40px; color: rgba(255,255,255,0.3); }
.empty .material-symbols-rounded { font-size: 48px; display: block; margin-bottom: 12px; }
</style>
</head>
<body>
<div id="nav-root"></div>

<div class="main">
  <h1 class="page-title">Alerts & Notifications</h1>
  <p class="page-subtitle">Configure where D-PlaneOS sends alerts — webhooks, email, and Telegram</p>

  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('webhooks')">
      <span class="material-symbols-rounded" style="font-size:16px;">webhook</span> Webhooks
    </button>
    <button class="tab-btn" onclick="switchTab('smtp')">
      <span class="material-symbols-rounded" style="font-size:16px;">mail</span> Email (SMTP)
    </button>
    <button class="tab-btn" onclick="switchTab('telegram')">
      <span class="material-symbols-rounded" style="font-size:16px;">send</span> Telegram
    </button>
  </div>

  <!-- ── WEBHOOKS ─────────────────────────────────────────────────────────── -->
  <div id="pane-webhooks" class="tab-pane active">

    <!-- Existing webhooks -->
    <div class="card">
      <div class="card-title">
        <span class="material-symbols-rounded">list</span>
        Configured Webhooks
        <button class="btn btn-primary btn-sm" onclick="toggleAddWebhook()" id="addWHBtn" style="margin-left:auto;">
          <span class="material-symbols-rounded" style="font-size:14px;">add</span> Add Webhook
        </button>
      </div>
      <div id="webhookList">
        <div class="empty"><span class="material-symbols-rounded">webhook</span>Loading…</div>
      </div>
    </div>

    <!-- Add webhook form -->
    <div class="card" id="addWebhookCard" style="display:none;">
      <div class="card-title"><span class="material-symbols-rounded">add_link</span> New Webhook</div>
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Name *</label>
          <input type="text" class="form-input" id="wh_name" placeholder="Slack #alerts">
        </div>
        <div class="form-group">
          <label class="form-label">URL *</label>
          <input type="url" class="form-input" id="wh_url" placeholder="https://hooks.slack.com/services/…">
        </div>
        <div class="form-group span2">
          <label class="form-label">HTTP Method</label>
          <select class="form-input" id="wh_method" style="max-width:160px;">
            <option value="POST">POST</option>
            <option value="PUT">PUT</option>
          </select>
        </div>
        <div class="form-group span2">
          <label class="form-label">Event Triggers</label>
          <div class="events-grid" id="eventCheckboxes"></div>
          <div class="form-hint">Leave all unchecked to receive all events.</div>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn btn-primary" onclick="saveWebhook()" id="saveWHBtn">
          <span class="material-symbols-rounded" style="font-size:16px;">save</span> Save Webhook
        </button>
        <button class="btn btn-ghost" onclick="toggleAddWebhook()">Cancel</button>
      </div>
    </div>

  </div>

  <!-- ── SMTP ─────────────────────────────────────────────────────────────── -->
  <div id="pane-smtp" class="tab-pane">
    <div class="card">
      <div class="card-title"><span class="material-symbols-rounded">mail</span> SMTP Configuration</div>
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">SMTP Host *</label>
          <input type="text" class="form-input" id="smtp_host" placeholder="smtp.gmail.com">
        </div>
        <div class="form-group">
          <label class="form-label">Port</label>
          <input type="number" class="form-input" id="smtp_port" placeholder="587" min="1" max="65535">
        </div>
        <div class="form-group">
          <label class="form-label">Username</label>
          <input type="text" class="form-input" id="smtp_username" placeholder="alerts@example.com">
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" class="form-input" id="smtp_password" placeholder="leave blank to keep current">
        </div>
        <div class="form-group">
          <label class="form-label">From Address *</label>
          <input type="email" class="form-input" id="smtp_from" placeholder="dplaneos@example.com">
        </div>
        <div class="form-group">
          <label class="form-label">To Address(es) *</label>
          <input type="text" class="form-input" id="smtp_to" placeholder="admin@example.com, ops@example.com">
          <div class="form-hint">Comma-separated list</div>
        </div>
        <div class="form-group span2" style="display:flex;align-items:center;gap:12px;padding-top:4px;">
          <input type="checkbox" id="smtp_tls" style="width:16px;height:16px;accent-color:var(--primary);">
          <label for="smtp_tls" style="font-size:14px;cursor:pointer;">Use TLS/STARTTLS</label>
        </div>
      </div>
      <div id="smtpTestResult" class="test-result"></div>
      <div class="btn-row">
        <button class="btn btn-primary" onclick="saveSMTP()" id="saveSMTPBtn">
          <span class="material-symbols-rounded" style="font-size:16px;">save</span> Save
        </button>
        <button class="btn btn-ghost" onclick="testSMTP()" id="testSMTPBtn">
          <span class="material-symbols-rounded" style="font-size:16px;">send</span> Send Test Email
        </button>
      </div>
    </div>
  </div>

  <!-- ── TELEGRAM ──────────────────────────────────────────────────────────── -->
  <div id="pane-telegram" class="tab-pane">
    <div class="card">
      <div class="card-title"><span class="material-symbols-rounded">send</span> Telegram Bot Configuration</div>
      <div style="padding:12px 16px;background:rgba(33,150,243,0.08);border:1px solid rgba(33,150,243,0.2);border-radius:10px;font-size:13px;color:rgba(255,255,255,0.6);margin-bottom:20px;line-height:1.6;">
        <strong>Setup:</strong> Create a bot via <code>@BotFather</code> on Telegram to get a token.
        Then send a message to your bot and use <code>@userinfobot</code> to find your Chat ID.
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Bot Token *</label>
          <input type="text" class="form-input" id="tg_token" placeholder="123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11">
        </div>
        <div class="form-group">
          <label class="form-label">Chat ID *</label>
          <input type="text" class="form-input" id="tg_chatid" placeholder="-1001234567890">
          <div class="form-hint">Use negative ID for group chats</div>
        </div>
        <div class="form-group span2" style="display:flex;align-items:center;gap:12px;padding-top:4px;">
          <input type="checkbox" id="tg_enabled" style="width:16px;height:16px;accent-color:var(--primary);">
          <label for="tg_enabled" style="font-size:14px;cursor:pointer;">Enable Telegram alerts</label>
        </div>
      </div>
      <div id="tgTestResult" class="test-result"></div>
      <div class="btn-row">
        <button class="btn btn-primary" onclick="saveTelegram()" id="saveTGBtn">
          <span class="material-symbols-rounded" style="font-size:16px;">save</span> Save
        </button>
        <button class="btn btn-ghost" onclick="testTelegram()" id="testTGBtn">
          <span class="material-symbols-rounded" style="font-size:16px;">send</span> Send Test Message
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// ── Known alert event types ───────────────────────────────────────────────────
const EVENT_TYPES = [
  { key: 'zfs.degraded',     label: 'ZFS Pool Degraded' },
  { key: 'zfs.capacity',     label: 'Capacity Threshold' },
  { key: 'zfs.error',        label: 'ZFS Error' },
  { key: 'system.update',    label: 'System Update' },
  { key: 'system.reboot',    label: 'System Reboot' },
  { key: 'docker.failure',   label: 'Container Failure' },
  { key: 'gitops.drift',     label: 'GitOps Drift' },
  { key: 'ha.failover',      label: 'HA Failover' },
  { key: 'security.event',   label: 'Security Event' },
];

let addWebhookOpen = false;

// ── Tab switching ─────────────────────────────────────────────────────────────
function switchTab(name) {
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('pane-' + name).classList.add('active');
  event.target.closest('.tab-btn').classList.add('active');
  if (name === 'smtp') loadSMTP();
  if (name === 'telegram') loadTelegram();
}

// ── WEBHOOKS ──────────────────────────────────────────────────────────────────
function toggleAddWebhook() {
  addWebhookOpen = !addWebhookOpen;
  const card = document.getElementById('addWebhookCard');
  const btn = document.getElementById('addWHBtn');
  if (addWebhookOpen) {
    card.style.display = 'block';
    btn.innerHTML = '<span class="material-symbols-rounded" style="font-size:14px;">close</span> Cancel';
    renderEventCheckboxes();
  } else {
    card.style.display = 'none';
    btn.innerHTML = '<span class="material-symbols-rounded" style="font-size:14px;">add</span> Add Webhook';
  }
}

function renderEventCheckboxes() {
  document.getElementById('eventCheckboxes').innerHTML = EVENT_TYPES.map(e => `
    <label class="event-check">
      <input type="checkbox" name="evt" value="${e.key}">
      <label>${e.label}</label>
    </label>
  `).join('');
}

async function loadWebhooks() {
  try {
    const res = await csrfFetch('/api/alerts/webhooks');
    const data = await res.json();
    const list = document.getElementById('webhookList');
    const hooks = data.webhooks || data || [];
    if (!hooks.length) {
      list.innerHTML = '<div class="empty"><span class="material-symbols-rounded">webhook</span>No webhooks configured. Add one to start receiving alerts.</div>';
      return;
    }
    list.innerHTML = hooks.map(h => `
      <div class="webhook-item">
        <div style="flex:0 0 auto;">
          <div class="webhook-name">${esc(h.name || 'Webhook')}</div>
          <div class="webhook-events">${formatEvents(h.events)}</div>
        </div>
        <div class="webhook-url" title="${esc(h.url)}">${esc(h.url)}</div>
        <div class="webhook-actions">
          <button class="btn btn-ghost btn-sm" onclick="testWebhook(${h.id})" title="Send test">
            <span class="material-symbols-rounded" style="font-size:14px;">send</span>
          </button>
          <button class="btn btn-danger btn-sm" onclick="deleteWebhook(${h.id}, '${esc(h.name)}')" title="Delete">
            <span class="material-symbols-rounded" style="font-size:14px;">delete</span>
          </button>
        </div>
      </div>
    `).join('');
  } catch (e) {
    document.getElementById('webhookList').innerHTML = `<div class="empty" style="color:#ef9a9a;">Failed to load: ${esc(e.message)}</div>`;
  }
}

function formatEvents(events) {
  if (!events || events.length === 0) return 'All events';
  return events.slice(0, 3).join(', ') + (events.length > 3 ? ` +${events.length - 3} more` : '');
}

async function saveWebhook() {
  const name = document.getElementById('wh_name').value.trim();
  const url = document.getElementById('wh_url').value.trim();
  const method = document.getElementById('wh_method').value;
  const events = Array.from(document.querySelectorAll('input[name="evt"]:checked')).map(e => e.value);

  if (!name || !url) {
    if (window.EnhancedUI) EnhancedUI.toast('Name and URL are required', 'error');
    return;
  }
  if (!url.startsWith('http')) {
    if (window.EnhancedUI) EnhancedUI.toast('URL must start with http:// or https://', 'error');
    return;
  }

  const btn = document.getElementById('saveWHBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Saving…';

  try {
    const res = await csrfFetch('/api/alerts/webhooks', {
      method: 'POST',
      body: JSON.stringify({ name, url, method, events })
    });
    const data = await res.json();
    if (data.success || data.id) {
      if (window.EnhancedUI) EnhancedUI.toast('Webhook saved', 'success');
      toggleAddWebhook();
      loadWebhooks();
    } else {
      if (window.EnhancedUI) EnhancedUI.toast(data.error || 'Save failed', 'error');
    }
  } catch (e) {
    if (window.EnhancedUI) EnhancedUI.toast('Network error: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<span class="material-symbols-rounded" style="font-size:16px;">save</span> Save Webhook';
  }
}

async function deleteWebhook(id, name) {
  if (!await ui.confirm('Delete Webhook', `Delete webhook "${name}"? Notifications will no longer be sent to this URL.`)) return;
  try {
    const res = await csrfFetch(`/api/alerts/webhooks/${id}`, { method: 'DELETE' });
    const data = await res.json();
    if (data.success) {
      if (window.EnhancedUI) EnhancedUI.toast('Webhook deleted', 'success');
      loadWebhooks();
    } else {
      if (window.EnhancedUI) EnhancedUI.toast(data.error || 'Delete failed', 'error');
    }
  } catch (e) {
    if (window.EnhancedUI) EnhancedUI.toast('Network error: ' + e.message, 'error');
  }
}

async function testWebhook(id) {
  try {
    const res = await csrfFetch(`/api/alerts/webhooks/${id}/test`, { method: 'POST' });
    const data = await res.json();
    if (data.success) {
      if (window.EnhancedUI) EnhancedUI.toast('Test sent successfully', 'success');
    } else {
      if (window.EnhancedUI) EnhancedUI.toast('Test failed: ' + (data.error || 'Unknown error'), 'error');
    }
  } catch (e) {
    if (window.EnhancedUI) EnhancedUI.toast('Network error: ' + e.message, 'error');
  }
}

// ── SMTP ──────────────────────────────────────────────────────────────────────
async function loadSMTP() {
  try {
    const res = await csrfFetch('/api/alerts/smtp');
    const data = await res.json();
    const c = data.config || data.smtp || data || {};
    document.getElementById('smtp_host').value = c.host || '';
    document.getElementById('smtp_port').value = c.port || 587;
    document.getElementById('smtp_username').value = c.username || '';
    document.getElementById('smtp_from').value = c.from || c.from_address || '';
    document.getElementById('smtp_to').value = Array.isArray(c.to) ? c.to.join(', ') : (c.to || c.to_address || '');
    document.getElementById('smtp_tls').checked = !!(c.tls || c.use_tls);
  } catch (e) {
    // Silently ignore — might not be configured yet
  }
}

async function saveSMTP() {
  const config = {
    host:     document.getElementById('smtp_host').value.trim(),
    port:     parseInt(document.getElementById('smtp_port').value) || 587,
    username: document.getElementById('smtp_username').value.trim(),
    password: document.getElementById('smtp_password').value,
    from:     document.getElementById('smtp_from').value.trim(),
    to:       document.getElementById('smtp_to').value.split(',').map(s => s.trim()).filter(Boolean),
    tls:      document.getElementById('smtp_tls').checked
  };

  if (!config.host || !config.from || config.to.length === 0) {
    if (window.EnhancedUI) EnhancedUI.toast('Host, from address, and at least one recipient are required', 'error');
    return;
  }

  const btn = document.getElementById('saveSMTPBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Saving…';

  try {
    const res = await csrfFetch('/api/alerts/smtp', { method: 'POST', body: JSON.stringify(config) });
    const data = await res.json();
    showTestResult('smtpTestResult', data.success || data.ok, data.message || (data.success ? 'SMTP configuration saved.' : data.error));
    if (data.success || data.ok) {
      if (window.EnhancedUI) EnhancedUI.toast('SMTP saved', 'success');
    }
  } catch (e) {
    showTestResult('smtpTestResult', false, 'Network error: ' + e.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<span class="material-symbols-rounded" style="font-size:16px;">save</span> Save';
  }
}

async function testSMTP() {
  const btn = document.getElementById('testSMTPBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Sending…';
  try {
    const res = await csrfFetch('/api/alerts/smtp/test', { method: 'POST' });
    const data = await res.json();
    showTestResult('smtpTestResult', data.success || data.ok, data.message || (data.success ? 'Test email sent.' : data.error || 'Failed'));
  } catch (e) {
    showTestResult('smtpTestResult', false, 'Network error: ' + e.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<span class="material-symbols-rounded" style="font-size:16px;">send</span> Send Test Email';
  }
}

// ── TELEGRAM ──────────────────────────────────────────────────────────────────
async function loadTelegram() {
  try {
    const res = await csrfFetch('/api/alerts/telegram');
    const data = await res.json();
    const c = data.config || data.telegram || data || {};
    document.getElementById('tg_token').value = c.bot_token || c.token || '';
    document.getElementById('tg_chatid').value = c.chat_id || '';
    document.getElementById('tg_enabled').checked = !!(c.enabled);
  } catch (e) {
    // Not configured yet — ignore
  }
}

async function saveTelegram() {
  const config = {
    bot_token: document.getElementById('tg_token').value.trim(),
    chat_id:   document.getElementById('tg_chatid').value.trim(),
    enabled:   document.getElementById('tg_enabled').checked
  };

  if (config.enabled && (!config.bot_token || !config.chat_id)) {
    if (window.EnhancedUI) EnhancedUI.toast('Bot token and Chat ID are required to enable Telegram', 'error');
    return;
  }

  const btn = document.getElementById('saveTGBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Saving…';

  try {
    const res = await csrfFetch('/api/alerts/telegram', { method: 'POST', body: JSON.stringify(config) });
    const data = await res.json();
    if (data.success || data.ok) {
      if (window.EnhancedUI) EnhancedUI.toast('Telegram configuration saved', 'success');
      showTestResult('tgTestResult', true, 'Configuration saved.');
    } else {
      showTestResult('tgTestResult', false, data.error || 'Save failed');
    }
  } catch (e) {
    showTestResult('tgTestResult', false, 'Network error: ' + e.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<span class="material-symbols-rounded" style="font-size:16px;">save</span> Save';
  }
}

async function testTelegram() {
  const btn = document.getElementById('testTGBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Sending…';
  try {
    const res = await csrfFetch('/api/alerts/telegram/test', { method: 'POST' });
    const data = await res.json();
    showTestResult('tgTestResult', data.success || data.ok,
      data.message || (data.success ? 'Test message sent to Telegram.' : data.error || 'Failed'));
  } catch (e) {
    showTestResult('tgTestResult', false, 'Network error: ' + e.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<span class="material-symbols-rounded" style="font-size:16px;">send</span> Send Test Message';
  }
}

// ── Shared helpers ────────────────────────────────────────────────────────────
function showTestResult(elemId, ok, msg) {
  const el = document.getElementById(elemId);
  el.style.display = 'block';
  el.className = 'test-result ' + (ok ? 'ok' : 'err');
  el.textContent = msg;
  setTimeout(() => el.style.display = 'none', 6000);
}

function esc(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ── Init ──────────────────────────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', () => {
  loadWebhooks();
});
</script>
</body>
</html>
