<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Support & Diagnostics - D-PlaneOS</title>
<link rel="stylesheet" href="/assets/css/design-tokens.css">
<link rel="stylesheet" href="/assets/css/dplaneos-ui-complete.css">
<link rel="stylesheet" href="/assets/css/m3-tokens.css">
<link rel="stylesheet" href="/assets/css/m3-components.css">
<link rel="stylesheet" href="/assets/css/m3-icons.css">
<link rel="stylesheet" href="/assets/css/enhanced-ui.css">
<link rel="stylesheet" href="/assets/css/m3-animations.css">
<link rel="stylesheet" href="/assets/css/material-symbols-local.css">
<link rel="stylesheet" href="/assets/css/ui-consistency.css">
<link rel="stylesheet" href="/assets/css/ui-polish.css">
<link rel="stylesheet" href="/assets/css/ui-components.css">
<script src="/assets/js/core.js"></script>
<script src="/assets/js/nav-shared.js"></script>
<script src="/assets/js/nav-flyout.js"></script>
<script src="/assets/js/enhanced-ui.js"></script>
<script src="/assets/js/connection-monitor.js"></script>
<script src="/assets/js/permission-checker.js"></script>
<style>
.main { max-width: 1100px; margin: 140px auto 60px; padding: 0 40px; }
.page-title { font-size: 32px; font-weight: 700; letter-spacing: -1.5px; margin-bottom: 8px; }
.page-subtitle { font-size: 16px; color: rgba(255,255,255,0.5); margin-bottom: 32px; }

/* Sections */
.section { margin-bottom: 32px; }
.section-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }

/* Cards */
.card { padding: 28px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);
  border-radius: 16px; margin-bottom: 16px; }
.card-row { display: flex; align-items: flex-start; gap: 20px; }
.card-icon { font-size: 32px; color: var(--primary); flex-shrink: 0; margin-top: 2px; }
.card-body { flex: 1; }
.card-name { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
.card-desc { font-size: 14px; color: rgba(255,255,255,0.5); margin-bottom: 16px; line-height: 1.6; }

/* Buttons */
.btn { padding: 10px 20px; border-radius: 12px; border: none; cursor: pointer;
  font-size: 14px; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover { opacity: 0.85; transform: translateY(-1px); }
.btn-ghost { background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.7);
  border: 1px solid rgba(255,255,255,0.1); }
.btn-ghost:hover { background: rgba(255,255,255,0.1); color: #fff; }
.btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

/* Result areas */
.result { margin-top: 16px; padding: 14px 18px; border-radius: 10px;
  font-size: 13px; display: none; }
.result.ok  { background: rgba(76,175,80,0.1); color: #81c784; border: 1px solid rgba(76,175,80,0.2); }
.result.err { background: rgba(244,67,54,0.1); color: #ef9a9a; border: 1px solid rgba(244,67,54,0.2); }
.result.info { background: rgba(33,150,243,0.08); color: #64b5f6; border: 1px solid rgba(33,150,243,0.2); }

/* Chain verify display */
.chain-result { padding: 20px; border-radius: 12px; font-family: monospace; font-size: 13px; }
.chain-ok  { background: rgba(76,175,80,0.08); border: 1px solid rgba(76,175,80,0.2); color: #a5d6a7; }
.chain-err { background: rgba(244,67,54,0.08); border: 1px solid rgba(244,67,54,0.2); color: #ef9a9a; }
.chain-field { display: flex; justify-content: space-between; padding: 4px 0;
  border-bottom: 1px solid rgba(255,255,255,0.06); }
.chain-field:last-child { border-bottom: none; }
.chain-key { color: rgba(255,255,255,0.5); }
.chain-val { color: rgba(255,255,255,0.85); }

/* Snapshot table */
.snapshot-table { width: 100%; border-collapse: collapse; }
.snapshot-table th { text-align: left; padding: 10px 12px; font-size: 12px;
  color: rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 0.5px;
  border-bottom: 1px solid rgba(255,255,255,0.08); }
.snapshot-table td { padding: 12px; font-size: 14px; border-bottom: 1px solid rgba(255,255,255,0.04); }
.snapshot-table tr:last-child td { border-bottom: none; }
.snapshot-name { font-family: monospace; font-size: 12px; color: rgba(255,255,255,0.6); }

/* Progress bar for bundle download */
.progress-bar { height: 4px; background: rgba(255,255,255,0.08); border-radius: 4px;
  margin-top: 12px; overflow: hidden; display: none; }
.progress-fill { height: 100%; background: var(--primary); border-radius: 4px;
  width: 0; transition: width 0.3s; animation: progressPulse 1.5s infinite; }
@keyframes progressPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

/* Spinner */
.spinner { display: inline-block; width: 14px; height: 14px;
  border: 2px solid rgba(255,255,255,0.2); border-top-color: rgba(255,255,255,0.8);
  border-radius: 50%; animation: spin 0.6s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Status badge */
.badge-ok { display: inline-flex; align-items: center; gap: 4px;
  background: rgba(76,175,80,0.15); color: #81c784; border: 1px solid rgba(76,175,80,0.25);
  padding: 3px 10px; border-radius: 8px; font-size: 12px; font-weight: 600; }
.badge-err { background: rgba(244,67,54,0.15); color: #ef9a9a; border-color: rgba(244,67,54,0.25); }
</style>
</head>
<body>
<div id="nav-root"></div>

<div class="main">
  <h1 class="page-title">Support & Diagnostics</h1>
  <p class="page-subtitle">Generate support bundles, verify audit integrity, and inspect pre-upgrade snapshots</p>

  <!-- â”€â”€ Support Bundle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="section">
    <div class="section-title">
      <span class="material-symbols-rounded">folder_zip</span>
      Support Bundle
    </div>
    <div class="card">
      <div class="card-row">
        <span class="material-symbols-rounded card-icon">inventory_2</span>
        <div class="card-body">
          <div class="card-name">Generate Diagnostic Bundle</div>
          <div class="card-desc">
            Creates a compressed archive containing ZFS pool status, SMART diagnostics,
            system journal (last 1000 lines), network state, and the most recent audit log entries.
            No passwords or secrets are included.
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn btn-primary" onclick="generateBundle()" id="bundleBtn">
              <span class="material-symbols-rounded" style="font-size:16px;">download</span>
              Download Support Bundle
            </button>
            <button class="btn btn-ghost" onclick="previewBundleContents()" id="previewBtn">
              <span class="material-symbols-rounded" style="font-size:16px;">preview</span>
              Preview Contents
            </button>
          </div>
          <div class="progress-bar" id="bundleProgress">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div class="result" id="bundleResult"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Audit Chain Integrity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="section">
    <div class="section-title">
      <span class="material-symbols-rounded">verified</span>
      Audit Chain Integrity
    </div>
    <div class="card">
      <div class="card-row">
        <span class="material-symbols-rounded card-icon">link</span>
        <div class="card-body">
          <div class="card-name">Verify HMAC Audit Chain</div>
          <div class="card-desc">
            Validates the tamper-evident HMAC chain across all audit log entries.
            Each entry is linked to the previous via HMAC-SHA256, making any modification detectable.
            Verification checks the entire chain from first entry to last.
          </div>
          <button class="btn btn-primary" onclick="verifyAuditChain()" id="chainBtn">
            <span class="material-symbols-rounded" style="font-size:16px;">fact_check</span>
            Verify Audit Chain
          </button>
          <div id="chainResult" style="margin-top:16px;display:none;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Pre-Upgrade Snapshots â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="section">
    <div class="section-title">
      <span class="material-symbols-rounded">history</span>
      Pre-Upgrade ZFS Snapshots
    </div>
    <div class="card">
      <div class="card-row">
        <span class="material-symbols-rounded card-icon">photo_camera</span>
        <div class="card-body">
          <div class="card-name">Automatic Pre-Upgrade Snapshots</div>
          <div class="card-desc">
            D-PlaneOS automatically creates a ZFS snapshot of every pool before applying a
            NixOS system update (<code>nixos-rebuild switch</code>). These snapshots are tagged
            <code>@pre-upgrade-&lt;timestamp&gt;</code> and can be used for rollback if an update causes issues.
          </div>
          <button class="btn btn-ghost" onclick="loadSnapshots()" id="snapshotRefreshBtn">
            <span class="material-symbols-rounded" style="font-size:16px;">refresh</span>
            Refresh Snapshots
          </button>
          <div id="snapshotList" style="margin-top:16px;">
            <div style="color:rgba(255,255,255,0.3);padding:16px;text-align:center;">
              Click Refresh to load pre-upgrade snapshots
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ System Info Quick â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="section">
    <div class="section-title">
      <span class="material-symbols-rounded">computer</span>
      Quick System Info
    </div>
    <div class="card" id="sysInfoCard">
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;" id="sysInfoGrid">
        <div style="text-align:center;color:rgba(255,255,255,0.3);grid-column:1/-1;padding:20px;">
          <span class="spinner"></span> Loading system infoâ€¦
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// â”€â”€ Support Bundle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function generateBundle() {
  const btn = document.getElementById('bundleBtn');
  const progress = document.getElementById('bundleProgress');
  const fill = document.getElementById('progressFill');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Generatingâ€¦';
  progress.style.display = 'block';

  // Animate progress bar (we don't know when it ends â€” stream)
  let pct = 0;
  const progressInterval = setInterval(() => {
    pct = Math.min(pct + Math.random() * 8, 90);
    fill.style.width = pct + '%';
  }, 300);

  try {
    const res = await csrfFetch('/api/system/support-bundle', { method: 'POST' });
    if (!res.ok) {
      const data = await res.json().catch(() => ({}));
      throw new Error(data.error || `HTTP ${res.status}`);
    }

    clearInterval(progressInterval);
    fill.style.width = '100%';

    // Trigger download
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const now = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
    a.href = url;
    a.download = `dplaneos-support-bundle-${now}.tar.gz`;
    a.click();
    URL.revokeObjectURL(url);

    showResult('bundleResult', 'ok', 'âœ“ Support bundle downloaded successfully.');
    if (window.EnhancedUI) EnhancedUI.toast('Bundle downloaded', 'success');
  } catch (e) {
    clearInterval(progressInterval);
    showResult('bundleResult', 'err', 'âœ— Failed to generate bundle: ' + e.message);
    if (window.EnhancedUI) EnhancedUI.toast('Bundle generation failed: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<span class="material-symbols-rounded" style="font-size:16px;">download</span> Download Support Bundle';
    setTimeout(() => { progress.style.display = 'none'; fill.style.width = '0'; }, 2000);
  }
}

async function previewBundleContents() {
  const btn = document.getElementById('previewBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Loadingâ€¦';
  // Show what's included
  const contents = [
    'ðŸ“ zfs-status.txt      â€” zpool status + zfs list output',
    'ðŸ“ smart/              â€” smartctl JSON for each disk',
    'ðŸ“ journal.txt         â€” last 1000 system journal lines',
    'ðŸ“ network.txt         â€” ip addr, ip route output',
    'ðŸ“ audit.tail.jsonl    â€” last 100 audit log entries',
    'ðŸ“ daemon-info.json    â€” daemon version, uptime, config',
    'ðŸ“ os-release.txt      â€” NixOS version information',
  ];
  const html = contents.map(c => `<div style="font-family:monospace;font-size:13px;padding:4px 0;color:rgba(255,255,255,0.7);">${esc(c)}</div>`).join('');
  showResult('bundleResult', 'info', '<strong>Bundle contents:</strong><br><div style="margin-top:8px;">' + html + '</div>');
  btn.disabled = false;
  btn.innerHTML = '<span class="material-symbols-rounded" style="font-size:16px;">preview</span> Preview Contents';
}

// â”€â”€ Audit Chain â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function verifyAuditChain() {
  const btn = document.getElementById('chainBtn');
  const result = document.getElementById('chainResult');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Verifyingâ€¦';
  result.style.display = 'none';

  try {
    const res = await csrfFetch('/api/system/audit/verify-chain');
    const data = await res.json();
    result.style.display = 'block';

    const ok = data.valid || data.success || data.ok;
    const fields = [
      { key: 'Status',         val: ok ? 'âœ“ VALID â€” chain integrity confirmed' : 'âœ— INVALID â€” tampering detected' },
      { key: 'Total entries',  val: data.total_entries || data.count || 'â€”' },
      { key: 'Checked',        val: data.checked || data.verified || 'â€”' },
      { key: 'First entry',    val: data.first_entry || data.oldest || 'â€”' },
      { key: 'Last entry',     val: data.last_entry || data.newest || 'â€”' },
      { key: 'Chain depth',    val: data.chain_depth || data.depth || 'â€”' },
      { key: 'Verified at',    val: new Date().toLocaleString() },
    ];
    if (!ok && data.error) {
      fields.push({ key: 'Error detail', val: data.error });
    }

    result.innerHTML = `
      <div class="chain-result ${ok ? 'chain-ok' : 'chain-err'}">
        ${fields.filter(f => f.val && f.val !== 'â€”').map(f => `
          <div class="chain-field">
            <span class="chain-key">${esc(f.key)}</span>
            <span class="chain-val">${esc(String(f.val))}</span>
          </div>
        `).join('')}
      </div>`;
    if (window.EnhancedUI) EnhancedUI.toast(ok ? 'Audit chain valid' : 'Chain integrity FAILED', ok ? 'success' : 'error');
  } catch (e) {
    result.style.display = 'block';
    result.innerHTML = `<div class="result err" style="display:block;">Network error: ${esc(e.message)}</div>`;
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<span class="material-symbols-rounded" style="font-size:16px;">fact_check</span> Verify Audit Chain';
  }
}

// â”€â”€ Pre-Upgrade Snapshots â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadSnapshots() {
  const btn = document.getElementById('snapshotRefreshBtn');
  const list = document.getElementById('snapshotList');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Loadingâ€¦';
  try {
    const res = await csrfFetch('/api/nixos/pre-upgrade-snapshots');
    const data = await res.json();
    const snaps = data.snapshots || [];
    if (snaps.length === 0) {
      list.innerHTML = '<div style="color:rgba(255,255,255,0.3);padding:16px;">No pre-upgrade snapshots found. They are created automatically before each NixOS upgrade.</div>';
    } else {
      list.innerHTML = `
        <table class="snapshot-table">
          <thead>
            <tr>
              <th>Pool</th>
              <th>Snapshot Name</th>
              <th>Created</th>
              <th>Used</th>
            </tr>
          </thead>
          <tbody>
            ${snaps.map(s => `
              <tr>
                <td>${esc(s.pool || 'â€”')}</td>
                <td><span class="snapshot-name">${esc(s.name || s.snapshot || 'â€”')}</span></td>
                <td>${s.created ? new Date(s.created * 1000).toLocaleString() : (s.created_at || 'â€”')}</td>
                <td>${esc(s.used || s.size || 'â€”')}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>`;
    }
  } catch (e) {
    list.innerHTML = `<div style="color:#ef9a9a;padding:16px;">Failed to load: ${esc(e.message)}</div>`;
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<span class="material-symbols-rounded" style="font-size:16px;">refresh</span> Refresh Snapshots';
  }
}

// â”€â”€ System Info â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadSysInfo() {
  try {
    const res = await csrfFetch('/api/system/metrics');
    const data = await res.json();
    const m = data.metrics || data || {};

    const items = [
      { label: 'Hostname',       val: m.hostname || 'â€”' },
      { label: 'OS',             val: m.os || m.platform || 'â€”' },
      { label: 'Kernel',         val: m.kernel || 'â€”' },
      { label: 'CPU',            val: m.cpu_model || m.cpu || 'â€”' },
      { label: 'CPU Usage',      val: typeof m.cpu_percent === 'number' ? m.cpu_percent.toFixed(1) + '%' : 'â€”' },
      { label: 'Memory',         val: formatMem(m.mem_total, m.mem_used) },
      { label: 'Load Average',   val: m.load_avg || (m.load_1 ? `${m.load_1} ${m.load_5} ${m.load_15}` : 'â€”') },
      { label: 'Uptime',         val: formatUptime(m.uptime_seconds || m.uptime) },
      { label: 'Daemon Version', val: m.version || 'â€”' },
    ];
    document.getElementById('sysInfoGrid').innerHTML = items.map(i => `
      <div style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:16px;">
        <div style="font-size:11px;color:rgba(255,255,255,0.35);text-transform:uppercase;letter-spacing:0.6px;margin-bottom:6px;">${esc(i.label)}</div>
        <div style="font-size:15px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${esc(String(i.val))}">${esc(String(i.val))}</div>
      </div>
    `).join('');
  } catch (e) {
    document.getElementById('sysInfoGrid').innerHTML =
      `<div style="color:rgba(255,255,255,0.3);grid-column:1/-1;padding:16px;">Failed to load system info</div>`;
  }
}

function formatMem(total, used) {
  if (!total) return 'â€”';
  const gb = v => (v / 1024 / 1024 / 1024).toFixed(1) + ' GB';
  if (used) return `${gb(used)} / ${gb(total)}`;
  return gb(total);
}

function formatUptime(secs) {
  if (!secs) return 'â€”';
  const s = parseInt(secs);
  const d = Math.floor(s / 86400);
  const h = Math.floor((s % 86400) / 3600);
  const m = Math.floor((s % 3600) / 60);
  if (d > 0) return `${d}d ${h}h ${m}m`;
  if (h > 0) return `${h}h ${m}m`;
  return `${m}m`;
}

function showResult(id, type, html) {
  const el = document.getElementById(id);
  el.style.display = 'block';
  el.className = 'result ' + type;
  el.innerHTML = html;
}

function esc(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

document.addEventListener('DOMContentLoaded', () => {
  loadSysInfo();
});
</script>
</body>
</html>
