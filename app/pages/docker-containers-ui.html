<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Containers - D-PlaneOS</title>
    <link rel="stylesheet" href="../assets/css/m3-tokens.css">
    <link rel="stylesheet" href="../assets/css/m3-components.css">
    <link rel="stylesheet" href="../assets/css/ui-components.css">
    <link rel="stylesheet" href="/assets/css/material-symbols-local.css">
    <style>
        :root {
            --surface-container: rgba(255,255,255,0.03);
            --surface-container-low: #0a0a0a;
            --surface-container-high: rgba(255,255,255,0.05);
            --primary: var(--primary, #8a9cff);
            --primary-container: #1f6feb;
            --on-surface: #e6edf3;
            --on-surface-variant: #8b949e;
            --outline: rgba(255,255,255,0.1);
            --success: #238636;
            --success-container: #2ea043;
            --warning: #d29922;
            --error: #da3633;
            --error-container: #f85149;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #0a0a0a;
            color: var(--on-surface);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--outline);
        }
        
        .page-header h1 {
            font-size: 28px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .page-header .material-symbols-rounded {
            font-size: 32px;
            color: var(--primary);
        }
        
        .header-actions {
            display: flex;
            gap: 12px;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }
        
        .btn-primary {
            background: var(--primary-container);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary);
        }
        
        .btn-secondary {
            background: var(--surface-container-high);
            color: var(--on-surface);
            border: 1px solid var(--outline);
        }
        
        .btn-secondary:hover {
            background: var(--surface-container);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: var(--surface-container);
            border: 1px solid var(--outline);
            border-radius: 12px;
            padding: 20px;
        }
        
        .stat-label {
            font-size: 13px;
            color: var(--on-surface-variant);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--on-surface);
            line-height: 1;
        }
        
        .stat-detail {
            font-size: 13px;
            color: var(--on-surface-variant);
            margin-top: 8px;
        }
        
        .view-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .view-toggle button {
            padding: 8px 16px;
            background: var(--surface-container);
            border: 1px solid var(--outline);
            border-radius: 6px;
            color: var(--on-surface-variant);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .view-toggle button.active {
            background: var(--primary-container);
            color: white;
            border-color: var(--primary-container);
        }
        
        .stack-section {
            margin-bottom: 24px;
        }
        
        .stack-header {
            background: var(--surface-container-high);
            border: 1px solid var(--outline);
            border-radius: 12px 12px 0 0;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .stack-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .stack-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background: var(--surface-container-low);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .container-table {
            background: var(--surface-container);
            border: 1px solid var(--outline);
            border-top: none;
            border-radius: 0 0 12px 12px;
            overflow: hidden;
        }
        
        .container-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .container-table thead {
            background: var(--surface-container-high);
        }
        
        .container-table th {
            text-align: left;
            padding: 12px 16px;
            font-size: 12px;
            font-weight: 600;
            color: var(--on-surface-variant);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--outline);
        }
        
        .container-table td {
            padding: 16px;
            border-bottom: 1px solid var(--outline);
            vertical-align: middle;
        }
        
        .container-table tr:last-child td {
            border-bottom: none;
        }
        
        .container-table tbody tr {
            transition: background 0.2s;
        }
        
        .container-table tbody tr:hover {
            background: var(--surface-container-low);
        }
        
        .container-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--on-surface);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .container-image {
            font-size: 12px;
            color: var(--on-surface-variant);
            font-family: 'Courier New', monospace;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-badge.running {
            background: var(--success);
            color: white;
        }
        
        .status-badge.exited {
            background: var(--error);
            color: white;
        }
        
        .status-badge.paused {
            background: var(--warning);
            color: white;
        }
        
        .status-badge.created {
            background: var(--surface-container-high);
            color: var(--on-surface-variant);
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }
        
        .health-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .health-badge.healthy {
            background: rgba(35, 134, 54, 0.2);
            color: #3fb950;
        }
        
        .health-badge.unhealthy {
            background: rgba(218, 54, 51, 0.2);
            color: #f85149;
        }
        
        .health-badge.starting {
            background: rgba(210, 153, 34, 0.2);
            color: #f0bb5e;
        }
        
        .ports-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .port-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: linear-gradient(135deg, var(--primary-container) 0%, #2563eb 100%);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        
        .port-link:hover {
            background: linear-gradient(135deg, var(--primary) 0%, #3b82f6 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(88, 166, 255, 0.3);
        }
        
        .port-link .material-symbols-rounded {
            font-size: 16px;
        }
        
        .port-info {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: var(--surface-container-low);
            border: 1px solid var(--outline);
            border-radius: 6px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            color: var(--on-surface-variant);
        }
        
        .resource-usage {
            font-size: 12px;
            color: var(--on-surface-variant);
        }
        
        .resource-bar {
            display: inline-block;
            width: 60px;
            height: 4px;
            background: var(--surface-container-low);
            border-radius: 2px;
            margin-left: 8px;
            vertical-align: middle;
            overflow: hidden;
        }
        
        .resource-bar-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s;
        }
        
        .resource-bar-fill.high {
            background: var(--error);
        }
        
        .resource-bar-fill.medium {
            background: var(--warning);
        }
        
        .uptime {
            font-size: 12px;
            color: var(--on-surface-variant);
        }
        
        .actions-menu {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 6px;
            background: transparent;
            border: 1px solid var(--outline);
            border-radius: 6px;
            color: var(--on-surface-variant);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .action-btn:hover {
            background: var(--surface-container-high);
            color: var(--primary);
        }
        
        .action-btn .material-symbols-rounded {
            font-size: 18px;
        }
        
        .empty-state {
            text-align: center;
            padding: 64px 24px;
            color: var(--on-surface-variant);
        }
        
        .empty-state .material-symbols-rounded {
            font-size: 64px;
            opacity: 0.5;
            margin-bottom: 16px;
        }
        
        .loading {
            text-align: center;
            padding: 48px;
            color: var(--on-surface-variant);
        }
        
        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--outline);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Permission issue banners — matches .warning-box design tokens */
        .perm-issues { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
        .perm-issue {
            display: flex; align-items: center; gap: 16px; padding: 16px 20px;
            background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px; animation: fadeIn 0.3s ease;
        }
        .perm-issue-icon { color: #F59E0B; font-size: 28px; flex-shrink: 0; }
        .perm-issue-body { flex: 1; min-width: 0; }
        .perm-issue-title { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
        .perm-issue-detail { font-size: 13px; color: rgba(255,255,255,0.6); line-height: 1.4; }
        .perm-issue-path { font-family: 'Consolas', 'Monaco', monospace; color: #F59E0B; font-size: 12px; }
        .perm-issue-actions { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
        .perm-issue-actions a, .perm-issue-actions button {
            font-size: 12px; padding: 6px 14px; border-radius: 8px; cursor: pointer;
            text-decoration: none; border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.9);
            display: inline-flex; align-items: center; gap: 6px; transition: background 0.15s;
        }
        .perm-issue-actions a:hover, .perm-issue-actions button:hover { background: rgba(255,255,255,0.1); }
        .perm-issue-dismiss {
            background: none !important; border: none !important; color: rgba(255,255,255,0.4);
            font-size: 20px; padding: 4px 8px !important; cursor: pointer; flex-shrink: 0;
        }
        .perm-issue-dismiss:hover { color: rgba(255,255,255,0.8); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
    </style>
  <link rel="stylesheet" href="/assets/css/ui-consistency.css">
  <script src="/assets/js/daemon-api.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="page-header">
            <h1>
                <span class="material-symbols-rounded">deployed_code</span>
                Containers
            </h1>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="refreshContainers()">
                    <span class="material-symbols-rounded" style="font-size: 18px;">refresh</span>
                    Refresh
                </button>
                <a href="docker-pull-ui.html" class="btn btn-primary">
                    <span class="material-symbols-rounded" style="font-size: 18px;">download</span>
                    Pull Image
                </a>
            </div>
        </div>
        
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Containers</div>
                <div class="stat-value" id="totalContainers">-</div>
                <div class="stat-detail" id="containerDetail">Loading...</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Running</div>
                <div class="stat-value" id="runningContainers" style="color: var(--success);">-</div>
                <div class="stat-detail" id="runningDetail">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Stacks</div>
                <div class="stat-value" id="totalStacks">-</div>
                <div class="stat-detail" id="stacksDetail">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Exposed Ports</div>
                <div class="stat-value" id="totalPorts">-</div>
                <div class="stat-detail" id="portsDetail">-</div>
            </div>
        </div>
        
        <!-- View Toggle -->
        <div class="view-toggle">
            <button class="active" onclick="switchView('grouped')">
                <span class="material-symbols-rounded" style="font-size: 16px; vertical-align: middle;">folder</span>
                Group by Stack
            </button>
            <button onclick="switchView('list')">
                <span class="material-symbols-rounded" style="font-size: 16px; vertical-align: middle;">list</span>
                List View
            </button>
        </div>
        
        <!-- Permission Issues (populated dynamically) -->
        <div id="permIssues" class="perm-issues"></div>
        
        <!-- Container List -->
        <div id="containerList">
            <div class="loading">
                <div class="spinner"></div>
                <div>Loading containers...</div>
            </div>
        </div>
    </div>
    
    <script>
        let currentView = 'grouped';
        let containers = [];
        let refreshInterval = null;
        
        async function refreshContainers() {
            try {
                const endpoint = currentView === 'grouped' 
                    ? '/api/docker/containers'
                    : '/api/docker/containers';
                
                const response = await fetch(endpoint);
                const data = await response.json();
                
                if (data.success) {
                    // Extract flat container list for permission checking
                    var allContainers = [];
                    if (currentView === 'grouped') {
                        renderGroupedView(data.stacks);
                        updateStats({
                            total: data.total_containers,
                            stacks: data.total_stacks
                        });
                        (data.stacks || []).forEach(function(s) {
                            (s.containers || []).forEach(function(c) { allContainers.push(c); });
                        });
                    } else {
                        containers = data.containers;
                        renderListView(data.containers);
                        updateStats({
                            total: data.count
                        });
                        allContainers = data.containers || [];
                    }
                    
                    // Check exited containers for permission issues (non-blocking)
                    if (allContainers.length > 0) {
                        checkPermissionIssues(allContainers);
                    }
                } else {
                    showError(data.error);
                }
            } catch (error) {
                showError('Failed to load containers: ' + error.message);
            }
        }
        
        function updateStats(data) {
            const totalEl = document.getElementById('totalContainers');
            const runningEl = document.getElementById('runningContainers');
            const stacksEl = document.getElementById('totalStacks');
            const portsEl = document.getElementById('totalPorts');
            
            if (data.total !== undefined) {
                totalEl.textContent = data.total;
            }
            
            if (data.stacks !== undefined) {
                stacksEl.textContent = data.stacks;
            }
            
            // Calculate running containers and total ports
            let running = 0;
            let totalPorts = 0;
            
            if (currentView === 'grouped' && window.stacksData) {
                window.stacksData.forEach(stack => {
                    running += stack.running_containers;
                    totalPorts += stack.total_ports;
                });
            } else if (containers.length > 0) {
                running = containers.filter(c => c.state === 'running').length;
                totalPorts = containers.reduce((sum, c) => sum + c.ports.length, 0);
            }
            
            runningEl.textContent = running;
            portsEl.textContent = totalPorts;
            
            document.getElementById('containerDetail').textContent = 
                `${data.total || containers.length} containers managed`;
            document.getElementById('runningDetail').textContent = 
                `${running} active`;
            document.getElementById('stacksDetail').textContent = 
                data.stacks ? `${data.stacks} compose projects` : '-';
            document.getElementById('portsDetail').textContent = 
                `${totalPorts} web services`;
        }
        
        function renderGroupedView(stacks) {
            window.stacksData = stacks;
            const container = document.getElementById('containerList');
            
            if (stacks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="material-symbols-rounded">deployed_code</span>
                        <h3>No containers found</h3>
                        <p>Pull an image to get started</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            stacks.forEach(stack => {
                const stackName = stack.name || 'Standalone Containers';
                const isStandalone = !stack.name;
                
                html += `
                    <div class="stack-section">
                        <div class="stack-header">
                            <div class="stack-title">
                                <span class="material-symbols-rounded">
                                    ${isStandalone ? 'deployed_code' : 'folder'}
                                </span>
                                ${stackName}
                                <span class="stack-badge">
                                    <span>${stack.running_containers} / ${stack.total_containers}</span>
                                    <span style="opacity: 0.6;">running</span>
                                </span>
                            </div>
                        </div>
                        <div class="container-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Container</th>
                                        <th>Status</th>
                                        <th>Ports & Web Access</th>
                                        <th>Resources</th>
                                        <th>Uptime</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${stack.containers.map(c => renderContainerRow(c)).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function renderListView(containers) {
            const container = document.getElementById('containerList');
            
            if (containers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="material-symbols-rounded">deployed_code</span>
                        <h3>No containers found</h3>
                        <p>Pull an image to get started</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="container-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Container</th>
                                <th>Status</th>
                                <th>Ports & Web Access</th>
                                <th>Resources</th>
                                <th>Uptime</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${containers.map(c => renderContainerRow(c)).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function renderContainerRow(container) {
            const healthBadge = container.health ? `
                <span class="health-badge ${container.health}">
                    <span class="material-symbols-rounded" style="font-size: 12px;">
                        ${container.health === 'healthy' ? 'check_circle' : 
                          container.health === 'unhealthy' ? 'error' : 'pending'}
                    </span>
                    ${container.health}
                </span>
            ` : '';
            
            const portsHtml = renderPorts(container);
            const resourcesHtml = renderResources(container.resources);
            
            return `
                <tr>
                    <td>
                        <div class="container-name">${container.name}</div>
                        <div class="container-image">${container.image}</div>
                    </td>
                    <td>
                        <div class="status-badge ${container.state}">
                            <span class="status-indicator"></span>
                            ${container.state}
                        </div>
                        ${healthBadge}
                    </td>
                    <td>${portsHtml}</td>
                    <td>${resourcesHtml}</td>
                    <td>
                        <div class="uptime">${container.uptime || '-'}</div>
                    </td>
                    <td>
                        <div class="actions-menu">
                            <button class="action-btn" title="Logs">
                                <span class="material-symbols-rounded">description</span>
                            </button>
                            <button class="action-btn" title="Terminal">
                                <span class="material-symbols-rounded">terminal</span>
                            </button>
                            <button class="action-btn" title="Restart">
                                <span class="material-symbols-rounded">restart_alt</span>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }
        
        function renderPorts(container) {
            if (!container.web_links || container.web_links.length === 0) {
                if (container.ports && container.ports.length > 0) {
                    return container.ports.map(p => `
                        <span class="port-info">
                            ${p.host_port}:${p.container_port}/${p.protocol}
                        </span>
                    `).join(' ');
                }
                return '<span style="color: var(--on-surface-variant);">No ports</span>';
            }
            
            return `
                <div class="ports-container">
                    ${container.web_links.map(link => `
                        <a href="${link.url}" target="_blank" class="port-link">
                            <span class="material-symbols-rounded">open_in_new</span>
                            ${link.label}
                        </a>
                    `).join('')}
                    ${container.ports.filter(p => 
                        !container.web_links.some(l => l.port === p.host_port)
                    ).map(p => `
                        <span class="port-info">
                            ${p.host_port}:${p.container_port}/${p.protocol}
                        </span>
                    `).join('')}
                </div>
            `;
        }
        
        function renderResources(stats) {
            if (!stats) {
                return '<span style="color: var(--on-surface-variant);">-</span>';
            }
            
            const cpuClass = stats.cpu_percent > 80 ? 'high' : stats.cpu_percent > 50 ? 'medium' : '';
            const memClass = stats.mem_percent > 80 ? 'high' : stats.mem_percent > 50 ? 'medium' : '';
            
            return `
                <div class="resource-usage">
                    <div>CPU: ${stats.cpu_percent.toFixed(1)}%
                        <span class="resource-bar">
                            <span class="resource-bar-fill ${cpuClass}" style="width: ${Math.min(stats.cpu_percent, 100)}%"></span>
                        </span>
                    </div>
                    <div>MEM: ${stats.mem_used}
                        <span class="resource-bar">
                            <span class="resource-bar-fill ${memClass}" style="width: ${Math.min(stats.mem_percent, 100)}%"></span>
                        </span>
                    </div>
                </div>
            `;
        }
        
        function switchView(view) {
            currentView = view;
            
            // Update button states
            document.querySelectorAll('.view-toggle button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('button').classList.add('active');
            
            refreshContainers();
        }
        
        function showError(message) {
            const container = document.getElementById('containerList');
            container.innerHTML = `
                <div class="empty-state">
                    <span class="material-symbols-rounded" style="color: var(--error);">error</span>
                    <h3>Error Loading Containers</h3>
                    <p>${message}</p>
                </div>
            `;
        }
        
        // Auto-refresh every 5 seconds
        function startAutoRefresh() {
            refreshInterval = setInterval(refreshContainers, 5000);
        }
        
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }
        
        // ===== PERMISSION ISSUE DETECTION =====
        const checkedContainers = new Set();
        const activeIssues = new Map();
        
        async function checkPermissionIssues(allContainers) {
            for (const c of allContainers) {
                if (checkedContainers.has(c.name)) continue;
                if (c.state === 'running' || c.state === 'created') continue;
                
                // Only check exited containers — mark as checked immediately to avoid re-checking
                checkedContainers.add(c.name);
                
                // Fetch logs (fire-and-forget, don't block UI)
                fetchAndCheckLogs(c.name, c.image);
            }
            
            // If a previously-alerted container is now running, remove the banner
            for (const [name] of activeIssues) {
                const c = allContainers.find(x => x.name === name);
                if (c && c.state === 'running') {
                    dismissPermIssue(name);
                    checkedContainers.delete(name); // Allow re-check if it exits again
                }
            }
        }
        
        async function fetchAndCheckLogs(name, image) {
            try {
                const resp = await fetch('/api/docker/logs?container=' + encodeURIComponent(name));
                const data = await resp.json();
                if (!data.success || !data.logs) return;
                
                const logs = data.logs;
                const permPatterns = [
                    /permission denied/i,
                    /EACCES/,
                    /operation not permitted/i,
                    /read.only file system/i
                ];
                
                if (!permPatterns.some(p => p.test(logs))) return;
                
                // Extract container-internal path from error
                var detectedPath = null;
                var pathPatterns = [
                    /(?:open|stat|mkdir|chown|access|touch|write)\s+['"]?([/][^\s'",:)\]]+)/i,
                    /Permission denied:\s*'([/][^']+)'/i,
                    /EACCES[^/]*([/][^\s'",:)\]]+)/
                ];
                for (var i = 0; i < pathPatterns.length; i++) {
                    var m = logs.match(pathPatterns[i]);
                    if (m) { detectedPath = m[1]; break; }
                }
                
                showPermBanner(name, image, detectedPath, logs);
            } catch (e) { /* silent - log fetch failed, no big deal */ }
        }
        
        function showPermBanner(name, image, containerPath, logs) {
            activeIssues.set(name, { image: image, path: containerPath });
            renderPermBanners();
        }
        
        function dismissPermIssue(name) {
            activeIssues.delete(name);
            renderPermBanners();
        }
        
        function viewPermLogs(name) {
            var safeName = name.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
            fetch('/api/docker/logs?container=' + encodeURIComponent(name))
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (!data.success) return;
                    var pre = document.createElement('div');
                    pre.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:9999;';
                    pre.innerHTML = '<div style="background:rgba(30,41,59,0.98);border:1px solid rgba(255,255,255,0.1);border-radius:16px;max-width:800px;width:90%;max-height:80vh;display:flex;flex-direction:column;backdrop-filter:blur(10px);">'
                        + '<div style="padding:16px 20px;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;justify-content:space-between;align-items:center;">'
                        + '<span style="font-weight:600;">Logs: ' + safeName + '</span>'
                        + '<button onclick="this.closest(\'div[style*=fixed]\').remove()" style="background:none;border:none;color:rgba(255,255,255,0.6);font-size:24px;cursor:pointer;">&times;</button></div>'
                        + '<pre style="padding:16px 20px;overflow:auto;font-family:Consolas,Monaco,monospace;font-size:12px;line-height:1.5;margin:0;color:rgba(255,255,255,0.8);flex:1;white-space:pre-wrap;word-break:break-all;">'
                        + data.logs.replace(/</g, '&lt;').replace(/(permission denied|EACCES|operation not permitted|read.only file system)/gi, '<span style="color:#EF4444;font-weight:600;">$1</span>')
                        + '</pre></div>';
                    pre.addEventListener('click', function(e) { if (e.target === pre) pre.remove(); });
                    document.body.appendChild(pre);
                });
        }
        
        function renderPermBanners() {
            var el = document.getElementById('permIssues');
            if (!el) return;
            if (activeIssues.size === 0) { el.innerHTML = ''; return; }
            
            function esc(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
            
            var html = '';
            activeIssues.forEach(function(info, name) {
                var safeName = esc(name);
                var safeImage = esc((info.image || '').split(':')[0]);
                var safePath = info.path ? esc(info.path) : '';
                var jsName = name.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                var pathLine = safePath
                    ? '<div class="perm-issue-path">Container path: ' + safePath + '</div>'
                    : '';
                html += '<div class="perm-issue" data-container="' + safeName + '">'
                    + '<span class="material-symbols-rounded perm-issue-icon">warning</span>'
                    + '<div class="perm-issue-body">'
                    + '<div class="perm-issue-title">Permission issue — ' + safeName + '</div>'
                    + '<div class="perm-issue-detail">'
                    + 'Container <strong>' + safeName + '</strong> (' + safeImage + ') exited with file permission errors.'
                    + pathLine
                    + '</div>'
                    + '<div class="perm-issue-actions">'
                    + '<button onclick="viewPermLogs(\'' + jsName + '\')">'
                    + '<span class="material-symbols-rounded" style="font-size:14px;">description</span> View Logs</button>'
                    + '<a href="files.html?path=/mnt/" target="_self">'
                    + '<span class="material-symbols-rounded" style="font-size:14px;">folder_open</span> Open File Browser</a>'
                    + '<a href="pools.html" target="_self">'
                    + '<span class="material-symbols-rounded" style="font-size:14px;">database</span> Manage Datasets</a>'
                    + '</div>'
                    + '</div>'
                    + '<button class="perm-issue-dismiss" onclick="dismissPermIssue(\'' + jsName + '\')" title="Dismiss">&times;</button>'
                    + '</div>';
            });
            el.innerHTML = html;
        }
        
        // Initialize
        refreshContainers();
        startAutoRefresh();
        
        // Stop refresh when page is hidden
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                startAutoRefresh();
            }
        });
    </script>
<script src="/assets/js/docker-icons.js"></script>
</body>
</html>
