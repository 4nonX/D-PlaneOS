<!DOCTYPE html>
<html lang="en">
<head>
<style>html{background:#080c14}</style>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Git Sync — D-PlaneOS</title>
<link rel="stylesheet" href="/assets/css/design-tokens.css">
<link rel="stylesheet" href="/assets/css/m3-tokens.css">
<link rel="stylesheet" href="/assets/css/m3-components.css">
<link rel="stylesheet" href="/assets/css/m3-icons.css">
<link rel="stylesheet" href="/assets/css/enhanced-ui.css">
<link rel="stylesheet" href="/assets/css/material-symbols-local.css">
<link rel="stylesheet" href="/assets/css/ui-components.css">
<link rel="stylesheet" href="/assets/css/ui-consistency.css">
<link rel="stylesheet" href="/assets/css/ui-polish.css">
<script src="/assets/js/core.js"></script>
<script src="/assets/js/nav-flyout.js"></script>
<script src="/assets/js/enhanced-ui.js"></script>
<script src="/assets/js/connection-monitor.js"></script>
<script src="/assets/js/daemon-api.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'JetBrains Mono',ui-monospace,'Cascadia Code',monospace;background:#080c14;color:#e2e8f0;min-height:100vh;overflow-x:hidden}
:root{--accent:#3b82f6;--accent2:#8b5cf6;--green:#22c55e;--amber:#f59e0b;--red:#ef4444;--surface:rgba(255,255,255,0.03);--border:rgba(255,255,255,0.07);--text-muted:rgba(255,255,255,0.4)}

/* Nav */
.nav{position:fixed;top:0;left:0;right:0;z-index:100;background:rgba(8,12,20,0.92);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 32px;height:64px;gap:24px}
.nav-logo{font-size:16px;font-weight:700;color:#fff;letter-spacing:-0.5px;cursor:pointer;font-family:'JetBrains Mono',monospace}
.nav-logo span{color:var(--accent)}
.nav-links{display:flex;gap:4px;margin-left:16px}
.nav-link{font-size:13px;color:rgba(255,255,255,0.5);padding:6px 12px;border-radius:8px;cursor:pointer;text-decoration:none;transition:all 0.2s;font-family:inherit}
.nav-link:hover,.nav-link.active{color:#fff;background:rgba(255,255,255,0.07)}
.nav-spacer{flex:1}
.nav-user{display:flex;align-items:center;gap:12px;font-size:13px;color:rgba(255,255,255,0.5)}
.btn-logout{background:none;border:1px solid var(--border);color:rgba(255,255,255,0.4);padding:6px 12px;border-radius:8px;cursor:pointer;font-size:12px;font-family:inherit;transition:all 0.2s}
.btn-logout:hover{border-color:var(--red);color:var(--red)}

/* Layout */
.main{max-width:1400px;margin:0 auto;padding:96px 32px 64px}
.page-header{margin-bottom:40px;display:flex;align-items:flex-start;justify-content:space-between;gap:16px}
.page-title{font-size:28px;font-weight:700;letter-spacing:-1px;display:flex;align-items:center;gap:12px}
.page-title .icon{width:40px;height:40px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px}
.page-subtitle{font-size:14px;color:var(--text-muted);margin-top:6px;font-family:'JetBrains Mono',monospace}

/* Tabs */
.tabs{display:flex;gap:2px;background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:12px;padding:4px;margin-bottom:32px;width:fit-content}
.tab{padding:8px 20px;border-radius:9px;cursor:pointer;font-size:13px;color:var(--text-muted);transition:all 0.2s;border:none;background:none;color:inherit;font-family:inherit;display:flex;align-items:center;gap:8px}
.tab:hover{color:#fff;background:rgba(255,255,255,0.05)}
.tab.active{background:var(--accent);color:#fff;font-weight:600}
.tab-badge{background:rgba(255,255,255,0.2);border-radius:4px;padding:1px 6px;font-size:11px}

/* Cards */
.card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px;transition:border-color 0.2s}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.card-title{font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px}
.card-title .material-symbols-rounded{font-size:18px;color:var(--accent)}

/* Repo cards */
.repo-grid{display:grid;gap:16px}
.repo-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:20px;position:relative;overflow:hidden;transition:all 0.2s}
.repo-card:hover{border-color:rgba(59,130,246,0.3)}
.repo-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent),var(--accent2));opacity:0;transition:opacity 0.2s}
.repo-card:hover::before{opacity:1}
.repo-card-header{display:flex;align-items:center;gap:14px;margin-bottom:14px}
.repo-icon{width:40px;height:40px;background:linear-gradient(135deg,rgba(59,130,246,0.15),rgba(139,92,246,0.15));border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.repo-icon .material-symbols-rounded{font-size:20px;color:var(--accent)}
.repo-name{font-size:16px;font-weight:700;letter-spacing:-0.3px}
.repo-url{font-size:12px;color:var(--text-muted);margin-top:2px;font-family:'JetBrains Mono',monospace;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:320px}
.repo-meta{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px}
.meta-pill{display:flex;align-items:center;gap:5px;font-size:12px;color:var(--text-muted);background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:6px;padding:3px 10px}
.meta-pill .material-symbols-rounded{font-size:14px}
.meta-pill.active{color:var(--green);border-color:rgba(34,197,94,0.2);background:rgba(34,197,94,0.06)}
.meta-pill.error{color:var(--red);border-color:rgba(239,68,68,0.2);background:rgba(239,68,68,0.06)}
.repo-actions{display:flex;gap:8px;flex-wrap:wrap}
.repo-status{font-size:12px;color:var(--text-muted);font-family:'JetBrains Mono',monospace;margin-bottom:12px;display:flex;align-items:center;gap:6px}
.repo-status .commit{color:var(--accent);font-weight:600}
.last-sync{color:var(--text-muted);font-size:11px}
.last-error{color:var(--red);font-size:12px;margin-top:8px;background:rgba(239,68,68,0.06);border:1px solid rgba(239,68,68,0.15);border-radius:8px;padding:8px 12px;font-family:'JetBrains Mono',monospace;word-break:break-word}

/* Credentials */
.cred-grid{display:grid;gap:12px}
.cred-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;display:flex;align-items:center;gap:16px;transition:all 0.2s}
.cred-card:hover{border-color:rgba(59,130,246,0.3)}
.cred-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.cred-icon.token{background:rgba(34,197,94,0.1);color:var(--green)}
.cred-icon.ssh{background:rgba(139,92,246,0.1);color:var(--accent2)}
.cred-icon .material-symbols-rounded{font-size:20px}
.cred-info{flex:1;min-width:0}
.cred-name{font-size:14px;font-weight:700}
.cred-meta{font-size:12px;color:var(--text-muted);margin-top:2px}
.cred-actions{display:flex;gap:8px}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:7px;padding:9px 18px;border-radius:9px;font-size:13px;font-weight:600;cursor:pointer;border:none;font-family:inherit;transition:all 0.2s;text-decoration:none;white-space:nowrap}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{background:#2563eb;box-shadow:0 4px 16px rgba(59,130,246,0.35)}
.btn-secondary{background:rgba(255,255,255,0.07);color:#fff;border:1px solid var(--border)}
.btn-secondary:hover{background:rgba(255,255,255,0.12)}
.btn-success{background:rgba(34,197,94,0.15);color:var(--green);border:1px solid rgba(34,197,94,0.2)}
.btn-success:hover{background:rgba(34,197,94,0.25)}
.btn-danger{background:rgba(239,68,68,0.1);color:var(--red);border:1px solid rgba(239,68,68,0.2)}
.btn-danger:hover{background:rgba(239,68,68,0.2)}
.btn-sm{padding:6px 12px;font-size:12px;border-radius:7px}
.btn-icon{width:34px;height:34px;padding:0;justify-content:center}
.btn .material-symbols-rounded{font-size:16px}
.btn:disabled{opacity:0.4;cursor:not-allowed}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);z-index:1000;display:flex;align-items:center;justify-content:center;padding:24px}
.modal{background:#0f1623;border:1px solid var(--border);border-radius:20px;padding:32px;width:100%;max-width:600px;max-height:90vh;overflow-y:auto}
.modal-title{font-size:20px;font-weight:700;letter-spacing:-0.5px;margin-bottom:24px;display:flex;align-items:center;gap:10px}
.modal-title .material-symbols-rounded{color:var(--accent);font-size:22px}
.modal-footer{display:flex;gap:12px;justify-content:flex-end;margin-top:28px;padding-top:24px;border-top:1px solid var(--border)}

/* Forms */
.form-group{margin-bottom:18px}
.form-label{display:block;font-size:12px;font-weight:600;color:rgba(255,255,255,0.6);margin-bottom:7px;text-transform:uppercase;letter-spacing:0.5px}
.form-input,.form-select,.form-textarea{width:100%;background:rgba(0,0,0,0.3);border:1px solid var(--border);border-radius:10px;padding:11px 14px;color:#e2e8f0;font-size:14px;font-family:inherit;transition:border-color 0.2s;outline:none}
.form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--accent)}
.form-textarea{min-height:100px;resize:vertical;font-family:'JetBrains Mono',monospace;font-size:13px}
.form-hint{font-size:11px;color:var(--text-muted);margin-top:5px;line-height:1.5}
.form-hint a{color:var(--accent);text-decoration:none}
.form-hint a:hover{text-decoration:underline}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.form-toggle{display:flex;align-items:center;gap:10px;cursor:pointer}
.form-toggle input[type=checkbox]{width:16px;height:16px;accent-color:var(--accent)}

/* PAT Wizard */
.pat-wizard{background:rgba(59,130,246,0.06);border:1px solid rgba(59,130,246,0.2);border-radius:12px;padding:16px;margin-bottom:16px}
.pat-wizard-title{font-size:13px;font-weight:700;color:var(--accent);margin-bottom:10px;display:flex;align-items:center;gap:6px}
.pat-wizard-title .material-symbols-rounded{font-size:16px}
.pat-steps{display:flex;flex-direction:column;gap:6px}
.pat-step{font-size:12px;color:rgba(255,255,255,0.6);display:flex;align-items:flex-start;gap:8px;line-height:1.5}
.pat-step-num{width:18px;height:18px;background:var(--accent);border-radius:50%;font-size:11px;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px}
.pat-step a{color:var(--accent);text-decoration:none}
.pat-step a:hover{text-decoration:underline}
.scope-badge{display:inline-flex;align-items:center;gap:3px;background:rgba(34,197,94,0.1);color:var(--green);border:1px solid rgba(34,197,94,0.2);border-radius:5px;padding:1px 7px;font-size:11px;font-weight:600;font-family:'JetBrains Mono',monospace}

/* Empty state */
.empty-state{text-align:center;padding:60px 24px;color:var(--text-muted)}
.empty-state .material-symbols-rounded{font-size:48px;opacity:0.3;display:block;margin-bottom:12px}
.empty-state h3{font-size:16px;color:rgba(255,255,255,0.5);margin-bottom:6px}
.empty-state p{font-size:13px}

/* Loading */
.loading{display:flex;align-items:center;justify-content:center;padding:40px;gap:10px;color:var(--text-muted);font-size:14px}
.spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.7s linear infinite;flex-shrink:0}
@keyframes spin{to{transform:rotate(360deg)}}

/* YAML Preview */
.yaml-block{background:rgba(0,0,0,0.4);border:1px solid var(--border);border-radius:10px;padding:14px;font-family:'JetBrains Mono',monospace;font-size:12px;color:#4ade80;white-space:pre;overflow-x:auto;max-height:280px;overflow-y:auto;line-height:1.5}

/* Notification dot */
.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;flex-shrink:0}
.status-dot.online{background:var(--green);box-shadow:0 0 6px rgba(34,197,94,0.5)}
.status-dot.offline{background:var(--text-muted)}
.status-dot.syncing{background:var(--accent);animation:pulse 1s ease-in-out infinite}
.status-dot.error{background:var(--red)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}

/* Divider */
.section-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin:24px 0 14px;display:flex;align-items:center;gap:8px}
.section-label::after{content:'';flex:1;height:1px;background:var(--border)}
</style>
</head>
<body>

<nav class="nav">
  <div class="nav-logo" onclick="window.location.href='index.html'">D-<span>Plane</span>OS</div>
  <div class="nav-links">
    <a class="nav-link" href="index.html">Dashboard</a>
    <a class="nav-link" href="pools.html">Storage</a>
    <a class="nav-link" href="docker.html">Docker</a>
    <a class="nav-link active" href="git-sync.html">Git Sync</a>
    <a class="nav-link" href="settings.html">Settings</a>
  </div>
  <div class="nav-spacer"></div>
  <div class="nav-user">
    <span id="currentUser">—</span>
    <button class="btn-logout" onclick="handleLogout()"><span class="material-symbols-rounded" style="font-size:14px;vertical-align:middle;">logout</span> Logout</button>
  </div>
</nav>

<main class="main">
  <div class="page-header">
    <div>
      <div class="page-title">
        <div class="icon"><span class="material-symbols-rounded">sync_alt</span></div>
        Git Sync
      </div>
      <div class="page-subtitle">Bidirectional Docker Compose ↔ GitHub/Gitea backup &amp; deployment</div>
    </div>
    <div style="display:flex;gap:10px">
      <button class="btn btn-secondary" onclick="openAddRepoModal()">
        <span class="material-symbols-rounded">add</span> Add Sync
      </button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" onclick="switchTab('repos',this)" id="tab-repos">
      <span class="material-symbols-rounded" style="font-size:16px">hub</span>
      Syncs <span class="tab-badge" id="repos-count">0</span>
    </button>
    <button class="tab" onclick="switchTab('credentials',this)" id="tab-creds">
      <span class="material-symbols-rounded" style="font-size:16px">key</span>
      Credentials <span class="tab-badge" id="creds-count">0</span>
    </button>
    <button class="tab" onclick="switchTab('legacy',this)" id="tab-legacy">
      <span class="material-symbols-rounded" style="font-size:16px">settings</span>
      Legacy Config
    </button>
  </div>

  <!-- Repos Panel -->
  <div id="panel-repos">
    <div id="repos-container"><div class="loading"><div class="spinner"></div> Loading syncs…</div></div>
  </div>

  <!-- Credentials Panel -->
  <div id="panel-credentials" style="display:none">
    <div class="card" style="margin-bottom:20px">
      <div class="card-header">
        <div class="card-title">
          <span class="material-symbols-rounded">key</span>
          Git Credentials
        </div>
        <button class="btn btn-primary btn-sm" onclick="openAddCredModal()">
          <span class="material-symbols-rounded">add</span> Add Credential
        </button>
      </div>
      <p style="font-size:13px;color:var(--text-muted);margin-bottom:16px">
        Store GitHub/Gitea Personal Access Tokens or SSH keys here. Reference them when adding a sync — tokens are never sent back to the browser after saving.
      </p>
      <div id="creds-container"><div class="loading"><div class="spinner"></div> Loading…</div></div>
    </div>
  </div>

  <!-- Legacy Config Panel -->
  <div id="panel-legacy" style="display:none">
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <span class="material-symbols-rounded">settings</span>
          Legacy Single-Repo Config
        </div>
      </div>
      <p style="font-size:13px;color:var(--amber);margin-bottom:16px">
        ⚠️ This is the original single-repo configuration. Use the Syncs tab for multi-repo management.
      </p>
      <div id="legacy-status" style="font-size:13px;color:var(--text-muted)">Loading…</div>
    </div>
  </div>
</main>

<!-- ══════════════════════════════════════════ -->
<!--  MODAL: Add/Edit Sync                      -->
<!-- ══════════════════════════════════════════ -->
<div class="modal-overlay" id="modal-repo" style="display:none" onclick="if(event.target===this)closeModal('modal-repo')">
  <div class="modal">
    <div class="modal-title">
      <span class="material-symbols-rounded">hub</span>
      <span id="modal-repo-title">Add Git Sync</span>
    </div>

    <input type="hidden" id="repo-edit-id">

    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Sync Name</label>
        <input type="text" class="form-input" id="repo-name" placeholder="my-homelab-stacks">
        <div class="form-hint">Unique label — used as local directory name</div>
      </div>
      <div class="form-group">
        <label class="form-label">Branch</label>
        <input type="text" class="form-input" id="repo-branch" value="main">
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Repository URL</label>
      <input type="text" class="form-input" id="repo-url" placeholder="https://github.com/you/repo.git">
      <div class="form-hint">HTTPS: <code>https://github.com/user/repo.git</code> &nbsp;·&nbsp; SSH: <code>git@github.com:user/repo.git</code></div>
    </div>

    <div class="form-group">
      <label class="form-label">Compose File Path <span style="font-weight:400;color:var(--text-muted)">(relative to repo root)</span></label>
      <input type="text" class="form-input" id="repo-compose" value="docker-compose.yml">
      <div class="form-hint">e.g. <code>stacks/nextcloud/compose.yml</code> — use the file browser icon in Arcane style</div>
    </div>

    <div class="form-group">
      <label class="form-label">Credential</label>
      <select class="form-select" id="repo-cred">
        <option value="">None (public repo)</option>
      </select>
      <div class="form-hint">Select a saved credential, or <a href="#" onclick="closeModal('modal-repo');openAddCredModal();return false">add one first</a></div>
    </div>

    <div class="section-label">Commit Identity</div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Author Name</label>
        <input type="text" class="form-input" id="repo-commit-name" value="D-PlaneOS">
      </div>
      <div class="form-group">
        <label class="form-label">Author Email</label>
        <input type="text" class="form-input" id="repo-commit-email" value="dplaneos@localhost">
      </div>
    </div>

    <div class="section-label">Auto Sync</div>
    <div class="form-group">
      <label class="form-toggle">
        <input type="checkbox" id="repo-autosync">
        <span style="font-size:13px">Enable Auto Sync (pull periodically)</span>
      </label>
    </div>
    <div class="form-group" id="interval-group" style="display:none">
      <label class="form-label">Sync Interval (minutes)</label>
      <input type="number" class="form-input" id="repo-interval" value="5" min="1" max="1440">
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-repo')">Cancel</button>
      <button class="btn btn-primary" onclick="saveRepo()">
        <span class="material-symbols-rounded">save</span> Save Sync
      </button>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════ -->
<!--  MODAL: Add Credential                     -->
<!-- ══════════════════════════════════════════ -->
<div class="modal-overlay" id="modal-cred" style="display:none" onclick="if(event.target===this)closeModal('modal-cred')">
  <div class="modal">
    <div class="modal-title">
      <span class="material-symbols-rounded">key</span>
      Add Credential
    </div>

    <input type="hidden" id="cred-edit-id">

    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Name</label>
        <input type="text" class="form-input" id="cred-name" placeholder="my-github-pat">
      </div>
      <div class="form-group">
        <label class="form-label">Host</label>
        <input type="text" class="form-input" id="cred-host" value="github.com">
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Auth Type</label>
      <select class="form-select" id="cred-type" onchange="toggleCredFields()">
        <option value="token">Personal Access Token (PAT)</option>
        <option value="ssh">SSH Key</option>
      </select>
    </div>

    <!-- PAT Wizard -->
    <div id="pat-wizard-block">
      <div class="pat-wizard">
        <div class="pat-wizard-title">
          <span class="material-symbols-rounded">auto_awesome</span>
          How to create a GitHub PAT
        </div>
        <div class="pat-steps">
          <div class="pat-step">
            <div class="pat-step-num">1</div>
            <div>Go to <a href="https://github.com/settings/tokens?type=beta" target="_blank">GitHub → Settings → Developer settings → Fine-grained tokens</a> (or <a href="https://github.com/settings/tokens" target="_blank">Classic tokens</a>)</div>
          </div>
          <div class="pat-step">
            <div class="pat-step-num">2</div>
            <div>Click <strong>Generate new token</strong>. Set a name, expiry, and select the repository.</div>
          </div>
          <div class="pat-step">
            <div class="pat-step-num">3</div>
            <div>Required scopes for private repos: <span class="scope-badge">repo</span> (classic) or <span class="scope-badge">Contents: Read &amp; Write</span> + <span class="scope-badge">Metadata: Read</span> (fine-grained)</div>
          </div>
          <div class="pat-step">
            <div class="pat-step-num">4</div>
            <div>Copy the token — it's only shown once. Paste it below. D-PlaneOS stores it encrypted and never returns it to the browser.</div>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Personal Access Token</label>
        <input type="password" class="form-input" id="cred-token" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
        <div class="form-hint" id="cred-token-hint">Token is stored server-side and masked after saving.</div>
      </div>
    </div>

    <!-- SSH block -->
    <div id="ssh-block" style="display:none">
      <div class="form-group">
        <label class="form-label">Private SSH Key</label>
        <textarea class="form-textarea" id="cred-ssh" placeholder="-----BEGIN OPENSSH PRIVATE KEY-----
...
-----END OPENSSH PRIVATE KEY-----"></textarea>
        <div class="form-hint">Paste your private key. The corresponding public key must be added to your GitHub/Gitea account under <a href="https://github.com/settings/keys" target="_blank">Settings → SSH keys</a>.</div>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Notes (optional)</label>
      <input type="text" class="form-input" id="cred-notes" placeholder="e.g. expires 2027-01, homelab repo access">
    </div>

    <div class="form-group" id="test-block" style="display:none">
      <div class="section-label">Test Connection</div>
      <div style="display:flex;gap:10px;align-items:center">
        <input type="text" class="form-input" id="test-repo-url" placeholder="https://github.com/you/repo.git (to test against)">
        <button class="btn btn-secondary" onclick="testCred()" style="flex-shrink:0">
          <span class="material-symbols-rounded">wifi_tethering</span> Test
        </button>
      </div>
      <div id="test-result" style="margin-top:8px;font-size:12px;display:none"></div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-cred')">Cancel</button>
      <button class="btn btn-primary" onclick="saveCred()">
        <span class="material-symbols-rounded">save</span> Save Credential
      </button>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════ -->
<!--  MODAL: Deploy / Export                    -->
<!-- ══════════════════════════════════════════ -->
<div class="modal-overlay" id="modal-action" style="display:none" onclick="if(event.target===this)closeModal('modal-action')">
  <div class="modal">
    <div class="modal-title">
      <span class="material-symbols-rounded" id="action-modal-icon">terminal</span>
      <span id="action-modal-title">Action</span>
    </div>
    <div id="action-modal-body" style="font-size:13px;color:var(--text-muted);margin-bottom:16px"></div>
    <div id="action-output-block" style="display:none">
      <div class="yaml-block" id="action-output"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-action')">Close</button>
      <button class="btn btn-primary" id="action-confirm-btn" onclick="executeAction()">
        <span class="material-symbols-rounded" id="action-icon">play_arrow</span>
        <span id="action-confirm-label">Execute</span>
      </button>
    </div>
  </div>
</div>

<script src="/assets/js/nav-shared.js"></script>
<script>
// ── State ──────────────────────────────────────────────────────
let repos = [], credentials = [];
let pendingAction = null; // {type, repoId, repoName}
let editingCredId = null;

// ── Init ───────────────────────────────────────────────────────
(async function() {
  await loadCurrentUser();
  await Promise.all([loadRepos(), loadCredentials()]);
})();

function switchTab(tab, btn) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  if (btn) btn.classList.add('active');
  ['repos','credentials','legacy'].forEach(p => {
    document.getElementById('panel-' + p).style.display = p === tab ? '' : 'none';
  });
  if (tab === 'legacy') loadLegacyStatus();
}

// ── Repos ──────────────────────────────────────────────────────
async function loadRepos() {
  try {
    const r = await csrfFetch('/api/git-sync/repos');
    const d = await r.json();
    repos = d.repos || [];
    document.getElementById('repos-count').textContent = repos.length;
    renderRepos();
  } catch(e) {
    document.getElementById('repos-container').innerHTML =
      '<div class="empty-state"><span class="material-symbols-rounded">error</span><h3>Failed to load syncs</h3><p>' + e.message + '</p></div>';
  }
}

function renderRepos() {
  const c = document.getElementById('repos-container');
  if (!repos.length) {
    c.innerHTML = `
      <div class="empty-state">
        <span class="material-symbols-rounded">hub</span>
        <h3>No syncs configured yet</h3>
        <p>Add a sync to start backing up Docker Compose stacks to GitHub, or pulling stacks from a repo.</p>
        <button class="btn btn-primary" style="margin-top:16px" onclick="openAddRepoModal()">
          <span class="material-symbols-rounded">add</span> Add First Sync
        </button>
      </div>`;
    return;
  }

  const html = repos.map(repo => {
    const statusDot = repo.last_error
      ? '<span class="status-dot error"></span>'
      : repo.auto_sync
        ? '<span class="status-dot online"></span>'
        : '<span class="status-dot offline"></span>';

    const lastCommit = repo.last_commit
      ? `<span class="commit">${esc(repo.last_commit.slice(0,8))}</span>`
      : '<span style="opacity:0.4">no commits yet</span>';

    const lastSync = repo.last_sync_at
      ? `<span class="last-sync"> · ${esc(relativeTime(repo.last_sync_at))}</span>`
      : '';

    const errorBlock = repo.last_error
      ? `<div class="last-error"><span class="material-symbols-rounded" style="font-size:14px;vertical-align:middle;">error</span> ${esc(repo.last_error)}</div>`
      : '';

    const autoSyncPill = repo.auto_sync
      ? `<span class="meta-pill active"><span class="material-symbols-rounded">autorenew</span>Auto every ${repo.sync_interval}m</span>`
      : `<span class="meta-pill"><span class="material-symbols-rounded">sync_disabled</span>Manual</span>`;

    const credPill = repo.cred_name
      ? `<span class="meta-pill"><span class="material-symbols-rounded">key</span>${esc(repo.cred_name)}</span>`
      : `<span class="meta-pill"><span class="material-symbols-rounded">lock_open</span>No auth</span>`;

    return `
    <div class="repo-card" id="repo-card-${repo.id}">
      <div class="repo-card-header">
        <div class="repo-icon"><span class="material-symbols-rounded">source</span></div>
        <div style="flex:1;min-width:0">
          <div class="repo-name">${statusDot} ${esc(repo.name)}</div>
          <div class="repo-url">${esc(repo.repo_url)}</div>
        </div>
        <button class="btn btn-secondary btn-sm btn-icon" onclick="editRepo(${repo.id})" title="Edit">
          <span class="material-symbols-rounded">edit</span>
        </button>
      </div>
      <div class="repo-meta">
        <span class="meta-pill"><span class="material-symbols-rounded">call_split</span>${esc(repo.branch)}</span>
        <span class="meta-pill"><span class="material-symbols-rounded">description</span>${esc(repo.compose_path)}</span>
        ${autoSyncPill}
        ${credPill}
      </div>
      <div class="repo-status">
        ${lastCommit}${lastSync}
      </div>
      ${errorBlock}
      <div class="repo-actions">
        <button class="btn btn-secondary btn-sm" onclick="doRepoPull(${repo.id},'"+JSON.stringify(repo.name)+"')">
          <span class="material-symbols-rounded">download</span> Pull
        </button>
        <button class="btn btn-success btn-sm" onclick="doRepoDeploy(${repo.id},'"+JSON.stringify(repo.name)+"')">
          <span class="material-symbols-rounded">rocket_launch</span> Deploy
        </button>
        <button class="btn btn-secondary btn-sm" onclick="doExportToRepo(${repo.id},'"+JSON.stringify(repo.name)+"')">
          <span class="material-symbols-rounded">upload</span> Export Stack
        </button>
        <button class="btn btn-secondary btn-sm" onclick="doRepoPush(${repo.id},'"+JSON.stringify(repo.name)+"')">
          <span class="material-symbols-rounded">cloud_upload</span> Push to Git
        </button>
        <button class="btn btn-danger btn-sm" onclick="deleteRepo(${repo.id},'"+JSON.stringify(repo.name)+"')">
          <span class="material-symbols-rounded">delete</span>
        </button>
      </div>
    </div>`;
  }).join('');

  c.innerHTML = `<div class="repo-grid">${html}</div>`;
}

// ── Credentials ────────────────────────────────────────────────
async function loadCredentials() {
  try {
    const r = await csrfFetch('/api/git-sync/credentials');
    const d = await r.json();
    credentials = d.credentials || [];
    document.getElementById('creds-count').textContent = credentials.length;
    renderCredentials();
  } catch(e) {
    document.getElementById('creds-container').innerHTML =
      '<p style="color:var(--red);font-size:13px">Failed to load credentials</p>';
  }
}

function renderCredentials() {
  const c = document.getElementById('creds-container');
  if (!credentials.length) {
    c.innerHTML = `
      <div class="empty-state" style="padding:40px 16px">
        <span class="material-symbols-rounded">key_off</span>
        <h3>No credentials yet</h3>
        <p>Add a PAT or SSH key to authenticate with private repositories.</p>
      </div>`;
    return;
  }

  c.innerHTML = `<div class="cred-grid">${credentials.map(cr => `
    <div class="cred-card">
      <div class="cred-icon ${cr.auth_type}">
        <span class="material-symbols-rounded">${cr.auth_type === 'ssh' ? 'vpn_key' : 'token'}</span>
      </div>
      <div class="cred-info">
        <div class="cred-name">${esc(cr.name)}</div>
        <div class="cred-meta">${esc(cr.host)} · ${cr.auth_type === 'token' ? 'PAT' : 'SSH Key'}${cr.notes ? ' · ' + esc(cr.notes) : ''}</div>
      </div>
      <div class="cred-actions">
        <button class="btn btn-secondary btn-sm btn-icon" onclick="editCred(${cr.id})" title="Edit">
          <span class="material-symbols-rounded">edit</span>
        </button>
        <button class="btn btn-danger btn-sm btn-icon" onclick="deleteCred(${cr.id},'"+JSON.stringify(cr.name)+"')" title="Delete">
          <span class="material-symbols-rounded">delete</span>
        </button>
      </div>
    </div>`).join('')}</div>`;
}

// ── Repo modal ─────────────────────────────────────────────────
function openAddRepoModal() {
  document.getElementById('modal-repo-title').textContent = 'Add Git Sync';
  document.getElementById('repo-edit-id').value = '';
  document.getElementById('repo-name').value = '';
  document.getElementById('repo-url').value = '';
  document.getElementById('repo-branch').value = 'main';
  document.getElementById('repo-compose').value = 'docker-compose.yml';
  document.getElementById('repo-autosync').checked = false;
  document.getElementById('repo-interval').value = 5;
  document.getElementById('repo-commit-name').value = 'D-PlaneOS';
  document.getElementById('repo-commit-email').value = 'dplaneos@localhost';
  document.getElementById('interval-group').style.display = 'none';
  populateCredSelect(null);
  document.getElementById('modal-repo').style.display = 'flex';
}

function editRepo(id) {
  const repo = repos.find(r => r.id === id);
  if (!repo) return;
  document.getElementById('modal-repo-title').textContent = 'Edit Sync — ' + repo.name;
  document.getElementById('repo-edit-id').value = repo.id;
  document.getElementById('repo-name').value = repo.name;
  document.getElementById('repo-url').value = repo.repo_url;
  document.getElementById('repo-branch').value = repo.branch;
  document.getElementById('repo-compose').value = repo.compose_path;
  document.getElementById('repo-autosync').checked = repo.auto_sync;
  document.getElementById('repo-interval').value = repo.sync_interval;
  document.getElementById('repo-commit-name').value = repo.commit_name;
  document.getElementById('repo-commit-email').value = repo.commit_email;
  document.getElementById('interval-group').style.display = repo.auto_sync ? '' : 'none';
  populateCredSelect(repo.cred_id);
  document.getElementById('modal-repo').style.display = 'flex';
}

function populateCredSelect(selectedId) {
  const sel = document.getElementById('repo-cred');
  sel.innerHTML = '<option value="">None (public repo)</option>';
  credentials.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.name + ' (' + c.host + ')';
    if (selectedId && c.id === selectedId) opt.selected = true;
    sel.appendChild(opt);
  });
}

document.getElementById('repo-autosync').addEventListener('change', function() {
  document.getElementById('interval-group').style.display = this.checked ? '' : 'none';
});

async function saveRepo() {
  const editId = document.getElementById('repo-edit-id').value;
  const payload = {
    name: document.getElementById('repo-name').value.trim(),
    repo_url: document.getElementById('repo-url').value.trim(),
    branch: document.getElementById('repo-branch').value.trim() || 'main',
    compose_path: document.getElementById('repo-compose').value.trim() || 'docker-compose.yml',
    auto_sync: document.getElementById('repo-autosync').checked,
    sync_interval: parseInt(document.getElementById('repo-interval').value) || 5,
    commit_name: document.getElementById('repo-commit-name').value.trim() || 'D-PlaneOS',
    commit_email: document.getElementById('repo-commit-email').value.trim() || 'dplaneos@localhost',
    enabled: true,
  };
  const credVal = document.getElementById('repo-cred').value;
  if (credVal) payload.credential_id = parseInt(credVal);
  if (editId) payload.id = parseInt(editId);

  if (!payload.name) { ui.toast('Name is required', 'error'); return; }
  if (!payload.repo_url) { ui.toast('Repository URL is required', 'error'); return; }

  try {
    const r = await csrfFetch('/api/git-sync/repos', {method:'POST', body:JSON.stringify(payload)});
    const d = await r.json();
    if (d.success) {
      ui.toast(editId ? 'Sync updated' : 'Sync added', 'success');
      closeModal('modal-repo');
      loadRepos();
    } else {
      ui.toast(d.error || 'Failed to save', 'error');
    }
  } catch(e) { ui.toast('Request failed', 'error'); }
}

async function deleteRepo(id, name) {
  if (!await ui.confirm('Delete Sync', 'Delete "' + name + '"? The local clone will not be removed.')) return;
  const r = await csrfFetch('/api/git-sync/repos/delete?id=' + id, {method:'POST'});
  const d = await r.json();
  if (d.success) { ui.toast('Sync deleted', 'success'); loadRepos(); }
  else ui.toast(d.error || 'Failed', 'error');
}

// ── Repo Actions ───────────────────────────────────────────────
function doRepoPull(id, name) {
  showActionModal('pull', id, name,
    'Pull latest changes from the remote repository.<br>This will run <code>git pull --rebase</code> on the local clone.',
    'cloud_download', 'Pull Now');
}
function doRepoDeploy(id, name) {
  showActionModal('deploy', id, name,
    'Run <code>docker compose up -d --remove-orphans</code> using the compose file in the cloned repository.<br><strong>Pull first</strong> to ensure you have the latest version.',
    'rocket_launch', 'Deploy');
}
function doExportToRepo(id, name) {
  showActionModal('export', id, name,
    'Export all currently running containers as a <code>docker-compose.yml</code> and write it into the local repository clone.<br>After exporting, use <strong>Push to Git</strong> to commit and push to the remote.',
    'upload', 'Export Stack');
}
function doRepoPush(id, name) {
  showActionModal('push', id, name,
    'Commit the current state of the compose file and push to the remote repository.',
    'cloud_upload', 'Push to Git');
}

function showActionModal(type, id, name, desc, icon, label) {
  pendingAction = {type, id, name};
  document.getElementById('action-modal-icon').textContent = icon;
  document.getElementById('action-modal-title').textContent = label + ' — ' + name;
  document.getElementById('action-modal-body').innerHTML = desc;
  document.getElementById('action-icon').textContent = icon;
  document.getElementById('action-confirm-label').textContent = label;
  document.getElementById('action-output-block').style.display = 'none';
  document.getElementById('action-output').textContent = '';
  document.getElementById('action-confirm-btn').disabled = false;
  document.getElementById('modal-action').style.display = 'flex';
}

async function executeAction() {
  if (!pendingAction) return;
  const {type, id} = pendingAction;
  const btn = document.getElementById('action-confirm-btn');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner"></div> Running…';

  const endpoints = {
    pull:   '/api/git-sync/repos/pull?id=' + id,
    deploy: '/api/git-sync/repos/deploy?id=' + id,
    export: '/api/git-sync/repos/export?id=' + id,
    push:   '/api/git-sync/repos/push?id=' + id,
  };

  try {
    const r = await csrfFetch(endpoints[type], {method:'POST', body:JSON.stringify({})});
    const d = await r.json();

    const out = document.getElementById('action-output');
    const outBlock = document.getElementById('action-output-block');

    if (d.success) {
      const outputText = d.output || d.yaml || ('Commit: ' + (d.commit || 'n/a'));
      out.textContent = outputText;
      outBlock.style.display = '';
      ui.toast(pendingAction.name + ': ' + type + ' successful', 'success');
      loadRepos();
    } else {
      out.textContent = (d.error || 'Failed') + (d.hint ? '\n\nHint: ' + d.hint : '');
      outBlock.style.display = '';
      ui.toast(d.error || 'Action failed', 'error');
    }
  } catch(e) {
    ui.toast('Request failed: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<span class="material-symbols-rounded">done</span> Done';
    pendingAction = null;
  }
}

// ── Credential modal ───────────────────────────────────────────
function openAddCredModal() {
  editingCredId = null;
  document.getElementById('cred-edit-id').value = '';
  document.getElementById('cred-name').value = '';
  document.getElementById('cred-host').value = 'github.com';
  document.getElementById('cred-type').value = 'token';
  document.getElementById('cred-token').value = '';
  document.getElementById('cred-ssh').value = '';
  document.getElementById('cred-notes').value = '';
  document.getElementById('test-block').style.display = 'none';
  document.getElementById('test-result').style.display = 'none';
  toggleCredFields();
  document.getElementById('modal-cred').style.display = 'flex';
}

function editCred(id) {
  const cred = credentials.find(c => c.id === id);
  if (!cred) return;
  editingCredId = id;
  document.getElementById('cred-edit-id').value = id;
  document.getElementById('cred-name').value = cred.name;
  document.getElementById('cred-host').value = cred.host;
  document.getElementById('cred-type').value = cred.auth_type;
  document.getElementById('cred-token').value = '';
  document.getElementById('cred-token').placeholder = cred.has_token ? 'Leave blank to keep existing token' : '';
  document.getElementById('cred-ssh').value = '';
  document.getElementById('cred-notes').value = cred.notes || '';
  document.getElementById('test-block').style.display = '';
  toggleCredFields();
  document.getElementById('modal-cred').style.display = 'flex';
}

function toggleCredFields() {
  const t = document.getElementById('cred-type').value;
  document.getElementById('pat-wizard-block').style.display = t === 'token' ? '' : 'none';
  document.getElementById('ssh-block').style.display = t === 'ssh' ? '' : 'none';
  // Show test block only for existing credentials
  if (editingCredId) document.getElementById('test-block').style.display = '';
}

async function saveCred() {
  const editId = document.getElementById('cred-edit-id').value;
  const authType = document.getElementById('cred-type').value;
  const payload = {
    name:      document.getElementById('cred-name').value.trim(),
    host:      document.getElementById('cred-host').value.trim() || 'github.com',
    auth_type: authType,
    token:     document.getElementById('cred-token').value,
    ssh_key:   document.getElementById('cred-ssh').value,
    notes:     document.getElementById('cred-notes').value.trim(),
  };
  if (editId) payload.id = parseInt(editId);

  if (!payload.name) { ui.toast('Name is required', 'error'); return; }

  try {
    const r = await csrfFetch('/api/git-sync/credentials', {method:'POST', body:JSON.stringify(payload)});
    const d = await r.json();
    if (d.success) {
      ui.toast('Credential saved', 'success');
      closeModal('modal-cred');
      await loadCredentials();
    } else {
      ui.toast(d.error || 'Failed to save', 'error');
    }
  } catch(e) { ui.toast('Request failed', 'error'); }
}

async function testCred() {
  const repoUrl = document.getElementById('test-repo-url').value.trim();
  if (!repoUrl) { ui.toast('Enter a repo URL to test against', 'error'); return; }
  const editId = document.getElementById('cred-edit-id').value;
  if (!editId) { ui.toast('Save the credential first', 'error'); return; }

  const resultEl = document.getElementById('test-result');
  resultEl.style.display = '';
  resultEl.innerHTML = '<div style="display:flex;gap:8px;align-items:center"><div class="spinner"></div> Testing connection…</div>';

  try {
    const r = await csrfFetch('/api/git-sync/credentials/test', {method:'POST',
      body: JSON.stringify({credential_id: parseInt(editId), repo_url: repoUrl})});
    const d = await r.json();
    if (d.success) {
      resultEl.innerHTML = '<span style="color:var(--green)"><span class="material-symbols-rounded" style="font-size:15px;vertical-align:middle">check_circle</span> Connection successful</span>';
    } else {
      resultEl.innerHTML = '<span style="color:var(--red)"><span class="material-symbols-rounded" style="font-size:15px;vertical-align:middle">error</span> ' + esc(d.error) +
        (d.hint ? '<br><span style="color:var(--text-muted)">' + esc(d.hint) + '</span>' : '') + '</span>';
    }
  } catch(e) {
    resultEl.innerHTML = '<span style="color:var(--red)">Request failed</span>';
  }
}

async function deleteCred(id, name) {
  if (!await ui.confirm('Delete Credential', 'Delete "' + name + '"? Syncs using this credential will stop authenticating.')) return;
  const r = await csrfFetch('/api/git-sync/credentials/delete?id=' + id, {method:'POST'});
  const d = await r.json();
  if (d.success) { ui.toast('Credential deleted', 'success'); loadCredentials(); }
  else ui.toast(d.error || 'Failed', 'error');
}

// ── Legacy Status ──────────────────────────────────────────────
async function loadLegacyStatus() {
  try {
    const r = await csrfFetch('/api/git-sync/status');
    const d = await r.json();
    if (!d.success) { document.getElementById('legacy-status').textContent = 'Not configured'; return; }
    const el = document.getElementById('legacy-status');
    el.innerHTML = `
      <div style="display:grid;grid-template-columns:120px 1fr;gap:8px 16px;font-size:13px">
        <span style="color:var(--text-muted)">Repo</span><span>${esc(d.repo_url||'—')}</span>
        <span style="color:var(--text-muted)">Branch</span><span>${esc(d.branch||'main')}</span>
        <span style="color:var(--text-muted)">Last commit</span><span style="color:var(--accent)">${esc(d.last_commit||'—')}</span>
        <span style="color:var(--text-muted)">Last sync</span><span>${d.last_sync_at ? esc(relativeTime(d.last_sync_at)) : '—'}</span>
      </div>`;
  } catch(e) {
    document.getElementById('legacy-status').textContent = 'Failed to load';
  }
}

// ── Utilities ──────────────────────────────────────────────────
function closeModal(id) {
  document.getElementById(id).style.display = 'none';
}

function esc(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function relativeTime(iso) {
  if (!iso) return '—';
  const diff = Date.now() - new Date(iso).getTime();
  if (diff < 60000) return 'just now';
  if (diff < 3600000) return Math.floor(diff/60000) + 'm ago';
  if (diff < 86400000) return Math.floor(diff/3600000) + 'h ago';
  return Math.floor(diff/86400000) + 'd ago';
}

async function loadCurrentUser() {
  try {
    const r = await csrfFetch('/api/auth/session');
    const d = await r.json();
    if (d.success && d.user) {
      const el = document.getElementById('currentUser');
      if (el) el.textContent = d.user.username;
    }
  } catch(e) {}
}

async function handleLogout() {
  if (!await ui.confirm('Logout', 'Are you sure?')) return;
  try {
    const r = await csrfFetch('/api/auth/logout', {method:'POST'});
    if (r.ok) { window.location.href = '/login'; return; }
    ui.toast('Logout failed', 'error');
  } catch(e) { ui.toast('Logout failed', 'error'); }
}
</script>
</body>
</html>
