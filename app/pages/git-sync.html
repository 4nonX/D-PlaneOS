<!DOCTYPE html>
<html lang="en"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Git Sync — D-PlaneOS</title>
<link rel="stylesheet" href="/assets/css/design-tokens.css">
<link rel="stylesheet" href="/assets/css/m3-tokens.css">
<link rel="stylesheet" href="/assets/css/m3-components.css">
<link rel="stylesheet" href="/assets/css/m3-icons.css">
<link rel="stylesheet" href="/assets/css/enhanced-ui.css">
<link rel="stylesheet" href="/assets/css/m3-animations.css">
<link rel="stylesheet" href="/assets/css/material-symbols-local.css">
<link rel="stylesheet" href="/assets/css/ui-consistency.css">
<link rel="stylesheet" href="/assets/css/ui-polish.css">
<link rel="stylesheet" href="/assets/css/ui-components.css">
<style>
/* D-PlaneOS Git Sync — Bidirectional Multi-Repo M3 Layout */
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",system-ui,sans-serif; background:var(--bg,#0a0a0a); color:var(--text,#fff); overflow-x:hidden; }
.gs-main { max-width:1200px; margin:120px auto 60px; padding:0 40px; }
.page-header { display:flex; align-items:flex-start; justify-content:space-between; gap:20px; margin-bottom:32px; flex-wrap:wrap; }
.page-title { font-size:32px; font-weight:700; letter-spacing:-1.5px; margin-bottom:8px; display:flex; align-items:center; gap:14px; }
.page-title .material-symbols-rounded { font-size:36px; color:var(--primary); }
.page-subtitle { font-size:15px; color:var(--text-dim); }
.tabs { display:flex; gap:4px; margin-bottom:24px; border-bottom:1px solid var(--border-subtle,rgba(255,255,255,0.05)); }
.tab { display:inline-flex; align-items:center; gap:6px; padding:10px 18px; border:none; background:transparent; color:var(--text-dim); font-size:14px; font-weight:500; cursor:pointer; border-bottom:2px solid transparent; transition:all 0.2s; margin-bottom:-1px; }
.tab:hover { color:var(--text); background:var(--surface,rgba(255,255,255,0.03)); }
.tab.active { color:var(--primary); border-bottom-color:var(--primary); }
.tab-badge { font-size:11px; padding:1px 7px; border-radius:10px; background:var(--surface-variant,rgba(255,255,255,0.08)); color:var(--text-dim); }
.tab.active .tab-badge { background:rgba(138,156,255,0.15); color:var(--primary); }
.card { background:var(--surface,rgba(255,255,255,0.03)); border:1px solid var(--border,rgba(255,255,255,0.08)); border-radius:var(--radius-lg,16px); padding:24px; }
.card-header { display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:12px; }
.card-title { font-size:18px; font-weight:700; display:flex; align-items:center; gap:8px; }
.card-title .material-symbols-rounded { font-size:20px; color:var(--primary); }
.repo-grid { display:flex; flex-direction:column; gap:12px; }
.repo-card { background:var(--surface,rgba(255,255,255,0.03)); border:1px solid var(--border,rgba(255,255,255,0.08)); border-radius:var(--radius-lg,16px); padding:20px 24px; transition:border-color 0.2s; }
.repo-card:hover { border-color:var(--border-strong,rgba(255,255,255,0.15)); }
.repo-card-header { display:flex; align-items:center; gap:14px; margin-bottom:12px; }
.repo-icon { width:40px; height:40px; border-radius:var(--radius-md,12px); background:rgba(138,156,255,0.1); display:flex; align-items:center; justify-content:center; }
.repo-icon .material-symbols-rounded { font-size:20px; color:var(--primary); }
.repo-name { font-size:16px; font-weight:700; letter-spacing:-0.3px; display:flex; align-items:center; gap:8px; }
.repo-url { font-size:12px; color:var(--text-dim); font-family:'Consolas','Monaco',monospace; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:500px; margin-top:2px; }
.repo-meta { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px; }
.meta-pill { display:inline-flex; align-items:center; gap:4px; padding:3px 10px; border-radius:var(--radius-full,9999px); background:var(--surface-variant,rgba(255,255,255,0.05)); font-size:12px; color:var(--text-dim); }
.meta-pill .material-symbols-rounded { font-size:14px; }
.meta-pill.active { background:rgba(0,255,127,0.1); color:var(--success,#00ff7f); }
.repo-status { font-size:13px; color:var(--text-dim); margin-bottom:6px; }
.commit { font-family:'Consolas','Monaco',monospace; color:var(--primary); font-weight:600; }
.last-sync { color:var(--text-dimmer); }
.last-error { font-size:12px; color:var(--error,#ff5252); margin-bottom:8px; display:flex; align-items:center; gap:4px; }
.repo-actions { display:flex; flex-wrap:wrap; gap:8px; margin-top:12px; padding-top:12px; border-top:1px solid var(--border-subtle,rgba(255,255,255,0.05)); }
.status-dot { display:inline-block; width:8px; height:8px; border-radius:50%; }
.status-dot.online { background:var(--success,#00ff7f); box-shadow:0 0 6px rgba(0,255,127,0.4); }
.status-dot.error { background:var(--error,#ff5252); box-shadow:0 0 6px rgba(255,82,82,0.4); }
.status-dot.offline { background:var(--text-dimmer,rgba(255,255,255,0.3)); }
.cred-grid { display:flex; flex-direction:column; gap:8px; }
.cred-card { display:flex; align-items:center; gap:14px; padding:14px 18px; border-radius:var(--radius-md,12px); background:var(--surface-variant,rgba(255,255,255,0.05)); border:1px solid var(--border-subtle,rgba(255,255,255,0.05)); }
.cred-icon { width:36px; height:36px; border-radius:var(--radius-sm,8px); display:flex; align-items:center; justify-content:center; background:rgba(138,156,255,0.1); }
.cred-icon.ssh { background:rgba(0,255,127,0.1); }
.cred-icon .material-symbols-rounded { font-size:18px; color:var(--primary); }
.cred-icon.ssh .material-symbols-rounded { color:var(--success); }
.cred-info { flex:1; min-width:0; }
.cred-name { font-size:14px; font-weight:600; }
.cred-meta { font-size:12px; color:var(--text-dim); margin-top:2px; }
.cred-actions { display:flex; gap:6px; }
.btn { display:inline-flex; align-items:center; gap:6px; padding:8px 16px; border:1px solid var(--border); border-radius:var(--radius-md,10px); background:transparent; color:var(--text-dim); font-size:13px; font-weight:500; cursor:pointer; transition:all 0.2s; }
.btn:hover { background:var(--surface-hover,rgba(255,255,255,0.08)); color:var(--text); border-color:var(--border-strong); }
.btn .material-symbols-rounded { font-size:16px; }
.btn-primary { background:linear-gradient(135deg,var(--primary,#8a9cff) 0%,#764ba2 100%); border-color:transparent; color:#fff; }
.btn-primary:hover { box-shadow:0 4px 16px rgba(138,156,255,0.35); }
.btn-secondary { border-color:var(--border); }
.btn-success { border-color:rgba(0,255,127,0.3); color:var(--success); }
.btn-success:hover { background:rgba(0,255,127,0.1); }
.btn-danger { border-color:rgba(255,82,82,0.3); color:var(--error); }
.btn-danger:hover { background:rgba(255,82,82,0.1); }
.btn-sm { padding:6px 12px; font-size:12px; }
.btn-sm .material-symbols-rounded { font-size:15px; }
.btn-icon { padding:6px 8px; }
.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter:blur(4px); z-index:1000; display:flex; align-items:center; justify-content:center; padding:24px; }
.modal { background:var(--bg-elevated,#0f0f0f); border:1px solid var(--border); border-radius:var(--radius-xl,20px); padding:28px; width:100%; max-width:600px; max-height:90vh; overflow-y:auto; }
.modal-title { font-size:20px; font-weight:700; letter-spacing:-0.5px; margin-bottom:24px; display:flex; align-items:center; gap:10px; }
.modal-title .material-symbols-rounded { color:var(--primary); font-size:22px; }
.modal-footer { display:flex; gap:12px; justify-content:flex-end; margin-top:24px; padding-top:20px; border-top:1px solid var(--border-subtle); }
.form-group { margin-bottom:16px; }
.form-label { display:block; font-size:13px; font-weight:600; color:var(--text-dim); margin-bottom:6px; }
.form-input, .form-select, .form-textarea { width:100%; padding:10px 14px; background:var(--surface,rgba(255,255,255,0.05)); border:1px solid var(--border); border-radius:var(--radius-md,10px); color:var(--text); font-size:14px; transition:border-color 0.2s; }
.form-input:focus, .form-select:focus, .form-textarea:focus { outline:none; border-color:var(--primary); }
.form-textarea { min-height:100px; resize:vertical; font-family:'Consolas','Monaco',monospace; font-size:13px; }
.form-hint { font-size:12px; color:var(--text-dimmer); margin-top:4px; }
.form-hint code { background:var(--surface-variant); padding:1px 5px; border-radius:4px; font-size:11px; }
.form-hint a { color:var(--primary); text-decoration:none; }
.form-hint a:hover { text-decoration:underline; }
.form-row { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
@media(max-width:600px) { .form-row { grid-template-columns:1fr; } }
.form-select { cursor:pointer; }
.form-select option { background:var(--bg-elevated); }
.form-toggle { display:flex; align-items:center; gap:10px; cursor:pointer; font-size:13px; }
.section-label { font-size:12px; font-weight:700; color:var(--text-dim); text-transform:uppercase; letter-spacing:0.5px; margin:20px 0 12px; }
.pat-wizard { background:rgba(138,156,255,0.05); border:1px solid rgba(138,156,255,0.15); border-radius:var(--radius-md,12px); padding:16px; margin-bottom:16px; }
.pat-wizard-title { font-size:14px; font-weight:700; color:var(--primary); display:flex; align-items:center; gap:8px; margin-bottom:12px; }
.pat-steps { display:flex; flex-direction:column; gap:10px; }
.pat-step { display:flex; align-items:flex-start; gap:10px; font-size:13px; color:var(--text-dim); line-height:1.5; }
.pat-step a { color:var(--primary); text-decoration:none; }
.pat-step a:hover { text-decoration:underline; }
.pat-step-num { flex-shrink:0; width:22px; height:22px; border-radius:50%; background:rgba(138,156,255,0.15); color:var(--primary); font-size:12px; font-weight:700; display:flex; align-items:center; justify-content:center; }
.scope-badge { display:inline-block; padding:1px 8px; border-radius:4px; background:rgba(138,156,255,0.15); color:var(--primary); font-size:12px; font-weight:600; font-family:'Consolas','Monaco',monospace; }
.empty-state { text-align:center; padding:60px 20px; }
.empty-state .material-symbols-rounded { font-size:48px; color:var(--text-dimmer); margin-bottom:16px; display:block; }
.empty-state h3 { font-size:18px; font-weight:700; margin-bottom:8px; }
.empty-state p { font-size:14px; color:var(--text-dim); max-width:400px; margin:0 auto; }
.yaml-block { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius-md); padding:14px; font-family:'Consolas','Monaco',monospace; font-size:12px; color:var(--text-dim); max-height:300px; overflow-y:auto; white-space:pre-wrap; word-break:break-all; }
.loading { display:flex; align-items:center; gap:10px; justify-content:center; padding:40px; color:var(--text-dim); font-size:14px; }
.spinner { width:18px; height:18px; border:2px solid rgba(255,255,255,0.15); border-top-color:var(--primary); border-radius:50%; animation:spin 0.8s linear infinite; }
@keyframes spin { to { transform:rotate(360deg); } }
</style>
</head>
<body>
<nav class="nav-container">
  <div class="nav-main">
    <div style="display:flex;align-items:center;gap:16px;">
      <div class="logo">D-PlaneOS<span class="version-badge">v3.0.0</span></div>
    </div>
    <div class="nav-links">
      <button class="nav-link" onclick="navigateToSection('dashboard')" data-section="dashboard">Dashboard</button>
      <button class="nav-link" onclick="toggleSubNav('storage',this)" data-section="storage">Storage</button>
      <button class="nav-link active" onclick="toggleSubNav('compute',this)" data-section="compute">Compute</button>
      <button class="nav-link" onclick="toggleSubNav('network',this)" data-section="network">Network</button>
      <button class="nav-link" onclick="toggleSubNav('identity',this)" data-section="identity">Identity</button>
      <button class="nav-link" onclick="toggleSubNav('security',this)" data-section="security">Security</button>
      <button class="nav-link" onclick="toggleSubNav('system',this)" data-section="system">System</button>
    </div>
    <div class="nav-actions">
      <button class="nav-action-btn" onclick="showKeyboardHelp()" title="Keyboard Shortcuts (?)"><span class="material-symbols-rounded">keyboard</span></button>
      <div class="connection-status online" id="navConnectionStatus"><span class="status-dot"></span><span>Connected</span></div>
    </div>
  </div>
  <div id="sub-storage" class="nav-sub"><div class="nav-sub-inner">
    <a href="pools.html" class="sub-link" data-page="pools"><span class="material-symbols-rounded">database</span>ZFS Pools</a>
    <a href="pools-advanced.html" class="sub-link" data-page="pools-advanced"><span class="material-symbols-rounded">photo_camera</span>Snapshots</a>
    <a href="shares.html" class="sub-link" data-page="shares"><span class="material-symbols-rounded">folder_shared</span>Shares</a>
    <a href="replication.html" class="sub-link" data-page="replication"><span class="material-symbols-rounded">sync</span>Replication</a>
  </div></div>
  <div id="sub-compute" class="nav-sub" style="display:flex;"><div class="nav-sub-inner">
    <a href="docker.html" class="sub-link" data-page="docker"><span class="material-symbols-rounded">dns</span>Docker Stacks</a>
    <a href="git-sync.html" class="sub-link active" data-page="git-sync"><span class="material-symbols-rounded">sync</span>Git Sync</a>
    <a href="modules.html" class="sub-link" data-page="modules"><span class="material-symbols-rounded">extension</span>App Modules</a>
  </div></div>
  <div id="sub-network" class="nav-sub"><div class="nav-sub-inner">
    <a href="network.html" class="sub-link" data-page="network"><span class="material-symbols-rounded">lan</span>Interfaces</a>
    <a href="dns.html" class="sub-link" data-page="dns"><span class="material-symbols-rounded">dns</span>DNS</a>
    <a href="vpn.html" class="sub-link" data-page="vpn"><span class="material-symbols-rounded">vpn_lock</span>VPN</a>
  </div></div>
  <div id="sub-identity" class="nav-sub"><div class="nav-sub-inner">
    <a href="users.html" class="sub-link" data-page="users"><span class="material-symbols-rounded">group</span>Users</a>
    <a href="permissions.html" class="sub-link" data-page="permissions"><span class="material-symbols-rounded">admin_panel_settings</span>Permissions</a>
  </div></div>
  <div id="sub-security" class="nav-sub"><div class="nav-sub-inner">
    <a href="security.html" class="sub-link" data-page="security"><span class="material-symbols-rounded">shield</span>Overview</a>
    <a href="audit-log.html" class="sub-link" data-page="audit-log"><span class="material-symbols-rounded">history</span>Audit Log</a>
  </div></div>
  <div id="sub-system" class="nav-sub"><div class="nav-sub-inner">
    <a href="settings.html" class="sub-link" data-page="settings"><span class="material-symbols-rounded">settings</span>Settings</a>
    <a href="reporting.html" class="sub-link" data-page="reporting"><span class="material-symbols-rounded">monitoring</span>Monitoring</a>
    <a href="notifications.html" class="sub-link" data-page="notifications"><span class="material-symbols-rounded">notifications</span>Alerts</a>
  </div></div>
</nav>
<main class="main">
  <div class="page-header">
    <div>
      <div class="page-title">
        <div class="icon"><span class="material-symbols-rounded">sync_alt</span></div>
        Git Sync
      </div>
      <div class="page-subtitle">Bidirectional Docker Compose ↔ GitHub/Gitea backup &amp; deployment</div>
    </div>
    <div style="display:flex;gap:10px">
      <button class="btn btn-secondary" onclick="openAddRepoModal()">
        <span class="material-symbols-rounded">add</span> Add Sync
      </button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" onclick="switchTab('repos',this)" id="tab-repos">
      <span class="material-symbols-rounded" style="font-size:16px">hub</span>
      Syncs <span class="tab-badge" id="repos-count">0</span>
    </button>
    <button class="tab" onclick="switchTab('credentials',this)" id="tab-creds">
      <span class="material-symbols-rounded" style="font-size:16px">key</span>
      Credentials <span class="tab-badge" id="creds-count">0</span>
    </button>
    <button class="tab" onclick="switchTab('legacy',this)" id="tab-legacy">
      <span class="material-symbols-rounded" style="font-size:16px">settings</span>
      Legacy Config
    </button>
  </div>

  <!-- Repos Panel -->
  <div id="panel-repos">
    <div id="repos-container"><div class="loading"><div class="spinner"></div> Loading syncs…</div></div>
  </div>

  <!-- Credentials Panel -->
  <div id="panel-credentials" style="display:none">
    <div class="card" style="margin-bottom:20px">
      <div class="card-header">
        <div class="card-title">
          <span class="material-symbols-rounded">key</span>
          Git Credentials
        </div>
        <button class="btn btn-primary btn-sm" onclick="openAddCredModal()">
          <span class="material-symbols-rounded">add</span> Add Credential
        </button>
      </div>
      <p style="font-size:13px;color:var(--text-muted);margin-bottom:16px">
        Store GitHub/Gitea Personal Access Tokens or SSH keys here. Reference them when adding a sync — tokens are never sent back to the browser after saving.
      </p>
      <div id="creds-container"><div class="loading"><div class="spinner"></div> Loading…</div></div>
    </div>
  </div>

  <!-- Legacy Config Panel -->
  <div id="panel-legacy" style="display:none">
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <span class="material-symbols-rounded">settings</span>
          Legacy Single-Repo Config
        </div>
      </div>
      <p style="font-size:13px;color:var(--amber);margin-bottom:16px">
        ⚠️ This is the original single-repo configuration. Use the Syncs tab for multi-repo management.
      </p>
      <div id="legacy-status" style="font-size:13px;color:var(--text-muted)">Loading…</div>
    </div>
  </div>
</main>

<!-- ══════════════════════════════════════════ -->
<!--  MODAL: Add/Edit Sync                      -->
<!-- ══════════════════════════════════════════ -->
<div class="modal-overlay" id="modal-repo" style="display:none" onclick="if(event.target===this)closeModal('modal-repo')">
  <div class="modal">
    <div class="modal-title">
      <span class="material-symbols-rounded">hub</span>
      <span id="modal-repo-title">Add Git Sync</span>
    </div>

    <input type="hidden" id="repo-edit-id">

    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Sync Name</label>
        <input type="text" class="form-input" id="repo-name" placeholder="my-homelab-stacks">
        <div class="form-hint">Unique label — used as local directory name</div>
      </div>
      <div class="form-group">
        <label class="form-label">Branch</label>
        <input type="text" class="form-input" id="repo-branch" value="main">
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Repository URL</label>
      <input type="text" class="form-input" id="repo-url" placeholder="https://github.com/you/repo.git">
      <div class="form-hint">HTTPS: <code>https://github.com/user/repo.git</code> &nbsp;·&nbsp; SSH: <code>git@github.com:user/repo.git</code></div>
    </div>

    <div class="form-group">
      <label class="form-label">Compose File Path <span style="font-weight:400;color:var(--text-muted)">(relative to repo root)</span></label>
      <input type="text" class="form-input" id="repo-compose" value="docker-compose.yml">
      <div class="form-hint">e.g. <code>stacks/nextcloud/compose.yml</code> </div>
    </div>

    <div class="form-group">
      <label class="form-label">Credential</label>
      <select class="form-select" id="repo-cred">
        <option value="">None (public repo)</option>
      </select>
      <div class="form-hint">Select a saved credential, or <a href="#" onclick="closeModal('modal-repo');openAddCredModal();return false">add one first</a></div>
    </div>

    <div class="section-label">Commit Identity</div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Author Name</label>
        <input type="text" class="form-input" id="repo-commit-name" value="D-PlaneOS">
      </div>
      <div class="form-group">
        <label class="form-label">Author Email</label>
        <input type="text" class="form-input" id="repo-commit-email" value="dplaneos@localhost">
      </div>
    </div>

    <div class="section-label">Auto Sync</div>
    <div class="form-group">
      <label class="form-toggle">
        <input type="checkbox" id="repo-autosync">
        <span style="font-size:13px">Enable Auto Sync (pull periodically)</span>
      </label>
    </div>
    <div class="form-group" id="interval-group" style="display:none">
      <label class="form-label">Sync Interval (minutes)</label>
      <input type="number" class="form-input" id="repo-interval" value="5" min="1" max="1440">
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-repo')">Cancel</button>
      <button class="btn btn-primary" onclick="saveRepo()">
        <span class="material-symbols-rounded">save</span> Save Sync
      </button>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════ -->
<!--  MODAL: Add Credential                     -->
<!-- ══════════════════════════════════════════ -->
<div class="modal-overlay" id="modal-cred" style="display:none" onclick="if(event.target===this)closeModal('modal-cred')">
  <div class="modal">
    <div class="modal-title">
      <span class="material-symbols-rounded">key</span>
      Add Credential
    </div>

    <input type="hidden" id="cred-edit-id">

    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Name</label>
        <input type="text" class="form-input" id="cred-name" placeholder="my-github-pat">
      </div>
      <div class="form-group">
        <label class="form-label">Host</label>
        <input type="text" class="form-input" id="cred-host" value="github.com">
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Auth Type</label>
      <select class="form-select" id="cred-type" onchange="toggleCredFields()">
        <option value="token">Personal Access Token (PAT)</option>
        <option value="ssh">SSH Key</option>
      </select>
    </div>

    <!-- PAT Wizard -->
    <div id="pat-wizard-block">
      <div class="pat-wizard">
        <div class="pat-wizard-title">
          <span class="material-symbols-rounded">auto_awesome</span>
          How to create a GitHub PAT
        </div>
        <div class="pat-steps">
          <div class="pat-step">
            <div class="pat-step-num">1</div>
            <div>Go to <a href="https://github.com/settings/tokens?type=beta" target="_blank">GitHub → Settings → Developer settings → Fine-grained tokens</a> (or <a href="https://github.com/settings/tokens" target="_blank">Classic tokens</a>)</div>
          </div>
          <div class="pat-step">
            <div class="pat-step-num">2</div>
            <div>Click <strong>Generate new token</strong>. Set a name, expiry, and select the repository.</div>
          </div>
          <div class="pat-step">
            <div class="pat-step-num">3</div>
            <div>Required scopes for private repos: <span class="scope-badge">repo</span> (classic) or <span class="scope-badge">Contents: Read &amp; Write</span> + <span class="scope-badge">Metadata: Read</span> (fine-grained)</div>
          </div>
          <div class="pat-step">
            <div class="pat-step-num">4</div>
            <div>Copy the token — it's only shown once. Paste it below. D-PlaneOS stores it encrypted and never returns it to the browser.</div>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Personal Access Token</label>
        <input type="password" class="form-input" id="cred-token" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
        <div class="form-hint" id="cred-token-hint">Token is stored server-side and masked after saving.</div>
      </div>
    </div>

    <!-- SSH block -->
    <div id="ssh-block" style="display:none">
      <div class="form-group">
        <label class="form-label">Private SSH Key</label>
        <textarea class="form-textarea" id="cred-ssh" placeholder="-----BEGIN OPENSSH PRIVATE KEY-----
...
-----END OPENSSH PRIVATE KEY-----"></textarea>
        <div class="form-hint">Paste your private key. The corresponding public key must be added to your GitHub/Gitea account under <a href="https://github.com/settings/keys" target="_blank">Settings → SSH keys</a>.</div>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Notes (optional)</label>
      <input type="text" class="form-input" id="cred-notes" placeholder="e.g. expires 2027-01, homelab repo access">
    </div>

    <div class="form-group" id="test-block" style="display:none">
      <div class="section-label">Test Connection</div>
      <div style="display:flex;gap:10px;align-items:center">
        <input type="text" class="form-input" id="test-repo-url" placeholder="https://github.com/you/repo.git (to test against)">
        <button class="btn btn-secondary" onclick="testCred()" style="flex-shrink:0">
          <span class="material-symbols-rounded">wifi_tethering</span> Test
        </button>
      </div>
      <div id="test-result" style="margin-top:8px;font-size:12px;display:none"></div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-cred')">Cancel</button>
      <button class="btn btn-primary" onclick="saveCred()">
        <span class="material-symbols-rounded">save</span> Save Credential
      </button>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════ -->
<!--  MODAL: Deploy / Export                    -->
<!-- ══════════════════════════════════════════ -->
<div class="modal-overlay" id="modal-action" style="display:none" onclick="if(event.target===this)closeModal('modal-action')">
  <div class="modal">
    <div class="modal-title">
      <span class="material-symbols-rounded" id="action-modal-icon">terminal</span>
      <span id="action-modal-title">Action</span>
    </div>
    <div id="action-modal-body" style="font-size:13px;color:var(--text-muted);margin-bottom:16px"></div>
    <div id="action-output-block" style="display:none">
      <div class="yaml-block" id="action-output"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-action')">Close</button>
      <button class="btn btn-primary" id="action-confirm-btn" onclick="executeAction()">
        <span class="material-symbols-rounded" id="action-icon">play_arrow</span>
        <span id="action-confirm-label">Execute</span>
      </button>
    </div>
  </div>
</div>

<script src="/assets/js/core.js"></script>
<script src="/assets/js/nav-flyout.js"></script>
<script src="/assets/js/hybrid-router.js"></script>
<script src="/assets/js/enhanced-ui.js"></script>
<script src="/assets/js/connection-monitor.js"></script>
<script src="/assets/js/keyboard-shortcuts.js"></script>
<script src="/assets/js/daemon-api.js"></script>
<script>
// ── State ──────────────────────────────────────────────────────
let repos = [], credentials = [];
let pendingAction = null; // {type, repoId, repoName}
let editingCredId = null;

// ── Init ───────────────────────────────────────────────────────
(async function() {
  await Promise.all([loadRepos(), loadCredentials()]);
})();

function switchTab(tab, btn) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  if (btn) btn.classList.add('active');
  ['repos','credentials','legacy'].forEach(p => {
    document.getElementById('panel-' + p).style.display = p === tab ? '' : 'none';
  });
  if (tab === 'legacy') loadLegacyStatus();
}

// ── Repos ──────────────────────────────────────────────────────
async function loadRepos() {
  try {
    const r = await csrfFetch('/api/git-sync/repos');
    const d = await r.json();
    repos = d.repos || [];
    document.getElementById('repos-count').textContent = repos.length;
    renderRepos();
  } catch(e) {
    document.getElementById('repos-container').innerHTML =
      '<div class="empty-state"><span class="material-symbols-rounded">error</span><h3>Failed to load syncs</h3><p>' + e.message + '</p></div>';
  }
}

function renderRepos() {
  const c = document.getElementById('repos-container');
  if (!repos.length) {
    c.innerHTML = `
      <div class="empty-state">
        <span class="material-symbols-rounded">hub</span>
        <h3>No syncs configured yet</h3>
        <p>Add a sync to start backing up Docker Compose stacks to GitHub, or pulling stacks from a repo.</p>
        <button class="btn btn-primary" style="margin-top:16px" onclick="openAddRepoModal()">
          <span class="material-symbols-rounded">add</span> Add First Sync
        </button>
      </div>`;
    return;
  }

  const html = repos.map(repo => {
    const statusDot = repo.last_error
      ? '<span class="status-dot error"></span>'
      : repo.auto_sync
        ? '<span class="status-dot online"></span>'
        : '<span class="status-dot offline"></span>';

    const lastCommit = repo.last_commit
      ? `<span class="commit">${esc(repo.last_commit.slice(0,8))}</span>`
      : '<span style="opacity:0.4">no commits yet</span>';

    const lastSync = repo.last_sync_at
      ? `<span class="last-sync"> · ${esc(relativeTime(repo.last_sync_at))}</span>`
      : '';

    const errorBlock = repo.last_error
      ? `<div class="last-error"><span class="material-symbols-rounded" style="font-size:14px;vertical-align:middle;">error</span> ${esc(repo.last_error)}</div>`
      : '';

    const autoSyncPill = repo.auto_sync
      ? `<span class="meta-pill active"><span class="material-symbols-rounded">autorenew</span>Auto every ${repo.sync_interval}m</span>`
      : `<span class="meta-pill"><span class="material-symbols-rounded">sync_disabled</span>Manual</span>`;

    const credPill = repo.cred_name
      ? `<span class="meta-pill"><span class="material-symbols-rounded">key</span>${esc(repo.cred_name)}</span>`
      : `<span class="meta-pill"><span class="material-symbols-rounded">lock_open</span>No auth</span>`;

    return `
    <div class="repo-card" id="repo-card-${repo.id}">
      <div class="repo-card-header">
        <div class="repo-icon"><span class="material-symbols-rounded">source</span></div>
        <div style="flex:1;min-width:0">
          <div class="repo-name">${statusDot} ${esc(repo.name)}</div>
          <div class="repo-url">${esc(repo.repo_url)}</div>
        </div>
        <button class="btn btn-secondary btn-sm btn-icon" onclick="editRepo(${repo.id})" title="Edit">
          <span class="material-symbols-rounded">edit</span>
        </button>
      </div>
      <div class="repo-meta">
        <span class="meta-pill"><span class="material-symbols-rounded">call_split</span>${esc(repo.branch)}</span>
        <span class="meta-pill"><span class="material-symbols-rounded">description</span>${esc(repo.compose_path)}</span>
        ${autoSyncPill}
        ${credPill}
      </div>
      <div class="repo-status">
        ${lastCommit}${lastSync}
      </div>
      ${errorBlock}
      <div class="repo-actions">
        <button class="btn btn-secondary btn-sm" onclick="doRepoPull(${repo.id},${JSON.stringify(repo.name)})">
          <span class="material-symbols-rounded">download</span> Pull
        </button>
        <button class="btn btn-success btn-sm" onclick="doRepoDeploy(${repo.id},${JSON.stringify(repo.name)})">
          <span class="material-symbols-rounded">rocket_launch</span> Deploy
        </button>
        <button class="btn btn-secondary btn-sm" onclick="doExportToRepo(${repo.id},${JSON.stringify(repo.name)})">
          <span class="material-symbols-rounded">upload</span> Export Stack
        </button>
        <button class="btn btn-secondary btn-sm" onclick="doRepoPush(${repo.id},${JSON.stringify(repo.name)})">
          <span class="material-symbols-rounded">cloud_upload</span> Push to Git
        </button>
        <button class="btn btn-danger btn-sm" onclick="deleteRepo(${repo.id},${JSON.stringify(repo.name)})">
          <span class="material-symbols-rounded">delete</span>
        </button>
      </div>
    </div>`;
  }).join('');

  c.innerHTML = `<div class="repo-grid">${html}</div>`;
}

// ── Credentials ────────────────────────────────────────────────
async function loadCredentials() {
  try {
    const r = await csrfFetch('/api/git-sync/credentials');
    const d = await r.json();
    credentials = d.credentials || [];
    document.getElementById('creds-count').textContent = credentials.length;
    renderCredentials();
  } catch(e) {
    document.getElementById('creds-container').innerHTML =
      '<p style="color:var(--error);font-size:13px">Failed to load credentials</p>';
  }
}

function renderCredentials() {
  const c = document.getElementById('creds-container');
  if (!credentials.length) {
    c.innerHTML = `
      <div class="empty-state" style="padding:40px 16px">
        <span class="material-symbols-rounded">key_off</span>
        <h3>No credentials yet</h3>
        <p>Add a PAT or SSH key to authenticate with private repositories.</p>
      </div>`;
    return;
  }

  c.innerHTML = `<div class="cred-grid">${credentials.map(cr => `
    <div class="cred-card">
      <div class="cred-icon ${cr.auth_type}">
        <span class="material-symbols-rounded">${cr.auth_type === 'ssh' ? 'vpn_key' : 'token'}</span>
      </div>
      <div class="cred-info">
        <div class="cred-name">${esc(cr.name)}</div>
        <div class="cred-meta">${esc(cr.host)} · ${cr.auth_type === 'token' ? 'PAT' : 'SSH Key'}${cr.notes ? ' · ' + esc(cr.notes) : ''}</div>
      </div>
      <div class="cred-actions">
        <button class="btn btn-secondary btn-sm btn-icon" onclick="editCred(${cr.id})" title="Edit">
          <span class="material-symbols-rounded">edit</span>
        </button>
        <button class="btn btn-danger btn-sm btn-icon" onclick="deleteCred(${cr.id},${JSON.stringify(cr.name)})" title="Delete">
          <span class="material-symbols-rounded">delete</span>
        </button>
      </div>
    </div>`).join('')}</div>`;
}

// ── Repo modal ─────────────────────────────────────────────────
function openAddRepoModal() {
  document.getElementById('modal-repo-title').textContent = 'Add Git Sync';
  document.getElementById('repo-edit-id').value = '';
  document.getElementById('repo-name').value = '';
  document.getElementById('repo-url').value = '';
  document.getElementById('repo-branch').value = 'main';
  document.getElementById('repo-compose').value = 'docker-compose.yml';
  document.getElementById('repo-autosync').checked = false;
  document.getElementById('repo-interval').value = 5;
  document.getElementById('repo-commit-name').value = 'D-PlaneOS';
  document.getElementById('repo-commit-email').value = 'dplaneos@localhost';
  document.getElementById('interval-group').style.display = 'none';
  populateCredSelect(null);
  document.getElementById('modal-repo').style.display = 'flex';
}

function editRepo(id) {
  const repo = repos.find(r => r.id === id);
  if (!repo) return;
  document.getElementById('modal-repo-title').textContent = 'Edit Sync — ' + repo.name;
  document.getElementById('repo-edit-id').value = repo.id;
  document.getElementById('repo-name').value = repo.name;
  document.getElementById('repo-url').value = repo.repo_url;
  document.getElementById('repo-branch').value = repo.branch;
  document.getElementById('repo-compose').value = repo.compose_path;
  document.getElementById('repo-autosync').checked = repo.auto_sync;
  document.getElementById('repo-interval').value = repo.sync_interval;
  document.getElementById('repo-commit-name').value = repo.commit_name;
  document.getElementById('repo-commit-email').value = repo.commit_email;
  document.getElementById('interval-group').style.display = repo.auto_sync ? '' : 'none';
  populateCredSelect(repo.cred_id);
  document.getElementById('modal-repo').style.display = 'flex';
}

function populateCredSelect(selectedId) {
  const sel = document.getElementById('repo-cred');
  sel.innerHTML = '<option value="">None (public repo)</option>';
  credentials.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.name + ' (' + c.host + ')';
    if (selectedId && c.id === selectedId) opt.selected = true;
    sel.appendChild(opt);
  });
}

document.getElementById('repo-autosync').addEventListener('change', function() {
  document.getElementById('interval-group').style.display = this.checked ? '' : 'none';
});

async function saveRepo() {
  const editId = document.getElementById('repo-edit-id').value;
  const payload = {
    name: document.getElementById('repo-name').value.trim(),
    repo_url: document.getElementById('repo-url').value.trim(),
    branch: document.getElementById('repo-branch').value.trim() || 'main',
    compose_path: document.getElementById('repo-compose').value.trim() || 'docker-compose.yml',
    auto_sync: document.getElementById('repo-autosync').checked,
    sync_interval: parseInt(document.getElementById('repo-interval').value) || 5,
    commit_name: document.getElementById('repo-commit-name').value.trim() || 'D-PlaneOS',
    commit_email: document.getElementById('repo-commit-email').value.trim() || 'dplaneos@localhost',
    enabled: true,
  };
  const credVal = document.getElementById('repo-cred').value;
  if (credVal) payload.credential_id = parseInt(credVal);
  if (editId) payload.id = parseInt(editId);

  if (!payload.name) { ui.toast('Name is required', 'error'); return; }
  if (!payload.repo_url) { ui.toast('Repository URL is required', 'error'); return; }

  try {
    const r = await csrfFetch('/api/git-sync/repos', {method:'POST', body:JSON.stringify(payload)});
    const d = await r.json();
    if (d.success) {
      ui.toast(editId ? 'Sync updated' : 'Sync added', 'success');
      closeModal('modal-repo');
      loadRepos();
    } else {
      ui.toast(d.error || 'Failed to save', 'error');
    }
  } catch(e) { ui.toast('Request failed', 'error'); }
}

async function deleteRepo(id, name) {
  if (!await ui.confirm('Delete Sync', 'Delete "' + name + '"? The local clone will not be removed.')) return;
  const r = await csrfFetch('/api/git-sync/repos/delete?id=' + id, {method:'POST'});
  const d = await r.json();
  if (d.success) { ui.toast('Sync deleted', 'success'); loadRepos(); }
  else ui.toast(d.error || 'Failed', 'error');
}

// ── Repo Actions ───────────────────────────────────────────────
function doRepoPull(id, name) {
  showActionModal('pull', id, name,
    'Pull latest changes from the remote repository.<br>This will run <code>git pull --rebase</code> on the local clone.',
    'cloud_download', 'Pull Now');
}
function doRepoDeploy(id, name) {
  showActionModal('deploy', id, name,
    'Run <code>docker compose up -d --remove-orphans</code> using the compose file in the cloned repository.<br><strong>Pull first</strong> to ensure you have the latest version.',
    'rocket_launch', 'Deploy');
}
function doExportToRepo(id, name) {
  showActionModal('export', id, name,
    'Export all currently running containers as a <code>docker-compose.yml</code> and write it into the local repository clone.<br>After exporting, use <strong>Push to Git</strong> to commit and push to the remote.',
    'upload', 'Export Stack');
}
function doRepoPush(id, name) {
  showActionModal('push', id, name,
    'Commit the current state of the compose file and push to the remote repository.',
    'cloud_upload', 'Push to Git');
}

function showActionModal(type, id, name, desc, icon, label) {
  pendingAction = {type, id, name};
  document.getElementById('action-modal-icon').textContent = icon;
  document.getElementById('action-modal-title').textContent = label + ' — ' + name;
  document.getElementById('action-modal-body').innerHTML = desc;
  document.getElementById('action-icon').textContent = icon;
  document.getElementById('action-confirm-label').textContent = label;
  document.getElementById('action-output-block').style.display = 'none';
  document.getElementById('action-output').textContent = '';
  document.getElementById('action-confirm-btn').disabled = false;
  document.getElementById('modal-action').style.display = 'flex';
}

async function executeAction() {
  if (!pendingAction) return;
  const {type, id} = pendingAction;
  const btn = document.getElementById('action-confirm-btn');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner"></div> Running…';

  const endpoints = {
    pull:   '/api/git-sync/repos/pull?id=' + id,
    deploy: '/api/git-sync/repos/deploy?id=' + id,
    export: '/api/git-sync/repos/export?id=' + id,
    push:   '/api/git-sync/repos/push?id=' + id,
  };

  try {
    const r = await csrfFetch(endpoints[type], {method:'POST', body:JSON.stringify({})});
    const d = await r.json();

    const out = document.getElementById('action-output');
    const outBlock = document.getElementById('action-output-block');

    if (d.success) {
      const outputText = d.output || d.yaml || ('Commit: ' + (d.commit || 'n/a'));
      out.textContent = outputText;
      outBlock.style.display = '';
      ui.toast(pendingAction.name + ': ' + type + ' successful', 'success');
      loadRepos();
    } else {
      out.textContent = (d.error || 'Failed') + (d.hint ? '\n\nHint: ' + d.hint : '');
      outBlock.style.display = '';
      ui.toast(d.error || 'Action failed', 'error');
    }
  } catch(e) {
    ui.toast('Request failed: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<span class="material-symbols-rounded">done</span> Done';
    pendingAction = null;
  }
}

// ── Credential modal ───────────────────────────────────────────
function openAddCredModal() {
  editingCredId = null;
  document.getElementById('cred-edit-id').value = '';
  document.getElementById('cred-name').value = '';
  document.getElementById('cred-host').value = 'github.com';
  document.getElementById('cred-type').value = 'token';
  document.getElementById('cred-token').value = '';
  document.getElementById('cred-ssh').value = '';
  document.getElementById('cred-notes').value = '';
  document.getElementById('test-block').style.display = 'none';
  document.getElementById('test-result').style.display = 'none';
  toggleCredFields();
  document.getElementById('modal-cred').style.display = 'flex';
}

function editCred(id) {
  const cred = credentials.find(c => c.id === id);
  if (!cred) return;
  editingCredId = id;
  document.getElementById('cred-edit-id').value = id;
  document.getElementById('cred-name').value = cred.name;
  document.getElementById('cred-host').value = cred.host;
  document.getElementById('cred-type').value = cred.auth_type;
  document.getElementById('cred-token').value = '';
  document.getElementById('cred-token').placeholder = cred.has_token ? 'Leave blank to keep existing token' : '';
  document.getElementById('cred-ssh').value = '';
  document.getElementById('cred-notes').value = cred.notes || '';
  document.getElementById('test-block').style.display = '';
  toggleCredFields();
  document.getElementById('modal-cred').style.display = 'flex';
}

function toggleCredFields() {
  const t = document.getElementById('cred-type').value;
  document.getElementById('pat-wizard-block').style.display = t === 'token' ? '' : 'none';
  document.getElementById('ssh-block').style.display = t === 'ssh' ? '' : 'none';
  // Show test block only for existing credentials
  if (editingCredId) document.getElementById('test-block').style.display = '';
}

async function saveCred() {
  const editId = document.getElementById('cred-edit-id').value;
  const authType = document.getElementById('cred-type').value;
  const payload = {
    name:      document.getElementById('cred-name').value.trim(),
    host:      document.getElementById('cred-host').value.trim() || 'github.com',
    auth_type: authType,
    token:     document.getElementById('cred-token').value,
    ssh_key:   document.getElementById('cred-ssh').value,
    notes:     document.getElementById('cred-notes').value.trim(),
  };
  if (editId) payload.id = parseInt(editId);

  if (!payload.name) { ui.toast('Name is required', 'error'); return; }

  try {
    const r = await csrfFetch('/api/git-sync/credentials', {method:'POST', body:JSON.stringify(payload)});
    const d = await r.json();
    if (d.success) {
      ui.toast('Credential saved', 'success');
      closeModal('modal-cred');
      await loadCredentials();
    } else {
      ui.toast(d.error || 'Failed to save', 'error');
    }
  } catch(e) { ui.toast('Request failed', 'error'); }
}

async function testCred() {
  const repoUrl = document.getElementById('test-repo-url').value.trim();
  if (!repoUrl) { ui.toast('Enter a repo URL to test against', 'error'); return; }
  const editId = document.getElementById('cred-edit-id').value;
  if (!editId) { ui.toast('Save the credential first', 'error'); return; }

  const resultEl = document.getElementById('test-result');
  resultEl.style.display = '';
  resultEl.innerHTML = '<div style="display:flex;gap:8px;align-items:center"><div class="spinner"></div> Testing connection…</div>';

  try {
    const r = await csrfFetch('/api/git-sync/credentials/test', {method:'POST',
      body: JSON.stringify({credential_id: parseInt(editId), repo_url: repoUrl})});
    const d = await r.json();
    if (d.success) {
      resultEl.innerHTML = '<span style="color:var(--success)"><span class="material-symbols-rounded" style="font-size:15px;vertical-align:middle">check_circle</span> Connection successful</span>';
    } else {
      resultEl.innerHTML = '<span style="color:var(--error)"><span class="material-symbols-rounded" style="font-size:15px;vertical-align:middle">error</span> ' + esc(d.error) +
        (d.hint ? '<br><span style="color:var(--text-dim)">' + esc(d.hint) + '</span>' : '') + '</span>';
    }
  } catch(e) {
    resultEl.innerHTML = '<span style="color:var(--error)">Request failed</span>';
  }
}

async function deleteCred(id, name) {
  if (!await ui.confirm('Delete Credential', 'Delete "' + name + '"? Syncs using this credential will stop authenticating.')) return;
  const r = await csrfFetch('/api/git-sync/credentials/delete?id=' + id, {method:'POST'});
  const d = await r.json();
  if (d.success) { ui.toast('Credential deleted', 'success'); loadCredentials(); }
  else ui.toast(d.error || 'Failed', 'error');
}

// ── Legacy Status ──────────────────────────────────────────────
async function loadLegacyStatus() {
  try {
    const r = await csrfFetch('/api/git-sync/status');
    const d = await r.json();
    if (!d.success) { document.getElementById('legacy-status').textContent = 'Not configured'; return; }
    const el = document.getElementById('legacy-status');
    el.innerHTML = `
      <div style="display:grid;grid-template-columns:120px 1fr;gap:8px 16px;font-size:13px">
        <span style="color:var(--text-dim)">Repo</span><span>${esc(d.repo_url||'—')}</span>
        <span style="color:var(--text-dim)">Branch</span><span>${esc(d.branch||'main')}</span>
        <span style="color:var(--text-dim)">Last commit</span><span style="color:var(--primary)">${esc(d.last_commit||'—')}</span>
        <span style="color:var(--text-dim)">Last sync</span><span>${d.last_sync_at ? esc(relativeTime(d.last_sync_at)) : '—'}</span>
      </div>`;
  } catch(e) {
    document.getElementById('legacy-status').textContent = 'Failed to load';
  }
}

// ── Utilities ──────────────────────────────────────────────────
function closeModal(id) {
  document.getElementById(id).style.display = 'none';
}

function esc(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function relativeTime(iso) {
  if (!iso) return '—';
  const diff = Date.now() - new Date(iso).getTime();
  if (diff < 60000) return 'just now';
  if (diff < 3600000) return Math.floor(diff/60000) + 'm ago';
  if (diff < 86400000) return Math.floor(diff/3600000) + 'h ago';
  return Math.floor(diff/86400000) + 'd ago';
}

  try {
    const r = await csrfFetch('/api/auth/session');
    const d = await r.json();
    if (d.success && d.user) {
      const el = document.getElementById('currentUser');
      if (el) el.textContent = d.user.username;
    }
  } catch(e) {}
}

  if (!await ui.confirm('Logout', 'Are you sure?')) return;
  try {
    const r = await csrfFetch('/api/auth/logout', {method:'POST'});
    if (r.ok) { window.location.href = '/login'; return; }
    ui.toast('Logout failed', 'error');
  } catch(e) { ui.toast('Logout failed', 'error'); }
}
</script>
</body></html>
